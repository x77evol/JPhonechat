<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://img.heliar.top/file/1771644347008_IMG_20260221_112453.jpg">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JPhone</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <style id="dynamic-font-style"></style>
    <style id="custom-bubble-style"></style>
    <style>
        /* --- 基础字体与变量定义 --- */
        @font-face {
            font-family: 'PresetFont1';
            src: url('https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756685803738_qdqqd_52zkmz.ttf') format('truetype');
        }
        @font-face {
            font-family: 'PresetFont2';
            src: url('https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756711789458_qdqqd_1cxldd.ttf') format('truetype');
        }

        :root {
            --phone-width: 360px;
            --phone-height: 690px;
            --primary-text: #000;
            --secondary-text: #8e8e93;
            --ios-blue: #000; /* 强调色统一为黑色 */
            --theme-color: #000; /* 主要UI元素颜色改为黑色 */
            --theme-color-light: #e5e5e5;
            --theme-bg: linear-gradient(180deg, #f7f7f7 0%, #e9e9e9 100%);
            --glass-effect: linear-gradient(135deg, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.6) 100%);
            --default-font: -apple-system, BlinkMacSystemFont, sans-serif;
            --current-font: var(--default-font);
            --global-font-size: 15px;
            --global-font-weight: normal;
            --global-font-style: normal;
            
            /* ★★★ UI调整CSS变量 ★★★ */
            --ui-element-base-size: 16px;
            --global-icon-size: 28px;
            --global-top-nav-height: 44px;
            --global-bottom-nav-height: 50px;
            --status-bar-icon-size: 15px;

            /* ★★★ 气泡与头像调整CSS变量 (优化后) ★★★ */
            /* User (Me) */
            --user-avatar-size: 35px;
            --user-avatar-offset-x: 0px;
            --user-avatar-offset-y: 0px;
            --user-avatar-frame-width: 43px;
            --user-avatar-frame-height: 43px;
            --user-avatar-frame-offset-x: -4px;
            --user-avatar-frame-offset-y: -4px;
            --user-bubble-offset-x: 0px;
            --user-bubble-offset-y: 0px;
            --user-bubble-padding-x: 12px;
            --user-bubble-padding-y: 8px;

            /* Char (Them) */
            --char-avatar-size: 35px;
            --char-avatar-offset-x: 0px;
            --char-avatar-offset-y: 0px;
            --char-avatar-frame-width: 43px;
            --char-avatar-frame-height: 43px;
            --char-avatar-frame-offset-x: -4px;
            --char-avatar-frame-offset-y: -4px;
            --char-bubble-offset-x: 0px;
            --char-bubble-offset-y: 0px;
            --char-bubble-padding-x: 12px;
            --char-bubble-padding-y: 8px;

            /* ★★★ 更新: 气泡间距与形状优化 ★★★ */
            --avatar-gap: 6px; /* 气泡与头像间距 (宽度) */
            --consecutive-bubble-gap: 4px; /* 连续气泡间距 (高度) */
            --bubble-gap-height: 12px; /* 气泡上下间距 */
            --bubble-max-width-ratio: 70%; /* 气泡最大宽度比例 */
            --chat-screen-padding: 10px; /* 聊天屏幕左右边距 */
            --bubble-border-radius: 18px; /* ★★★ 新增: 气泡圆角变量 ★★★ */
        }

        * {
            font-family: var(--current-font), sans-serif;
            font-weight: var(--global-font-weight);
            font-style: var(--global-font-style);
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            background: #f0f0f0;
            padding: 0;
            overflow: hidden;
            transition: background 0.4s ease-in-out, padding 0.4s ease-in-out;
        }
        
        .phone-container { 
            width: 100vw; 
            height: 100vh; 
            background: #fff; 
            border-radius: 0; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative; 
            border: none; 
            box-shadow: none;
            transition: all 0.4s ease-in-out;
        }

        body.phone-frame-mode {
            background: #fff;
            padding: 20px;
        }

        body.phone-frame-mode .phone-container {
            width: var(--phone-width);
            height: var(--phone-height);
            border-radius: 40px;
            border: 10px solid #000;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            transform: scale(1);
            transform-origin: center;
            transition: all 0.4s ease-in-out, transform 0.4s ease-in-out;
        }
        
        .screen { 
            width: 100%; 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            background-color: #fff; 
            font-size: var(--global-font-size);
        }

        /* --- 主屏幕 --- */
        .home-screen { 
            position: absolute; 
            inset: 0; 
            background: var(--theme-bg);
            background-size: cover; 
            background-position: center; 
            display: flex; 
            flex-direction: column; 
            transition: background-image 0.5s ease;
        }
        
        .home-screen-content { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding-top: 60px; 
            gap: 15px;
        }
        
        .home-time { 
            font-size: calc(var(--ui-element-base-size) * 3.5);
            font-weight: 600; 
            color: var(--theme-color); 
            text-shadow: 0 1px 2px rgba(0,0,0,0.1); 
        }
        
        .home-date {
            font-size: calc(var(--ui-element-base-size) * 1.1);
            color: var(--theme-color);
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .card-widget {
            width: calc(100% - 30px);
            border-radius: 20px;
            background: var(--glass-effect);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            padding: 15px;
            color: var(--primary-text);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        .card-widget-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.3;
            z-index: 0;
        }
        .card-widget-content {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .card-widget-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .card-widget-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #eee;
            background-size: cover;
            background-position: center;
            border: 2px solid rgba(255,255,255,0.8);
            flex-shrink: 0;
        }
        .card-widget-info {
            flex: 1;
            overflow: hidden;
        }
        .card-widget-nickname {
            font-size: calc(var(--ui-element-base-size) * 1.1);
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card-widget-username {
            font-size: calc(var(--global-font-size) * 1.1);
            color: var(--secondary-text);
        }
        .card-widget-body {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .card-widget-signature, .card-widget-address {
            font-size: calc(var(--global-font-size) * 1.1);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .card-widget-address i {
            color: var(--primary-text);
        }

        .widget-row {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 0 15px;
            gap: 10px;
        }
        .widget {
            border-radius: 20px;
            background: var(--glass-effect);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            padding: 12px;
            color: var(--primary-text);
            position: relative;
        }
        #music-widget {
            flex: 1;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }
        #music-widget-art {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            background-color: #eee;
            margin-bottom: 5px;
        }
        #music-widget-info {
            text-align: center;
            font-size: calc(var(--global-font-size) * 1.1);
            overflow: hidden;
        }
        #music-widget-title {
            font-weight: 600;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            width: 100%;
        }
        #music-widget-artist {
            color: var(--secondary-text);
            font-size: calc(var(--global-font-size) * 1);
        }
        #music-widget-controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            margin-top: 5px;
        }
        #music-widget-controls i {
            color: var(--primary-text);
            cursor: pointer;
            font-size: calc(var(--ui-element-base-size) * 1);
        }
        #copywriting-widget {
            flex: 1;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* 从顶部开始 */
            gap: 5px;
            background-color: white; /* 默认白色背景 */
            transition: background 0.3s, backdrop-filter 0.3s;
        }
        #copywriting-widget.glassy {
            background: var(--glass-effect);
            backdrop-filter: blur(15px);
        }
        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 8px;
        }
        #widget-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #eee;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.1);
        }
        #copywriting-style-btn {
            background: rgba(0,0,0,0.05);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            color: var(--primary-text);
            cursor: pointer;
            font-size: calc(var(--ui-element-base-size) * 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .copywriting-line {
            background: transparent;
            border: none;
            border-bottom: 1px dashed rgba(0, 0, 0, 0.5);
            border-radius: 0;
            padding: 3px 6px;
            font-size: calc(var(--global-font-size) * 1.2);
            outline: none;
            min-height: 1.2em;
            color: var(--primary-text);
            text-shadow: 0 1px 2px rgba(255,255,255,0.7);
        }
        
        .app-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 15px; 
            width: 100%; 
            padding: 0 15px; 
            justify-items: center;
        }
        
        .app-icon-wrapper { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            cursor: pointer; 
            width: 80px;
        }
        
        .app-icon-image { 
            width: 72px; 
            height: 72px; 
            border-radius: 18px; 
            overflow: hidden; 
            margin-bottom: 5px; 
            background: var(--glass-effect);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            color: white;
            font-size: var(--global-icon-size);
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            background-size: cover;
            background-position: center;
        }
        
        .app-icon-image i {
            color: var(--primary-text);
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .app-icon-name { 
            font-size: calc(var(--global-font-size) * 1.1); 
            color: var(--primary-text); 
            text-shadow: 0 1px 2px rgba(255,255,255,0.5); 
            text-align: center;
            font-weight: 500;
            white-space: nowrap;
        }

        /* ★★★ 新增: 黑白线条UI风格 ★★★ */
        body.ui-style-line .home-screen {
            background: #fff;
        }
        body.ui-style-line .app-icon-image {
            background: #fff !important; /* 强制覆盖背景图 */
            border: 1.5px solid var(--primary-text);
            box-shadow: none;
            backdrop-filter: none;
        }
        body.ui-style-line .app-icon-image i {
            font-weight: 300; /* 使用FontAwesome的light风格 */
            transform: scale(0.9);
        }
        body.ui-style-line .app-icon-name {
            color: var(--primary-text);
            text-shadow: none;
        }
        body.ui-style-line .widget,
        body.ui-style-line .card-widget {
            background: #fff;
            backdrop-filter: none;
            border: 1px solid #eee;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        body.ui-style-line #music-widget-controls i,
        body.ui-style-line .card-widget-address i {
            font-weight: 300;
        }
        body.ui-style-line .copywriting-line {
            border-bottom-color: rgba(0,0,0,0.2);
            text-shadow: none;
        }
        body.ui-style-line #copywriting-widget {
            background: #fff;
        }


        /* --- 状态栏 & 灵动岛 --- */
        .status-bar { 
            height: 44px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 20px; 
            color: var(--theme-color); 
            font-size: var(--status-bar-icon-size);
            position: absolute; 
            top: 0; 
            left: 0; 
            right: 0; 
            z-index: 1100; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.1); 
            pointer-events: none; 
        }
        
        #ins-dynamic-island {
            display: flex;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 110px;
            height: 36px;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 40px;
            align-items: center;
            justify-content: center;
            padding: 0 8px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            overflow: hidden;
            z-index: 1200;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            pointer-events: auto;
        }
        #ins-dynamic-island.expanded {
            width: 90%;
            max-width: 340px;
            height: 220px;
            border-radius: 30px;
            overflow: visible;
            padding: 0;
        }
        #ins-dynamic-island .island-content {
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: space-between;
            color: white;
            font-size: 13px;
            font-weight: 500;
        }
        #ins-dynamic-island.no-music .island-placeholder {
            display: flex;
        }
        #ins-dynamic-island:not(.no-music):not(.expanded) .island-default {
            display: flex;
            gap: 8px;
            padding: 0 4px;
        }
        #ins-dynamic-island.expanded .music-player {
            display: flex;
        }
        .island-placeholder {
            /* 无音乐时的占位符，保持灵动岛形态 */
        }
        #ins-dynamic-island .album-cover {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            overflow: hidden;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.8);
            background-size: cover;
            background-position: center;
            animation: rotate 20s linear infinite;
            animation-play-state: paused;
            flex-shrink: 0;
        }
        #ins-dynamic-island.playing .album-cover {
            animation-play-state: running;
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        #ins-dynamic-island .island-default .album-cover i { font-size: 14px; }
        
        #ins-dynamic-island .wave-container-small {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            height: 16px;
        }
        #ins-dynamic-island .wave-bar-small {
            width: 2px;
            background-color: #34C759; /* 绿色 */
            border-radius: 1px;
            animation: ins-wave-small 1s ease-in-out infinite alternate;
            animation-play-state: paused;
        }
        #ins-dynamic-island.playing .wave-bar-small { animation-play-state: running; }
        #ins-dynamic-island .wave-bar-small:nth-child(2) { animation-delay: 0.1s; }
        #ins-dynamic-island .wave-bar-small:nth-child(3) { animation-delay: 0.2s; }
        #ins-dynamic-island .wave-bar-small:nth-child(4) { animation-delay: 0.3s; }
        @keyframes ins-wave-small { 0% { height: 2px; } 100% { height: 12px; } }

        #ins-dynamic-island .music-player {
            width: 100%;
            height: 100%;
            padding: 18px 20px;
            flex-direction: column;
            justify-content: space-between;
            box-sizing: border-box;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 30px;
        }
        #ins-dynamic-island .song-info { color: white; }
        #ins-dynamic-island .song-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #ins-dynamic-island .artist {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }
        #ins-dynamic-island .wave-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            height: 20px;
            margin-top: 5px;
        }
        #ins-dynamic-island .wave-bar {
            width: 2px;
            background-color: white;
            border-radius: 1px;
            animation: ins-wave 1s ease-in-out infinite alternate;
            animation-play-state: paused;
        }
        #ins-dynamic-island.playing .wave-bar { animation-play-state: running; }
        #ins-dynamic-island .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        #ins-dynamic-island .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        #ins-dynamic-island .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        #ins-dynamic-island .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        #ins-dynamic-island .wave-bar:nth-child(6) { animation-delay: 0.5s; }
        #ins-dynamic-island .wave-bar:nth-child(7) { animation-delay: 0.4s; }
        #ins-dynamic-island .wave-bar:nth-child(8) { animation-delay: 0.3s; }
        #ins-dynamic-island .wave-bar:nth-child(9) { animation-delay: 0.2s; }
        #ins-dynamic-island .wave-bar:nth-child(10) { animation-delay: 0.1s; }
        @keyframes ins-wave { 0% { height: 4px; } 100% { height: 16px; } }
        
        #ins-dynamic-island .progress-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        #ins-dynamic-island .time-display {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
            min-width: 35px;
        }
        #ins-dynamic-island .progress-bar {
            flex: 1;
            height: 3px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 1.5px;
            overflow: hidden;
        }
        #ins-dynamic-island .progress {
            height: 100%;
            width: 0%;
            background-color: white;
            border-radius: 1.5px;
        }
        #ins-dynamic-island .music-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        #ins-dynamic-island .control-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        #ins-dynamic-island .control-btn:hover { background-color: rgba(255, 255, 255, 0.1); }
        #ins-dynamic-island .control-btn i { color: white; font-size: 16px; }
        #ins-dynamic-island .play-btn {
            width: 44px;
            height: 44px;
            background-color: white;
        }
        #ins-dynamic-island .play-btn i { color: black; font-size: 18px; }
        
        #ins-dynamic-island .advanced-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            margin-top: 8px;
        }
        #ins-dynamic-island .slider-group {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
        }
        #ins-dynamic-island .slider-group i {
            width: 14px;
            text-align: center;
        }
        #ins-dynamic-island .slider-group input[type="range"] {
            flex: 1;
            height: 2px;
            background: rgba(255,255,255,0.2);
        }
        #ins-dynamic-island .slider-group input[type="range"]::-webkit-slider-thumb {
            width: 12px;
            height: 12px;
            border: none;
            box-shadow: none;
        }

        .status-bar-left, .status-bar-right { display: flex; align-items: center; height: 100%; pointer-events: auto; cursor: pointer; z-index: 1102; gap: 6px; }
        .time { font-weight: 600; }
        .signal-bars { display: flex; align-items: flex-end; height: calc(var(--status-bar-icon-size) * 0.8); gap: 1.5px; }
        .signal-bar { width: calc(var(--status-bar-icon-size) * 0.2); background-color: var(--theme-color); border-radius: 1px; }
        .signal-bar:nth-child(1) { height: 25%; } .signal-bar:nth-child(2) { height: 50%; } .signal-bar:nth-child(3) { height: 75%; } .signal-bar:nth-child(4) { height: 100%; }
        .network-type { font-size: calc(var(--status-bar-icon-size) * 0.8); font-weight: 500; margin-left: 4px; }
        .battery-icon { width: calc(var(--status-bar-icon-size) * 1.6); height: calc(var(--status-bar-icon-size) * 0.75); border: 1.5px solid var(--theme-color); border-radius: 3.5px; position: relative; padding: 1px; box-sizing: border-box; background: rgba(0,0,0,0.1); }
        .battery-icon::after { content: ''; position: absolute; right: -3px; top: 50%; transform: translateY(-50%); width: 1.5px; height: calc(var(--status-bar-icon-size) * 0.25); background-color: var(--theme-color); border-radius: 0 1px 1px 0; }
        .battery-level { position: absolute; top: 1px; left: 1px; bottom: 1px; background: var(--theme-color); border-radius: 2px; transition: width 0.5s ease, background-color 0.5s ease; width: 85%; }
        .battery-text { display: none; }
        
        /* --- 应用通用 --- */
        .app-container { 
            position: absolute; inset: 0; background-color: #f9f9f9; 
            display: none; flex-direction: column; z-index: 1000; 
            transform: translateX(100%); transition: transform 0.3s ease-in-out; 
        }
        .app-container.active { display: flex; transform: translateX(0); }
        .app-navigation-bar {
            position: absolute; top: 44px; left: 0; right: 0; height: var(--global-top-nav-height);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; flex-shrink: 0; z-index: 10;
            background-color: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--theme-color-light);
        }
        .app-back-btn, .app-action-btn { font-size: calc(var(--ui-element-base-size) * 1.4); cursor: pointer; color: var(--primary-text); padding: 5px; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; }
        .app-title { font-size: calc(var(--ui-element-base-size) * 1.1); font-weight: 600; color: var(--primary-text); }
        .app-action-btn-group { display: flex; align-items: center; gap: 8px; }
        .app-content {
            flex: 1; overflow-y: auto; background-color: #fff;
            padding-top: calc(44px + var(--global-top-nav-height)); display: flex; flex-direction: column;
            color: var(--primary-text); font-size: calc(var(--global-font-size) * 1.2);
            align-items: center; text-align: center; padding: calc(56px + var(--global-top-nav-height)) 20px 20px;
        }
        .home-indicator { 
            position: absolute; 
            bottom: 5px;
            left: 50%; 
            transform: translateX(-50%); 
            width: 120px;
            height: 4px;
            background-color: rgba(0, 0, 0, 0.35); 
            border-radius: 2px; 
            cursor: pointer; 
            z-index: 1101;
            box-shadow: 0 -1px 2px rgba(255,255,255,0.1);
        }
        
        /* --- UI 组件 --- */
        .glass-list { width: 100%; display: flex; flex-direction: column; gap: 12px; }
        .glass-list-item {
            background: var(--glass-effect); backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.3); border-radius: 15px;
            padding: 12px 18px; display: flex; align-items: center;
            justify-content: space-between; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s;
        }
        .glass-list-item:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .glass-list-item .item-icon { font-size: calc(var(--ui-element-base-size) * 1.25); color: var(--primary-text); margin-right: 15px; width: 22px; text-align: center; }
        .glass-list-item .item-text { flex: 1; font-size: calc(var(--global-font-size) * 1.4); color: var(--primary-text); font-weight: 500; text-align: left; }
        .glass-list-item .item-arrow { font-size: calc(var(--ui-element-base-size) * 0.9); color: var(--secondary-text); }

        .glass-form-group {
            width: 100%; margin-bottom: 15px;
            background: rgba(255,255,255,0.3); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 12px;
            padding: 10px 15px; text-align: left;
        }
        .glass-form-group label {
            display: block; font-size: calc(var(--global-font-size) * 1.1);
            color: var(--primary-text); font-weight: 600; margin-bottom: 8px;
            opacity: 0.8;
        }
        .glass-input, .glass-select, .glass-textarea {
            width: 100%; background: rgba(255,255,255,0.5); border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px; padding: 8px 12px; font-size: calc(var(--global-font-size) * 1.2);
            color: var(--primary-text); outline: none;
        }
        .glass-textarea { resize: vertical; min-height: 80px; }
        .glass-input::placeholder, .glass-textarea::placeholder { color: rgba(0, 0, 0, 0.4); }
        .glass-button {
            width: 100%; padding: 12px; border-radius: 12px; border: none;
            background: var(--theme-color);
            color: white; font-size: calc(var(--ui-element-base-size) * 0.9); font-weight: 600;
            cursor: pointer; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }
        .glass-button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); }
        .form-row { display: flex; align-items: center; gap: 10px; }
        .form-row .glass-button { width: auto; padding: 8px 15px; font-size: calc(var(--ui-element-base-size) * 0.8); }

        .segmented-control {
            display: flex; background: rgba(0, 0, 0, 0.05); border-radius: 8px; padding: 3px;
        }
        .segmented-control button {
            flex: 1; padding: 6px 10px; border: none; background: transparent;
            color: var(--primary-text); font-size: calc(var(--global-font-size) * 1.1);
            border-radius: 6px; cursor: pointer; transition: all 0.3s ease;
        }
        .segmented-control button.active {
            background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .segmented-control button:disabled {
            color: #ccc;
            cursor: not-allowed;
        }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-text); }
        input:focus + .slider { box-shadow: 0 0 1px var(--primary-text); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* ★★★ 新增: 黑白线条UI风格 - UI组件 ★★★ */
        body.ui-style-line .app-navigation-bar {
            background: rgba(255,255,255,0.9);
            backdrop-filter: none;
        }
        body.ui-style-line .glass-list-item,
        body.ui-style-line .glass-form-group,
        body.ui-style-line .contact-list-item, 
        body.ui-style-line .worldbook-list-item, 
        body.ui-style-line .message-list-item, 
        body.ui-style-line .profile-list-item, 
        body.ui-style-line .blacklist-item,
        body.ui-style-line .wallet-balance-card,
        body.ui-style-line .transaction-item,
        body.ui-style-line .friend-post,
        body.ui-style-line .me-profile-header,
        body.ui-style-line #shopping-me-profile-header,
        body.ui-style-line .tieba-me-profile-header {
            background: #fff;
            backdrop-filter: none;
            border: 1px solid #f0f0f0;
            box-shadow: none;
        }
        body.ui-style-line .glass-list-item:hover {
            background: #f9f9f9;
            box-shadow: none;
            transform: none;
        }
        body.ui-style-line .glass-input, 
        body.ui-style-line .glass-select, 
        body.ui-style-line .glass-textarea {
            background: #f9f9f9;
            border-color: #ddd;
        }
        body.ui-style-line .glass-button {
            box-shadow: none;
        }
        body.ui-style-line .glass-button:hover {
            transform: none;
            box-shadow: none;
            opacity: 0.8;
        }
        body.ui-style-line .item-icon,
        body.ui-style-line .item-arrow,
        body.ui-style-line .app-back-btn i,
        body.ui-style-line .app-action-btn i {
            font-weight: 300;
        }
        body.ui-style-line .segmented-control {
            background: #f0f0f0;
        }
        body.ui-style-line .segmented-control button.active {
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        /* --- 列表视图 --- */
        #contactsListContent, #worldBookListContent, #messagesListContent, #myProfilesListContent, #blacklistContent, #memorySummaryContactListContent, #dataManagementContent, #uiAdjustmentContainer .app-content, #statusBarSettingsContainer .app-content, #displayModeSettingsContainer .app-content, #recentlyPlayedContainer .app-content, #friendsSettingsContainer .app-content, #uiStyleSettingsContainer .app-content {
            padding: calc(54px + var(--global-top-nav-height)) 15px 70px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--theme-bg);
        }
        .contact-group-header {
            padding: 10px 15px 5px;
            font-size: calc(var(--global-font-size) * 1.2);
            font-weight: 600;
            color: var(--secondary-text);
            text-align: left;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .contact-list-item, .worldbook-list-item, .message-list-item, .profile-list-item, .blacklist-item {
            display: flex; align-items: center; padding: 10px 15px;
            cursor: pointer;
            width: 100%;
            background: var(--glass-effect); backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.3); border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .message-list-item.pinned { background: rgba(220, 220, 220, 0.8); }
        .contact-list-item:hover, .worldbook-list-item:hover, .message-list-item:hover, .profile-list-item:hover, .blacklist-item:hover { background: rgba(255,255,255,0.5); }
        .list-item-avatar-wrapper { position: relative; width: 45px; height: 45px; flex-shrink: 0; margin-right: 15px; }
        .list-item-avatar { width: 100%; height: 100%; border-radius: 50%; background-size: cover; background-position: center; background-color: #eee; }
        .list-item-avatar-frame { position: absolute; inset: -5px; background-size: contain; background-repeat: no-repeat; background-position: center; pointer-events: none; }
        .list-item-info { flex: 1; overflow: hidden; text-align: left; }
        .list-item-name { font-size: calc(var(--global-font-size) * 1.4); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--primary-text); }
        .list-item-bio { font-size: calc(var(--global-font-size) * 1.1); color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .worldbook-tags, .contact-groups-display { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
        .worldbook-tag, .contact-group-tag { background: rgba(0, 0, 0, 0.05); color: var(--primary-text); padding: 2px 6px; border-radius: 5px; font-size: calc(var(--global-font-size) * 0.9); }
        .app-placeholder { padding: 50px 20px; font-size: calc(var(--global-font-size) * 1.3); color: #aaa; text-align: center; background: transparent; }

        /* --- 编辑器通用 --- */
        .editor-avatar-section { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .editor-avatar-preview { width: 80px; height: 80px; border-radius: 50%; background-size: cover; background-position: center; border: 2px solid var(--theme-color-light); cursor: pointer; }
        .gender-options { display: flex; gap: 15px; }
        .gender-options label { display: flex; align-items: center; gap: 5px; font-size: calc(var(--global-font-size) * 1.2); }

        /* --- 世界书编辑器 --- */
        #worldBookEditorContainer .app-content { padding: calc(56px + var(--global-top-nav-height)) 15px 20px; gap: 15px; }
        .tag-input-container {
            display: flex; flex-wrap: wrap; gap: 5px; padding: 8px;
            background: rgba(255,255,255,0.5); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 8px;
        }
        .tag-item {
            background: var(--theme-color); color: white; padding: 3px 8px;
            border-radius: 5px; font-size: calc(var(--global-font-size) * 1.1);
            display: flex; align-items: center; gap: 5px;
        }
        .tag-item .remove-tag { cursor: pointer; }
        #tag-input { border: none; background: transparent; outline: none; flex: 1; min-width: 80px; }

        /* --- 聊天 App --- */
        #chatContainer { padding-bottom: var(--global-bottom-nav-height); }
        .chat-bottom-nav {
            position: absolute; bottom: 0; left: 0; right: 0; height: var(--global-bottom-nav-height);
            background: rgba(248, 248, 248, 0.7); backdrop-filter: blur(20px);
            border-top: 1px solid var(--theme-color-light);
            display: flex; z-index: 1010;
        }
        .chat-nav-item {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 2px; color: var(--secondary-text); cursor: pointer;
        }
        .chat-nav-item.active { color: var(--primary-text); }
        .chat-nav-item i { font-size: calc(var(--ui-element-base-size) * 1.6); color: var(--primary-text); }
        .chat-nav-item span { font-size: calc(var(--global-font-size) * 1.2); }
        .chat-page { display: none; width: 100%; height: 100%; flex-direction: column; }
        .chat-page.active { display: flex; }

        #chatPageMe .app-content { padding: calc(54px + var(--global-top-nav-height)) 15px 20px; gap: 15px; background: var(--theme-bg); }
        .me-profile-header {
            display: flex; align-items: center; width: 100%;
            padding: 20px; cursor: pointer;
        }
        .me-avatar-wrapper { position: relative; width: 60px; height: 60px; flex-shrink: 0; margin-right: 15px; }
        .me-avatar { width: 100%; height: 100%; border-radius: 12px; background-size: cover; background-position: center; background-color: #eee; }
        .me-avatar-frame { position: absolute; inset: -5px; background-size: contain; background-repeat: no-repeat; background-position: center; }
        .me-info { flex: 1; text-align: left; }
        .me-nickname { font-size: calc(var(--ui-element-base-size) * 1.25); font-weight: 600; cursor: pointer; }
        .me-signature { font-size: calc(var(--global-font-size) * 1.2); color: var(--secondary-text); margin-top: 5px; cursor: pointer; }

        #bankCardContainer .app-content { padding: calc(54px + var(--global-top-nav-height)) 15px 20px; gap: 20px; background: var(--theme-bg); }
        .bank-card {
            width: 100%; padding: 20px; border-radius: 15px;
            background: linear-gradient(135deg, #434343 0%, #000000 100%);
            color: white; position: relative; overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .bank-card::before { content: ''; position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255,255,255,0.05); border-radius: 50%; }
        .bank-card-name { font-size: calc(var(--ui-element-base-size) * 1); font-weight: 500; }
        .bank-card-balance { font-size: calc(var(--ui-element-base-size) * 1.75); font-weight: 700; margin: 15px 0; }
        .bank-card-number { font-size: calc(var(--ui-element-base-size) * 0.9); letter-spacing: 2px; }

        #walletContainer .app-content, #transactionHistoryContainer .app-content { padding: calc(54px + var(--global-top-nav-height)) 15px 20px; gap: 15px; background: var(--theme-bg); }
        .wallet-balance-card {
            width: 100%; padding: 30px; text-align: center;
            background: var(--glass-effect); backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.3); border-radius: 20px;
        }
        .wallet-balance-label { font-size: calc(var(--global-font-size) * 1.4); opacity: 0.8; }
        .wallet-balance-amount { font-size: calc(var(--ui-element-base-size) * 2.5); font-weight: 700; margin: 10px 0; }
        .wallet-currency-switcher { margin-top: 15px; }
        .transaction-item {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; padding: 15px;
            background: rgba(255,255,255,0.3); border-radius: 12px;
        }
        .transaction-info .type { font-size: calc(var(--global-font-size) * 1.3); font-weight: 500; }
        .transaction-info .date { font-size: calc(var(--global-font-size) * 1); color: #666; margin-top: 4px; }
        .transaction-amount { font-size: calc(var(--ui-element-base-size) * 1); font-weight: 600; }
        .transaction-amount.income { color: #28a745; }
        .transaction-amount.expense { color: #dc3545; }

        /* --- 聊天室 (优化) --- */
        #chatRoomContainer { background-size: cover; background-position: center; }
        #chatRoomContainer .app-navigation-bar {
            height: auto;
            padding: 10px 16px;
            background: transparent; /* 完全透明 */
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border-bottom: none; /* 移除底部边框 */
        }
        .chat-room-header-main {
            display: flex;
            width: 100%;
            align-items: center;
            justify-content: space-between;
        }
        .chat-room-header-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        #chatRoomHeaderAvatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            margin-bottom: 2px;
        }
        #chatRoomTitleWrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.2;
        }
        #chatRoomTitle {
            font-size: calc(var(--ui-element-base-size) * 1.1);
            font-weight: 600;
        }
        #chatRoomRemark {
            font-size: calc(var(--global-font-size) * 1.1);
            color: var(--secondary-text);
        }
        #chatRoomContainer .app-content { 
            padding: calc(44px + 68px) 0 0; /* 44px状态栏 + 68px(估算)导航栏 */
            background: transparent; 
        }
        .chat-messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px var(--chat-screen-padding) 150px;
            display: flex; 
            flex-direction: column; 
        }
        .chat-messages {
            max-width: 700px;
            margin: 0 auto;
            width: 100%;
        }
        .palpitation-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            cursor: pointer;
            z-index: 1010;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .palpitation-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .message-timestamp-center {
            align-self: center;
            background: rgba(0,0,0,0.1);
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: calc(var(--global-font-size) * 1.0);
            margin: 10px 0;
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        }
        .message-wrapper { 
            display: flex; 
            max-width: var(--bubble-max-width-ratio); 
            align-items: flex-start;
            gap: var(--avatar-gap);
            position: relative; 
            margin-top: var(--bubble-gap-height);
        }
        .message-wrapper.consecutive { 
            margin-top: var(--consecutive-bubble-gap);
        }
        .message-avatar-wrapper { 
            position: relative; 
            flex-shrink: 0; 
            display: flex;
            align-items: center;
            height: var(--char-avatar-size);
        }
        .message-wrapper.message-right .message-avatar-wrapper {
            height: var(--user-avatar-size);
        }
        .message-wrapper.consecutive .message-avatar-wrapper { 
            visibility: hidden; 
        }
        .message-avatar { 
            width: 100%; 
            height: 100%; 
            border-radius: 50%; 
            background-size: cover; 
            background-position: center; 
        }
        .message-avatar-frame { 
            position: absolute; 
            background-size: contain; 
            background-repeat: no-repeat; 
            background-position: center; 
            pointer-events: none; 
        }
        .message-content-wrapper { 
            display: flex; 
            flex-direction: column; 
            position: relative;
        }
        .message-timestamp-under {
            font-size: calc(var(--global-font-size) * 0.9);
            color: #999;
            margin-top: 3px;
        }
        .message-bubble { 
            max-width: 100%; 
            word-wrap: break-word; 
            white-space: pre-wrap; 
            font-size: calc(var(--global-font-size) * 1.3); 
            cursor: pointer; 
            border-radius: var(--bubble-border-radius);
        }
        /* User-specific bubble styles */
        .message-wrapper.message-right .message-avatar-wrapper {
            width: var(--user-avatar-size);
            height: var(--user-avatar-size);
            transform: translate(var(--user-avatar-offset-x), var(--user-avatar-offset-y));
        }
        .message-wrapper.message-right .message-avatar-frame {
            width: var(--user-avatar-frame-width);
            height: var(--user-avatar-frame-height);
            left: var(--user-avatar-frame-offset-x);
            top: var(--user-avatar-frame-offset-y);
        }
        .message-wrapper.message-right .message-content-wrapper {
            transform: translate(var(--user-bubble-offset-x), var(--user-bubble-offset-y));
        }
        .message-wrapper.message-right .message-bubble {
            padding: var(--user-bubble-padding-y) var(--user-bubble-padding-x);
        }
        /* Char-specific bubble styles */
        .message-wrapper.message-left .message-avatar-wrapper {
            width: var(--char-avatar-size);
            height: var(--char-avatar-size);
            transform: translate(var(--char-avatar-offset-x), var(--char-avatar-offset-y));
        }
        .message-wrapper.message-left .message-avatar-frame {
            width: var(--char-avatar-frame-width);
            height: var(--char-avatar-frame-height);
            left: var(--char-avatar-frame-offset-x);
            top: var(--char-avatar-frame-offset-y);
        }
        .message-wrapper.message-left .message-content-wrapper {
            transform: translate(var(--char-bubble-offset-x), var(--char-bubble-offset-y));
        }
        .message-wrapper.message-left .message-bubble {
            padding: var(--char-bubble-padding-y) var(--char-bubble-padding-x);
        }

        .message-wrapper.message-left .message-bubble { 
            background-color: #f0f0f0;
            color: #000;
            border-top-left-radius: 5px; 
        }
        .message-wrapper.message-left .message-timestamp-under { 
            align-self: flex-start; 
            margin-left: 5px; 
        }
        .message-wrapper.message-right { 
            align-self: flex-end; 
            flex-direction: row-reverse; 
        }
        .message-wrapper.message-right .message-content-wrapper { 
            align-items: flex-end; 
        }
        .message-wrapper.message-right .message-bubble { 
            background-color: #fff;
            color: #000;
            border: 1px solid #e5e5e5;
            border-top-right-radius: 5px; 
        }
        .message-wrapper.message-right .message-timestamp-under { 
            align-self: flex-end; 
            margin-right: 5px; 
        }
        .message-bubble img, .message-bubble video { 
            max-width: 100%; 
            border-radius: 10px; 
            display: block;
        }
        .sticker-bubble-wrapper {
            position: relative;
            display: inline-block;
        }
        .sticker-bubble-wrapper .message-bubble {
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            box-shadow: none !important;
        }
        .sticker-bubble-wrapper .message-bubble img {
            width: 100px;
            height: 100px;
            object-fit: contain;
        }
        .sticker-count {
            position: absolute;
            bottom: -5px;
            right: -8px;
            background: rgba(0,0,0,0.6);
            color: white;
            border-radius: 8px;
            padding: 1px 5px;
            font-size: calc(var(--global-font-size) * 1.0);
            font-weight: 600;
        }
        .message-typing-indicator { 
            font-style: italic; 
            color: #888; 
            font-size: calc(var(--global-font-size) * 1.1); 
        }
        
        .quoted-reply {
            background: rgba(0,0,0,0.08);
            color: #000;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: calc(var(--global-font-size) * 1.1);
            margin-bottom: 5px;
            text-align: left;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            border-left: 2px solid var(--secondary-text);
        }
        .message-wrapper.message-right .quoted-reply {
            background: rgba(0, 0, 0, 0.05);
            border-left-color: var(--secondary-text);
        }
        
        .recalled-message-center {
            align-self: center;
            font-size: calc(var(--global-font-size) * 1.1);
            color: #aaa;
            padding: 8px 12px;
            margin: 5px 0;
        }

        .multiselect-checkbox { position: absolute; top: 50%; transform: translateY(-50%); display: none; }
        .message-wrapper.multiselect-mode .multiselect-checkbox { display: block; }
        .message-wrapper.message-left.multiselect-mode .multiselect-checkbox { left: -25px; }
        .message-wrapper.message-right.multiselect-mode .multiselect-checkbox { right: -25px; }

        .chat-input-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: transparent;
            z-index: 1001;
            padding: 5px 10px;
        }
        .chat-input-bar {
            display: flex; 
            align-items: flex-end; 
            gap: 10px;
        }
        .chat-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 0 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chat-input-wrapper i {
            font-size: calc(var(--ui-element-base-size) * 1.5);
            color: var(--primary-text);
            cursor: pointer;
            padding: 8px 5px;
        }
        .chat-input-field {
            flex: 1;
            background: transparent;
            border: none;
            padding: 8px 5px;
            font-size: calc(var(--global-font-size) * 1.4);
            outline: none;
            resize: none;
            max-height: 80px;
            overflow-y: auto;
            color: var(--primary-text);
        }
        .chat-send-btn {
            background: transparent;
            border: none;
            color: var(--primary-text);
            font-size: calc(var(--ui-element-base-size) * 1.1);
            font-weight: 700;
            cursor: pointer;
            display: none;
            padding: 8px 5px;
        }
        .chat-send-btn.visible { 
            display: block; 
        }

        .chat-quick-actions {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 10px 0 5px;
            -ms-overflow-style: none;
            scrollbar-width: none;
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 100px; /* or whatever is appropriate */
            opacity: 1;
        }
        .chat-quick-actions.hidden {
            max-height: 0;
            opacity: 0;
            padding: 0;
            overflow: hidden;
        }
        .chat-quick-actions::-webkit-scrollbar {
            display: none;
        }
        .chat-action-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 8px; 
            cursor: pointer; 
            flex-shrink: 0;
        }
        .chat-action-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: transparent;
            display: flex; 
            justify-content: center; 
            align-items: center;
            font-size: calc(var(--ui-element-base-size) * 1.4);
            color: var(--primary-text);
            box-shadow: none;
        }
        .chat-action-item span { 
            font-size: calc(var(--global-font-size) * 1.1); 
        }
        
        .message-action-popover {
            position: absolute; background: rgba(248, 248, 248, 0.9); backdrop-filter: blur(20px);
            border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            z-index: 1005; display: none; flex-wrap: wrap; max-width: 220px;
        }
        .message-action-popover-item {
            padding: 8px 12px; font-size: calc(var(--global-font-size) * 1.2);
            cursor: pointer; color: #333; white-space: nowrap;
            flex-grow: 1; text-align: center;
            border-right: 1px solid rgba(60, 60, 67, 0.2);
            border-bottom: 1px solid rgba(60, 60, 67, 0.2);
        }
        .message-action-popover-item:last-child { border-right: none; }
        .message-action-popover-item:hover { background: rgba(0,0,0,0.05); }
        .message-action-popover-item.destructive { color: #FF3B30; }

        .multiselect-action-bar {
            position: absolute; bottom: 0; left: 0; right: 0; height: 50px;
            background: rgba(248, 248, 248, 0.9); backdrop-filter: blur(20px);
            border-top: 1px solid var(--theme-color-light);
            display: none; justify-content: space-around; align-items: center;
            z-index: 1003;
        }
        .multiselect-action-bar.visible { display: flex; }
        .multiselect-action-bar button { background: none; border: none; color: var(--primary-text); font-size: 24px; cursor: pointer; }

        #stickerModal .modal-body, #transferModal .modal-body { background: var(--theme-bg); padding: 20px; }
        .sticker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; }
        .sticker-item { width: 100%; aspect-ratio: 1; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; border-radius: 8px; transition: transform 0.2s; }
        .sticker-item:hover { transform: scale(1.1); }
        .transfer-form .glass-input { text-align: center; font-size: calc(var(--ui-element-base-size) * 2); padding: 15px; }
        .transfer-form .glass-input::placeholder { font-size: calc(var(--ui-element-base-size) * 1); }
        
        .transfer-bubble {
            background: #fff; border: 1px solid var(--theme-color-light);
            border-radius: 10px; padding: 12px; width: 200px; cursor: pointer;
            display: flex; flex-direction: column;
        }
        .transfer-header { display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--theme-color-light); padding-bottom: 8px; margin-bottom: 8px; }
        .transfer-icon { font-size: calc(var(--ui-element-base-size) * 1.25); color: var(--primary-text); }
        .transfer-title { font-weight: 500; color: var(--primary-text); font-size: calc(var(--global-font-size) * 1.3); }
        .transfer-amount { font-size: calc(var(--ui-element-base-size) * 1.75); font-weight: 700; color: #000; }
        .transfer-memo { font-size: calc(var(--global-font-size) * 1.1); color: #666; margin-top: 4px; }
        .transfer-status { font-size: calc(var(--global-font-size) * 1.1); color: #888; margin-top: 8px; }

        .file-bubble, .sim-video-bubble {
            background: #fff; border-radius: 10px; padding: 12px;
            width: 220px; cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .file-bubble { display: flex; align-items: center; gap: 12px; }
        .file-icon-lg { font-size: calc(var(--ui-element-base-size) * 2); color: var(--primary-text); width: 35px; text-align: center; }
        .file-info { flex: 1; overflow: hidden; text-align: left; }
        .file-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: calc(var(--global-font-size) * 1.3); }
        .file-size { font-size: calc(var(--global-font-size) * 1.1); color: #888; }
        
        .location-bubble { 
            display: flex; flex-direction: column; gap: 8px; 
            background: white; border-radius: 10px; padding: 12px;
            width: 220px; cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .location-text { text-align: left; }
        .location-title { font-weight: 600; font-size: calc(var(--global-font-size) * 1.4); }
        .location-summary { color: #666; font-size: calc(var(--global-font-size) * 1.2); }
        .location-map-placeholder { 
            width: 100%; height: 80px; border-radius: 8px; 
            background: #f0f0f0; 
            border: 1px solid #e5e5e5;
            display: flex; justify-content: center; align-items: center; 
            overflow: hidden; position: relative;
        }
        .location-map-placeholder::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
            background-size: 15px 15px;
            opacity: 0.5;
        }
        .location-map-placeholder i { 
            font-size: calc(var(--ui-element-base-size) * 1.75); color: var(--primary-text);
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1;
        }

        .sim-video-bubble { padding: 0; overflow: hidden; }
        .sim-video-player { width: 100%; height: 120px; background: #000; display: flex; justify-content: center; align-items: center; position: relative; }
        .sim-video-player i { font-size: calc(var(--ui-element-base-size) * 2.5); color: rgba(255,255,255,0.8); }
        .sim-video-duration { position: absolute; bottom: 5px; right: 8px; background: rgba(0,0,0,0.5); color: white; padding: 2px 5px; border-radius: 5px; font-size: calc(var(--global-font-size) * 1.1); }
        .sim-video-info { padding: 8px 12px; text-align: left; }
        .sim-video-desc { font-size: calc(var(--global-font-size) * 1.2); }
        .sim-video-size { font-size: calc(var(--global-font-size) * 1.1); color: #888; margin-top: 4px; }

        .image-placeholder-bubble {
            background: white; border-radius: 10px; padding: 12px;
            width: 150px; height: 150px; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center; color: #aaa;
            display: flex; justify-content: center; align-items: center;
            border: 1px solid #eee;
        }
        .image-placeholder-bubble .placeholder-text { display: block; font-size: calc(var(--global-font-size) * 1.2); }
        .image-placeholder-bubble .real-content { display: none; text-align: left; color: #333; white-space: pre-wrap; word-wrap: break-word; }
        .image-placeholder-bubble.revealed {
            width: auto; height: auto; max-width: 220px;
        }
        .image-placeholder-bubble.revealed .placeholder-text { display: none; }
        .image-placeholder-bubble.revealed .real-content { display: block; }

        .voice-bubble { 
            display: flex; align-items: center; gap: 10px; 
            width: auto; min-width: 80px; max-width: 200px; 
            position: relative;
        }
        .voice-icon { font-size: calc(var(--ui-element-base-size) * 1.25); color: var(--primary-text); }
        .voice-duration { font-size: calc(var(--global-font-size) * 1.2); }
        
        .voice-wave-container { flex: 1; height: 20px; display: flex; align-items: center; gap: 2px; overflow: hidden; }
        .voice-wave-bar { width: 3px; height: 20%; border-radius: 2px; transition: height 0.3s ease-in-out; }
        .message-wrapper.message-left .voice-wave-bar { background-color: #000; }
        .message-wrapper.message-right .voice-wave-bar { background-color: #000; }

        .voice-bubble.playing .voice-wave-bar { animation: wave 1.2s ease-in-out infinite; }
        .voice-bubble.playing .voice-wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .voice-bubble.playing .voice-wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .voice-bubble.playing .voice-wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .voice-bubble.playing .voice-wave-bar:nth-child(5) { animation-delay: 0.4s; }
        @keyframes wave { 0%, 100% { height: 20%; } 50% { height: 100%; } }
        
        .voice-text-content { 
            display: none; position: absolute; top: 100%; left: 0; 
            width: 220px; background: white; padding: 8px 10px; border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.15); z-index: 10; 
            font-size: calc(var(--global-font-size) * 1.2); color: #000; 
            text-align: left; margin-top: 5px; white-space: pre-wrap; word-wrap: break-word;
        }
        .voice-bubble.show-text .voice-text-content { display: block; }

        .tieba-share-bubble {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 10px;
            padding: 12px;
            width: 220px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: left;
        }
        .tieba-share-title {
            font-weight: 600;
            font-size: calc(var(--global-font-size) * 1.4);
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .tieba-share-content {
            font-size: calc(var(--global-font-size) * 1.2);
            color: #666;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 8px;
        }
        .tieba-share-footer {
            font-size: calc(var(--global-font-size) * 1.1);
            color: var(--secondary-text);
            border-top: 1px solid #f0f0f0;
            padding-top: 5px;
        }

        .music-share-bubble {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 10px;
            padding: 12px;
            width: 220px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .music-share-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .music-share-cover {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }
        .music-share-info {
            flex: 1;
            overflow: hidden;
            text-align: left;
        }
        .music-share-title {
            font-weight: 600;
            font-size: calc(var(--global-font-size) * 1.3);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .music-share-artist {
            font-size: calc(var(--global-font-size) * 1.1);
            color: var(--secondary-text);
        }
        .music-share-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: calc(var(--global-font-size) * 1.1);
            color: var(--secondary-text);
            border-top: 1px solid #f0f0f0;
            padding-top: 8px;
            margin-top: 4px;
        }
        .music-share-footer i {
            font-size: calc(var(--ui-element-base-size) * 1.2);
        }

        /* --- 朋友圈 (移入聊天App) --- */
        #chatPageFriends .app-content { padding: calc(44px + var(--global-top-nav-height)) 0 0; background: var(--theme-bg); }
        .friends-feed {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .friend-post {
            background: var(--glass-effect); backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.3); border-radius: 15px;
            padding: 15px;
            display: flex;
            gap: 15px;
        }
        .post-main { flex: 1; position: relative; }
        .post-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .post-author-name { font-size: calc(var(--ui-element-base-size) * 0.95); font-weight: 600; color: var(--primary-text); }
        .post-timestamp { font-size: calc(var(--global-font-size) * 1); color: #666; }
        .post-content-text { font-size: calc(var(--global-font-size) * 1.3); white-space: pre-wrap; word-wrap: break-word; margin-bottom: 10px; text-align: left; }
        .post-files-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 5px; margin-bottom: 10px; }
        .post-file-item { width: 100%; aspect-ratio: 1; background: #eee; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 24px; color: #aaa; background-size: cover; background-position: center; }
        .post-location { display: flex; align-items: center; gap: 5px; font-size: calc(var(--global-font-size) * 1.1); color: var(--primary-text); margin-bottom: 10px; }
        .post-footer { display: flex; justify-content: flex-end; align-items: center; gap: 15px; }
        .post-delete-btn { color: var(--primary-text); cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: calc(var(--ui-element-base-size) * 0.8); }
        .post-actions-btn { cursor: pointer; background: rgba(0, 0, 0, 0.05); border-radius: 5px; padding: 3px 6px; color: var(--primary-text); }
        
        .post-actions-popover {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            z-index: 10;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .post-actions-popover button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--primary-text);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: calc(var(--global-font-size) * 1.3);
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .post-actions-popover button:hover { background: rgba(0, 0, 0, 0.05); }
        .post-actions-popover button:not(:last-child) {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        .post-actions-popover i {
            font-size: calc(var(--ui-element-base-size) * 1);
            width: 20px;
            text-align: center;
            color: var(--primary-text);
        }

        .post-likes-comments { background: rgba(0, 0, 0, 0.03); border-radius: 8px; margin-top: 10px; padding: 8px; text-align: left; }
        .post-likes { display: flex; align-items: center; gap: 5px; padding-bottom: 5px; border-bottom: 1px solid rgba(0, 0, 0, 0.05); flex-wrap: wrap; font-size: calc(var(--global-font-size) * 1.2); }
        .post-likes i { color: var(--primary-text); }
        .post-comments-list { padding-top: 5px; display: flex; flex-direction: column; gap: 5px; }
        .post-comment-item { font-size: calc(var(--global-font-size) * 1.2); cursor: pointer; }
        .post-comment-item .comment-author { font-weight: 600; color: var(--primary-text); }
        .post-comment-item .reply-to { color: #555; }
        .post-avatar-wrapper { flex-shrink: 0; }
        .post-avatar { width: 45px; height: 45px; border-radius: 12px; background-size: cover; background-position: center; }
        #postEditorContainer .app-content { padding: calc(54px + var(--global-top-nav-height)) 15px 20px; gap: 15px; background: var(--theme-bg); }
        #post-files-preview { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .file-preview-item { position: relative; width: 100%; aspect-ratio: 1; }
        .file-preview-item img, .file-preview-item video { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        .file-preview-item .file-icon { width: 100%; height: 100%; background: #eee; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 24px; color: #aaa; }
        .remove-file-btn { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 12px; }

        /* --- 商城 App --- */
        #shoppingContainer { padding-bottom: 40px; }
        .shopping-page { display: none; width: 100%; height: 100%; flex-direction: column; }
        .shopping-page.active { display: flex; }
        .shopping-bottom-nav {
            position: absolute; bottom: 0; left: 0; right: 0; height: 40px;
            background: rgba(248, 248, 248, 0.7); backdrop-filter: blur(20px);
            border-top: 1px solid var(--theme-color-light);
            display: flex; z-index: 1010;
        }
        .shopping-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; color: var(--secondary-text); cursor: pointer; }
        .shopping-nav-item.active { color: var(--primary-text); }
        .shopping-nav-item i { font-size: calc(var(--ui-element-base-size) * 1.25); color: var(--primary-text); }
        .shopping-nav-item span { font-size: calc(var(--global-font-size) * 1); }
        
        #shoppingPageHome .app-content { padding: calc(44px + var(--global-top-nav-height)) 15px 20px; background: var(--theme-bg); gap: 10px; }
        .shopping-home-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .shopping-categories { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; flex-grow: 1; }
        .shopping-category-btn { padding: 5px 12px; border: 1px solid var(--theme-color-light); background: white; border-radius: 15px; white-space: nowrap; cursor: pointer; font-size: calc(var(--global-font-size) * 1.2); }
        .shopping-category-btn.active { background: var(--primary-text); color: white; border-color: var(--primary-text); }
        .shopping-products-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; }
        .shopping-products-list { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .product-card-grid { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; }
        .product-card-grid img { width: 100%; height: 100px; object-fit: cover; }
        .product-card-grid-info { padding: 8px; text-align: left; }
        .product-name { font-size: calc(var(--global-font-size) * 1.3); font-weight: 500; }
        .product-price { font-size: calc(var(--global-font-size) * 1.4); color: #FF3B30; font-weight: 600; margin-top: 5px; }
        .product-card-list { display: flex; gap: 10px; background: white; border-radius: 12px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; }
        .product-card-list img { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; }
        .product-card-list-info { flex: 1; text-align: left; }

        #shoppingPageCart .app-content { padding: calc(44px + var(--global-top-nav-height)) 15px 60px; background: var(--theme-bg); gap: 10px; }
        .cart-item { display: flex; gap: 10px; background: white; border-radius: 12px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .cart-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
        .cart-item-info { flex: 1; text-align: left; }
        .cart-item-name { font-weight: 500; font-size: calc(var(--global-font-size) * 1.3); }
        .cart-item-price { color: #FF3B30; font-weight: 600; font-size: calc(var(--global-font-size) * 1.3); }
        .cart-item-quantity { display: flex; align-items: center; gap: 8px; margin-top: 5px; }
        .cart-item-quantity button { width: 20px; height: 20px; border: 1px solid #ccc; border-radius: 50%; background: white; }
        .cart-checkout-bar { position: absolute; bottom: 40px; left: 0; right: 0; height: 50px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        .cart-total-price { font-weight: 600; font-size: calc(var(--global-font-size) * 1.4); }
        .cart-checkout-btn-group { display: flex; gap: 10px; }
        .cart-checkout-btn { padding: 8px 15px; border-radius: 15px; border: none; color: white; font-weight: 500; cursor: pointer; font-size: calc(var(--global-font-size) * 1.3); }
        .checkout-for-self { background: #34C759; }
        .checkout-for-char { background: var(--ios-blue); }
        .checkout-ask-char { background: #FF9500; }

        #shoppingPageMe .app-content { padding: calc(54px + var(--global-top-nav-height)) 15px 20px; background: var(--theme-bg); gap: 15px; }
        #shopping-me-profile-header {
            display: flex; align-items: center; width: 100%;
            padding: 20px; cursor: pointer;
            background: var(--glass-effect);
            border-radius: 15px;
        }
        .shopping-me-stats { display: flex; justify-content: space-around; width: 100%; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .shopping-me-stat-item { text-align: center; }
        .stat-value { font-size: calc(var(--ui-element-base-size) * 1.6); font-weight: 600; }
        .stat-label { font-size: calc(var(--global-font-size) * 1.2); color: #888; }

        .receipt-modal-body { background: #f7f7f7; padding: 20px; font-family: 'Courier New', Courier, monospace; color: #333; }
        .receipt-header { text-align: center; margin-bottom: 15px; }
        .receipt-title { font-size: calc(var(--ui-element-base-size) * 1.25); font-weight: bold; }
        .receipt-store { font-size: calc(var(--global-font-size) * 1.2); }
        .receipt-divider { border-top: 1px dashed #999; margin: 10px 0; }
        .receipt-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: calc(var(--global-font-size) * 1.2); }
        .receipt-item-name { max-width: 60%; }
        .receipt-total { font-weight: bold; font-size: calc(var(--global-font-size) * 1.4); }

        /* --- 音乐 App (优化后) --- */
        #musicContainer { padding-bottom: 50px; }
        .music-page { display: none; width: 100%; height: 100%; flex-direction: column; }
        .music-page.active { display: flex; }
        .music-bottom-nav {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            height: 40px; width: 80%;
            background: rgba(248, 248, 248, 0.8); backdrop-filter: blur(20px);
            border: 1px solid var(--theme-color-light);
            border-radius: 20px;
            display: flex; z-index: 1010;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .music-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; color: var(--secondary-text); cursor: pointer; }
        .music-nav-item.active { color: var(--primary-text); }
        .music-nav-item i { font-size: calc(var(--ui-element-base-size) * 1.4); color: var(--primary-text); }
        .music-nav-item span { font-size: calc(var(--global-font-size) * 1); }
        
        #musicPageHome .app-content { padding: calc(54px + var(--global-top-nav-height)) 15px 20px; background: var(--theme-bg); gap: 15px; }
        #musicPlaylistsContainer .app-content, #favoriteSongsContainer .app-content {
            padding: calc(54px + var(--global-top-nav-height)) 15px 20px; background: var(--theme-bg);
        }
        #musicPageMe .app-content {
            padding: calc(54px + var(--global-top-nav-height)) 15px 20px; background: var(--theme-bg); gap: 15px;
        }
        #localMusicList, #musicSearchResults {
            width: 100%; display: flex; flex-direction: column; gap: 10px; margin-top: 10px;
        }
        .music-list-item {
            display: flex; align-items: center; padding: 10px;
            background: rgba(255,255,255,0.4); border-radius: 12px;
            cursor: pointer;
        }
        .music-list-item:hover { background: rgba(255,255,255,0.6); }
        .music-list-item-cover { width: 40px; height: 40px; border-radius: 8px; background-size: cover; background-position: center; margin-right: 12px; }
        .music-list-item-info { flex: 1; text-align: left; }
        .music-list-item-title { font-weight: 500; font-size: calc(var(--global-font-size) * 1.4); }
        .music-list-item-artist { color: var(--secondary-text); font-size: calc(var(--global-font-size) * 1.2); }
        .music-list-item-actions { display: flex; align-items: center; gap: 10px; }
        .music-list-item-actions i { font-size: calc(var(--ui-element-base-size) * 1.1); color: var(--primary-text); cursor: pointer; }
        .music-list-item-actions .fa-heart.favorited { color: #FF3B30; }

        /* 音乐播放器页面 */
        #musicPlayerContainer .app-content {
            background: var(--glass-effect);
            backdrop-filter: blur(30px);
            padding: calc(54px + var(--global-top-nav-height)) 20px 20px;
            justify-content: space-around;
        }
        #playerAlbumArt {
            width: 200px; height: 200px;
                        border-radius: 50%;
            background-size: cover;
            background-position: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        #playerAlbumArt.playing {
            animation: player-rotate 20s linear infinite;
        }
        @keyframes player-rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #playerSongInfo { text-align: center; margin-bottom: 20px; }
        #playerSongTitle { font-size: calc(var(--ui-element-base-size) * 1.4); font-weight: 600; }
        #playerSongArtist { font-size: calc(var(--ui-element-base-size) * 1); color: var(--secondary-text); margin-top: 5px; }
        #playerProgressContainer { width: 100%; margin-bottom: 15px; }
        #playerProgressBar { width: 100%; }
        #playerTimeContainer { display: flex; justify-content: space-between; font-size: calc(var(--global-font-size) * 1.2); color: var(--secondary-text); }
        #playerControls { display: flex; justify-content: space-around; align-items: center; width: 100%; margin-bottom: 20px; }
        #playerControls .control-btn { color: var(--primary-text); font-size: calc(var(--ui-element-base-size) * 1.5); cursor: pointer; }
        #playerControls .play-pause-btn { font-size: calc(var(--ui-element-base-size) * 2.5); }
        #playerAdvancedControls { width: 100%; display: flex; flex-direction: column; gap: 15px; }
        .player-slider-group { display: flex; flex-direction: column; gap: 5px; }
        .player-slider-group label { text-align: left; font-size: calc(var(--global-font-size) * 1.2); }

        /* ★★★ 更新: 音乐迷你播放器 (可拖动) ★★★ */
        #music-mini-player {
            position: absolute;
            bottom: 60px;
            left: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            padding: 10px;
            display: none;
            flex-direction: column;
            z-index: 1050; /* 提高层级 */
            transition: opacity 0.3s ease-in-out;
            touch-action: none; /* 禁用默认触摸行为以进行拖动 */
        }
        #music-mini-player.visible {
            display: flex;
        }
        .mini-player-header {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: move;
        }
        .mini-player-cover {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }
        .mini-player-info {
            flex: 1;
            overflow: hidden;
        }
        .mini-player-title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .mini-player-artist {
            font-size: calc(var(--global-font-size) * 1.1);
            color: var(--secondary-text);
        }
        .mini-player-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .mini-player-controls i {
            font-size: calc(var(--ui-element-base-size) * 1.2);
            cursor: pointer;
            color: var(--primary-text); /* ★★★ 更新: 确保图标为黑色 ★★★ */
        }
        .mini-player-lyrics {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--theme-color-light);
            font-size: calc(var(--global-font-size) * 1.2);
            text-align: center;
            max-height: 4.5em;
            overflow-y: auto;
            color: var(--primary-text);
        }
        .mini-player-toggle-lyrics {
            position: absolute;
            top: -10px;
            right: 10px;
            background: white;
            border: 1px solid #eee;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- 贴吧 App --- */
        #tiebaContainer { padding-bottom: 40px; }
        .tieba-page { display: none; width: 100%; height: 100%; flex-direction: column; }
        .tieba-page.active { display: flex; }
        .tieba-bottom-nav {
            position: absolute; bottom: 0; left: 0; right: 0; height: 40px;
            background: rgba(248, 248, 248, 0.7); backdrop-filter: blur(20px);
            border-top: 1px solid var(--theme-color-light);
            display: flex; z-index: 1010;
        }
        .tieba-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; color: var(--secondary-text); cursor: pointer; }
        .tieba-nav-item.active { color: var(--primary-text); }
        .tieba-nav-item i { font-size: calc(var(--ui-element-base-size) * 1.25); color: var(--primary-text); }
        .tieba-nav-item span { font-size: calc(var(--global-font-size) * 1); }
        .tieba-nav-item.create-post-btn i { font-size: calc(var(--ui-element-base-size) * 2.2); transform: translateY(-3px); color: var(--ios-blue); }
        
        #tiebaPageHome .app-content, #tiebaPageFollowing .app-content { padding: calc(44px + var(--global-top-nav-height)) 0 20px; background: var(--theme-bg); gap: 15px; }
        
        .tieba-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px 15px;
            border-bottom: 1px solid var(--theme-color-light);
            flex-shrink: 0;
        }
        .tieba-category-btn {
            padding: 5px 8px; 
            border: 1px solid var(--theme-color-light); 
            background: white;
            border-radius: 8px;
            white-space: nowrap; 
            cursor: pointer; 
            color: var(--primary-text);
            font-size: calc(var(--global-font-size) * 1.1);
            text-align: center;
        }
        .tieba-category-btn.active { background: var(--primary-text); color: white; }

        #tiebaFeedHome, #tiebaFeedFollowing {
            width: 100%; padding: 0 15px; display: flex; flex-direction: column; gap: 15px;
        }

        .tieba-post-card {
            width: 100%; background: white; border-radius: 12px; padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: left; cursor: pointer;
            display: flex; gap: 12px;
        }
        .tieba-post-card-avatar { width: 40px; height: 40px; border-radius: 50%; background-size: cover; background-position: center; flex-shrink: 0; }
        .tieba-post-card-main { flex: 1; overflow: hidden; }
        .tieba-post-author-info { display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 8px; }
        .tieba-post-author-name { font-weight: 600; color: var(--primary-text); font-size: calc(var(--global-font-size) * 1.3); }
        .tieba-post-author-username { font-size: calc(var(--global-font-size) * 1.1); color: var(--secondary-text); }
        .tieba-post-author-signature { font-size: calc(var(--global-font-size) * 1.1); color: #aaa; margin-top: 3px; font-style: italic; }
        
        .tieba-post-title { font-size: calc(var(--ui-element-base-size) * 1); font-weight: 600; margin-bottom: 10px; }
        .tieba-post-content-preview {
            font-size: calc(var(--global-font-size) * 1.3); color: #333;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            overflow: hidden; text-overflow: ellipsis; margin-bottom: 15px;
        }
        .tieba-post-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .tieba-post-tag { background: rgba(0, 0, 0, 0.05); color: var(--primary-text); padding: 2px 6px; border-radius: 5px; font-size: calc(var(--global-font-size) * 1.0); }
        .tieba-post-location { color: var(--ios-blue); font-size: calc(var(--global-font-size) * 1.1); margin-bottom: 10px; }
        .tieba-post-location i { margin-right: 4px; color: var(--ios-blue); }

        .tieba-post-footer { display: flex; justify-content: space-between; align-items: center; color: var(--secondary-text); font-size: calc(var(--global-font-size) * 1.2); }
        .tieba-post-actions { display: flex; gap: 15px; }
        .tieba-post-actions div { cursor: pointer; color: var(--secondary-text); }
        .tieba-post-actions i { margin-right: 4px; color: var(--secondary-text); }
        .tieba-post-actions .liked i { color: var(--ios-blue); }

        #tiebaPageMe .app-content { padding: calc(54px + var(--global-top-nav-height)) 15px 20px; background: var(--theme-bg); }
        .tieba-me-profile-header {
            display: flex; align-items: center; width: 100%;
            padding: 20px; cursor: pointer;
            background: var(--glass-effect);
            border-radius: 15px;
            margin-bottom: 15px;
        }
        .tieba-me-avatar { width: 60px; height: 60px; border-radius: 50%; background-size: cover; background-position: center; margin-right: 15px; }
        .tieba-me-info { flex: 1; text-align: left; }
        .tieba-me-nickname { font-size: calc(var(--ui-element-base-size) * 1.25); font-weight: 600; }
        .tieba-me-username { font-size: calc(var(--global-font-size) * 1.2); color: var(--secondary-text); margin-top: 5px; }
        .tieba-me-stats {
            display: flex; justify-content: space-around; width: 100%;
            background: var(--glass-effect); padding: 15px; border-radius: 15px;
        }
        .tieba-me-stat-item { text-align: center; }
        .tieba-me-stat-value { font-size: calc(var(--ui-element-base-size) * 1.4); font-weight: 600; }
        .tieba-me-stat-label { font-size: calc(var(--global-font-size) * 1.1); color: #888; }

        #tiebaPostEditorContainer .app-content, #tiebaProfileEditorContainer .app-content { padding: calc(54px + var(--global-top-nav-height)) 15px 20px; gap: 15px; background: var(--theme-bg); }
        #tieba-post-files-preview { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }

        #tiebaPostDetailContainer .app-content { padding: calc(44px + var(--global-top-nav-height)) 15px 20px; background: var(--theme-bg); text-align: left; }
        
        .tieba-detail-post-header { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; 
            margin-bottom: 15px; 
            text-align: left;
        }
        .tieba-detail-author-info { flex: 1; }
        .tieba-detail-author-name { font-weight: 600; font-size: calc(var(--ui-element-base-size) * 0.95); }
        .tieba-detail-author-username { color: var(--secondary-text); font-size: calc(var(--global-font-size) * 1.2); }
        .tieba-detail-author-signature { font-size: calc(var(--global-font-size) * 1.1); color: #aaa; margin-top: 3px; font-style: italic; }
        .tieba-detail-title { font-size: calc(var(--ui-element-base-size) * 1.25); font-weight: 700; margin-bottom: 10px; text-align: left; }
        .tieba-detail-content { font-size: calc(var(--global-font-size) * 1.4); white-space: pre-wrap; word-wrap: break-word; margin-bottom: 20px; }
        
        .tieba-detail-actions { 
            display: flex; 
            justify-content: flex-start; 
            gap: 20px;
            padding: 10px 0; 
            border-top: 1px solid var(--theme-color-light); 
            border-bottom: 1px solid var(--theme-color-light); 
            margin-bottom: 20px; 
        }
        .tieba-detail-actions button { background: none; border: none; color: var(--primary-text); font-size: calc(var(--ui-element-base-size) * 1.25); cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .tieba-detail-actions button.liked { color: #FF3B30; }
        
        .tieba-detail-comments-section { width: 100%; }
        .tieba-comment-item { display: flex; gap: 10px; margin-bottom: 15px; cursor: pointer; }
        .tieba-comment-avatar { width: 35px; height: 35px; border-radius: 50%; background-size: cover; background-position: center; flex-shrink: 0; }
        .tieba-comment-main { flex: 1; }
        .tieba-comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .tieba-comment-author-name { font-weight: 600; font-size: calc(var(--global-font-size) * 1.3); }
        .tieba-comment-floor { font-size: calc(var(--global-font-size) * 1.1); color: var(--secondary-text); }
        .tieba-comment-content { font-size: calc(var(--global-font-size) * 1.3); }
        .tieba-comment-reply-to {
            background: rgba(0,0,0,0.05); padding: 5px 8px; border-radius: 6px;
            margin-bottom: 5px; font-size: calc(var(--global-font-size) * 1.1);
            border-left: 2px solid #ccc;
        }
        .tieba-comment-reply-to .author { font-weight: 600; }

        #tiebaProfileDetailContainer .app-content { padding: calc(44px + var(--global-top-nav-height)) 0 20px; background: var(--theme-bg); }
        .tieba-profile-header {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .tieba-profile-avatar { width: 70px; height: 70px; border-radius: 50%; background-size: cover; background-position: center; }
        .tieba-profile-nickname { font-size: calc(var(--ui-element-base-size) * 1.4); font-weight: 700; }
        .tieba-profile-username { font-size: calc(var(--global-font-size) * 1.3); color: var(--secondary-text); }
        .tieba-profile-signature { font-size: calc(var(--global-font-size) * 1.2); margin-top: 5px; }
        .tieba-profile-stats {
            display: flex; justify-content: space-around; width: 100%;
            padding: 15px 0; border-top: 1px solid var(--theme-color-light); border-bottom: 1px solid var(--theme-color-light);
        }
        .tieba-profile-stat-item { text-align: center; }
        .tieba-profile-stat-value { font-size: calc(var(--ui-element-base-size) * 1.25); font-weight: 600; }
        .tieba-profile-stat-label { font-size: calc(var(--global-font-size) * 1.1); color: #888; }
        .tieba-profile-tabs { display: flex; border-bottom: 1px solid var(--theme-color-light); }
        .tieba-profile-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: var(--secondary-text); font-size: calc(var(--global-font-size) * 1.3); }
        .tieba-profile-tab.active { color: var(--primary-text); border-bottom: 2px solid var(--primary-text); }
        .tieba-profile-content { padding: 15px; }
        .tieba-profile-post-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .tieba-profile-post-item { width: 100%; aspect-ratio: 1; background: #eee; border-radius: 8px; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; }
        .tieba-profile-post-item img { width: 100%; height: 100%; object-fit: cover; }
        .tieba-profile-post-item .post-title-overlay {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.5); color: white;
            padding: 5px; font-size: calc(var(--global-font-size) * 1);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* --- iOS 风格加载动画 --- */
        .ios-spinner-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(2px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1050;
        }
        .ios-spinner-wrapper {
            background: rgba(248, 248, 248, 0.85);
            backdrop-filter: blur(20px);
            padding: 20px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .ios-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0, 0, 0, 0.2);
            border-top-color: #000;
            border-radius: 50%;
            animation: ios-spin 1s linear infinite;
        }
        .ios-spinner-close {
            color: var(--primary-text);
            font-size: 20px;
            cursor: pointer;
            position: absolute;
            top: 5px;
            right: 10px;
        }
        @keyframes ios-spin {
            to { transform: rotate(360deg); }
        }

        /* --- iOS 风格弹窗 --- */
        .ios-alert-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.4);
            z-index: 9990; display: flex; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .ios-alert-overlay.show { opacity: 1; pointer-events: auto; }
        .ios-alert-content {
            width: 270px; background: rgba(248, 248, 248, 0.85);
            backdrop-filter: blur(20px); border-radius: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            transform: scale(1.1); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .ios-alert-overlay.show .ios-alert-content { transform: scale(1); }
        .ios-alert-title { padding: 20px 20px 5px; font-size: 17px; font-weight: 600; color: #000; }
        .ios-alert-message { padding: 0 20px 20px; font-size: 13px; color: #000; white-space: pre-wrap; }
        .ios-alert-actions { border-top: 1px solid rgba(60, 60, 67, 0.29); display: flex; flex-direction: column; }
        .ios-alert-button {
            width: 100%; padding: 12px; font-size: 17px; color: var(--ios-blue);
            cursor: pointer; background: transparent; border: none;
        }
        .ios-alert-button:not(:first-child) { border-top: 1px solid rgba(60, 60, 67, 0.29); }
        .ios-alert-button.bold { font-weight: 600; }
        .ios-alert-button.destructive { color: #FF3B30; }

        /* --- Cropper Modal --- */
        #cropperModal .modal-content { max-height: 90%; }
        #cropperImageContainer { width: 100%; height: 250px; background: #ddd; }
        .cropper-actions { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .cropper-ratios { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
        .cropper-ratios button, .cropper-confirm-btn {
            padding: 8px 12px; border-radius: 8px; border: 1px solid var(--primary-text);
            background: transparent; color: var(--primary-text); cursor: pointer;
        }
        .cropper-ratios button.active { background: var(--primary-text); color: white; }
        .cropper-confirm-btn { background: var(--primary-text); color: white; width: 100%; }

        /* --- 其他 --- */
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 5px; background: rgba(0, 0, 0, 0.1); border-radius: 5px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: white; border: 2px solid var(--primary-text); border-radius: 50%; cursor: pointer; box-shadow: 0 0 5px rgba(0, 0, 0, 0.3); }
        .modal-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.4);
            z-index: 9990; display: flex; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-content {
            width: 90%; max-height: 80%; background: rgba(255,255,255,0.8);
            backdrop-filter: blur(20px); border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            transform: scale(0.9); transition: transform 0.3s;
        }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-title { padding: 15px; font-size: calc(var(--ui-element-base-size) * 1); font-weight: 600; color: var(--primary-text); text-align: center; border-bottom: 1px solid rgba(0, 0, 0, 0.1); }
        .modal-body { flex: 1; overflow-y: auto; padding: 10px; }
        .modal-body .list-item { padding: 12px 15px; border-bottom: 1px solid rgba(0, 0, 0, 0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .modal-body .list-item:hover { background: rgba(0,0,0,0.05); }
        .checkbox-list-item { display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body id="phone-body">
    <div class="phone-container">
        <div class="screen">
            <!-- 系统组件 -->
            <div id="ins-dynamic-island" onclick="toggleDynamicIsland()">
                <div class="island-content island-placeholder"></div>
                <div class="island-content island-default">
                    <div class="album-cover" id="island-album-cover-small"></div>
                    <div class="wave-container-small" id="island-wave-small">
                        <div class="wave-bar-small"></div><div class="wave-bar-small"></div><div class="wave-bar-small"></div><div class="wave-bar-small"></div>
                    </div>
                </div>
                <div class="island-content music-player" onclick="event.stopPropagation()">
                    <div class="song-info">
                        <div class="song-title" id="island-song-title">歌曲名称</div>
                        <div class="artist" id="island-artist">艺人</div>
                    </div>
                    <div class="progress-container">
                        <div class="time-display" id="island-current-time">0:00</div>
                        <div class="progress-bar">
                            <div class="progress" id="island-progress"></div>
                        </div>
                        <div class="time-display" id="island-duration">0:00</div>
                    </div>
                    <div class="advanced-controls">
                        <div class="slider-group">
                            <i class="fas fa-tachometer-alt"></i>
                            <input type="range" id="island-speed-slider" min="0.7" max="2" step="0.1" value="1">
                            <span id="island-speed-value" style="min-width: 25px; text-align: right;">1.0x</span>
                        </div>
                        <div class="slider-group">
                            <i class="fas fa-music"></i>
                            <input type="range" id="island-pitch-slider" min="0.7" max="2" step="0.1" value="1">
                            <span id="island-pitch-value" style="min-width: 25px; text-align: right;">1.0x</span>
                        </div>
                    </div>
                    <div class="music-controls">
                        <div class="control-btn" onclick="playPrevSong()"><i class="fas fa-backward-step"></i></div>
                        <div class="control-btn play-btn" onclick="togglePlayPause()"><i id="island-play-icon" class="fas fa-play"></i></div>
                        <div class="control-btn" onclick="playNextSong()"><i class="fas fa-forward-step"></i></div>
                        <div id="island-mode-btn" class="control-btn" onclick="changePlayMode()"><i class="fas fa-retweet"></i></div>
                    </div>
                </div>
            </div>
            <div class="status-bar">
                <div class="status-bar-left"><div class="time" id="statusTime">12:00</div></div>
                <div class="status-bar-right">
                    <div class="signal-bars"><div class="signal-bar"></div><div class="signal-bar"></div><div class="signal-bar"></div><div class="signal-bar"></div></div>
                    <div class="network-type">5G</div>
                    <div class="battery-container">
                        <div class="battery-icon">
                            <div class="battery-level" id="batteryLevel"></div>
                            <div class="battery-text" id="batteryText">85</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="home-indicator" onclick="returnToHome()"></div>
            <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
                <div class="modal-content" id="modalContent" onclick="event.stopPropagation()"></div>
            </div>
            <div class="ios-alert-overlay" id="iosAlertOverlay">
                <div class="ios-alert-content">
                    <div class="ios-alert-title" id="iosAlertTitle"></div>
                    <div class="ios-alert-message" id="iosAlertMessage"></div>
                    <div class="ios-alert-actions" id="iosAlertActions"></div>
                </div>
            </div>
            <div class="modal-overlay" id="cropperModal">
                <div class="modal-content" onclick="event.stopPropagation()">
                    <div class="modal-title" data-lang="cropper_title">裁剪图片</div>
                    <div class="modal-body" style="padding:0;">
                        <div id="cropperImageContainer"><img id="cropperImage" style="max-width: 100%;"></div>
                    </div>
                    <div class="cropper-actions">
                        <div class="cropper-ratios">
                            <button onclick="setCropRatio(1/1)">1:1</button>
                            <button onclick="setCropRatio(NaN)" data-lang="cropper_ratio_free">自由</button>
                        </div>
                        <button class="cropper-confirm-btn" onclick="confirmCrop()" data-lang="cropper_confirm">确认裁剪</button>
                    </div>
                </div>
            </div>
            <div class="message-action-popover" id="messageActionPopover"></div>

            <!-- 主屏幕 -->
            <div class="home-screen" id="homeScreen">
                <div class="home-screen-content">
                    <div class="home-time" id="homeTime">12:00</div>
                    <div class="home-date" id="homeDate">2023年1月1日</div>
                    
                    <div class="card-widget" id="cardWidget" onclick="openCardWidgetEditor()">
                        <div class="card-widget-bg" id="cardWidgetBg"></div>
                        <div class="card-widget-content">
                            <div class="card-widget-header">
                                <div class="card-widget-avatar" id="cardWidgetAvatar"></div>
                                <div class="card-widget-info">
                                    <div class="card-widget-nickname" id="cardWidgetNickname"></div>
                                    <div class="card-widget-username" id="cardWidgetUsername"></div>
                                </div>
                            </div>
                            <div class="card-widget-body">
                                <div class="card-widget-signature" id="cardWidgetSignature"></div>
                                <div class="card-widget-address" id="cardWidgetAddress"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="widget-row">
                        <div class="widget" id="music-widget">
                            <div id="music-widget-art"></div>
                            <div id="music-widget-info">
                                <div id="music-widget-title" data-lang-placeholder="music_widget_no_song">暂无歌曲</div>
                                <div id="music-widget-artist">...</div>
                            </div>
                            <div id="music-widget-controls">
                                <i class="fas fa-backward-step" onclick="playPrevSong()"></i>
                                <i id="music-widget-play-btn" class="fas fa-play" onclick="togglePlayPause()"></i>
                                <i class="fas fa-forward-step" onclick="playNextSong()"></i>
                            </div>
                        </div>
                        <div class="widget" id="copywriting-widget">
                            <div class="widget-header">
                                <div id="widget-avatar" onclick="triggerAvatarUpload('widget')"></div>
                                <button id="copywriting-style-btn" onclick="toggleCopywritingWidgetStyle()"><i class="fas fa-adjust"></i></button>
                            </div>
                            <div id="copywriting-line-1" class="copywriting-line" contenteditable="true" onblur="saveCopywriting()"></div>
                            <div id="copywriting-line-2" class="copywriting-line" contenteditable="true" onblur="saveCopywriting()"></div>
                            <div id="copywriting-line-3" class="copywriting-line" contenteditable="true" onblur="saveCopywriting()"></div>
                            <input type="file" id="widget-avatar-upload" accept="image/*" style="display:none;" onchange="handleWidgetAvatarUpload(event)">
                        </div>
                    </div>
                    <div class="app-grid" id="appGrid"></div>
                </div>
            </div>
            
            <!-- 应用容器 -->

            <!-- 聊天 App -->
            <div class="app-container" id="chatContainer">
                <div class="app-navigation-bar" id="chatNavBar">
                    <div class="app-back-btn" onclick="closeApp('chat')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" id="chatTitle" data-lang="chat_title_messages">消息</div>
                    <div class="app-action-btn-group" id="chatActionBtnGroup"></div>
                </div>
                
                <div class="chat-page active" id="chatPageMessages">
                    <div class="app-content" id="messagesListContent"></div>
                </div>

                <div class="chat-page" id="chatPageContacts">
                    <div class="app-content" id="contactsListContent"></div>
                </div>

                <div class="chat-page" id="chatPageFriends">
                    <div class="app-content" style="padding: calc(44px + var(--global-top-nav-height)) 0 0;">
                        <div class="friends-feed" id="friendsFeed"></div>
                    </div>
                </div>

                <div class="chat-page" id="chatPageMe">
                    <div class="app-content">
                        <div class="me-profile-header" onclick="openUserEditor(appData.chat.activeProfileId)">
                            <div class="me-avatar-wrapper">
                                <div class="me-avatar" id="meAvatar"></div>
                                <div class="me-avatar-frame" id="meAvatarFrame"></div>
                            </div>
                            <div class="me-info">
                                <div class="me-nickname" id="meNickname" onclick="event.stopPropagation(); editNickname();" data-lang-placeholder="chat_me_set_nickname">设置昵称</div>
                                <div class="me-signature" id="meSignature" onclick="event.stopPropagation(); editSignature();" data-lang-placeholder="chat_me_set_signature">设置个性签名</div>
                            </div>
                            <i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                        <div class="glass-list">
                            <div class="glass-list-item" onclick="openSubPage('myProfiles')">
                                <i class="fas fa-id-card item-icon"></i><span class="item-text" data-lang="chat_me_my_profiles">我的自设</span><i class="fas fa-chevron-right item-arrow"></i>
                            </div>
                            <div class="glass-list-item" onclick="openSubPage('bankCard')">
                                <i class="fas fa-credit-card item-icon"></i><span class="item-text" data-lang="chat_me_bank_card">银行卡</span><i class="fas fa-chevron-right item-arrow"></i>
                            </div>
                            <div class="glass-list-item" onclick="openSubPage('wallet')">
                                <i class="fas fa-wallet item-icon"></i><span class="item-text" data-lang="chat_me_wallet">钱包</span><i class="fas fa-chevron-right item-arrow"></i>
                            </div>
                            <div class="glass-list-item" onclick="showTopUpModal()">
                                <i class="fas fa-money-bill-wave item-icon"></i><span class="item-text" data-lang="chat_me_top_up">充值</span><i class="fas fa-chevron-right item-arrow"></i>
                            </div>
                            <div class="glass-list-item" onclick="showWithdrawModal()">
                                <i class="fas fa-hand-holding-usd item-icon"></i><span class="item-text" data-lang="chat_me_withdraw">提现</span><i class="fas fa-chevron-right item-arrow"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chat-bottom-nav">
                    <div class="chat-nav-item active" onclick="switchChatTab('messages')">
                        <i class="fas fa-comment-dots"></i><span data-lang="chat_nav_messages">消息</span>
                    </div>
                    <div class="chat-nav-item" onclick="switchChatTab('contacts')">
                        <i class="fas fa-address-book"></i><span data-lang="chat_nav_contacts">联系人</span>
                    </div>
                    <div class="chat-nav-item" onclick="switchChatTab('friends')">
                        <i class="fas fa-users"></i><span data-lang="chat_nav_friends">朋友圈</span>
                    </div>
                    <div class="chat-nav-item" onclick="switchChatTab('me')">
                        <i class="fas fa-user"></i><span data-lang="chat_nav_me">我</span>
                    </div>
                </div>
            </div>

            <!-- 聊天 App 子页面 -->
            <div class="app-container" id="myProfilesContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('myProfiles')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="my_profiles_title">我的自设</div>
                    <div class="app-action-btn" onclick="openUserEditor(null)"><i class="fas fa-plus"></i></div>
                </div>
                <div class="app-content" id="myProfilesListContent"></div>
            </div>

            <div class="app-container" id="userEditorContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('userEditor')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" id="userEditorTitle" data-lang-placeholder-create="user_editor_title_create" data-lang-placeholder-edit="user_editor_title_edit">创建自设</div>
                    <div class="app-action-btn" onclick="saveUser()"><i class="fas fa-save"></i></div>
                </div>
                <div class="app-content" style="background: var(--theme-bg);">
                    <input type="file" id="user-avatar-upload" accept="image/*" style="display:none;">
                    <div class="editor-avatar-section">
                        <div class="editor-avatar-preview" id="userAvatarPreview" onclick="triggerAvatarUpload('user')"></div>
                        <label class="glass-button" style="width:auto; padding: 5px 15px;" onclick="triggerAvatarUpload('user')" data-lang="editor_change_avatar">更换头像</label>
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="user_editor_name">user名字</label>
                        <input type="text" id="user-name" class="glass-input" maxlength="30">
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="editor_gender">user性别</label>
                        <div class="gender-options" id="user-gender-options">
                            <label><input type="radio" name="user-gender" value="male"> <span data-lang="gender_male">男</span></label>
                            <label><input type="radio" name="user-gender" value="female"> <span data-lang="gender_female">女</span></label>
                            <label><input type="radio" name="user-gender" value="other"> <span data-lang="gender_other">其他</span></label>
                        </div>
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="user_editor_occupation">user的身份/职业</label>
                        <input type="text" id="user-occupation" class="glass-input" maxlength="30">
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="user_editor_wxid">user的wxid</label>
                        <input type="text" id="user-wxid" class="glass-input" maxlength="20">
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="user_editor_qid">user的QID</label>
                        <input type="text" id="user-qid" class="glass-input" maxlength="12">
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="user_editor_qq">user的QQ号</label>
                        <input type="text" id="user-qq" class="glass-input" maxlength="10">
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="user_editor_persona">user的设定</label>
                        <textarea id="user-persona" class="glass-textarea" style="min-height: 150px;"></textarea>
                    </div>
                </div>
            </div>

            <div class="app-container" id="bankCardContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('bankCard')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="bank_card_title">银行卡</div>
                    <div class="app-action-btn" onclick="addBankCard()"><i class="fas fa-plus"></i></div>
                </div>
                <div class="app-content" id="bankCardList"></div>
            </div>

            <div class="app-container" id="walletContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('wallet')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="wallet_title">钱包</div>
                    <div class="app-action-btn" onclick="openSubPage('transactionHistory')"><i class="fas fa-history"></i></div>
                </div>
                <div class="app-content">
                    <div class="wallet-balance-card">
                        <div class="wallet-balance-label" data-lang="wallet_balance_label">零钱余额</div>
                        <div class="wallet-balance-amount" id="walletBalanceAmount">¥0.00</div>
                        <div class="wallet-currency-switcher">
                            <div class="segmented-control" id="currencySwitcher"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="app-container" id="transactionHistoryContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('transactionHistory')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="transaction_history_title">收支明细</div><div></div>
                </div>
                <div class="app-content" id="transactionHistoryList"></div>
            </div>

            <div class="app-container" id="chatRoomContainer">
                <div class="app-navigation-bar">
                    <div class="chat-room-header-main">
                        <div class="app-back-btn" onclick="closeSubPage('chatRoom')"><i class="fas fa-chevron-left"></i></div>
                        <div class="app-action-btn-group">
                            <div class="app-action-btn" id="chatModeToggleBtn" onclick="toggleChatRoomMode()">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="app-action-btn" onclick="openChatSettings()">
                                <i class="fas fa-ellipsis-h"></i>
                            </div>
                        </div>
                    </div>
                    <div class="chat-room-header-center">
                        <div id="chatRoomHeaderAvatar"></div>
                        <div id="chatRoomTitleWrapper">
                            <div class="app-title" id="chatRoomTitle">...</div>
                            <div id="chatRoomRemark"></div>
                        </div>
                    </div>
                </div>
                <div class="app-content">
                    <div class="chat-messages" id="chatMessagesContainer"></div>
                    <div class="palpitation-icon" onclick="toggleQuickActions()">
                        <img src="https://img.heliar.top/file/1771181075229_Image_1771181045186_462.png" alt="悸">
                    </div>
                    <div class="chat-input-area">
                        <div class="chat-input-bar">
                            <div class="chat-input-wrapper">
                                <i class="far fa-grin" onclick="openStickerModal()"></i>
                                <textarea id="chatInputField" class="chat-input-field" data-lang-placeholder="chat_input_placeholder" placeholder="输入消息..." rows="1"></textarea>
                                <button id="chatSendBtn" class="chat-send-btn" onclick="sendTextMessage()">ins</button>
                                <i class="fas fa-paperclip" onclick="triggerApiReply()"></i>
                            </div>
                            <input type="file" id="chat-image-upload" accept="image/*,video/*" style="display:none;" onchange="sendImage(event)">
                        </div>
                        <div class="chat-quick-actions" id="chatQuickActions">
                            <div class="chat-action-item" onclick="openTransferModal('user')"><div class="chat-action-icon"><i class="fas fa-exchange-alt"></i></div><span data-lang="chat_action_transfer">转账</span></div>
                            <div class="chat-action-item" onclick="document.getElementById('chat-image-upload').click()"><div class="chat-action-icon"><i class="fas fa-image"></i></div><span data-lang="chat_action_image">图片</span></div>
                            <div class="chat-action-item" onclick="openStickerImportModal()"><div class="chat-action-icon"><i class="fas fa-download"></i></div><span data-lang="chat_action_import_sticker">导入表情</span></div>
                            <div class="chat-action-item" onclick="openVoiceSimModal('user')"><div class="chat-action-icon"><i class="fas fa-microphone"></i></div><span data-lang="chat_action_voice">语音</span></div>
                            <div class="chat-action-item" onclick="openLocationModal('user')"><div class="chat-action-icon"><i class="fas fa-map-marker-alt"></i></div><span data-lang="chat_action_location">位置</span></div>
                            <div class="chat-action-item" onclick="openCameraSimModal('user')"><div class="chat-action-icon"><i class="fas fa-camera"></i></div><span data-lang="chat_action_camera">拍摄</span></div>
                            <div class="chat-action-item" onclick="openFileModal('user')"><div class="chat-action-icon"><i class="fas fa-folder"></i></div><span data-lang="chat_action_file">文件</span></div>
                        </div>
                    </div>
                    <div class="multiselect-action-bar" id="multiselectActionBar">
                        <button onclick="deleteSelectedMessages()"><i class="fas fa-trash"></i></button>
                        <button onclick="exitMultiSelectMode()" data-lang="common_cancel">取消</button>
                    </div>
                </div>
            </div>
            
            <div class="app-container" id="chatSettingsContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('chatSettings')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="chat_settings_title">聊天设置</div><div></div>
                </div>
                <div class="app-content" style="background: var(--theme-bg); padding-top: calc(54px + var(--global-top-nav-height));">
                    <div class="glass-list">
                        <div class="glass-list-item" onclick="editChatRemark()">
                            <i class="fas fa-pencil-alt item-icon"></i><span class="item-text" data-lang="chat_settings_edit_remark">修改备注</span>
                        </div>
                        <div class="glass-list-item" onclick="openReplyCountSettings()">
                            <i class="fas fa-list-ol item-icon"></i><span class="item-text" data-lang="chat_settings_reply_count">自定义回复条数</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                        <div class="glass-list-item" onclick="togglePinContact()">
                            <i class="fas fa-thumbtack item-icon"></i><span class="item-text" id="pinContactText" data-lang-placeholder-pin="chat_settings_pin" data-lang-placeholder-unpin="chat_settings_unpin">置顶该好友</span>
                        </div>
                        <div class="glass-list-item" onclick="blockContact()">
                            <i class="fas fa-ban item-icon"></i><span class="item-text" data-lang="chat_settings_block">拉黑该好友</span>
                        </div>
                        <div class="glass-list-item" onclick="document.getElementById('chat-bg-upload').click()">
                            <i class="fas fa-image item-icon"></i><span class="item-text" data-lang="chat_settings_change_bg">更换聊天背景图</span>
                            <input type="file" id="chat-bg-upload" accept="image/*" style="display:none;" onchange="changeChatBackground(event)">
                        </div>
                        <div class="glass-list-item" onclick="document.getElementById('chat-char-avatar-upload').click()">
                            <i class="fas fa-user-edit item-icon"></i><span class="item-text" data-lang="chat_settings_change_char_avatar">更换对方头像</span>
                            <input type="file" id="chat-char-avatar-upload" accept="image/*" style="display:none;" onchange="changeChatAvatar(event, 'char')">
                        </div>
                        <div class="glass-list-item" onclick="document.getElementById('chat-user-avatar-upload').click()">
                            <i class="fas fa-user-cog item-icon"></i><span class="item-text" data-lang="chat_settings_change_user_avatar">更换我的头像</span>
                            <input type="file" id="chat-user-avatar-upload" accept="image/*" style="display:none;" onchange="changeChatAvatar(event, 'user')">
                        </div>
                        <div class="glass-list-item" onclick="triggerAvatarFrameUpload('char')">
                            <i class="far fa-square item-icon"></i><span class="item-text" data-lang="chat_settings_change_char_frame">更换对方头像框</span>
                            <input type="file" id="char-avatar-frame-upload" accept="image/*" style="display:none;" onchange="changeAvatarFrame(event, 'char')">
                        </div>
                        <div class="glass-list-item" onclick="triggerAvatarFrameUpload('user')">
                            <i class="far fa-check-square item-icon"></i><span class="item-text" data-lang="chat_settings_change_user_frame">更换我的头像框</span>
                            <input type="file" id="user-avatar-frame-upload" accept="image/*" style="display:none;" onchange="changeAvatarFrame(event, 'user')">
                        </div>
                        <div class="glass-list-item" onclick="clearChatHistory()">
                            <i class="fas fa-trash item-icon"></i><span class="item-text" data-lang="chat_settings_clear_history">清空聊天记录</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 商城 App -->
            <div class="app-container" id="shoppingContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeApp('shopping')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" id="shoppingTitle" data-lang="shopping_title_home">商城</div>
                    <div class="app-action-btn-group" id="shoppingActionGroup"></div>
                </div>
                
                <div class="shopping-page active" id="shoppingPageHome">
                    <div class="app-content" style="padding: calc(44px + var(--global-top-nav-height)) 15px 20px; background: var(--theme-bg); gap: 10px;">
                        <div class="shopping-home-header">
                            <div class="shopping-categories" id="shoppingCategories"></div>
                            <button class="glass-button" style="width:auto; padding: 5px 10px; font-size: calc(var(--global-font-size) * 1.1);" onclick="addShoppingCategory()" data-lang="shopping_add_category">添加分类</button>
                        </div>
                        <div class="shopping-products-grid" id="shoppingProductsContainer"></div>
                    </div>
                </div>

                <div class="shopping-page" id="shoppingPageCart">
                    <div class="app-content" id="shoppingCartContent" style="padding: calc(44px + var(--global-top-nav-height)) 15px 60px; background: var(--theme-bg); gap: 10px;"></div>
                    <div class="cart-checkout-bar">
                        <div class="cart-total-price" id="cartTotalPrice" data-lang-placeholder="shopping_cart_total">总计: ¥0.00</div>
                        <div class="cart-checkout-btn-group">
                            <button class="cart-checkout-btn checkout-for-self" onclick="checkout('self')" data-lang="shopping_cart_pay_self">自己付</button>
                            <button class="cart-checkout-btn checkout-for-char" onclick="checkout('char')" data-lang="shopping_cart_pay_for_char">给TA买</button>
                            <button class="cart-checkout-btn checkout-ask-char" onclick="checkout('ask-char')" data-lang="shopping_cart_ask_char">请TA付</button>
                        </div>
                    </div>
                </div>

                <div class="shopping-page" id="shoppingPageMe">
                    <div class="app-content" style="padding: calc(54px + var(--global-top-nav-height)) 15px 20px; background: var(--theme-bg);">
                        <div id="shopping-me-profile-header" class="me-profile-header">
                            <div class="me-avatar-wrapper">
                                <div class="me-avatar" id="shoppingMeAvatar"></div>
                                <div class="me-avatar-frame" id="shoppingMeAvatarFrame"></div>
                            </div>
                            <div class="me-info">
                                <div class="me-nickname" id="shoppingMeNickname"></div>
                                <div class="me-signature" id="shoppingMeSignature"></div>
                            </div>
                        </div>
                        <div class="shopping-me-stats">
                            <div class="shopping-me-stat-item">
                                <div class="stat-value" id="shoppingFavoritesCount">0</div>
                                <div class="stat-label" data-lang="shopping_me_favorites">已收藏</div>
                            </div>
                            <div class="shopping-me-stat-item">
                                <div class="stat-value" id="shoppingPurchasedCount">0</div>
                                <div class="stat-label" data-lang="shopping_me_purchased">已购买</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="shopping-bottom-nav">
                    <div class="shopping-nav-item active" onclick="switchShoppingTab('Home')">
                        <i class="fas fa-store"></i><span data-lang="shopping_nav_home">首页</span>
                    </div>
                    <div class="shopping-nav-item" onclick="switchShoppingTab('Cart')">
                        <i class="fas fa-shopping-cart"></i><span data-lang="shopping_nav_cart">购物车</span>
                    </div>
                    <div class="shopping-nav-item" onclick="switchShoppingTab('Me')">
                        <i class="fas fa-user-circle"></i><span data-lang="shopping_nav_me">我</span>
                    </div>
                </div>
            </div>
            
            <!-- 朋友圈发布器 (作为子页面) -->
            <div class="app-container" id="postEditorContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('postEditor')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="post_editor_title">发表动态</div>
                    <div class="app-action-btn" onclick="savePost()"><i class="fas fa-paper-plane"></i></div>
                </div>
                <div class="app-content" style="background: var(--theme-bg); padding: calc(54px + var(--global-top-nav-height)) 15px 20px; gap: 15px;">
                    <div class="glass-form-group">
                        <textarea id="post-content-input" class="glass-textarea" data-lang-placeholder="post_editor_placeholder" placeholder="分享新鲜事..." style="min-height: 120px;"></textarea>
                    </div>
                    <div id="post-files-preview"></div>
                    <div class="glass-list">
                        <div class="glass-list-item" onclick="document.getElementById('post-file-upload').click()">
                            <i class="fas fa-photo-video item-icon"></i><span class="item-text" data-lang="post_editor_add_file">图片/视频/文件</span><i class="fas fa-chevron-right item-arrow"></i>
                            <input type="file" id="post-file-upload" multiple style="display:none;" onchange="handlePostFiles(event)">
                        </div>
                        <div class="glass-list-item" onclick="editPostLocation()">
                            <i class="fas fa-map-marker-alt item-icon"></i><span id="post-location-display" class="item-text" data-lang-placeholder="post_editor_location">所在位置</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                        <div class="glass-list-item" onclick="editPostVisibility()">
                            <i class="fas fa-user-friends item-icon"></i><span id="post-visibility-display" class="item-text" data-lang-placeholder="post_editor_visibility">谁可以看</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 音乐 App (优化后) -->
            <div class="app-container" id="musicContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeApp('music')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="music_title">音乐</div>
                    <div class="app-action-btn" onclick="openMusicSearchSettings()"><i class="fas fa-cog"></i></div>
                </div>
                
                <div class="music-page active" id="musicPageHome">
                    <div class="app-content">
                        <div class="glass-form-group" style="width: 100%;">
                            <div class="form-row">
                                <input type="text" id="music-search-input" class="glass-input" data-lang-placeholder="music_search_placeholder" placeholder="搜索歌曲...">
                                <button class="glass-button" onclick="searchMusic()"><i class="fas fa-search"></i></button>
                            </div>
                        </div>
                        <div id="musicSearchResults"></div>
                    </div>
                </div>
                
                <div class="music-page" id="musicPageMe">
                    <div class="app-content">
                        <div class="me-profile-header" style="background: var(--glass-effect); border-radius: 15px; width: 100%; box-sizing: border-box;">
                            <div class="me-avatar-wrapper">
                                <div class="me-avatar" id="musicMeAvatar"></div>
                            </div>
                            <div class="me-info">
                                <div class="me-nickname" id="musicMeNickname"></div>
                                <div class="me-signature" id="musicMeSignature"></div>
                            </div>
                        </div>
                        <div class="glass-list">
                            <div class="glass-list-item" onclick="openSubPage('recentlyPlayed')">
                                <i class="fas fa-history item-icon"></i><span class="item-text" data-lang="music_recently_played">最近常听</span><i class="fas fa-chevron-right item-arrow"></i>
                            </div>
                             <div class="glass-list-item" onclick="openSubPage('musicPlaylists')">
                                <i class="fas fa-layer-group item-icon"></i><span class="item-text" data-lang="music_favorite_playlists">收藏歌单</span><i class="fas fa-chevron-right item-arrow"></i>
                            </div>
                            <div class="glass-list-item" onclick="openSubPage('favoriteSongs')">
                                <i class="fas fa-heart item-icon"></i><span class="item-text" data-lang="music_favorite_songs">我喜欢的音乐</span><i class="fas fa-chevron-right item-arrow"></i>
                            </div>
                            <div class="glass-list-item" onclick="openMusicImportModal('url')">
                                <i class="fas fa-link item-icon"></i><span class="item-text" data-lang="music_import_url">本地URL链接导入</span><i class="fas fa-chevron-right item-arrow"></i>
                            </div>
                            <div class="glass-list-item" onclick="openMusicImportModal('file')">
                                <i class="fas fa-folder-open item-icon"></i><span class="item-text" data-lang="music_import_file">本地文件导入</span><i class="fas fa-chevron-right item-arrow"></i>
                            </div>
                            <div class="glass-list-item" onclick="openSubPage('localMusic')">
                                <i class="fas fa-compact-disc item-icon"></i><span class="item-text" data-lang="music_local_music">本地音乐</span><i class="fas fa-chevron-right item-arrow"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="music-bottom-nav">
                    <div class="music-nav-item active" onclick="switchMusicTab('Home')">
                        <i class="fas fa-home"></i><span data-lang="music_nav_home">首页</span>
                    </div>
                    <div class="music-nav-item" onclick="switchMusicTab('Me')">
                        <i class="fas fa-user"></i><span data-lang="music_nav_me">我</span>
                    </div>
                </div>
            </div>
            
            <!-- ★★★ 更新: 音乐迷你播放器 (全局) ★★★ -->
            <div id="music-mini-player">
                <div class="mini-player-header">
                    <div id="mini-player-cover" class="mini-player-cover" onclick="openApp('music'); openSubPage('musicPlayer');"></div>
                    <div class="mini-player-info" onclick="openApp('music'); openSubPage('musicPlayer');">
                        <div id="mini-player-title" class="mini-player-title"></div>
                        <div id="mini-player-artist" class="mini-player-artist"></div>
                    </div>
                    <div class="mini-player-controls">
                        <i id="mini-player-play-btn" class="fas fa-play" onclick="togglePlayPause()"></i>
                        <i class="fas fa-forward-step" onclick="playNextSong()"></i>
                        <i class="fas fa-eye-slash" onclick="hideMiniPlayer()"></i>
                    </div>
                </div>
                <div id="mini-player-lyrics-container" style="display: none;">
                    <div id="mini-player-lyrics" class="mini-player-lyrics"></div>
                </div>
                <div class="mini-player-toggle-lyrics" onclick="toggleMiniPlayerLyrics()">
                    <i id="mini-player-lyrics-toggle-icon" class="fas fa-chevron-down"></i>
                </div>
            </div>

            <!-- 音乐播放器子页面 -->
            <div class="app-container" id="musicPlayerContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('musicPlayer')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="music_player_title">正在播放</div><div></div>
                </div>
                <div class="app-content">
                    <div id="playerAlbumArt"></div>
                    <div id="playerSongInfo">
                        <div id="playerSongTitle"></div>
                        <div id="playerSongArtist"></div>
                    </div>
                    <div id="playerProgressContainer">
                        <input type="range" id="playerProgressBar" value="0" step="1">
                        <div id="playerTimeContainer">
                            <span id="playerCurrentTime">0:00</span>
                            <span id="playerDuration">0:00</span>
                        </div>
                    </div>
                    <div id="playerControls">
                        <i id="playerModeBtn" class="fas fa-retweet control-btn" onclick="changePlayMode()"></i>
                        <i class="fas fa-backward-step control-btn" onclick="playPrevSong()"></i>
                        <i id="playerPlayPauseBtn" class="fas fa-play-circle play-pause-btn" onclick="togglePlayPause()"></i>
                        <i class="fas fa-forward-step control-btn" onclick="playNextSong()"></i>
                        <i class="fas fa-list-ul control-btn" onclick="showMusicPlaylist()"></i>
                    </div>
                    <div id="playerAdvancedControls">
                        <div class="player-slider-group">
                            <label><span data-lang="music_player_speed">倍速</span>: <span id="playerSpeedValue">1.0</span>x</label>
                            <input type="range" id="playerSpeedSlider" min="0.5" max="3" step="0.1" value="1">
                        </div>
                        <div class="player-slider-group">
                            <label><span data-lang="music_player_pitch">音调</span>: <span id="playerPitchValue">1.0</span>x</label>
                            <input type="range" id="playerPitchSlider" min="0.5" max="3" step="0.1" value="1">
                        </div>
                        <button class="glass-button" style="margin-top: 10px;" onclick="showLyrics()" data-lang="music_player_show_lyrics">查看歌词</button>
                    </div>
                </div>
            </div>
            
            <div class="app-container" id="musicPlaylistsContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('musicPlaylists')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="music_playlists_title">收藏歌单</div>
                    <div class="app-action-btn" onclick="createPlaylist()"><i class="fas fa-plus"></i></div>
                </div>
                <div class="app-content" id="musicPlaylistsContent"></div>
            </div>
            <div class="app-container" id="favoriteSongsContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('favoriteSongs')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="music_favorite_songs_title">我喜欢的音乐</div><div></div>
                </div>
                <div class="app-content" id="favoriteSongsContent"></div>
            </div>
            <div class="app-container" id="localMusicContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('localMusic')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="music_local_music">本地音乐</div><div></div>
                </div>
                <div class="app-content" id="localMusicListContent" style="padding: calc(54px + var(--global-top-nav-height)) 15px 20px; background: var(--theme-bg);"></div>
            </div>
            <div class="app-container" id="recentlyPlayedContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('recentlyPlayed')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="music_recently_played">最近常听</div>
                    <div class="app-action-btn" onclick="showSortOptions()"><i class="fas fa-sort-amount-down"></i></div>
                </div>
                <div class="app-content" id="recentlyPlayedListContent"></div>
            </div>


            <!-- 贴吧 App -->
            <div class="app-container" id="tiebaContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeApp('tieba')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" id="tiebaTitle" data-lang="tieba_title">贴吧</div>
                    <div class="app-action-btn" id="tiebaRefreshBtn" style="display: none;"><i class="fas fa-sync-alt"></i></div>
                </div>
                <div class="ios-spinner-overlay" id="tiebaSpinnerOverlay">
                    <div class="ios-spinner-wrapper">
                        <div class="ios-spinner"></div>
                        <span class="ios-spinner-close" onclick="showSpinner('tiebaSpinnerOverlay', false)">&times;</span>
                    </div>
                </div>
                
                <div class="tieba-page active" id="tiebaPageHome">
                    <div class="app-content" style="padding-top: calc(44px + var(--global-top-nav-height)); padding-left: 0; padding-right: 0;">
                        <div class="tieba-categories" id="tiebaCategories"></div>
                        <div id="tiebaFeedHome"></div>
                    </div>
                </div>
                <div class="tieba-page" id="tiebaPageFollowing">
                    <div class="app-content" id="tiebaFeedFollowing" style="padding: calc(54px + var(--global-top-nav-height)) 15px 20px; background: var(--theme-bg);"></div>
                </div>
                <div class="tieba-page" id="tiebaPageTrending">
                    <div class="app-content">
                        <i class="fas fa-fire" style="font-size: 60px; color: var(--primary-text); margin-bottom: 20px;"></i>
                        <div data-lang="tieba_trending_wip">热搜页面开发中...</div>
                    </div>
                </div>
                <div class="tieba-page" id="tiebaPageMe">
                    <div class="app-content" id="tiebaMeContent" style="padding: calc(54px + var(--global-top-nav-height)) 15px 20px; background: var(--theme-bg);"></div>
                </div>

                <div class="tieba-bottom-nav">
                    <div class="tieba-nav-item active" onclick="switchTiebaTab('Home')">
                        <i class="fas fa-home"></i><span data-lang="tieba_nav_home">首页</span>
                    </div>
                    <div class="tieba-nav-item" onclick="switchTiebaTab('Following')">
                        <i class="fas fa-star"></i><span data-lang="tieba_nav_following">关注</span>
                    </div>
                    <div class="tieba-nav-item create-post-btn" onclick="openTiebaPostEditor()">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <div class="tieba-nav-item" onclick="switchTiebaTab('Trending')">
                        <i class="fas fa-fire"></i><span data-lang="tieba_nav_trending">热搜</span>
                    </div>
                    <div class="tieba-nav-item" onclick="switchTiebaTab('Me')">
                        <i class="fas fa-user"></i><span data-lang="tieba_nav_me">我</span>
                    </div>
                </div>
            </div>
            <div class="app-container" id="tiebaPostEditorContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('tiebaPostEditor')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="tieba_post_editor_title">发表帖子</div>
                    <div class="app-action-btn" onclick="saveTiebaPost()"><i class="fas fa-paper-plane"></i></div>
                </div>
                <div class="app-content" style="background: var(--theme-bg); padding: calc(54px + var(--global-top-nav-height)) 15px 20px; gap: 15px;">
                    <div class="glass-form-group">
                        <label data-lang="tieba_post_editor_author">发帖人</label>
                        <select id="tieba-post-author-select" class="glass-select"></select>
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="tieba_post_editor_post_title">帖子标题</label>
                        <input type="text" id="tieba-post-title-input" class="glass-input" data-lang-placeholder="tieba_post_editor_title_placeholder" placeholder="起个响亮的标题吧" maxlength="20">
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="tieba_post_editor_post_content">帖子内容</label>
                        <textarea id="tieba-post-content-input" class="glass-textarea" data-lang-placeholder="tieba_post_editor_content_placeholder" placeholder="尽情分享你的想法..." style="min-height: 200px;"></textarea>
                    </div>
                    <div id="tieba-post-files-preview"></div>
                    <div class="glass-list">
                        <div class="glass-list-item" onclick="document.getElementById('tieba-post-file-upload').click()">
                            <i class="fas fa-paperclip item-icon"></i><span class="item-text" data-lang="tieba_post_editor_add_attachment">添加附件</span><i class="fas fa-chevron-right item-arrow"></i>
                            <input type="file" id="tieba-post-file-upload" multiple style="display:none;" onchange="handleTiebaPostFiles(event)">
                        </div>
                        <div class="glass-list-item" onclick="editTiebaPostLocation()">
                            <i class="fas fa-map-marker-alt item-icon"></i><span id="tieba-post-location-display" class="item-text" data-lang-placeholder="tieba_post_editor_location">所在位置</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="app-container" id="tiebaProfileEditorContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('tiebaProfileEditor')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="tieba_profile_editor_title">编辑个人资料</div>
                    <div class="app-action-btn" onclick="saveTiebaProfile()"><i class="fas fa-save"></i></div>
                </div>
                <div class="app-content" style="background: var(--theme-bg);">
                    <input type="file" id="tieba-avatar-upload" accept="image/*" style="display:none;">
                    <div class="editor-avatar-section">
                        <div class="editor-avatar-preview" id="tiebaAvatarPreview" onclick="triggerAvatarUpload('tiebaProfile')"></div>
                        <label class="glass-button" style="width:auto; padding: 5px 15px;" onclick="triggerAvatarUpload('tiebaProfile')" data-lang="editor_change_avatar">更换头像</label>
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="tieba_profile_editor_nickname">昵称</label>
                        <input type="text" id="tieba-nickname" class="glass-input" maxlength="30">
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="tieba_profile_editor_username">用户名 (@...)</label>
                        <input type="text" id="tieba-username" class="glass-input" maxlength="20">
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="tieba_profile_editor_signature">个性签名</label>
                        <textarea id="tieba-signature" class="glass-textarea" maxlength="120"></textarea>
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="tieba_profile_editor_followers">粉丝数</label>
                        <input type="number" id="tieba-followers" class="glass-input">
                    </div>
                </div>
            </div>
            <div class="app-container" id="tiebaPostDetailContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('tiebaPostDetail')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="tieba_post_detail_title">帖子详情</div>
                    <div class="app-action-btn" id="tiebaDetailRefreshBtn"><i class="fas fa-sync-alt"></i></div>
                </div>
                <div class="ios-spinner-overlay" id="tiebaDetailSpinnerOverlay">
                    <div class="ios-spinner-wrapper">
                        <div class="ios-spinner"></div>
                        <span class="ios-spinner-close" onclick="showSpinner('tiebaDetailSpinnerOverlay', false)">&times;</span>
                    </div>
                </div>
                <div class="app-content" id="tiebaPostDetailContent"></div>
            </div>
            <div class="app-container" id="tiebaProfileDetailContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('tiebaProfileDetail')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="tieba_profile_detail_title">个人主页</div>
                    <div></div>
                </div>
                <div class="app-content" id="tiebaProfileDetailContent"></div>
            </div>

            <!-- 联系人编辑器 (作为子页面) -->
            <div class="app-container" id="contactEditorContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('contactEditor')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" id="contactEditorTitle" data-lang-placeholder-create="contact_editor_title_create" data-lang-placeholder-edit="contact_editor_title_edit">创建联系人</div>
                    <div class="app-action-btn" onclick="saveContact()"><i class="fas fa-save"></i></div>
                </div>
                <div class="app-content" style="background: var(--theme-bg);">
                    <input type="file" id="avatar-upload" accept="image/*" style="display:none;">
                    <div class="editor-avatar-section">
                        <div class="editor-avatar-preview" id="avatarPreview" onclick="triggerAvatarUpload('contact')"></div>
                        <label class="glass-button" style="width:auto; padding: 5px 15px;" onclick="triggerAvatarUpload('contact')" data-lang="editor_change_avatar">更换头像</label>
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="contact_editor_name">名字</label>
                        <input type="text" id="contact-name" class="glass-input" maxlength="30">
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="contact_editor_bio">简介</label>
                        <textarea id="contact-bio" class="glass-textarea" maxlength="120"></textarea>
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="editor_gender">性别</label>
                        <div class="gender-options">
                            <label><input type="radio" name="gender" value="male"> <span data-lang="gender_male">男</span></label>
                            <label><input type="radio" name="gender" value="female"> <span data-lang="gender_female">女</span></label>
                            <label><input type="radio" name="gender" value="other"> <span data-lang="gender_other">其他</span></label>
                        </div>
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="contact_editor_occupation">身份/职业</label>
                        <input type="text" id="contact-occupation" class="glass-input" maxlength="30">
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="contact_editor_wxid">wxid</label>
                        <input type="text" id="contact-wxid" class="glass-input" maxlength="20">
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="contact_editor_qid">QID</label>
                        <input type="text" id="contact-qid" class="glass-input" maxlength="12">
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="contact_editor_qq">QQ号</label>
                                                <input type="text" id="contact-qq" class="glass-input" maxlength="10">
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="contact_editor_persona">设定</label>
                        <textarea id="contact-persona" class="glass-textarea" style="min-height: 150px;"></textarea>
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="contact_editor_relationship">关系</label>
                        <input type="text" id="contact-relationship" class="glass-input" maxlength="12">
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="contact_editor_bind_user">绑定的User</label>
                        <select id="contact-user" class="glass-select"></select>
                    </div>
                    <div class="glass-form-group" onclick="openMultiSelectModal('worldbooks')">
                        <label data-lang="contact_editor_bind_worldbook">绑定世界书</label>
                        <div id="contact-worldbooks-display" class="glass-input" style="min-height: 36px; cursor: pointer;" data-lang-placeholder="editor_click_to_select">点击选择</div>
                    </div>
                    <div class="glass-form-group" onclick="openMultiSelectModal('groups')">
                        <label data-lang="contact_editor_groups">分组</label>
                        <div id="contact-groups-display" class="glass-input" style="min-height: 36px; cursor: pointer;" data-lang-placeholder="editor_click_to_select">点击选择</div>
                    </div>
                </div>
            </div>

            <!-- 世界书 App -->
            <div class="app-container" id="worldBookContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeApp('worldBook')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="worldbook_title">世界书</div>
                    <div class="app-action-btn" onclick="openWorldBookEditor(null)"><i class="fas fa-plus"></i></div>
                </div>
                <div class="app-content" id="worldBookListContent"></div>
            </div>
            <div class="app-container" id="worldBookEditorContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('worldBookEditor')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" id="worldBookEditorTitle" data-lang-placeholder-create="worldbook_editor_title_create" data-lang-placeholder-edit="worldbook_editor_title_edit">创建世界书</div>
                    <div class="app-action-btn" onclick="saveWorldBook()"><i class="fas fa-save"></i></div>
                </div>
                <div class="app-content" style="background: var(--theme-bg);">
                    <div class="glass-form-group">
                        <label data-lang="worldbook_editor_entry_title">标题</label>
                        <input type="text" id="worldbook-title" class="glass-input">
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="worldbook_editor_category">分类</label>
                        <input type="text" id="worldbook-category" class="glass-input">
                    </div>
                    <div class="glass-form-group">
                        <label><span data-lang="worldbook_editor_depth">深度</span>: <span id="worldbook-depth-value">0</span></label>
                        <input type="range" id="worldbook-depth" min="-10" max="10" step="1" value="0">
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="worldbook_editor_tags">标签 (输入后按回车)</label>
                        <div class="tag-input-container" id="tag-container">
                            <input type="text" id="tag-input" data-lang-placeholder="worldbook_editor_add_tag" placeholder="添加标签...">
                        </div>
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="worldbook_editor_keywords">关键词 (用逗号或空格隔开)</label>
                        <textarea id="worldbook-keywords" class="glass-textarea" style="min-height: 50px;"></textarea>
                    </div>
                    <div class="glass-list-item" style="padding: 10px 15px;">
                        <span class="item-text" data-lang="worldbook_editor_trigger_by_keywords">根据关键词触发</span>
                        <label class="switch"><input type="checkbox" id="worldbook-trigger-toggle"><span class="slider"></span></label>
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="worldbook_editor_content">内容</label>
                        <textarea id="worldbook-content" class="glass-textarea" style="min-height: 150px;"></textarea>
                    </div>
                </div>
            </div>

            <!-- 设置 App & 子页面 -->
            <div class="app-container" id="settingsContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeApp('settings')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="settings_title">设置</div><div></div>
                </div>
                <div class="app-content" style="background: var(--theme-bg); padding-top: calc(54px + var(--global-top-nav-height));">
                    <div class="glass-list">
                        <div class="glass-list-item" onclick="openSubPage('languageSettings')">
                            <i class="fas fa-language item-icon"></i><span class="item-text" data-lang="settings_language">语言设置</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                        <div class="glass-list-item" onclick="openSubPage('displayModeSettings')">
                            <i class="fas fa-desktop item-icon"></i><span class="item-text" data-lang="settings_display_mode">显示模式</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                        <div class="glass-list-item" onclick="openSubPage('fontSettings')">
                            <i class="fas fa-font item-icon"></i><span class="item-text" data-lang="settings_font">字体设置</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                        <div class="glass-list-item" onclick="openSubPage('desktopBeautification')">
                            <i class="fas fa-palette item-icon"></i><span class="item-text" data-lang="settings_desktop">桌面美化</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                        <div class="glass-list-item" onclick="openSubPage('friendsSettings')">
                            <i class="fas fa-users item-icon"></i><span class="item-text" data-lang="settings_friends">朋友圈设置</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                        <div class="glass-list-item" onclick="openSubPage('bubbleCssSettings')">
                            <i class="fas fa-comment-medical item-icon"></i><span class="item-text" data-lang="settings_bubble">气泡CSS渲染</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                        <div class="glass-list-item" onclick="openSubPage('uiAdjustment')">
                            <i class="fas fa-ruler-combined item-icon"></i><span class="item-text" data-lang="settings_ui_adjustment">UI调整</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                        <div class="glass-list-item" onclick="openSubPage('statusBarSettings')">
                            <i class="fas fa-window-maximize item-icon"></i><span class="item-text" data-lang="settings_status_bar">手机顶部状态栏图标调整</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                        <div class="glass-list-item" onclick="openSubPage('timePerceptionSettings')">
                            <i class="fas fa-clock item-icon"></i><span class="item-text" data-lang="settings_time">时间感知</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                        <div class="glass-list-item" onclick="openSubPage('mainApiSettings')">
                            <i class="fas fa-globe item-icon"></i><span class="item-text" data-lang="settings_main_api">主API设置</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                        <div class="glass-list-item" onclick="openSubPage('apiSettings')">
                            <i class="fas fa-cogs item-icon"></i><span class="item-text" data-lang="settings_app_api">应用API设置</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                        <div class="glass-list-item" onclick="openSubPage('memorySummary')">
                            <i class="fas fa-brain item-icon"></i><span class="item-text" data-lang="settings_memory">记忆总结</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                        <div class="glass-list-item" onclick="openSubPage('blacklist')">
                            <i class="fas fa-user-slash item-icon"></i><span class="item-text" data-lang="settings_blacklist">黑名单</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                        <div class="glass-list-item" onclick="openSubPage('dataManagement')">
                            <i class="fas fa-database item-icon"></i><span class="item-text" data-lang="settings_data">数据管理</span><i class="fas fa-chevron-right item-arrow"></i>
                        </div>
                        <a href="https://xhslink.com/m/6rhDBRMmDch" target="_blank" class="glass-list-item" style="text-decoration: none;">
                            <i class="fas fa-heart item-icon"></i><span class="item-text" data-lang="settings_author">原作者直达</span><i class="fas fa-chevron-right item-arrow"></i>
                        </a>
                    </div>
                </div>
            </div>

            <div class="app-container" id="languageSettingsContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('languageSettings')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="language_settings_title">语言设置</div><div></div>
                </div>
                <div class="app-content" style="background: var(--theme-bg); padding-top: calc(54px + var(--global-top-nav-height));">
                    <div class="glass-list" id="language-list"></div>
                </div>
            </div>

            <div class="app-container" id="displayModeSettingsContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('displayModeSettings')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="display_mode_title">显示模式</div><div></div>
                </div>
                <div class="app-content" style="background: var(--theme-bg); padding-top: calc(54px + var(--global-top-nav-height));">
                    <div class="glass-list" id="display-mode-list"></div>
                </div>
            </div>

            <div class="app-container" id="fontSettingsContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('fontSettings')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="font_settings_title">字体设置</div>
                    <div class="app-action-btn" onclick="applyCurrentFontSettings()"><i class="fas fa-check"></i></div>
                </div>
                <div class="app-content" id="fontSettingsContent" style="background: var(--theme-bg); gap: 15px; padding: calc(54px + var(--global-top-nav-height)) 15px 20px;"></div>
            </div>

            <div class="app-container" id="friendsSettingsContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('friendsSettings')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="friends_settings_title">朋友圈设置</div>
                    <div class="app-action-btn" onclick="saveFriendsSettings()"><i class="fas fa-check"></i></div>
                </div>
                <div class="app-content">
                    <div class="glass-form-group">
                        <label data-lang="friends_settings_probability">Char发动态概率: <span id="friends-probability-value">20</span>%</label>
                        <input type="range" id="friends-probability-slider" min="1" max="100" step="1" value="20">
                    </div>
                    <div class="glass-form-group">
                        <label data-lang="friends_settings_time_slot">Char发动态时间段</label>
                        <select id="friends-time-slot-select" class="glass-select">
                            <option value="any">任何时间</option>
                            <option value="morning">上午 (9-12点)</option>
                            <option value="noon">中午 (12-14点)</option>
                            <option value="afternoon">下午 (14-18点)</option>
                            <option value="evening">晚上 (18-23点)</option>
                            <option value="night">深夜 (23-2点)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="app-container" id="bubbleCssSettingsContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('bubbleCssSettings')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="bubble_settings_title">气泡CSS渲染</div>
                    <div class="app-action-btn" onclick="applyCurrentBubbleSettings()"><i class="fas fa-check"></i></div>
                </div>
                <div class="app-content" id="bubbleCssSettingsContent" style="background: var(--theme-bg); gap: 15px; padding: calc(54px + var(--global-top-nav-height)) 15px 20px;"></div>
            </div>

            <!-- ★★★ 新增: UI风格设置页面 ★★★ -->
            <div class="app-container" id="uiStyleSettingsContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('uiStyleSettings')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="ui_style_title">UI风格</div>
                    <div class="app-action-btn" onclick="saveUiStyle()"><i class="fas fa-check"></i></div>
                </div>
                <div class="app-content">
                    <div class="glass-list">
                        <div class="glass-list-item" onclick="selectUiStyle('default')">
                            <span class="item-text" data-lang="ui_style_default">默认ins风格</span>
                            <i id="ui-style-check-default" class="fas fa-check" style="color: var(--theme-color);"></i>
                        </div>
                        <div class="glass-list-item" onclick="selectUiStyle('line')">
                            <span class="item-text" data-lang="ui_style_line">黑白线条简约风格</span>
                            <i id="ui-style-check-line" class="fas fa-check" style="color: var(--theme-color); display: none;"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="app-container" id="uiAdjustmentContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('uiAdjustment')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="ui_adjustment_title">UI调整</div>
                    <div class="app-action-btn" onclick="saveUiAdjustments()"><i class="fas fa-check"></i></div>
                </div>
                <div class="app-content"></div>
            </div>

            <div class="app-container" id="statusBarSettingsContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('statusBarSettings')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="settings_status_bar">手机顶部状态栏图标调整</div>
                    <div class="app-action-btn" onclick="saveStatusBarSettings()"><i class="fas fa-check"></i></div>
                </div>
                <div class="app-content"></div>
            </div>

            <div class="app-container" id="desktopBeautificationContainer">
                 <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('desktopBeautification')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="desktop_settings_title">桌面美化</div><div></div>
                </div>
                <div class="app-content" style="background: var(--theme-bg); gap: 20px; padding-top: calc(54px + var(--global-top-nav-height));">
                    <div class="beautify-section">
                        <label for="wallpaper-upload" class="glass-button" data-lang="desktop_settings_change_wallpaper">更换壁纸</label>
                        <input type="file" id="wallpaper-upload" accept="image/*" onchange="changeWallpaper(event)" style="display:none;">
                    </div>
                    <div class="beautify-section glass-form-group">
                        <label data-lang="desktop_settings_change_icons">更换应用图标</label>
                        <div class="beautify-icons-grid" id="beautifyIconsGrid"></div>
                    </div>
                </div>
            </div>
            
            <div class="app-container" id="timePerceptionSettingsContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('timePerceptionSettings')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="time_settings_title">时间感知</div><div></div>
                </div>
                <div class="app-content" style="background: var(--theme-bg); padding-top: calc(54px + var(--global-top-nav-height));">
                    <div class="glass-list">
                        <div class="glass-list-item">
                            <div style="text-align: left;">
                                <span class="item-text" data-lang="time_settings_enable">开启时间感知</span>
                                <p style="font-size: calc(var(--global-font-size) * 1.1); color: var(--secondary-text); margin-top: 4px;" data-lang="time_settings_description">开启后，AI将能感知并回应现实时间与节日。</p>
                            </div>
                            <label class="switch"><input type="checkbox" id="time-perception-toggle"><span class="slider"></span></label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="app-container" id="mainApiSettingsContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('mainApiSettings')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="main_api_settings_title">主API设置</div><div></div>
                </div>
                <div class="app-content" id="main-api-settings-content" style="background: var(--theme-bg); padding-top: calc(54px + var(--global-top-nav-height));"></div>
            </div>

            <div class="app-container" id="apiSettingsContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('apiSettings')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="app_api_settings_title">应用API设置</div><div></div>
                </div>
                <div class="app-content" id="api-settings-content" style="background: var(--theme-bg); padding-top: calc(54px + var(--global-top-nav-height));"></div>
            </div>

            <div class="app-container" id="memorySummaryContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('memorySummary')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="memory_summary_title">记忆总结</div><div></div>
                </div>
                <div class="app-content" id="memorySummaryContactListContent"></div>
            </div>
            
            <div class="app-container" id="blacklistContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('blacklist')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="blacklist_title">黑名单</div><div></div>
                </div>
                <div class="app-content" id="blacklistContent"></div>
            </div>

            <div class="app-container" id="dataManagementContainer">
                <div class="app-navigation-bar">
                    <div class="app-back-btn" onclick="closeSubPage('dataManagement')"><i class="fas fa-chevron-left"></i></div>
                    <div class="app-title" data-lang="data_management_title">数据管理</div><div></div>
                </div>
                <div class="app-content" id="dataManagementContent" style="padding: calc(54px + var(--global-top-nav-height)) 15px 20px;"></div>
            </div>

        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script>
        // --- 全局数据和状态管理 ---
        let appData = {};

        // --- 国际化 (i18n) ---
        const translations = {
            'zh-CN': {
                // App Names
                'app_chat': '聊天', 'app_worldBook': '世界书', 'app_shopping': '商城', 'app_settings': '设置', 'app_music': '音乐', 'app_tieba': '贴吧',
                // Common
                'common_back': '返回', 'common_cancel': '取消', 'common_confirm': '确认', 'common_save': '保存', 'common_delete': '删除', 'common_edit': '编辑', 'common_create': '创建', 'common_add': '添加', 'common_remove': '移除', 'common_ok': '好', 'common_error': '错误', 'common_success': '保存成功', 'common_info': '提示', 'common_warning': '警告',
                // Placeholders
                'placeholder_loading': '加载中...', 'placeholder_no_data': '暂无数据', 'placeholder_no_content': '无内容',
                // Alerts
                'alert_save_success': '保存成功', 'alert_save_failed': '保存失败', 'alert_load_failed': '读取本地存储失败', 'alert_parse_failed': '解析已存数据失败，将使用默认数据', 'alert_export_success': '导出成功', 'alert_export_failed': '导出失败', 'alert_import_confirm_title': '恢复数据', 'alert_import_confirm_msg': '恢复数据将完全覆盖当前所有本地数据。此操作不可逆！确定要继续吗？', 'alert_import_action_confirm': '确定恢复', 'alert_import_success': '恢复成功', 'alert_import_failed': '恢复失败', 'alert_clear_cache_title': '清理缓存', 'alert_clear_cache_msg': '此操作将清除由AI生成的临时数据（如贴吧用户缓存），但不会删除您的核心数据。确定要清理吗？', 'alert_clear_cache_action': '确定清理', 'alert_clear_cache_success': '清理成功', 'alert_clear_all_title': '清除所有数据', 'alert_clear_all_msg': '此操作将删除所有联系人、聊天记录、设置等全部数据，且不可恢复！您确定要这么做吗？', 'alert_clear_all_action': '我确定，全部清除', 'alert_clear_all_success': '数据已清除',
                // Cropper
                'cropper_title': '裁剪图片', 'cropper_ratio_free': '自由', 'cropper_confirm': '确认裁剪',
                // Chat App
                'chat_title_messages': '消息', 'chat_title_contacts': '联系人', 'chat_title_friends': '朋友圈', 'chat_title_me': '我', 'chat_me_set_nickname': '设置昵称', 'chat_me_set_signature': '设置个性签名', 'chat_me_my_profiles': '我的自设', 'chat_me_bank_card': '银行卡', 'chat_me_wallet': '钱包', 'chat_me_top_up': '充值', 'chat_me_withdraw': '提现', 'chat_nav_messages': '消息', 'chat_nav_contacts': '联系人', 'chat_nav_friends': '朋友圈', 'chat_nav_me': '我', 'chat_input_placeholder': '输入消息...', 'chat_action_transfer': '转账', 'chat_action_image': '图片', 'chat_action_import_sticker': '导入表情', 'chat_action_voice': '语音', 'chat_action_location': '位置', 'chat_action_camera': '拍摄', 'chat_action_file': '文件',
                // My Profiles
                'my_profiles_title': '我的自设', 'my_profiles_placeholder': '还没有创建自设，点击右上角“+”创建一个吧。', 'my_profiles_current': '(当前)', 'my_profiles_op_title': '自设操作', 'my_profiles_op_view': '查看/编辑', 'my_profiles_op_activate': '设为当前',
                // User/Contact Editor
                'user_editor_title_create': '创建自设', 'user_editor_title_edit': '编辑自设', 'editor_change_avatar': '更换头像', 'user_editor_name': 'user名字', 'editor_gender': '性别', 'gender_male': '男', 'gender_female': '女', 'gender_other': '其他', 'user_editor_occupation': 'user的身份/职业', 'user_editor_wxid': 'user的wxid', 'user_editor_qid': 'user的QID', 'user_editor_qq': 'user的QQ号', 'user_editor_persona': 'user的设定', 'editor_click_to_select': '点击选择',
                // Bank Card
                'bank_card_title': '银行卡', 'bank_card_placeholder': '还没有银行卡，点击右上角“+”添加一张吧。',
                // Wallet
                'wallet_title': '钱包', 'wallet_balance_label': '零钱余额', 'transaction_history_title': '收支明细', 'transaction_history_placeholder': '暂无收支明细。',
                // Chat Room
                'chat_room_start_chat': '开始聊天吧...', 'chat_room_typing': '对方正在输入...', 'chat_room_recalled_msg': '撤回了一条消息', 'chat_room_you': '你',
                // Chat Settings
                'chat_settings_title': '聊天设置', 'chat_settings_edit_remark': '修改备注', 'chat_settings_pin': '置顶该好友', 'chat_settings_unpin': '取消置顶', 'chat_settings_block': '拉黑该好友', 'chat_settings_change_bg': '更换聊天背景图', 'chat_settings_change_char_avatar': '更换对方头像', 'chat_settings_change_user_avatar': '更换我的头像', 'chat_settings_change_char_frame': '更换对方头像框', 'chat_settings_change_user_frame': '更换我的头像框', 'chat_settings_clear_history': '清空聊天记录', 'chat_settings_reply_count': '自定义回复条数',
                // Shopping App
                'shopping_title_home': '商城', 'shopping_title_cart': '购物车', 'shopping_title_me': '我', 'shopping_add_category': '添加分类', 'shopping_cart_total': '总计: ¥0.00', 'shopping_cart_pay_self': '自己付', 'shopping_cart_pay_for_char': '给TA买', 'shopping_cart_ask_char': '请TA付', 'shopping_me_favorites': '已收藏', 'shopping_me_purchased': '已购买', 'shopping_nav_home': '首页', 'shopping_nav_cart': '购物车', 'shopping_nav_me': '我',
                // Friends App (now a tab)
                'friends_placeholder': '还没有动态，点击右上角相机发布第一条吧。',
                // Post Editor
                'post_editor_title': '发表动态', 'post_editor_placeholder': '分享新鲜事...', 'post_editor_add_file': '图片/视频/文件', 'post_editor_location': '所在位置', 'post_editor_visibility': '谁可以看', 'post_visibility_all': '全部可见', 'post_visibility_self': '仅自己可见', 'post_visibility_partial': '部分好友可见',
                // Music App
                'music_title': '音乐', 'music_widget_no_song': '暂无歌曲', 'music_search_placeholder': '创作者+歌曲名, 如: h3r3 再等冬天', 'music_local_music': '本地音乐', 'music_favorite_playlists': '收藏歌单', 'music_favorite_songs': '我喜欢的音乐', 'music_import_url': '本地URL链接导入', 'music_import_file': '本地文件导入', 'music_nav_home': '首页', 'music_nav_me': '我', 'music_player_title': '正在播放', 'music_player_speed': '倍速', 'music_player_pitch': '音调', 'music_player_show_lyrics': '查看歌词', 'music_playlists_title': '收藏歌单', 'music_favorite_songs_title': '我喜欢的音乐', 'music_engine_netease': '网易云音乐', 'music_recently_played': '最近常听', 'music_actions_title': '歌曲操作', 'music_action_download': '下载', 'music_action_share': '分享', 'music_sort_title': '排序方式', 'music_sort_az': '按字母 A-Z', 'music_sort_za': '按字母 Z-A', 'music_sort_count': '按播放次数', 'music_sort_newest': '按最新添加', 'music_sort_oldest': '按最早添加',
                // Tieba App
                'tieba_title': '贴吧', 'tieba_trending_wip': '热搜页面开发中...', 'tieba_nav_home': '首页', 'tieba_nav_following': '关注', 'tieba_nav_trending': '热搜', 'tieba_nav_me': '我', 'tieba_post_editor_title': '发表帖子', 'tieba_post_editor_author': '发帖人', 'tieba_post_editor_post_title': '帖子标题', 'tieba_post_editor_title_placeholder': '起个响亮的标题吧', 'tieba_post_editor_post_content': '帖子内容', 'tieba_post_editor_content_placeholder': '尽情分享你的想法...', 'tieba_post_editor_add_attachment': '添加附件', 'tieba_post_editor_location': '所在位置', 'tieba_profile_editor_title': '编辑个人资料', 'tieba_profile_editor_nickname': '昵称', 'tieba_profile_editor_username': '用户名 (@...)', 'tieba_profile_editor_signature': '个性签名', 'tieba_profile_editor_followers': '粉丝数', 'tieba_post_detail_title': '帖子详情', 'tieba_profile_detail_title': '个人主页',
                // Contacts (now a tab)
                'contacts_placeholder': '还没有联系人，点击右上角“+”创建一个吧。', 'contact_editor_title_create': '创建联系人', 'contact_editor_title_edit': '编辑联系人', 'contact_editor_name': '名字', 'contact_editor_bio': '简介', 'contact_editor_occupation': '身份/职业', 'contact_editor_wxid': 'wxid', 'contact_editor_qid': 'QID', 'contact_editor_qq': 'QQ号', 'contact_editor_persona': '设定', 'contact_editor_relationship': '关系', 'contact_editor_bind_user': '绑定的User', 'contact_editor_bind_worldbook': '绑定世界书', 'contact_editor_groups': '分组',
                // Worldbook App
                'worldbook_title': '世界书', 'worldbook_placeholder': '还没有世界书，点击右上角“+”创建一本吧。', 'worldbook_editor_title_create': '创建世界书', 'worldbook_editor_title_edit': '编辑世界书', 'worldbook_editor_entry_title': '标题', 'worldbook_editor_category': '分类', 'worldbook_editor_depth': '深度', 'worldbook_editor_tags': '标签 (输入后按回车)', 'worldbook_editor_add_tag': '添加标签...', 'worldbook_editor_keywords': '关键词 (用逗号或空格隔开)', 'worldbook_editor_trigger_by_keywords': '根据关键词触发', 'worldbook_editor_content': '内容',
                // Settings App
                'settings_title': '设置', 'settings_language': '语言设置', 'settings_display_mode': '显示模式', 'settings_font': '字体设置', 'settings_desktop': '桌面美化', 'settings_friends': '朋友圈设置', 'settings_bubble': '气泡CSS渲染', 'settings_ui_adjustment': 'UI调整', 'settings_status_bar': '手机顶部状态栏图标调整', 'settings_time': '时间感知', 'settings_main_api': '主API设置', 'settings_app_api': '应用API设置', 'settings_memory': '记忆总结', 'settings_blacklist': '黑名单', 'settings_data': '数据管理', 'settings_author': '原作者直达',
                // Language Settings
                'language_settings_title': '语言设置', 'language_zh_cn': '简体中文', 'language_zh_tw': '繁體中文', 'language_ko': '한국어',
                // Display Mode Settings
                'display_mode_title': '显示模式', 'display_mode_fullscreen': '全屏模式', 'display_mode_phone_frame': '手机边框模式', 'display_mode_phone_frame_2': '手机边框模式2 (待开发)',
                // Font Settings
                'font_settings_title': '字体设置',
                // Friends Settings
                'friends_settings_title': '朋友圈设置', 'friends_settings_probability': 'Char发动态概率', 'friends_settings_time_slot': 'Char发动态时间段',
                // Bubble Settings
                'bubble_settings_title': '气泡CSS渲染', 'bubble_settings_shape': '调整气泡形状', 'bubble_shape_rounded': '圆角', 'bubble_shape_circular': '圆形', 'bubble_shape_square': '方形',
                // UI Adjustment Settings
                'ui_adjustment_title': 'UI调整', 'ui_adjustment_icon_size': '桌面图标大小', 'ui_adjustment_top_nav_height': '顶部导航栏高度', 'ui_adjustment_bottom_nav_height': '底部导航栏高度', 'ui_adjustment_element_base_size': '功能UI大小', 'ui_style_title': 'UI风格', 'ui_style_default': '默认ins风格', 'ui_style_line': '黑白线条简约风格',
                // Status Bar Settings
                'status_bar_settings_title': '状态栏图标调整', 'status_bar_settings_icon_size': '图标大小',
                // Desktop Settings
                'desktop_settings_title': '桌面美化', 'desktop_settings_change_wallpaper': '更换壁纸', 'desktop_settings_change_icons': '更换应用图标',
                // Time Settings
                'time_settings_title': '时间感知', 'time_settings_enable': '开启时间感知', 'time_settings_description': '开启后，AI将能感知并回应现实时间与节日。',
                // API Settings
                'main_api_settings_title': '主API设置', 'app_api_settings_title': '应用API设置', 'api_settings_chat_tab': '聊天 API', 'api_settings_vision_tab': '识图 API', 'api_settings_tieba_tab': '贴吧 API', 'api_settings_use_main_api': '使用主API',
                // Memory Summary
                'memory_summary_title': '记忆总结',
                // Blacklist
                'blacklist_title': '黑名单',
                // Data Management
                'data_management_title': '数据管理', 'data_management_backup_all': '备份全部数据', 'data_management_backup_partial': '备份部分数据', 'data_management_restore': '从文件恢复数据', 'data_management_stats': '数据统计', 'data_management_clear_cache': '清理缓存', 'data_management_clear_all': '清除所有数据',
            },
            'zh-TW': {
                'app_chat': '聊天', 'app_worldBook': '世界書', 'app_shopping': '商城', 'app_settings': '設定', 'app_music': '音樂', 'app_tieba': '貼吧',
                'common_back': '返回', 'common_cancel': '取消', 'common_confirm': '確認', 'common_save': '儲存', 'common_delete': '刪除', 'common_edit': '編輯', 'common_create': '建立', 'common_add': '新增', 'common_remove': '移除', 'common_ok': '好', 'common_error': '錯誤', 'common_success': '儲存成功', 'common_info': '提示', 'common_warning': '警告',
                'placeholder_loading': '載入中...', 'placeholder_no_data': '暫無資料', 'placeholder_no_content': '無內容',
                'alert_save_success': '儲存成功', 'alert_save_failed': '儲存失敗', 'alert_load_failed': '讀取本地儲存失敗', 'alert_parse_failed': '解析已存資料失敗，將使用預設資料', 'alert_export_success': '匯出成功', 'alert_export_failed': '匯出失敗', 'alert_import_confirm_title': '還原資料', 'alert_import_confirm_msg': '還原資料將完全覆蓋當前所有本地資料。此操作不可逆！確定要繼續嗎？', 'alert_import_action_confirm': '確定還原', 'alert_import_success': '還原成功', 'alert_import_failed': '還原失敗', 'alert_clear_cache_title': '清理快取', 'alert_clear_cache_msg': '此操作將清除由AI生成的暫存資料（如貼吧使用者快取），但不會刪除您的核心資料。確定要清理嗎？', 'alert_clear_cache_action': '確定清理', 'alert_clear_cache_success': '清理成功', 'alert_clear_all_title': '清除所有資料', 'alert_clear_all_msg': '此操作將刪除所有聯絡人、聊天記錄、設定等全部資料，且不可還原！您確定要這麼做嗎？', 'alert_clear_all_action': '我確定，全部清除', 'alert_clear_all_success': '資料已清除',
                'cropper_title': '裁剪圖片', 'cropper_ratio_free': '自由', 'cropper_confirm': '確認裁剪',
                'chat_title_messages': '訊息', 'chat_title_contacts': '聯絡人', 'chat_title_friends': '朋友圈', 'chat_title_me': '我', 'chat_me_set_nickname': '設定暱稱', 'chat_me_set_signature': '設定個性簽名', 'chat_me_my_profiles': '我的自設', 'chat_me_bank_card': '銀行卡', 'chat_me_wallet': '錢包', 'chat_me_top_up': '儲值', 'chat_me_withdraw': '提現', 'chat_nav_messages': '訊息', 'chat_nav_contacts': '聯絡人', 'chat_nav_friends': '朋友圈', 'chat_nav_me': '我', 'chat_input_placeholder': '輸入訊息...', 'chat_action_transfer': '轉帳', 'chat_action_image': '圖片', 'chat_action_import_sticker': '匯入表情', 'chat_action_voice': '語音', 'chat_action_location': '位置', 'chat_action_camera': '拍攝', 'chat_action_file': '檔案',
                'my_profiles_title': '我的自設', 'my_profiles_placeholder': '還沒有建立自設，點擊右上角「+」建立一個吧。', 'my_profiles_current': '(目前)', 'my_profiles_op_title': '自設操作', 'my_profiles_op_view': '檢視/編輯', 'my_profiles_op_activate': '設為目前',
                'user_editor_title_create': '建立自設', 'user_editor_title_edit': '編輯自設', 'editor_change_avatar': '更換頭像', 'user_editor_name': 'user名字', 'editor_gender': '性別', 'gender_male': '男', 'gender_female': '女', 'gender_other': '其他', 'user_editor_occupation': 'user的身份/職業', 'user_editor_wxid': 'user的wxid', 'user_editor_qid': 'user的QID', 'user_editor_qq': 'user的QQ號', 'user_editor_persona': 'user的設定', 'editor_click_to_select': '點擊選擇',
                'bank_card_title': '銀行卡', 'bank_card_placeholder': '還沒有銀行卡，點擊右上角「+」新增一張吧。',
                'wallet_title': '錢包', 'wallet_balance_label': '零錢餘額', 'transaction_history_title': '收支明細', 'transaction_history_placeholder': '暫無收支明細。',
                'chat_room_start_chat': '開始聊天吧...', 'chat_room_typing': '對方正在輸入...', 'chat_room_recalled_msg': '撤回了一則訊息', 'chat_room_you': '你',
                'chat_settings_title': '聊天設定', 'chat_settings_edit_remark': '修改備註', 'chat_settings_pin': '置頂該好友', 'chat_settings_unpin': '取消置頂', 'chat_settings_block': '封鎖该好友', 'chat_settings_change_bg': '更換聊天背景圖', 'chat_settings_change_char_avatar': '更換對方頭像', 'chat_settings_change_user_avatar': '更換我的頭像', 'chat_settings_change_char_frame': '更換對方頭像框', 'chat_settings_change_user_frame': '更換我的頭像框', 'chat_settings_clear_history': '清空聊天記錄', 'chat_settings_reply_count': '自訂回覆則數',
                'shopping_title_home': '商城', 'shopping_title_cart': '購物車', 'shopping_title_me': '我', 'shopping_add_category': '新增分類', 'shopping_cart_total': '總計: ¥0.00', 'shopping_cart_pay_self': '自己付', 'shopping_cart_pay_for_char': '給TA買', 'shopping_cart_ask_char': '請TA付', 'shopping_me_favorites': '已收藏', 'shopping_me_purchased': '已購買', 'shopping_nav_home': '首頁', 'shopping_nav_cart': '購物車', 'shopping_nav_me': '我',
                'friends_placeholder': '還沒有動態，點擊右上角相機發佈第一條吧。',
                'post_editor_title': '發表動態', 'post_editor_placeholder': '分享新鮮事...', 'post_editor_add_file': '圖片/影片/檔案', 'post_editor_location': '所在位置', 'post_editor_visibility': '誰可以看', 'post_visibility_all': '全部可見', 'post_visibility_self': '僅自己可見', 'post_visibility_partial': '部分好友可見',
                                'music_title': '音樂', 'music_widget_no_song': '暫無歌曲', 'music_search_placeholder': '創作者或歌曲名, 如: h3r3 再等冬天', 'music_local_music': '本地音樂', 'music_favorite_playlists': '收藏歌單', 'music_favorite_songs': '我喜歡的音樂', 'music_import_url': '本地URL連結匯入', 'music_import_file': '本地檔案匯入', 'music_nav_home': '首頁', 'music_nav_me': '我', 'music_player_title': '正在播放', 'music_player_speed': '倍速', 'music_player_pitch': '音調', 'music_player_show_lyrics': '檢視歌詞', 'music_playlists_title': '收藏歌單', 'music_favorite_songs_title': '我喜歡的音樂', 'music_engine_netease': '網易雲音樂', 'music_recently_played': '最近常聽', 'music_actions_title': '歌曲操作', 'music_action_download': '下載', 'music_action_share': '分享', 'music_sort_title': '排序方式', 'music_sort_az': '按字母 A-Z', 'music_sort_za': '按字母 Z-A', 'music_sort_count': '按播放次數', 'music_sort_newest': '按最新新增', 'music_sort_oldest': '按最早新增',
                'tieba_title': '貼吧', 'tieba_trending_wip': '熱搜頁面開發中...', 'tieba_nav_home': '首頁', 'tieba_nav_following': '關注', 'tieba_nav_trending': '熱搜', 'tieba_nav_me': '我', 'tieba_post_editor_title': '發表帖子', 'tieba_post_editor_author': '發帖人', 'tieba_post_editor_post_title': '帖子標題', 'tieba_post_editor_title_placeholder': '取個響亮的標題吧', 'tieba_post_editor_post_content': '帖子內容', 'tieba_post_editor_content_placeholder': '盡情分享你的想法...', 'tieba_post_editor_add_attachment': '新增附件', 'tieba_post_editor_location': '所在位置', 'tieba_profile_editor_title': '編輯個人資料', 'tieba_profile_editor_nickname': '暱稱', 'tieba_profile_editor_username': '使用者名稱 (@...)', 'tieba_profile_editor_signature': '個性簽名', 'tieba_profile_editor_followers': '粉絲數', 'tieba_post_detail_title': '帖子詳情', 'tieba_profile_detail_title': '個人主頁',
                'contacts_title': '聯絡人', 'contacts_placeholder': '還沒有聯絡人，點擊右上角「+」建立一個吧。', 'contact_editor_title_create': '建立聯絡人', 'contact_editor_title_edit': '編輯聯絡人', 'contact_editor_name': '名字', 'contact_editor_bio': '簡介', 'contact_editor_occupation': '身份/職業', 'contact_editor_wxid': 'wxid', 'contact_editor_qid': 'QID', 'contact_editor_qq': 'QQ號', 'contact_editor_persona': '設定', 'contact_editor_relationship': '關係', 'contact_editor_bind_user': '綁定的User', 'contact_editor_bind_worldbook': '綁定世界書', 'contact_editor_groups': '分組',
                'worldbook_title': '世界書', 'worldbook_placeholder': '還沒有世界書，點擊右上角「+」建立一本吧。', 'worldbook_editor_title_create': '建立世界書', 'worldbook_editor_title_edit': '編輯世界書', 'worldbook_editor_entry_title': '標題', 'worldbook_editor_category': '分類', 'worldbook_editor_depth': '深度', 'worldbook_editor_tags': '標籤 (輸入後按Enter)', 'worldbook_editor_add_tag': '新增標籤...', 'worldbook_editor_keywords': '關鍵詞 (用逗號或空格隔開)', 'worldbook_editor_trigger_by_keywords': '根據關鍵詞觸發', 'worldbook_editor_content': '內容',
                'settings_title': '設定', 'settings_language': '語言設定', 'settings_display_mode': '顯示模式', 'settings_font': '字體設定', 'settings_desktop': '桌面美化', 'settings_friends': '朋友圈設定', 'settings_bubble': '氣泡CSS渲染', 'settings_ui_adjustment': 'UI調整', 'settings_status_bar': '手機頂部狀態列圖示調整', 'settings_time': '時間感知', 'settings_main_api': '主API設定', 'settings_app_api': '應用API設定', 'settings_memory': '記憶總結', 'settings_blacklist': '黑名單', 'settings_data': '資料管理', 'settings_author': '原作者直達',
                'language_settings_title': '語言設定', 'language_zh_cn': '简体中文', 'language_zh_tw': '繁體中文', 'language_ko': '한국어',
                'display_mode_title': '顯示模式', 'display_mode_fullscreen': '全螢幕模式', 'display_mode_phone_frame': '手機邊框模式', 'display_mode_phone_frame_2': '手機邊框模式2 (待開發)',
                'font_settings_title': '字體設定', 'friends_settings_title': '朋友圈設定', 'friends_settings_probability': 'Char發動態機率', 'friends_settings_time_slot': 'Char發動態時間段', 'bubble_settings_title': '氣泡CSS渲染', 'bubble_settings_shape': '調整氣泡形狀', 'bubble_shape_rounded': '圓角', 'bubble_shape_circular': '圓形', 'bubble_shape_square': '方形', 'ui_adjustment_title': 'UI調整', 'ui_adjustment_icon_size': '桌面圖示大小', 'ui_adjustment_top_nav_height': '頂部導覽列高度', 'ui_adjustment_bottom_nav_height': '底部導覽列高度', 'ui_adjustment_element_base_size': '功能UI大小', 'ui_style_title': 'UI風格', 'ui_style_default': '預設ins風格', 'ui_style_line': '黑白線條簡約風格', 'status_bar_settings_title': '狀態列圖示調整', 'status_bar_settings_icon_size': '圖示大小', 'desktop_settings_title': '桌面美化', 'desktop_settings_change_wallpaper': '更換桌布', 'desktop_settings_change_icons': '更換應用圖示',
                'time_settings_title': '時間感知', 'time_settings_enable': '開啟時間感知', 'time_settings_description': '開啟後，AI將能感知並回應現實時間與節日。',
                                'main_api_settings_title': '메인 API 설정', 'app_api_settings_title': '앱 API 설정', 'api_settings_chat_tab': '채팅 API', 'api_settings_vision_tab': '이미지 인식 API', 'api_settings_tieba_tab': '게시판 API', 'api_settings_use_main_api': '메인 API 사용',
                'memory_summary_title': '기억 요약', 'blacklist_title': '차단 목록',
                'data_management_title': '데이터 관리', 'data_management_backup_all': '전체 데이터 백업', 'data_management_backup_partial': '부분 데이터 백업', 'data_management_restore': '파일에서 데이터 복원', 'data_management_stats': '데이터 통계', 'data_management_clear_cache': '캐시 정리', 'data_management_clear_all': '모든 데이터 삭제',
            }
        };

        function t(key) {
            const lang = appData.settings.language || 'zh-CN';
            return translations[lang][key] || translations['zh-CN'][key] || `[${key}]`;
        }

        function applyTranslations() {
            document.querySelectorAll('[data-lang]').forEach(el => {
                el.textContent = t(el.dataset.lang);
            });
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.placeholder = t(el.dataset.langPlaceholder);
                } else {
                    el.textContent = t(el.dataset.langPlaceholder);
                }
            });
        }


        // --- 初始化与数据持久化 ---
        function getInitialAppData() {
            const white3DPresetCSS = `
.message-wrapper.message-right .message-bubble {
    position: relative;
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.95) 0%,
        rgba(248, 248, 248, 0.8) 100%);
    padding: 10px 14px;
    border-radius: 100px;
    box-shadow: 
        inset 2px 2px 4px rgba(0,0,0,0.1),
        inset -2px -2px 4px rgba(255,255,255,0.4);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(220, 220, 220, 0.2);
    color: #000000;
}

.message-wrapper.message-left .message-bubble {
    position: relative;
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.95) 0%,
        rgba(248, 248, 248, 0.8) 100%);
    padding: 10px 14px;
    border-radius: 100px;
    box-shadow: 
        inset -2px -2px 4px rgba(0,0,0,0.1),
        inset 2px 2px 4px rgba(255,255,255,0.4);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(220, 220, 220, 0.2);
    color: #000000;
}
`;
            const white3DPresetSettings = {
                css: white3DPresetCSS,
                borderRadius: '100px',
                user: { avatar: { size: 35, offsetX: 0, offsetY: 0 }, avatarFrame: { width: 43, height: 43, offsetX: -4, offsetY: -4 }, bubble: { offsetX: 0, offsetY: 0, paddingX: 10, paddingY: 14 } },
                char: { avatar: { size: 35, offsetX: 0, offsetY: 0 }, avatarFrame: { width: 43, height: 43, offsetX: -4, offsetY: -4 }, bubble: { offsetX: 0, offsetY: 0, paddingX: 10, paddingY: 14 } },
                consecutiveGap: 4,
                gap: { height: 12, width: 6 }
            };

            return {
                apps: [
                    { id: 'chat', name: '聊天', icon: 'fas fa-comment-dots' },
                    { id: 'worldBook', name: '世界书', icon: 'fas fa-book' },
                    { id: 'shopping', name: '商城', icon: 'fas fa-shopping-bag' },
                    { id: 'settings', name: '设置', icon: 'fas fa-cog' },
                    { id: 'music', name: '音乐', icon: 'fas fa-music' },
                    { id: 'tieba', name: '贴吧', icon: 'fas fa-comments' }
                ],
                settings: {
                    language: 'zh-CN',
                    displayMode: 'fullscreen',
                    font: { type: 'default', size: 15, weight: 'normal', style: 'normal', archives: [], customFontUrl: '', customFontData: '' },
                    bubble: { 
                        css: '', 
                        presets: [
                            { name: '白色立体版', settings: white3DPresetSettings }
                        ], 
                        borderRadius: '18px',
                        user: {
                            avatar: { size: 35, offsetX: 0, offsetY: 0 },
                            avatarFrame: { width: 43, height: 43, offsetX: -4, offsetY: -4 },
                            bubble: { offsetX: 0, offsetY: 0, paddingX: 12, paddingY: 8 }
                        },
                        char: {
                            avatar: { size: 35, offsetX: 0, offsetY: 0 },
                            avatarFrame: { width: 43, height: 43, offsetX: -4, offsetY: -4 },
                            bubble: { offsetX: 0, offsetY: 0, paddingX: 12, paddingY: 8 }
                        },
                        consecutiveGap: 4,
                        gap: { height: 12, width: 6 }
                    },
                    ui: {
                        iconSize: 28,
                        topNavHeight: 44,
                        bottomNavHeight: 50,
                        elementBaseSize: 16,
                        statusBarIconSize: 15,
                        style: 'default' // ★★★ 新增: UI风格
                    },
                    desktop: { 
                        wallpaper: '', 
                        icons: {}, 
                        copywriting: { 
                            lines: ["编辑你的心情", "...", "..."], 
                            avatar: '', 
                            style: 'white'
                        },
                        cardWidget: {
                            avatar: '',
                            background: '',
                            nickname: '你的昵称',
                            username: '@yourname',
                            address: '点击编辑地址',
                            signature: '点击编辑个性签名'
                        }
                    },
                    friends: {
                        postProbability: 20,
                        postTimeSlot: 'any'
                    },
                    mainApi: { provider: 'openai', endpoint: '', key: '', model: '', temperature: 1.0, repetition_penalty: 1.0, presets: [] },
                    chatApi: { useMain: false, provider: 'openai', endpoint: '', key: '', model: '', temperature: 1.0, repetition_penalty: 1.0, presets: [] },
                    visionApi: { useMain: false, provider: 'openai', endpoint: '', key: '', model: 'gpt-4-vision-preview', temperature: 0.5, presets: [] },
                    tiebaApi: { useMain: false, provider: 'openai', endpoint: '', key: '', model: '', temperature: 1.2, repetition_penalty: 1.0, presets: [] },
                    chatMode: 'offline',
                    blacklist: [],
                    timePerception: true,
                },
                contacts: [],
                contactGroups: [
                    { id: 'group_default', name: '默认好友' }
                ],
                worldbooks: [],
                chat: {
                    userProfiles: [],
                    activeProfileId: null,
                    wallet: { balance: 100000, currency: 'USD' },
                    transactions: [],
                    bankCards: [],
                    messages: {},
                    chatSettings: {},
                    stickers: []
                },
                friends: {
                    posts: []
                },
                shopping: {
                    categories: [],
                    products: [],
                    cart: [],
                    favorites: [],
                    purchases: [],
                    layout: 'grid',
                    activeCategory: 'all'
                },
                music: {
                    songs: [],
                    playlists: [],
                    favoriteSongIds: [],
                    recentlyPlayed: [], // { songId, playCount, lastPlayed, addedAt }
                    searchHistory: [],
                    settings: {
                        playbackRate: 1.0,
                        pitch: 1.0,
                        mode: 'sequence', // sequence, loop, shuffle
                        currentIndex: -1,
                        currentPlaylist: 'all',
                        searchEngine: 'netease',
                        recentlyPlayedSort: 'lastPlayed',
                        miniPlayerHidden: false
                    }
                },
                tieba: {
                    myProfile: {
                        id: 'tieba_user_self',
                        nickname: '我的贴吧昵称',
                        username: '@defaultUser2024',
                        signature: '编辑我的个性签名...',
                        avatar: '',
                        followers: 0,
                    },
                    posts: [],
                    categories: ["全部", "纯爱", "同人", "好物分享", "八卦", "挂人避雷", "娱乐圈", "小说推文", "cosplay", "漫展", "R18成人区"],
                    activeCategory: '全部',
                    users: {},
                }
            };
        }

        function saveData(silent = false) {
            try {
                const dataToSave = JSON.stringify(appData);
                localStorage.setItem('hakimiPhoneData', dataToSave);
                if (!silent) {
                    showiOSAlert(t('alert_save_success'));
                }
            } catch (e) {
                console.error("保存数据成功:", e);
                if (!silent) {
                    showiOSAlert(t('alert_save_success'));
                }
            }
        }

        function loadData() {
            let savedData = null;
            try {
                savedData = localStorage.getItem('hakimiPhoneData');
            } catch (e) {
                console.error("读取本地存储失败:", e);
                showiOSAlert(t('alert_load_failed'), e.message, 'error');
            }

            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    appData = deepMerge(getInitialAppData(), parsedData);
                } catch (e) {
                    console.error("解析已存数据失败，将使用默认数据:", e);
                    showiOSAlert(t('alert_parse_failed'), e.message, 'error');
                    appData = getInitialAppData();
                }
            } else {
                appData = getInitialAppData();
            }
            
            // 确保新旧数据结构兼容
            if (!appData.settings.displayMode) appData.settings.displayMode = 'fullscreen';
            if (!appData.settings.mainApi) appData.settings.mainApi = getInitialAppData().settings.mainApi;
            if (!appData.settings.chatApi) appData.settings.chatApi = getInitialAppData().settings.chatApi;
            if (!appData.settings.visionApi) appData.settings.visionApi = getInitialAppData().settings.visionApi;
            if (!appData.settings.tiebaApi) appData.settings.tiebaApi = getInitialAppData().settings.tiebaApi;
            if (!appData.tieba) appData.tieba = getInitialAppData().tieba;
            if (!appData.tieba.posts) appData.tieba.posts = [];
            if (!appData.tieba.users) appData.tieba.users = {};
            if (!appData.music) appData.music = getInitialAppData().music;
            if (!appData.music.recentlyPlayed) appData.music.recentlyPlayed = [];
            if (!appData.music.settings.recentlyPlayedSort) appData.music.settings.recentlyPlayedSort = 'lastPlayed';
            if (!appData.music.searchHistory) appData.music.searchHistory = [];
            if (!appData.music.settings.searchEngine) appData.music.settings.searchEngine = 'netease';
            if (typeof appData.music.settings.miniPlayerHidden === 'undefined') appData.music.settings.miniPlayerHidden = false;
            if (!appData.settings.bubble.user || !appData.settings.bubble.char) {
                appData.settings.bubble.user = getInitialAppData().settings.bubble.user;
                appData.settings.bubble.char = getInitialAppData().settings.bubble.char;
                appData.settings.bubble.gap = getInitialAppData().settings.bubble.gap;
            }
            if (typeof appData.settings.bubble.borderRadius === 'undefined') {
                appData.settings.bubble.borderRadius = '18px';
            }
            if (!appData.settings.ui) appData.settings.ui = getInitialAppData().settings.ui;
            if (typeof appData.settings.ui.elementBaseSize === 'undefined') appData.settings.ui.elementBaseSize = 16;
            if (typeof appData.settings.ui.statusBarIconSize === 'undefined') appData.settings.ui.statusBarIconSize = 15;
            if (typeof appData.settings.ui.style === 'undefined') appData.settings.ui.style = 'default'; // ★★★ 新增
            if (typeof appData.settings.chatApi.useMain === 'undefined') appData.settings.chatApi.useMain = false;
            if (typeof appData.settings.visionApi.useMain === 'undefined') appData.settings.visionApi.useMain = false;
            if (typeof appData.settings.tiebaApi.useMain === 'undefined') appData.settings.tiebaApi.useMain = false;
            if (typeof appData.settings.language === 'undefined') appData.settings.language = 'zh-CN';
            if (!appData.settings.desktop.copywriting) appData.settings.desktop.copywriting = getInitialAppData().settings.desktop.copywriting;
            if (!appData.settings.desktop.copywriting.avatar) appData.settings.desktop.copywriting.avatar = '';
            if (!appData.settings.desktop.copywriting.style) appData.settings.desktop.copywriting.style = 'white';
            if (!appData.settings.desktop.cardWidget) appData.settings.desktop.cardWidget = getInitialAppData().settings.desktop.cardWidget;
            if (!appData.chat.chatSettings) appData.chat.chatSettings = {};
            Object.keys(appData.chat.chatSettings).forEach(contactId => {
                if (!appData.chat.chatSettings[contactId].replyCount) {
                    appData.chat.chatSettings[contactId].replyCount = { min: 1, max: 8 };
                }
            });
            if (!appData.contactGroups.find(g => g.id === 'group_default')) {
                appData.contactGroups.unshift({ id: 'group_default', name: '默认好友' });
            }
            if (!appData.settings.friends) {
                appData.settings.friends = getInitialAppData().settings.friends;
            }
            if (!appData.settings.friends.postTimeSlot) {
                appData.settings.friends.postTimeSlot = 'any';
            }


            initializeShoppingData();
            initializeTiebaData();
        }

        function deepMerge(target, source) {
            for (const key in source) {
                if (source.hasOwnProperty(key)) {
                    if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key]) && target[key] && typeof target[key] === 'object') {
                        deepMerge(target[key], source[key]);
                    } else {
                        target[key] = source[key];
                    }
                }
            }
            const defaultObj = getInitialAppData();
            for (const key in defaultObj) {
                if (!target.hasOwnProperty(key)) {
                    target[key] = defaultObj[key];
                }
            }
            return target;
        }

        function applyLoadedSettings() {
            applyDisplayMode(appData.settings.displayMode, false);
            applyFontSettings(appData.settings.font, false);
            applyBubbleSettings(appData.settings.bubble, false);
            applyUiStyle(appData.settings.ui.style, false); // ★★★ 新增
            applyUiAdjustments(appData.settings.ui, false);
            applyStatusBarSettings(appData.settings.ui, false);
            if (appData.settings.desktop.wallpaper) {
                document.getElementById('homeScreen').style.backgroundImage = `url(${appData.settings.desktop.wallpaper})`;
            }
            setChatMode(appData.settings.chatMode, false);
            
            document.documentElement.lang = appData.settings.language.split('-')[0];
            applyTranslations();

            renderAppIcons();
            renderWidgets();
            renderMePage();
            updateDynamicIsland();
        }

        function initializeShoppingData() {
            if (!appData.shopping) appData.shopping = getInitialAppData().shopping;
            if (appData.shopping.categories.length === 0) {
                appData.shopping.categories = [
                    "经期用品", "女装", "男装", "外卖", "数码产品", "虚拟商品", "节日礼物", "情趣用品", "医用品"
                ];
            }
            if (appData.shopping.products.length === 0) {
                const sampleProducts = [
                    { name: '安心日用卫生巾', price: 29.9, category: '经期用品', store: '舒适生活馆', image: 'https://via.placeholder.com/150/FFC0CB/000000?text=Pad' },
                    { name: '超长夜用安心裤', price: 45.5, category: '经期用品', store: '舒适生活馆', image: 'https://via.placeholder.com/150/FFB6C1/000000?text=Pant' },
                    { name: '便携式棉条', price: 59.9, category: '经期用品', store: '她之密语', image: 'https://via.placeholder.com/150/FFA07A/000000?text=Tampon' },
                    { name: '暖宫贴', price: 19.9, category: '暖心小屋', store: '暖心小屋', image: 'https://via.placeholder.com/150/F08080/000000?text=Warm' },
                    { name: '法式复古连衣裙', price: 399, category: '女装', store: '衣橱的诗', image: 'https://via.placeholder.com/150/87CEFA/000000?text=Dress' },
                    { name: '高腰阔腿牛仔裤', price: 259, category: '女装', store: '潮流前线', image: 'https://via.placeholder.com/150/4682B4/FFFFFF?text=Jeans' },
                    { name: '针织开衫', price: 188, category: '女装', store: '柔软时光', image: 'https://via.placeholder.com/150/DDA0DD/000000?text=Knit' },
                    { name: '真丝吊带睡裙', price: 499, category: '女装', store: '梦境私语', image: 'https://via.placeholder.com/150/E6E6FA/000000?text=Silk' },
                    { name: '纯棉白T恤', price: 99, category: '男装', store: '基础优品', image: 'https://via.placeholder.com/150/F5F5F5/000000?text=Tee' },
                    { name: '工装束脚裤', price: 289, category: '男装', store: '都市行者', image: 'https://via.placeholder.com/150/696969/FFFFFF?text=Pants' },
                    { name: '连帽卫衣', price: 329, category: '男装', store: '街头玩家', image: 'https://via.placeholder.com/150/A9A9A9/FFFFFF?text=Hoodie' },
                    { name: '商务休闲衬衫', price: 450, category: '男装', store: '精英衣舍', image: 'https://via.placeholder.com/150/B0C4DE/000000?text=Shirt' },
                    { name: '豪华海鲜披萨', price: 88, category: '外卖', store: '马上到美食', image: 'https://via.placeholder.com/150/FFD700/000000?text=Pizza' },
                    { name: '日式鳗鱼饭套餐', price: 68, category: '外卖', store: '和风食堂', image: 'https://via.placeholder.com/150/8B4513/FFFFFF?text=Unagi' },
                    { name: '麻辣小龙虾', price: 128, category: '外卖', store: '夜宵江湖', image: 'https://via.placeholder.com/150/DC143C/FFFFFF?text=Cray' },
                    { name: '水果捞', price: 35, category: '外卖', store: '鲜果派对', image: 'https://via.placeholder.com/150/90EE90/000000?text=Fruit' },
                    { name: '降噪蓝牙耳机', price: 1299, category: '数码产品', store: '极客仓库', image: 'https://via.placeholder.com/150/000000/FFFFFF?text=HDP' },
                    { name: '机械键盘', price: 699, category: '电竞部落', store: '电竞部落', image: 'https://via.placeholder.com/150/1E90FF/FFFFFF?text=KB' },
                    { name: '便携投影仪', price: 2499, category: '数码产品', store: '光影之家', image: 'https://via.placeholder.com/150/483D8B/FFFFFF?text=Proj' },
                    { name: '智能手表', price: 1899, category: '数码产品', store: '未来穿戴', image: 'https://via.placeholder.com/150/778899/FFFFFF?text=Watch' },
                    { name: '游戏月卡', price: 30, category: '虚拟商品', store: '数字娱乐站', image: 'https://via.placeholder.com/150/9932CC/FFFFFF?text=Game' },
                    { name: '视频会员年费', price: 198, category: '虚拟商品', store: '影音时空', image: 'https://via.placeholder.com/150/FF1493/FFFFFF?text=VIP' },
                    { name: '软件激活码', price: 299, category: '虚拟商品', store: '效率工坊', image: 'https://via.placeholder.com/150/00CED1/000000?text=Code' },
                    { name: '知识付费课程', price: 99, category: '虚拟商品', store: '学海无涯', image: 'https://via.placeholder.com/150/3CB371/FFFFFF?text=Course' },
                    { name: '永生花礼盒', price: 520, category: '节日礼物', store: '爱意永恒', image: 'https://via.placeholder.com/150/DB7093/FFFFFF?text=Flower' },
                    { name: '定制情侣对戒', price: 1314, category: '节日礼物', store: '唯一印记', image: 'https://via.placeholder.com/150/C0C0C0/000000?text=Ring' },
                    { name: '手工巧克力', price: 188, category: '节日礼物', store: '甜蜜工坊', image: 'https://via.placeholder.com/150/D2691E/FFFFFF?text=Choco' },
                    { name: '香薰蜡烛套装', price: 268, category: '节日礼物', store: '芬芳秘境', image: 'https://via.placeholder.com/150/FAFAD2/000000?text=Candle' },
                    { name: '遥控跳蛋', price: 299, category: '情趣用品', store: '极乐园', image: 'https://via.placeholder.com/150/FF69B4/FFFFFF?text=Vibe' },
                    { name: '情趣内衣', price: 199, category: '情趣用品', store: '午夜玫瑰', image: 'https://via.placeholder.com/150/8B0000/FFFFFF?text=Lingerie' },
                    { name: '润滑液', price: 89, category: '情趣用品', store: '水漾之爱', image: 'https://via.placeholder.com/150/ADD8E6/000000?text=Lube' },
                    { name: '捆绑束缚带', price: 159, category: '情趣用品', store: '暗夜游戏', image: 'https://via.placeholder.com/150/2F4F4F/FFFFFF?text=Rope' },
                    { name: '创可贴组合装', price: 15.9, category: '医用品', store: '家庭药箱', image: 'https://via.placeholder.com/150/F5DEB3/000000?text=BandAid' },
                    { name: '碘伏消毒液', price: 9.9, category: '医用品', store: '健康守护', image: 'https://via.placeholder.com/150/DAA520/FFFFFF?text=Iodine' },
                    { name: '紧急避孕药', price: 78, category: '医用品', store: '安心药房', image: 'https://via.placeholder.com/150/4682B4/FFFFFF?text=Pill' },
                    { name: '医用纱布', price: 25, category: '医用品', store: '家庭药箱', image: 'https://via.placeholder.com/150/FFFFFF/000000?text=Gauze' },
                ];
                appData.shopping.products = sampleProducts.map((p, i) => ({ id: `prod_${Date.now()}_${i}`, ...p }));
            }
        }

        function initializeTiebaData() {
            if (appData.tieba.posts.length === 0) {
                appData.tieba.posts = []; 
            }
        }

        const exchangeRates = {
            USD: { rate: 1, symbol: '$' },
            CNY: { rate: 7.25, symbol: '¥' },
            EUR: { rate: 0.92, symbol: '€' },
            KRW: { rate: 1377, symbol: '₩' },
            GBP: { rate: 0.79, symbol: '£' }
        };

        let currentEditingContactId = null;
        let currentEditingWorldBookId = null;
        let currentEditingUserId = null;
        let currentChatContactId = null;
        let cropper = null;
        let tempAvatarData = { type: null, data: null };
        let currentAvatarTarget = { type: null, id: null };
        let currentTurnId = null;
        let multiSelectMode = false;
        let selectedMessages = new Set();
        let currentEditingPost = {
            id: null,
            content: '',
            files: [],
            location: '',
            visibility: { type: 'all', allowed: [] }
        };
        let currentEditingTiebaPost = {
            id: null,
            title: '',
            content: '',
            files: [],
            location: ''
        };
        let tempFileData = { name: null, data: null, type: null, size: 0 };
        let tempFontSettings = {};
        let tempBubbleSettings = {};
        let tempUiSettings = {};
        let musicAudioElement = new Audio();
        let tempMusicImportData = {};
        let tiebaLongPressTimer;
        let parsedLyrics = [];
        let currentLyricIndex = -1;
        let tempUiStyle = 'default'; // ★★★ 新增

        // --- 核心渲染函数 ---
        function renderAppIcons() {
            const appGrid = document.getElementById('appGrid');
            appGrid.innerHTML = '';
            appData.apps.forEach(app => {
                const customIcon = appData.settings.desktop.icons[app.id];
                const iconContent = customIcon ? '' : `<i class="${app.icon}" style="color: var(--primary-text);"></i>`;
                const backgroundStyle = customIcon ? `background-image: url(${customIcon});` : `background: white;`;

                const appIconHTML = `
                    <div class="app-icon-wrapper" onclick="openApp('${app.id}')">
                        <div class="app-icon-image" id="icon-img-${app.id}" style="${backgroundStyle}">
                            ${iconContent}
                        </div>
                        <div class="app-icon-name" data-lang="app_${app.id}">${t('app_' + app.id)}</div>
                    </div>
                `;
                appGrid.innerHTML += appIconHTML;
            });
        }

        // --- 系统基础功能 ---
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: '2-digit', hour12: false });
            const dateString = now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('homeTime').textContent = timeString;
            document.getElementById('statusTime').textContent = timeString;
            document.getElementById('homeDate').textContent = dateString;
        }
        
        function updateBattery() {
            if (navigator.getBattery) {
                navigator.getBattery().then(battery => {
                    const level = Math.floor(battery.level * 100);
                    document.getElementById('batteryLevel').style.width = `${level}%`;
                    document.getElementById('batteryText').textContent = level;
                });
            } else {
                const randomLevel = parseInt(document.getElementById('batteryText').textContent) || 85;
                document.getElementById('batteryLevel').style.width = `${randomLevel}%`;
            }
        }
        
        // --- 应用导航 ---
        function openApp(appId) {
            const containerId = `${appId}Container`;
            const container = document.getElementById(containerId);
            if (container) {
                container.classList.add('active');
                if (appId === 'settings') closeAllSubPages();
                if (appId === 'worldBook') renderWorldBookList();
                if (appId === 'chat') renderChatApp();
                if (appId === 'shopping') renderShoppingApp();
                if (appId === 'music') renderMusicApp();
                if (appId === 'tieba') renderTiebaApp();
            }
        }
        
        function closeApp(appId) {
            document.getElementById(`${appId}Container`).classList.remove('active');
        }

        function openSubPage(pageId) {
            closeAllSubPages(pageId);
            const container = document.getElementById(`${pageId}Container`);
            if (container) {
                container.classList.add('active');
            }
            
            if (pageId === 'languageSettings') renderLanguageSettingsPage();
            if (pageId === 'displayModeSettings') renderDisplayModeSettingsPage();
            if (pageId === 'fontSettings') renderFontSettingsPage();
            if (pageId === 'friendsSettings') renderFriendsSettingsPage();
            if (pageId === 'bubbleCssSettings') renderBubbleCssSettingsPage();
            if (pageId === 'uiAdjustment') renderUiAdjustmentPage();
            if (pageId === 'statusBarSettings') renderStatusBarSettingsPage();
            if (pageId === 'desktopBeautification') renderDesktopBeautificationPage();
            if (pageId === 'mainApiSettings') renderMainApiSettingsPage();
            if (pageId === 'apiSettings') renderApiSettingsPage();
            if (pageId === 'memorySummary') renderMemorySummaryContactList();
            if (pageId === 'bankCard') renderBankCards();
            if (pageId === 'wallet') renderWallet();
            if (pageId === 'transactionHistory') renderTransactionHistory();
            if (pageId === 'myProfiles') renderMyProfilesList();
            if (pageId === 'blacklist') renderBlacklist();
            if (pageId === 'dataManagement') renderDataManagementPage();
            if (pageId === 'timePerceptionSettings') renderTimePerceptionSettingsPage();
            if (pageId === 'musicPlaylists') renderPlaylists();
            if (pageId === 'favoriteSongs') renderFavoriteSongs();
            if (pageId === 'localMusic') renderLocalMusicList();
            if (pageId === 'recentlyPlayed') renderRecentlyPlayed();
            if (pageId === 'uiStyleSettings') renderUiStyleSettingsPage(); // ★★★ 新增
        }

        function closeSubPage(pageId) {
            const container = document.getElementById(`${pageId}Container`);
            if (container) {
                container.classList.remove('active');
            }
        }

        function closeAllSubPages(excludePage = '') {
            document.querySelectorAll('.app-container').forEach(el => {
                if (el.id.endsWith('Container') && el.id !== `${excludePage}Container`) {
                    const isMainApp = appData.apps.some(app => `${app.id}Container` === el.id);
                    if (!isMainApp) {
                        el.classList.remove('active');
                    }
                }
            });
        }
        
        function returnToHome() {
            document.querySelectorAll('.app-container.active').forEach(el => el.classList.remove('active'));
        }

        // --- 设置 App: 语言设置 ---
        function renderLanguageSettingsPage() {
            const container = document.getElementById('language-list');
            const languages = [
                { code: 'zh-CN', name: '简体中文' },
                { code: 'zh-TW', name: '繁體中文' },
                { code: 'ko', name: '한국어' }
            ];
            
            container.innerHTML = languages.map(lang => `
                <div class="glass-list-item" onclick="setLanguage('${lang.code}')">
                    <span class="item-text">${lang.name}</span>
                    ${appData.settings.language === lang.code ? '<i class="fas fa-check" style="color: var(--theme-color);"></i>' : ''}
                </div>
            `).join('');
        }

        function setLanguage(langCode) {
            appData.settings.language = langCode;
            saveData(true);
            document.documentElement.lang = langCode.split('-')[0];
            applyTranslations();
            renderLanguageSettingsPage();
            renderAppIcons();
            showiOSAlert(t('alert_save_success'));
        }

        // --- 设置 App: 显示模式 ---
        function renderDisplayModeSettingsPage() {
            const container = document.getElementById('display-mode-list');
            const modes = [
                { id: 'fullscreen', name: t('display_mode_fullscreen') },
                { id: 'phone_frame_1', name: t('display_mode_phone_frame') },
                { id: 'phone_frame_2', name: t('display_mode_phone_frame_2'), disabled: true }
            ];
            
            container.innerHTML = modes.map(mode => `
                <div class="glass-list-item" onclick="${mode.disabled ? '' : `applyDisplayMode('${mode.id}', true)`}" style="${mode.disabled ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                    <span class="item-text">${mode.name}</span>
                    ${appData.settings.displayMode === mode.id ? '<i class="fas fa-check" style="color: var(--theme-color);"></i>' : ''}
                </div>
            `).join('');
        }

        function applyDisplayMode(mode, doSave = false) {
            appData.settings.displayMode = mode;
            const body = document.body;
            const root = document.documentElement;
            
            if (mode === 'phone_frame_1') {
                body.classList.add('phone-frame-mode');
                root.style.setProperty('--global-font-size', `8px`);
                root.style.setProperty('--global-icon-size', `20px`);
                root.style.setProperty('--ui-element-base-size', `10px`);
                root.style.setProperty('--global-top-nav-height', `60px`);
                root.style.setProperty('--global-bottom-nav-height', `70px`);
                root.style.setProperty('--status-bar-icon-size', `12px`);
            } else { // fullscreen
                body.classList.remove('phone-frame-mode');
                applyUiAdjustments(appData.settings.ui, false);
                applyStatusBarSettings(appData.settings.ui, false);
            }

            if (doSave) {
                saveData();
                renderDisplayModeSettingsPage();
            }
        }

        // --- 设置 App: 字体设置 ---
        function renderFontSettingsPage() {
            const container = document.getElementById('fontSettingsContent');
            tempFontSettings = JSON.parse(JSON.stringify(appData.settings.font));

            const fontArchivesOptions = (tempFontSettings.archives || []).map((archive, index) => 
                `<option value="${index}">${archive.name}</option>`
            ).join('');

            container.innerHTML = `
                <div class="glass-form-group">
                    <label>字体预设</label>
                    <div class="segmented-control">
                        <button class="font-preset-btn" data-font-type="default">默认</button>
                        <button class="font-preset-btn" data-font-type="preset1">预设一</button>
                        <button class="font-preset-btn" data-font-type="preset2">预设二</button>
                        <button class="font-preset-btn" data-font-type="custom">自定义</button>
                    </div>
                </div>
                <div class="glass-form-group">
                    <label>字体大小: <span id="font-size-value">${tempFontSettings.size}</span>px</label>
                    <input type="range" id="font-size-slider" min="5" max="27" step="1" value="${tempFontSettings.size}">
                </div>
                <div class="glass-form-group">
                    <label>字体粗细</label>
                    <select id="font-weight-select" class="glass-select">
                        <option value="100">100 (Thin)</option>
                        <option value="300">300 (Light)</option>
                        <option value="normal">400 (Normal)</option>
                        <option value="600">600 (Semi-Bold)</option>
                        <option value="bold">700 (Bold)</option>
                        <option value="900">900 (Black)</option>
                    </select>
                </div>
                <div class="glass-list-item" style="padding: 10px 15px;">
                    <span class="item-text">斜体</span>
                    <label class="switch"><input type="checkbox" id="font-style-toggle"><span class="slider"></span></label>
                </div>
                <div class="glass-form-group">
                    <label>字体存档</label>
                    <div class="form-row">
                        <select id="font-archive-select" class="glass-select" style="flex: 1;">
                            <option value="-1">选择存档...</option>
                            ${fontArchivesOptions}
                        </select>
                        <button class="glass-button" onclick="saveFontArchive()"><i class="fas fa-save"></i></button>
                        <button class="glass-button" style="background-color: #FF3B30;" onclick="deleteFontArchive()"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="glass-form-group">
                    <label>导入字体 (URL)</label>
                    <input type="text" id="font-url-input" class="glass-input" placeholder="输入 .ttf, .woff, .woff2 链接..." value="${tempFontSettings.customFontUrl || ''}">
                </div>
                <div class="glass-form-group">
                    <label>导入字体 (文件)</label>
                    <input type="file" id="font-file-input" accept=".ttf,.woff,.woff2" style="display:none;">
                    <button class="glass-button" style="background-color: #8e8e93;" onclick="document.getElementById('font-file-input').click()">选择字体文件</button>
                </div>
                <div class="glass-form-group">
                    <label>字体预览</label>
                    <p id="font-preview" style="padding: 20px; background: rgba(255,255,255,0.5); border-radius: 8px; text-align: center;">Hello, World. 你好，世界。</p>
                </div>
            `;
            
            document.getElementById('font-weight-select').value = tempFontSettings.weight;
            document.getElementById('font-style-toggle').checked = tempFontSettings.style === 'italic';
            document.querySelector(`.font-preset-btn[data-font-type="${tempFontSettings.type}"]`).classList.add('active');

            updateFontPreview();

            document.querySelectorAll('.font-preset-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.font-preset-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    tempFontSettings.type = btn.dataset.fontType;
                    updateFontPreview();
                };
            });
            document.getElementById('font-size-slider').oninput = e => {
                tempFontSettings.size = e.target.value;
                document.getElementById('font-size-value').textContent = e.target.value;
                updateFontPreview();
            };
            document.getElementById('font-weight-select').onchange = e => {
                tempFontSettings.weight = e.target.value;
                updateFontPreview();
            };
            document.getElementById('font-style-toggle').onchange = e => {
                tempFontSettings.style = e.target.checked ? 'italic' : 'normal';
                updateFontPreview();
            };
            document.getElementById('font-url-input').oninput = e => {
                tempFontSettings.customFontUrl = e.target.value;
                tempFontSettings.customFontData = '';
                tempFontSettings.type = 'custom';
                document.querySelectorAll('.font-preset-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`.font-preset-btn[data-font-type="custom"]`).classList.add('active');
                updateFontPreview();
            };
            document.getElementById('font-file-input').onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        tempFontSettings.customFontData = ev.target.result;
                        tempFontSettings.customFontUrl = '';
                        tempFontSettings.type = 'custom';
                        document.querySelectorAll('.font-preset-btn').forEach(b => b.classList.remove('active'));
                        document.querySelector(`.font-preset-btn[data-font-type="custom"]`).classList.add('active');
                        updateFontPreview();
                    };
                    reader.readAsDataURL(file);
                }
            };
            document.getElementById('font-archive-select').onchange = e => {
                const index = e.target.value;
                if (index > -1) {
                    const archive = appData.settings.font.archives[index];
                    tempFontSettings = JSON.parse(JSON.stringify(archive.settings));
                    renderFontSettingsPage();
                }
            };
        }

        function updateFontPreview() {
            const preview = document.getElementById('font-preview');
            if (!preview) return;

            const fontMap = {
                'default': 'var(--default-font)',
                'preset1': "'PresetFont1', var(--default-font)",
                'preset2': "'PresetFont2', var(--default-font)",
                'custom': "'CustomFont', var(--default-font)"
            };

            const dynamicStyle = document.getElementById('dynamic-font-style');
            if (tempFontSettings.type === 'custom') {
                let src = '';
                if (tempFontSettings.customFontUrl) {
                    src = `url('${tempFontSettings.customFontUrl}')`;
                } else if (tempFontSettings.customFontData) {
                    src = `url('${tempFontSettings.customFontData}')`;
                }
                dynamicStyle.innerHTML = `@font-face { font-family: 'CustomFont'; src: ${src}; }`;
            } else {
                dynamicStyle.innerHTML = '';
            }

            preview.style.fontFamily = fontMap[tempFontSettings.type];
            preview.style.fontSize = `${tempFontSettings.size}px`;
            preview.style.fontWeight = tempFontSettings.weight;
            preview.style.fontStyle = tempFontSettings.style;
        }

        function applyCurrentFontSettings() {
            appData.settings.font = JSON.parse(JSON.stringify(tempFontSettings));
            applyFontSettings(appData.settings.font, true);
        }

        function applyFontSettings(settings, doSave = false) {
            const root = document.documentElement;
            const fontMap = {
                'default': 'var(--default-font)',
                'preset1': "'PresetFont1', var(--default-font)",
                'preset2': "'PresetFont2', var(--default-font)",
                'custom': "'CustomFont', var(--default-font)"
            };

            const dynamicStyle = document.getElementById('dynamic-font-style');
            if (settings.type === 'custom') {
                let src = '';
                if (settings.customFontUrl) {
                    src = `url('${settings.customFontUrl}')`;
                } else if (settings.customFontData) {
                    src = `url('${settings.customFontData}')`;
                }
                dynamicStyle.innerHTML = `@font-face { font-family: 'CustomFont'; src: ${src}; }`;
            } else {
                dynamicStyle.innerHTML = '';
            }

            root.style.setProperty('--current-font', fontMap[settings.type]);
            root.style.setProperty('--global-font-size', `${settings.size}px`);
            root.style.setProperty('--global-font-weight', settings.weight);
            root.style.setProperty('--global-font-style', settings.style);

            if (doSave) {
                saveData();
            }
        }

        function saveFontArchive() {
            const name = prompt("请输入字体存档名称:");
            if (name && name.trim()) {
                if (!appData.settings.font.archives) appData.settings.font.archives = [];
                appData.settings.font.archives.push({
                    name: name.trim(),
                    settings: JSON.parse(JSON.stringify(tempFontSettings))
                });
                saveData();
                renderFontSettingsPage();
            }
        }

        function deleteFontArchive() {
            const select = document.getElementById('font-archive-select');
            const index = select.value;
            if (index > -1) {
                const archiveName = appData.settings.font.archives[index].name;
                if (confirm(`确定要删除存档“${archiveName}”吗？`)) {
                    appData.settings.font.archives.splice(index, 1);
                    saveData();
                    renderFontSettingsPage();
                }
            } else {
                showiOSAlert(t('common_info'), '请先选择一个要删除的存档。');
            }
        }

        // --- 朋友圈设置 ---
        function renderFriendsSettingsPage() {
            const container = document.getElementById('friendsSettingsContainer').querySelector('.app-content');
            const probability = appData.settings.friends.postProbability;
            const timeSlot = appData.settings.friends.postTimeSlot;

            document.getElementById('friends-probability-value').textContent = probability;
            document.getElementById('friends-probability-slider').value = probability;
            document.getElementById('friends-time-slot-select').value = timeSlot;

            document.getElementById('friends-probability-slider').oninput = e => {
                document.getElementById('friends-probability-value').textContent = e.target.value;
            };
        }

        function saveFriendsSettings() {
            const probability = document.getElementById('friends-probability-slider').value;
            const timeSlot = document.getElementById('friends-time-slot-select').value;
            appData.settings.friends.postProbability = parseInt(probability);
            appData.settings.friends.postTimeSlot = timeSlot;
            saveData();
        }

        // --- 设置 App: 气泡CSS渲染 ---
        function renderBubbleCssSettingsPage() {
            const container = document.getElementById('bubbleCssSettingsContent');
            tempBubbleSettings = JSON.parse(JSON.stringify(appData.settings.bubble));

            const presetsOptions = (tempBubbleSettings.presets || []).map((preset, index) => 
                `<option value="${index}">${preset.name}</option>`
            ).join('');
            
            const exampleCss = `/* 示例：通用气泡美化代码 */
/* 适用于所有消息气泡的基础样式 */
.message-bubble {
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    transition: transform 0.2s ease;
}
.message-bubble:active {
    transform: scale(0.95);
}

/* 语音气泡的特殊样式 */
.voice-bubble {
    background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
}
.message-wrapper.message-right .voice-bubble {
    background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
}

/* 转账气泡的特殊样式 */
.transfer-bubble {
    background: linear-gradient(135deg, #ffeb3b, #fdd835);
    border: none;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.transfer-bubble .transfer-amount {
    color: #424242;
}
`;

            container.innerHTML = `
                <div class="glass-form-group">
                    <label>气泡预览</label>
                    <div id="bubble-preview-area" style="padding: 20px; background: #e9e9e9; border-radius: 8px; min-height: 280px; overflow: hidden; display: flex; flex-direction: column; gap: 10px;">
                        <div class="message-wrapper message-left">
                            <div class="message-avatar-wrapper"><div class="message-avatar" style="background-color: #ccc;"></div><div class="message-avatar-frame"></div></div>
                            <div class="message-content-wrapper"><div class="message-bubble">对方的消息气泡</div></div>
                        </div>
                        <div class="message-wrapper message-right">
                            <div class="message-avatar-wrapper"><div class="message-avatar" style="background-color: #a1c4fd;"></div><div class="message-avatar-frame"></div></div>
                            <div class="message-content-wrapper"><div class="message-bubble">我的消息气泡</div></div>
                        </div>
                        <div class="message-wrapper message-left">
                            <div class="message-avatar-wrapper"><div class="message-avatar" style="background-color: #ccc;"></div><div class="message-avatar-frame"></div></div>
                            <div class="message-content-wrapper"><div class="message-bubble voice-bubble"><i class="fas fa-play voice-icon"></i><div class="voice-wave-container">${'<div class="voice-wave-bar"></div>'.repeat(5)}</div><span class="voice-duration">12s</span></div></div>
                        </div>
                    </div>
                </div>

                <div class="glass-form-group">
                    <label data-lang="bubble_settings_shape">调整气泡形状</label>
                    <div class="segmented-control" id="bubble-shape-control">
                        <button data-shape="rounded">${t('bubble_shape_rounded')}</button>
                        <button data-shape="circular">${t('bubble_shape_circular')}</button>
                        <button data-shape="square">${t('bubble_shape_square')}</button>
                    </div>
                </div>

                <div class="glass-form-group">
                    <label>通用间距</label>
                    <div class="player-slider-group">
                        <label>头像与气泡间距: <span id="avatar-gap-value">${tempBubbleSettings.gap.width}</span>px</label>
                        <input type="range" id="avatar-gap-slider" min="0" max="20" step="1" value="${tempBubbleSettings.gap.width}">
                    </div>
                    <div class="player-slider-group">
                        <label>连续气泡间距: <span id="consecutive-gap-value">${tempBubbleSettings.consecutiveGap}</span>px</label>
                        <input type="range" id="consecutive-gap-slider" min="0" max="20" step="1" value="${tempBubbleSettings.consecutiveGap}">
                    </div>
                    <div class="player-slider-group">
                        <label>气泡上下间距: <span id="bubble-gap-height-value">${tempBubbleSettings.gap.height}</span>px</label>
                        <input type="range" id="bubble-gap-height-slider" min="0" max="20" step="1" value="${tempBubbleSettings.gap.height}">
                    </div>
                </div>

                <div class="glass-form-group">
                    <label>我的 (User) 头像与气泡</label>
                    <div class="player-slider-group"><label>头像大小: <span id="user-avatar-size-value">${tempBubbleSettings.user.avatar.size}</span>px</label><input type="range" id="user-avatar-size-slider" min="20" max="60" step="1" value="${tempBubbleSettings.user.avatar.size}"></div>
                    <div class="player-slider-group"><label>头像水平偏移: <span id="user-avatar-offset-x-value">${tempBubbleSettings.user.avatar.offsetX}</span>px</label><input type="range" id="user-avatar-offset-x-slider" min="-30" max="30" step="1" value="${tempBubbleSettings.user.avatar.offsetX}"></div>
                    <div class="player-slider-group"><label>头像垂直偏移: <span id="user-avatar-offset-y-value">${tempBubbleSettings.user.avatar.offsetY}</span>px</label><input type="range" id="user-avatar-offset-y-slider" min="-30" max="30" step="1" value="${tempBubbleSettings.user.avatar.offsetY}"></div>
                    <div class="player-slider-group"><label>气泡水平偏移: <span id="user-bubble-offset-x-value">${tempBubbleSettings.user.bubble.offsetX}</span>px</label><input type="range" id="user-bubble-offset-x-slider" min="-30" max="30" step="1" value="${tempBubbleSettings.user.bubble.offsetX}"></div>
                    <div class="player-slider-group"><label>气泡垂直偏移: <span id="user-bubble-offset-y-value">${tempBubbleSettings.user.bubble.offsetY}</span>px</label><input type="range" id="user-bubble-offset-y-slider" min="-30" max="30" step="1" value="${tempBubbleSettings.user.bubble.offsetY}"></div>
                    <div class="player-slider-group"><label>气泡左右内边距: <span id="user-bubble-padding-x-value">${tempBubbleSettings.user.bubble.paddingX}</span>px</label><input type="range" id="user-bubble-padding-x-slider" min="0" max="30" step="1" value="${tempBubbleSettings.user.bubble.paddingX}"></div>
                    <div class="player-slider-group"><label>气泡上下内边距: <span id="user-bubble-padding-y-value">${tempBubbleSettings.user.bubble.paddingY}</span>px</label><input type="range" id="user-bubble-padding-y-slider" min="0" max="30" step="1" value="${tempBubbleSettings.user.bubble.paddingY}"></div>
                </div>
                
                <div class="glass-form-group">
                    <label>对方 (Char) 头像与气泡</label>
                    <div class="player-slider-group"><label>头像大小: <span id="char-avatar-size-value">${tempBubbleSettings.char.avatar.size}</span>px</label><input type="range" id="char-avatar-size-slider" min="20" max="60" step="1" value="${tempBubbleSettings.char.avatar.size}"></div>
                    <div class="player-slider-group"><label>头像水平偏移: <span id="char-avatar-offset-x-value">${tempBubbleSettings.char.avatar.offsetX}</span>px</label><input type="range" id="char-avatar-offset-x-slider" min="-30" max="30" step="1" value="${tempBubbleSettings.char.avatar.offsetX}"></div>
                    <div class="player-slider-group"><label>头像垂直偏移: <span id="char-avatar-offset-y-value">${tempBubbleSettings.char.avatar.offsetY}</span>px</label><input type="range" id="char-avatar-offset-y-slider" min="-30" max="30" step="1" value="${tempBubbleSettings.char.avatar.offsetY}"></div>
                    <div class="player-slider-group"><label>气泡水平偏移: <span id="char-bubble-offset-x-value">${tempBubbleSettings.char.bubble.offsetX}</span>px</label><input type="range" id="char-bubble-offset-x-slider" min="-30" max="30" step="1" value="${tempBubbleSettings.char.bubble.offsetX}"></div>
                    <div class="player-slider-group"><label>气泡垂直偏移: <span id="char-bubble-offset-y-value">${tempBubbleSettings.char.bubble.offsetY}</span>px</label><input type="range" id="char-bubble-offset-y-slider" min="-30" max="30" step="1" value="${tempBubbleSettings.char.bubble.offsetY}"></div>
                    <div class="player-slider-group"><label>气泡左右内边距: <span id="char-bubble-padding-x-value">${tempBubbleSettings.char.bubble.paddingX}</span>px</label><input type="range" id="char-bubble-padding-x-slider" min="0" max="30" step="1" value="${tempBubbleSettings.char.bubble.paddingX}"></div>
                    <div class="player-slider-group"><label>气泡上下内边距: <span id="char-bubble-padding-y-value">${tempBubbleSettings.char.bubble.paddingY}</span>px</label><input type="range" id="char-bubble-padding-y-slider" min="0" max="30" step="1" value="${tempBubbleSettings.char.bubble.paddingY}"></div>
                </div>

                <div class="glass-form-group">
                    <label>自定义气泡CSS</label>
                    <textarea id="bubble-css-input" class="glass-textarea" style="min-height: 200px; font-family: monospace;" placeholder="在此输入CSS代码...">${tempBubbleSettings.css || exampleCss}</textarea>
                </div>

                <div class="glass-form-group">
                    <label>CSS预设</label>
                    <div class="form-row">
                        <select id="bubble-preset-select" class="glass-select" style="flex: 1;">
                            <option value="-1">选择预设...</option>
                            ${presetsOptions}
                        </select>
                        <button class="glass-button" onclick="saveBubblePreset()"><i class="fas fa-save"></i></button>
                        <button class="glass-button" style="background-color: #FF3B30;" onclick="deleteBubblePreset()"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;

            updateBubblePreview();

            // Event Listeners
            document.getElementById('bubble-css-input').oninput = e => { tempBubbleSettings.css = e.target.value; updateBubblePreview(); };
            document.getElementById('avatar-gap-slider').oninput = e => { tempBubbleSettings.gap.width = e.target.value; document.getElementById('avatar-gap-value').textContent = e.target.value; updateBubblePreview(); };
            document.getElementById('consecutive-gap-slider').oninput = e => { tempBubbleSettings.consecutiveGap = e.target.value; document.getElementById('consecutive-gap-value').textContent = e.target.value; updateBubblePreview(); };
            document.getElementById('bubble-gap-height-slider').oninput = e => { tempBubbleSettings.gap.height = e.target.value; document.getElementById('bubble-gap-height-value').textContent = e.target.value; updateBubblePreview(); };

            ['user', 'char'].forEach(type => {
                document.getElementById(`${type}-avatar-size-slider`).oninput = e => { tempBubbleSettings[type].avatar.size = e.target.value; document.getElementById(`${type}-avatar-size-value`).textContent = e.target.value; updateBubblePreview(); };
                document.getElementById(`${type}-avatar-offset-x-slider`).oninput = e => { tempBubbleSettings[type].avatar.offsetX = e.target.value; document.getElementById(`${type}-avatar-offset-x-value`).textContent = e.target.value; updateBubblePreview(); };
                document.getElementById(`${type}-avatar-offset-y-slider`).oninput = e => { tempBubbleSettings[type].avatar.offsetY = e.target.value; document.getElementById(`${type}-avatar-offset-y-value`).textContent = e.target.value; updateBubblePreview(); };
                document.getElementById(`${type}-bubble-offset-x-slider`).oninput = e => { tempBubbleSettings[type].bubble.offsetX = e.target.value; document.getElementById(`${type}-bubble-offset-x-value`).textContent = e.target.value; updateBubblePreview(); };
                document.getElementById(`${type}-bubble-offset-y-slider`).oninput = e => { tempBubbleSettings[type].bubble.offsetY = e.target.value; document.getElementById(`${type}-bubble-offset-y-value`).textContent = e.target.value; updateBubblePreview(); };
                document.getElementById(`${type}-bubble-padding-x-slider`).oninput = e => { tempBubbleSettings[type].bubble.paddingX = e.target.value; document.getElementById(`${type}-bubble-padding-x-value`).textContent = e.target.value; updateBubblePreview(); };
                document.getElementById(`${type}-bubble-padding-y-slider`).oninput = e => { tempBubbleSettings[type].bubble.paddingY = e.target.value; document.getElementById(`${type}-bubble-padding-y-value`).textContent = e.target.value; updateBubblePreview(); };
            });
            
            document.getElementById('bubble-preset-select').onchange = e => {
                const index = e.target.value;
                if (index > -1) {
                    const preset = appData.settings.bubble.presets[index];
                    tempBubbleSettings = JSON.parse(JSON.stringify(preset.settings));
                    renderBubbleCssSettingsPage();
                }
            };

            const shapeControl = document.getElementById('bubble-shape-control');
            const shapeMap = { '18px': 'rounded', '100px': 'circular', '4px': 'square' };
            const currentShape = shapeMap[tempBubbleSettings.borderRadius] || 'rounded';
            shapeControl.querySelector(`[data-shape="${currentShape}"]`).classList.add('active');

            shapeControl.querySelectorAll('button').forEach(btn => {
                btn.onclick = () => {
                    shapeControl.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const shape = btn.dataset.shape;
                    if (shape === 'rounded') tempBubbleSettings.borderRadius = '18px';
                    else if (shape === 'circular') tempBubbleSettings.borderRadius = '100px';
                    else if (shape === 'square') tempBubbleSettings.borderRadius = '4px';
                    updateBubblePreview();
                };
            });
        }

        function updateBubblePreview() {
            const previewArea = document.getElementById('bubble-preview-area');
            if (!previewArea) return;

            const tempStyle = document.createElement('style');
            tempStyle.innerHTML = tempBubbleSettings.css;
            
            previewArea.style.setProperty('--avatar-gap', `${tempBubbleSettings.gap.width}px`);
            previewArea.style.setProperty('--consecutive-bubble-gap', `${tempBubbleSettings.consecutiveGap}px`);
            previewArea.style.setProperty('--bubble-gap-height', `${tempBubbleSettings.gap.height}px`);
            previewArea.style.setProperty('--bubble-border-radius', tempBubbleSettings.borderRadius);

            ['user', 'char'].forEach(type => {
                previewArea.style.setProperty(`--${type}-avatar-size`, `${tempBubbleSettings[type].avatar.size}px`);
                previewArea.style.setProperty(`--${type}-avatar-offset-x`, `${tempBubbleSettings[type].avatar.offsetX}px`);
                previewArea.style.setProperty(`--${type}-avatar-offset-y`, `${tempBubbleSettings[type].avatar.offsetY}px`);
                previewArea.style.setProperty(`--${type}-bubble-offset-x`, `${tempBubbleSettings[type].bubble.offsetX}px`);
                previewArea.style.setProperty(`--${type}-bubble-offset-y`, `${tempBubbleSettings[type].bubble.offsetY}px`);
                previewArea.style.setProperty(`--${type}-bubble-padding-x`, `${tempBubbleSettings[type].bubble.paddingX}px`);
                previewArea.style.setProperty(`--${type}-bubble-padding-y`, `${tempBubbleSettings[type].bubble.paddingY}px`);
            });

            const oldStyle = previewArea.querySelector('style');
            if (oldStyle) oldStyle.remove();
            previewArea.appendChild(tempStyle);
        }

        function applyCurrentBubbleSettings() {
            appData.settings.bubble = JSON.parse(JSON.stringify(tempBubbleSettings));
            applyBubbleSettings(appData.settings.bubble, true);
        }

        function applyBubbleSettings(settings, doSave = false) {
            const root = document.documentElement;
            const styleTag = document.getElementById('custom-bubble-style');
            
            styleTag.innerHTML = settings.css || '';
            root.style.setProperty('--avatar-gap', `${settings.gap.width}px`);
            root.style.setProperty('--consecutive-bubble-gap', `${settings.consecutiveGap}px`);
            root.style.setProperty('--bubble-gap-height', `${settings.gap.height}px`);
            root.style.setProperty('--bubble-border-radius', settings.borderRadius);

            ['user', 'char'].forEach(type => {
                root.style.setProperty(`--${type}-avatar-size`, `${settings[type].avatar.size}px`);
                root.style.setProperty(`--${type}-avatar-offset-x`, `${settings[type].avatar.offsetX}px`);
                root.style.setProperty(`--${type}-avatar-offset-y`, `${settings[type].avatar.offsetY}px`);
                root.style.setProperty(`--${type}-avatar-frame-width`, `${settings[type].avatarFrame.width}px`);
                root.style.setProperty(`--${type}-avatar-frame-height`, `${settings[type].avatarFrame.height}px`);
                root.style.setProperty(`--${type}-avatar-frame-offset-x`, `${settings[type].avatarFrame.offsetX}px`);
                root.style.setProperty(`--${type}-avatar-frame-offset-y`, `${settings[type].avatarFrame.offsetY}px`);
                root.style.setProperty(`--${type}-bubble-offset-x`, `${settings[type].bubble.offsetX}px`);
                root.style.setProperty(`--${type}-bubble-offset-y`, `${settings[type].bubble.offsetY}px`);
                root.style.setProperty(`--${type}-bubble-padding-x`, `${settings[type].bubble.paddingX}px`);
                root.style.setProperty(`--${type}-bubble-padding-y`, `${settings[type].bubble.paddingY}px`);
            });

            if (doSave) {
                saveData();
            }
        }

        function saveBubblePreset() {
            const name = prompt("请输入CSS预设名称:");
            if (name && name.trim()) {
                if (!appData.settings.bubble.presets) appData.settings.bubble.presets = [];
                const newPresetSettings = JSON.parse(JSON.stringify(tempBubbleSettings));
                appData.settings.bubble.presets.push({
                    name: name.trim(),
                    settings: newPresetSettings
                });
                saveData();
                renderBubbleCssSettingsPage();
            }
        }

        function deleteBubblePreset() {
            const select = document.getElementById('bubble-preset-select');
            const index = select.value;
            if (index > -1) {
                const presetName = appData.settings.bubble.presets[index].name;
                if (confirm(`确定要删除预设“${presetName}”吗？`)) {
                    appData.settings.bubble.presets.splice(index, 1);
                    saveData();
                    renderBubbleCssSettingsPage();
                }
            } else {
                showiOSAlert(t('common_info'), '请先选择一个要删除的预设。');
            }
        }

        // --- 设置 App: UI调整 (★★★ 更新 ★★★) ---
        function renderUiAdjustmentPage() {
            const container = document.getElementById('uiAdjustmentContainer').querySelector('.app-content');
            container.innerHTML = `
                <div class="glass-list-item" onclick="openSubPage('uiStyleSettings')">
                    <i class="fas fa-paint-brush item-icon"></i><span class="item-text" data-lang="ui_style_title">UI风格</span><i class="fas fa-chevron-right item-arrow"></i>
                </div>
                <div class="app-placeholder" style="margin-top: 20px;">
                    UI尺寸已设为默认最佳值，无需调整。
                </div>
            `;
            applyTranslations();
        }

        function saveUiAdjustments() {
            // No longer saves individual values, but we keep the function for structure
            appData.settings.ui = JSON.parse(JSON.stringify(tempUiSettings));
            applyUiAdjustments(appData.settings.ui, true);
        }

        function applyUiAdjustments(settings, doSave = false) {
            const root = document.documentElement;
            // Keep applying default values to ensure consistency
            root.style.setProperty('--global-icon-size', `${settings.iconSize || 28}px`);
            root.style.setProperty('--ui-element-base-size', `${settings.elementBaseSize || 16}px`);
            root.style.setProperty('--global-top-nav-height', `${settings.topNavHeight || 44}px`);
            root.style.setProperty('--global-bottom-nav-height', `${settings.bottomNavHeight || 50}px`);
            if (doSave) {
                saveData();
            }
        }

        // ★★★ 新增: UI风格设置 ★★★
        function renderUiStyleSettingsPage() {
            tempUiStyle = appData.settings.ui.style;
            document.getElementById('ui-style-check-default').style.display = tempUiStyle === 'default' ? 'block' : 'none';
            document.getElementById('ui-style-check-line').style.display = tempUiStyle === 'line' ? 'block' : 'none';
        }

        function selectUiStyle(style) {
            tempUiStyle = style;
            document.getElementById('ui-style-check-default').style.display = style === 'default' ? 'block' : 'none';
            document.getElementById('ui-style-check-line').style.display = style === 'line' ? 'block' : 'none';
        }

        function saveUiStyle() {
            appData.settings.ui.style = tempUiStyle;
            applyUiStyle(tempUiStyle, true);
        }

        function applyUiStyle(style, doSave = false) {
            document.body.classList.toggle('ui-style-line', style === 'line');
            if (doSave) {
                saveData();
            }
        }

        // --- 设置 App: 状态栏设置 ---
        function renderStatusBarSettingsPage() {
            const container = document.getElementById('statusBarSettingsContainer').querySelector('.app-content');
            tempUiSettings = JSON.parse(JSON.stringify(appData.settings.ui));

            container.innerHTML = `
                <div class="glass-form-group">
                    <label data-lang="status_bar_settings_icon_size">图标大小: <span id="status-bar-icon-size-value">${tempUiSettings.statusBarIconSize}</span>px</label>
                    <input type="range" id="status-bar-icon-size-slider" min="10" max="22" step="1" value="${tempUiSettings.statusBarIconSize}">
                </div>
            `;
            applyTranslations();

            document.getElementById('status-bar-icon-size-slider').oninput = e => {
                document.getElementById('status-bar-icon-size-value').textContent = e.target.value;
                tempUiSettings.statusBarIconSize = e.target.value;
            };
        }

        function saveStatusBarSettings() {
            appData.settings.ui.statusBarIconSize = tempUiSettings.statusBarIconSize;
            applyStatusBarSettings(appData.settings.ui, true);
        }

        function applyStatusBarSettings(settings, doSave = false) {
            const root = document.documentElement;
            root.style.setProperty('--status-bar-icon-size', `${settings.statusBarIconSize}px`);
            if (doSave) {
                saveData();
            }
        }

        // --- 设置 App: 桌面美化 ---
        function renderDesktopBeautificationPage() {
            const grid = document.getElementById('beautifyIconsGrid');
            grid.innerHTML = '';
            appData.apps.forEach(app => {
                const customIcon = appData.settings.desktop.icons[app.id];
                const iconContent = customIcon ? '' : `<i class="${app.icon}" style="color: var(--primary-text);"></i>`;
                const backgroundStyle = customIcon ? `background-image: url(${customIcon});` : `background: white;`;

                const itemHTML = `
                    <div class="app-icon-wrapper" onclick="triggerIconUpload('${app.id}')">
                        <div class="app-icon-image" style="${backgroundStyle}">${iconContent}</div>
                        <div class="app-icon-name" data-lang="app_${app.id}">${t('app_' + app.id)}</div>
                        <input type="file" id="icon-upload-${app.id}" accept="image/*" onchange="changeAppIcon(event, '${app.id}')" style="display:none;">
                    </div>
                `;
                grid.innerHTML += itemHTML;
            });
        }

        function changeWallpaper(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    document.getElementById('homeScreen').style.backgroundImage = `url(${imageUrl})`;
                    appData.settings.desktop.wallpaper = imageUrl;
                    saveData();
                };
                reader.readAsDataURL(file);
            }
        }

        function triggerIconUpload(appId) {
            document.getElementById(`icon-upload-${appId}`).click();
        }

        function changeAppIcon(event, appId) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    appData.settings.desktop.icons[appId] = imageUrl;
                    saveData();
                    renderAppIcons();
                    renderDesktopBeautificationPage();
                };
                reader.readAsDataURL(file);
            }
        }

        // --- 设置 App: 聊天模式 ---
        function setChatMode(mode, doSave = true) {
            appData.settings.chatMode = mode;
            if (doSave) {
                saveData();
            }
            updateChatRoomModeButton();
        }

        // --- 设置 App: 时间感知 ---
        function renderTimePerceptionSettingsPage() {
            const toggle = document.getElementById('time-perception-toggle');
            if (toggle) {
                toggle.checked = appData.settings.timePerception;
                toggle.onchange = (e) => {
                    appData.settings.timePerception = e.target.checked;
                    saveData(true);
                };
            }
        }

        // --- 设置 App: API设置 ---
        function renderMainApiSettingsPage() {
            const container = document.getElementById('main-api-settings-content');
            container.innerHTML = `<div id="main-api-settings-form-container"></div>`;
            renderApiSettingsForm('main');
        }

        function renderApiSettingsPage() {
            const container = document.getElementById('api-settings-content');
            container.innerHTML = `
                <div class="segmented-control" style="margin-bottom: 15px;">
                    <button id="api-tab-chat" class="active" onclick="switchApiTab('chat')" data-lang="api_settings_chat_tab">聊天 API</button>
                    <button id="api-tab-vision" onclick="switchApiTab('vision')" data-lang="api_settings_vision_tab">识图 API</button>
                    <button id="api-tab-tieba" onclick="switchApiTab('tieba')" data-lang="api_settings_tieba_tab">贴吧 API</button>
                </div>
                <div id="api-settings-form-container"></div>
            `;
            switchApiTab('chat');
        }

        function switchApiTab(apiType) {
            document.getElementById('api-tab-chat').classList.toggle('active', apiType === 'chat');
            document.getElementById('api-tab-vision').classList.toggle('active', apiType === 'vision');
            document.getElementById('api-tab-tieba').classList.toggle('active', apiType === 'tieba');
            renderApiSettingsForm(apiType);
        }

        function renderApiSettingsForm(apiType) {
            const containerId = apiType === 'main' ? 'main-api-settings-form-container' : 'api-settings-form-container';
            const container = document.getElementById(containerId);
            const apiConfigKey = `${apiType}Api`;
            const apiConfig = appData.settings[apiConfigKey];
            
            const providers = {
                'openai': 'OpenAI', 'claude': 'Claude', 'gemini': 'Gemini',
                'deepseek': 'DeepSeek', 'openrouter': 'OpenRouter', 'grok': 'Grok',
                'doubao': '豆包', 'custom': '自定义 (OpenAI)', 'custom_gemini': '自定义 (Gemini)'
            };
            let providerOptions = '';
            for (const key in providers) {
                providerOptions += `<option value="${key}" ${apiConfig.provider === key ? 'selected' : ''}>${providers[key]}</option>`;
            }
            const presetsOptions = (apiConfig.presets || []).map((p, i) => `<option value="${i}">${p.name}</option>`).join('');

            let useMainApiHtml = '';
            if (apiType !== 'main') {
                useMainApiHtml = `
                    <div class="glass-list-item" style="padding: 10px 15px; margin-bottom: 15px;">
                        <span class="item-text" data-lang="api_settings_use_main_api">使用主API</span>
                        <label class="switch"><input type="checkbox" id="use-main-api-${apiType}" ${apiConfig.useMain ? 'checked' : ''} onchange="toggleUseMainApi('${apiType}')"><span class="slider"></span></label>
                    </div>
                `;
            }

            const isDisabled = apiType !== 'main' && apiConfig.useMain;
            const disabledAttr = isDisabled ? 'disabled style="opacity: 0.5; pointer-events: none;"' : '';

            container.innerHTML = `
                ${useMainApiHtml}
                <div id="api-config-fields-${apiType}" ${disabledAttr}>
                    <div class="glass-form-group">
                        <label>API 预设</label>
                        <div class="form-row">
                            <select id="api-preset-select-${apiType}" class="glass-select" style="flex: 1;">
                                <option value="-1">选择一个预设...</option>
                                ${presetsOptions}
                            </select>
                            <button class="glass-button" onclick="saveApiPreset('${apiType}')"><i class="fas fa-save"></i></button>
                        </div>
                    </div>
                    <div class="glass-form-group">
                        <label>供应商</label>
                        <select id="api-provider-${apiType}" class="glass-select">${providerOptions}</select>
                    </div>
                    <div class="glass-form-group">
                        <label>API端点 (Endpoint URL)</label>
                        <input type="text" id="api-endpoint-${apiType}" class="glass-input" value="${apiConfig.endpoint || ''}" placeholder="例如: https://api.openai.com/v1">
                    </div>
                    <div class="glass-form-group">
                        <label>密钥 (API Key)</label>
                        <input type="password" id="api-key-${apiType}" class="glass-input" value="${apiConfig.key || ''}">
                    </div>
                    <div class="glass-form-group">
                        <label>模型</label>
                        <div class="form-row">
                            <input type="text" id="api-model-${apiType}" class="glass-input" value="${apiConfig.model || ''}" style="flex: 1;" placeholder="例如: gpt-4-turbo">
                            <button class="glass-button" onclick="fetchModels('${apiType}')">获取</button>
                        </div>
                    </div>
                    <div class="glass-form-group">
                        <label>Temperature: <span id="temp-value-${apiType}">${(apiConfig.temperature || 1.0).toFixed(2)}</span></label>
                        <input type="range" id="temperature-${apiType}" min="0" max="2" step="0.01" value="${apiConfig.temperature || 1.0}">
                    </div>
                    ${apiType !== 'vision' ? `
                    <div class="glass-form-group">
                        <label>Repetition Penalty: <span id="penalty-value-${apiType}">${(apiConfig.repetition_penalty || 1.0).toFixed(2)}</span></label>
                        <input type="range" id="repetition-penalty-${apiType}" min="0" max="2" step="0.01" value="${apiConfig.repetition_penalty || 1.0}">
                    </div>` : ''}
                </div>
                <button class="glass-button" onclick="saveApiSettings('${apiType}')" data-lang="common_save"></button>
            `;
            applyTranslations(); // Apply translations after innerHTML is set

            if (!isDisabled) {
                document.getElementById(`temperature-${apiType}`).oninput = (e) => { document.getElementById(`temp-value-${apiType}`).textContent = parseFloat(e.target.value).toFixed(2); };
                if (apiType !== 'vision') {
                    document.getElementById(`repetition-penalty-${apiType}`).oninput = (e) => { document.getElementById(`penalty-value-${apiType}`).textContent = parseFloat(e.target.value).toFixed(2); };
                }

                document.getElementById(`api-preset-select-${apiType}`).onchange = (e) => {
                    const index = e.target.value;
                    const apiConfigKey = `${apiType}Api`;
                    const currentApiConfig = appData.settings[apiConfigKey];
                    if (index > -1) {
                        const preset = currentApiConfig.presets[index];
                        document.getElementById(`api-provider-${apiType}`).value = preset.provider;
                        document.getElementById(`api-endpoint-${apiType}`).value = preset.endpoint;
                        document.getElementById(`api-key-${apiType}`).value = preset.key;
                        document.getElementById(`api-model-${apiType}`).value = preset.model;
                        document.getElementById(`temperature-${apiType}`).value = preset.temperature;
                        document.getElementById(`temp-value-${apiType}`).textContent = preset.temperature.toFixed(2);
                        if (apiType !== 'vision') {
                            document.getElementById(`repetition-penalty-${apiType}`).value = preset.repetition_penalty;
                            document.getElementById(`penalty-value-${apiType}`).textContent = preset.repetition_penalty.toFixed(2);
                        }
                    }
                };
            }
        }

        function toggleUseMainApi(apiType) {
            const checkbox = document.getElementById(`use-main-api-${apiType}`);
            appData.settings[`${apiType}Api`].useMain = checkbox.checked;
            saveData();
            renderApiSettingsForm(apiType);
        }

        function saveApiPreset(apiType) {
            const presetName = prompt("请输入预设名称:");
            if (presetName) {
                const apiConfigKey = `${apiType}Api`;
                const newPreset = {
                    name: presetName,
                    provider: document.getElementById(`api-provider-${apiType}`).value,
                    endpoint: document.getElementById(`api-endpoint-${apiType}`).value.trim(),
                    key: document.getElementById(`api-key-${apiType}`).value.trim(),
                    model: document.getElementById(`api-model-${apiType}`).value.trim(),
                    temperature: parseFloat(document.getElementById(`temperature-${apiType}`).value),
                    repetition_penalty: apiType !== 'vision' ? parseFloat(document.getElementById(`repetition-penalty-${apiType}`).value) : 1.0
                };
                if (!appData.settings[apiConfigKey].presets) appData.settings[apiConfigKey].presets = [];
                appData.settings[apiConfigKey].presets.push(newPreset);
                saveData();
                renderApiSettingsForm(apiType);
            }
        }

        function saveApiSettings(apiType) {
            const apiConfigKey = `${apiType}Api`;
            if (apiType !== 'main' && appData.settings[apiConfigKey].useMain) {
                showiOSAlert(t('alert_save_success'));
                return;
            }

            appData.settings[apiConfigKey].provider = document.getElementById(`api-provider-${apiType}`).value;
            appData.settings[apiConfigKey].endpoint = document.getElementById(`api-endpoint-${apiType}`).value.trim();
            appData.settings[apiConfigKey].key = document.getElementById(`api-key-${apiType}`).value.trim();
            appData.settings[apiConfigKey].model = document.getElementById(`api-model-${apiType}`).value.trim();
            appData.settings[apiConfigKey].temperature = parseFloat(document.getElementById(`temperature-${apiType}`).value);
            if (apiType !== 'vision') {
                appData.settings[apiConfigKey].repetition_penalty = parseFloat(document.getElementById(`repetition-penalty-${apiType}`).value);
            }
            saveData();
        }

        async function fetchModels(apiType) {
            const apiConfigKey = `${apiType}Api`;
            let api = appData.settings[apiConfigKey];
            if (apiType !== 'main' && api.useMain) {
                api = appData.settings.mainApi;
            }

            const key = document.getElementById(`api-key-${apiType}`).value.trim();
            if (!key) { showiOSAlert("密钥错误", "请检查后重新填入密钥", "error"); return; }

            const modelsUrl = getApiEndpoint('models', apiType);
            if (!modelsUrl) { showiOSAlert("端点错误", "请选择供应商或填写端点", "error"); return; }
            
            showiOSAlert("请稍后", "正在获取模型列表...");
            
            try {
                const headers = {};
                const provider = document.getElementById(`api-provider-${apiType}`).value;
                
                if (provider === 'gemini' || provider === 'custom_gemini') {
                    // Gemini uses query param for key
                } else {
                    headers['Authorization'] = `Bearer ${key}`;
                }

                let fetchUrl = modelsUrl;
                if (provider === 'gemini' || provider === 'custom_gemini') {
                    fetchUrl += `?key=${key}`;
                }

                const response = await fetch(fetchUrl, { headers });
                if (!response.ok) throw new Error(`服务器返回 ${response.status}`);
                
                const data = await response.json();
                const models = data.data || data.models || data;
                if (!Array.isArray(models)) throw new Error("返回格式不正确");

                const modelListHtml = models.map(m => {
                    const modelId = m.id || m.name;
                    return `<div class="list-item" onclick="selectApiModel('${modelId}', '${apiType}')"><div class="item-main"><span class="item-name">${modelId}</span></div></div>`
                }).join('');
                showModal(`<div class="modal-title">选择模型</div><div class="modal-body">${modelListHtml}</div>`);
            } catch (error) {
                showiOSAlert(`获取失败`, `${error.message}`, "error");
            }
        }

        function selectApiModel(modelId, apiType) {
            if (apiType !== 'main' && appData.settings[`${apiType}Api`].useMain) {
                showiOSAlert("提示", "当前使用主API，请在主API设置中更改模型。");
            } else {
                document.getElementById(`api-model-${apiType}`).value = modelId;
            }
            closeModal();
        }

        // --- 设置 App: 记忆总结 ---
        function renderMemorySummaryContactList() {
            const container = document.getElementById('memorySummaryContactListContent');
            container.innerHTML = '';
            if (appData.contacts.length === 0) {
                container.innerHTML = '<div class="app-placeholder">没有联系人可供总结。</div>';
                return;
            }
            appData.contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'contact-list-item';
                item.innerHTML = `
                    <div class="list-item-avatar-wrapper">
                        <div class="list-item-avatar" style="background-image: url(${contact.avatar || ''})"></div>
                    </div>
                    <div class="list-item-info">
                        <div class="list-item-name">${contact.name || '未命名'}</div>
                    </div>
                    <i class="fas fa-chevron-right item-arrow"></i>
                `;
                item.onclick = () => generateMemorySummary(contact.id);
                container.appendChild(item);
            });
        }

        function generateMemorySummary(contactId) {
            const contact = appData.contacts.find(c => c.id === contactId);
            if (!contact) return;

            const allMessages = appData.chat.messages[contactId] || [];
            if (allMessages.length === 0) {
                showiOSAlert('无记忆', `与 ${contact.name} 之间还没有聊天记录。`);
                return;
            }

            showiOSAlert('正在生成...', '正在根据真实聊天记录生成记忆总结，请稍候。');

            const recentMessages = allMessages.slice(-20);
            let summaryPoints = new Set();

            recentMessages.forEach(msg => {
                if (msg.type === 'text') {
                    if (msg.content.includes('喜欢') || msg.content.includes('爱好')) summaryPoints.add(`讨论过彼此的喜好。`);
                    if (msg.content.match(/去哪|地点|约/)) summaryPoints.add(`可能约定或讨论过某个地点。`);
                    if (msg.content.match(/电影|剧|书/)) summaryPoints.add(`分享了关于文艺作品的看法。`);
                }
                if (msg.type === 'transfer') summaryPoints.add(`发生过金额为 ${msg.content.amount} 的转账。`);
                if (msg.type === 'location') summaryPoints.add(`分享过名为“${msg.content.title}”的位置。`);
            });

            if (summaryPoints.size === 0) summaryPoints.add('最近的交流比较日常。');

            const summaryText = Array.from(summaryPoints).map((point, index) => `${index + 1}. ${point}`).join('\n');
            const summaryHtml = `<pre style="white-space: pre-wrap; word-wrap: break-word; text-align: left; font-size: 1.2em; padding: 15px;">${summaryText}</pre>`;
            
            setTimeout(() => {
                showModal(`
                    <div class="modal-title">与 ${contact.name} 的记忆总结</div>
                    <div class="modal-body">${summaryHtml}</div>
                `);
            }, 1500);
        }

        // --- 设置 App: 黑名单 ---
        function renderBlacklist() {
            const container = document.getElementById('blacklistContent');
            container.innerHTML = '';
            if (appData.settings.blacklist.length === 0) {
                container.innerHTML = '<div class="app-placeholder">黑名单是空的。</div>';
                return;
            }
            appData.settings.blacklist.forEach(contactId => {
                const contact = appData.contacts.find(c => c.id === contactId);
                if (contact) {
                    const item = document.createElement('div');
                    item.className = 'blacklist-item';
                    item.innerHTML = `
                        <div class="list-item-avatar-wrapper">
                           <div class="list-item-avatar" style="background-image: url(${contact.avatar || ''})"></div>
                        </div>
                        <div class="list-item-info">
                            <div class="list-item-name">${contact.name || '未命名'}</div>
                        </div>
                        <button class="glass-button" style="width:auto; padding: 5px 10px; font-size: calc(var(--global-font-size) * 1.1);" onclick="unblockContact('${contact.id}', event)" data-lang="common_remove">移除</button>
                    `;
                    container.appendChild(item);
                }
            });
            applyTranslations();
        }

        function unblockContact(contactId, event) {
            event.stopPropagation();
            appData.settings.blacklist = appData.settings.blacklist.filter(id => id !== contactId);
            saveData();
            renderBlacklist();
            renderMessagesList();
            showiOSAlert('已移除', '该联系人已从黑名单中移除。');
        }

        // --- 设置 App: 数据管理 ---
        function renderDataManagementPage() {
            const container = document.getElementById('dataManagementContent');
            if (!container) return;
            container.innerHTML = `
                <div class="glass-list">
                    <div class="glass-list-item" onclick="exportData()">
                        <i class="fas fa-file-export item-icon"></i><span class="item-text" data-lang="data_management_backup_all"></span><i class="fas fa-chevron-right item-arrow"></i>
                    </div>
                    <div class="glass-list-item" onclick="exportPartialData()">
                        <i class="fas fa-file-invoice item-icon"></i><span class="item-text" data-lang="data_management_backup_partial"></span><i class="fas fa-chevron-right item-arrow"></i>
                    </div>
                    <div class="glass-list-item" onclick="document.getElementById('import-data-input').click()">
                        <i class="fas fa-file-import item-icon"></i><span class="item-text" data-lang="data_management_restore"></span><i class="fas fa-chevron-right item-arrow"></i>
                    </div>
                    <input type="file" id="import-data-input" accept=".json" style="display:none;">
                    <div class="glass-list-item" onclick="showDataStatistics()">
                        <i class="fas fa-chart-pie item-icon"></i><span class="item-text" data-lang="data_management_stats"></span><i class="fas fa-chevron-right item-arrow"></i>
                    </div>
                    <div class="glass-list-item" onclick="clearCache()">
                        <i class="fas fa-broom item-icon"></i><span class="item-text" data-lang="data_management_clear_cache"></span><i class="fas fa-chevron-right item-arrow"></i>
                    </div>
                    <div class="glass-list-item" onclick="clearAllData()">
                        <i class="fas fa-skull-crossbones item-icon" style="color: #FF3B30;"></i><span class="item-text" style="color: #FF3B30;" data-lang="data_management_clear_all">
                        </span><i class="fas fa-chevron-right item-arrow"></i>
                    </div>
                </div>
            `;
            document.getElementById('import-data-input').onchange = importData;
            applyTranslations();
        }

        function showDataStatistics() {
            const dataSize = (JSON.stringify(appData).length / 1024).toFixed(2);
            const totalMessages = Object.values(appData.chat.messages).reduce((acc, val) => acc + val.length, 0);

            const statsHtml = `
                <div class="glass-list" style="padding: 10px;">
                    <div class="glass-list-item" style="cursor: default;"><span class="item-text">联系人数量:</span><span>${appData.contacts.length}</span></div>
                    <div class="glass-list-item" style="cursor: default;"><span class="item-text">世界书条目:</span><span>${appData.worldbooks.length}</span></div>
                    <div class="glass-list-item" style="cursor: default;"><span class="item-text">自设数量:</span><span>${appData.chat.userProfiles.length}</span></div>
                    <div class="glass-list-item" style="cursor: default;"><span class="item-text">总消息数:</span><span>${totalMessages}</span></div>
                    <div class="glass-list-item" style="cursor: default;"><span class="item-text">数据大致体积:</span><span>${dataSize} KB</span></div>
                </div>
            `;
            showModal(`
                <div class="modal-title" data-lang="data_management_stats">数据统计</div>
                <div class="modal-body">${statsHtml}</div>
            `);
            applyTranslations();
        }

        function exportData() {
            try {
                const dataStr = JSON.stringify(appData, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `悸_全量数据_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showiOSAlert(t('alert_export_success'), '已将全部数据保存到您的下载文件夹。');
            } catch (e) {
                showiOSAlert(`${t('alert_export_failed')}: ${e.message}`, '', 'error');
            }
        }

        function exportPartialData() {
            try {
                const partialData = {
                    settings: appData.settings,
                    contacts: appData.contacts,
                    contactGroups: appData.contactGroups,
                    worldbooks: appData.worldbooks,
                    chat: {
                        userProfiles: appData.chat.userProfiles,
                        activeProfileId: appData.chat.activeProfileId,
                        messages: appData.chat.messages,
                        chatSettings: appData.chat.chatSettings,
                    },
                    friends: appData.friends,
                };
                const dataStr = JSON.stringify(partialData, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `悸_部分数据_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showiOSAlert(t('alert_export_success'), '已将部分数据保存到您的下载文件夹。');
            } catch (e) {
                showiOSAlert(`${t('alert_export_failed')}: ${e.message}`, '', 'error');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showCustomiOSAlert(t('alert_import_confirm_title'), t('alert_import_confirm_msg'), [
                { text: t('alert_import_action_confirm'), style: 'destructive', action: () => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            appData = deepMerge(getInitialAppData(), importedData);
                            saveData(true);
                            showiOSAlert(t('alert_import_success'), '数据已恢复，应用将重新加载。');
                            setTimeout(() => location.reload(), 1500);
                        } catch (err) {
                            showiOSAlert(t('alert_import_failed'), '解析文件失败：' + err.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                }},
                { text: t('common_cancel'), style: 'bold' }
            ]);
            event.target.value = '';
        }

        function clearCache() {
            showCustomiOSAlert(t('alert_clear_cache_title'), t('alert_clear_cache_msg'), [
                { text: t('alert_clear_cache_action'), action: () => {
                    appData.tieba.users = {};
                    saveData();
                    showiOSAlert(t('alert_clear_cache_success'));
                }},
                { text: t('common_cancel'), style: 'bold' }
            ]);
        }

        function clearAllData() {
            showCustomiOSAlert(t('alert_clear_all_title'), t('alert_clear_all_msg'), [
                { text: t('alert_clear_all_action'), style: 'destructive', action: () => {
                    localStorage.removeItem('hakimiPhoneData');
                    showiOSAlert(t('alert_clear_all_success'), '所有数据已被抹除，应用将重新加载。');
                    setTimeout(() => location.reload(), 1500);
                }},
                { text: t('common_cancel'), style: 'bold' }
            ]);
        }

        // --- 联系人 (作为聊天子页面) ---
        function openContactActionsModal() {
            showCustomiOSAlert(t('common_create'), '', [
                { text: t('contact_editor_title_create'), action: () => openContactEditor(null) },
                { text: '创建分组', action: () => createContactGroup() },
                { text: t('common_cancel'), style: 'bold' }
            ]);
        }

        function createContactGroup() {
            const groupName = prompt('请输入新分组的名称:');
            if (groupName && groupName.trim() !== '') {
                if (!appData.contactGroups) appData.contactGroups = [];
                appData.contactGroups.push({ id: `group_${Date.now()}`, name: groupName.trim() });
                saveData();
                showiOSAlert(t('common_success'), `分组“${groupName.trim()}”已创建。`);
                renderContactsList();
            }
        }

        function renderContactsList() {
            const container = document.getElementById('contactsListContent');
            container.innerHTML = '';

            const groupedContacts = {};
            const ungroupedContacts = [];

            // 初始化所有分组
            appData.contactGroups.forEach(group => {
                groupedContacts[group.id] = [];
            });

            // 分配联系人到分组
            appData.contacts.forEach(contact => {
                let isInGroup = false;
                if (contact.groups && contact.groups.length > 0) {
                    contact.groups.forEach(groupId => {
                        if (groupedContacts[groupId]) {
                            groupedContacts[groupId].push(contact);
                            isInGroup = true;
                        }
                    });
                }
                if (!isInGroup) {
                    // 如果没有分组，放入默认分组
                    if (groupedContacts['group_default']) {
                        groupedContacts['group_default'].push(contact);
                    } else {
                        ungroupedContacts.push(contact); // Fallback if default group is missing
                    }
                }
            });

            // 渲染所有分组，即使是空的
            appData.contactGroups.forEach(group => {
                const groupHeader = document.createElement('div');
                groupHeader.className = 'contact-group-header';
                groupHeader.textContent = group.name;
                container.appendChild(groupHeader);

                if (groupedContacts[group.id].length > 0) {
                    groupedContacts[group.id].forEach(contact => {
                        container.appendChild(createContactListItem(contact));
                    });
                }
            });
            
            // 如果有完全未分组的联系人（理论上不应该发生，因为有默认分组）
            if (ungroupedContacts.length > 0) {
                const groupHeader = document.createElement('div');
                groupHeader.className = 'contact-group-header';
                groupHeader.textContent = '未分组';
                container.appendChild(groupHeader);
                ungroupedContacts.forEach(contact => {
                    container.appendChild(createContactListItem(contact));
                });
            }
        }


        function createContactListItem(contact) {
            const item = document.createElement('div');
            item.className = 'contact-list-item';
            item.innerHTML = `
                <div class="list-item-avatar-wrapper">
                    <div class="list-item-avatar" style="background-image: url(${contact.avatar || ''})"></div>
                </div>
                <div class="list-item-info">
                    <div class="list-item-name">${contact.name || '未命名'}</div>
                    <div class="list-item-bio">${contact.bio || ''}</div>
                </div>
            `;
            item.onclick = () => openContactEditor(contact.id);
            return item;
        }


        function openContactEditor(contactId) {
            currentEditingContactId = contactId;
            openSubPage('contactEditor');
            const contact = contactId ? appData.contacts.find(c => c.id === contactId) : {};
            
            currentEditingContact.worldbooks = contact?.worldbooks || [];
            currentEditingContact.groups = contact?.groups || [];

            document.getElementById('contactEditorTitle').textContent = contactId ? t('contact_editor_title_edit') : t('contact_editor_title_create');
            document.getElementById('avatarPreview').style.backgroundImage = `url(${contact?.avatar || ''})`;
            document.getElementById('contact-name').value = contact?.name || '';
            document.getElementById('contact-bio').value = contact?.bio || '';
            document.querySelectorAll('input[name="gender"]').forEach(radio => {
                radio.checked = radio.value === (contact?.gender || '');
            });
            document.getElementById('contact-occupation').value = contact?.occupation || '';
            document.getElementById('contact-wxid').value = contact?.wxid || '';
            document.getElementById('contact-qid').value = contact?.qid || '';
            document.getElementById('contact-qq').value = contact?.qq || '';
            document.getElementById('contact-persona').value = contact?.persona || '';
            document.getElementById('contact-relationship').value = contact?.relationship || '';
            
            const userSelect = document.getElementById('contact-user');
            userSelect.innerHTML = '<option value="">暂不绑定</option>' + appData.chat.userProfiles.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            userSelect.value = contact?.user || '';

            updateMultiSelectDisplay('worldbooks', contact?.worldbooks || []);
            updateMultiSelectDisplay('groups', contact?.groups || []);
            
            tempAvatarData.data = contact?.avatar || null;
            tempAvatarData.type = 'avatar';
        }

        function saveContact() {
            const wxid = document.getElementById('contact-wxid').value;
            if (wxid && !/^[a-zA-Z0-9_-]{1,20}$/.test(wxid)) {
                showiOSAlert(t('common_error'), 'wxid只能包含大小写字母、数字、-和_，且长度不超过20。', 'error'); return;
            }
            const qid = document.getElementById('contact-qid').value;
            if (qid && !/^[a-zA-Z0-9]{1,12}$/.test(qid)) {
                showiOSAlert(t('common_error'), 'QID只能包含大小写字母和数字，且长度不超过12。', 'error'); return;
            }
            const qq = document.getElementById('contact-qq').value;
            if (qq && !/^\d{1,10}$/.test(qq)) {
                showiOSAlert(t('common_error'), 'QQ号只能是1-10位的纯数字。', 'error'); return;
            }

            const contactData = {
                avatar: tempAvatarData.type === 'avatar' ? tempAvatarData.data : (appData.contacts.find(c => c.id === currentEditingContactId)?.avatar || null),
                name: document.getElementById('contact-name').value,
                bio: document.getElementById('contact-bio').value,
                gender: document.querySelector('input[name="gender"]:checked')?.value || '',
                occupation: document.getElementById('contact-occupation').value,
                wxid: wxid,
                qid: qid,
                qq: qq,
                persona: document.getElementById('contact-persona').value,
                relationship: document.getElementById('contact-relationship').value,
                user: document.getElementById('contact-user').value,
                worldbooks: currentEditingContact.worldbooks,
                groups: currentEditingContact.groups
            };

            if (currentEditingContactId) {
                const index = appData.contacts.findIndex(c => c.id === currentEditingContactId);
                appData.contacts[index] = { ...appData.contacts[index], ...contactData };
            } else {
                appData.contacts.push({ id: `contact_${Date.now()}`, ...contactData });
            }
            saveData();
            closeSubPage('contactEditor');
            renderContactsList();
            renderMessagesList();
        }

        let currentEditingContact = { worldbooks: [], groups: [] };
        function openMultiSelectModal(type) {
            let title, items, selectedIds;
            if (type === 'worldbooks') {
                title = '选择世界书';
                items = appData.worldbooks;
                selectedIds = new Set(currentEditingContact.worldbooks);
            } else {
                title = '选择分组';
                items = appData.contactGroups;
                selectedIds = new Set(currentEditingContact.groups);
            }

            if (!items || items.length === 0) {
                showiOSAlert('无可用选项', `请先创建${type === 'worldbooks' ? '世界书' : '分组'}。`);
                return;
            }

            const listHtml = items.map(item => `
                <div class="list-item checkbox-list-item">
                    <input type="checkbox" id="ms-${item.id}" value="${item.id}" ${selectedIds.has(item.id) ? 'checked' : ''}>
                    <label for="ms-${item.id}" style="flex: 1;">${item.title || item.name}</label>
                </div>
            `).join('');

            showModal(`
                <div class="modal-title">${title}</div>
                <div class="modal-body">${listHtml}</div>
                <div style="padding: 10px;">
                    <button class="glass-button" onclick="confirmMultiSelect('${type}')">${t('common_confirm')}</button>
                </div>
            `);
        }

        function confirmMultiSelect(type) {
            const selected = [];
            document.querySelectorAll('.modal-body input[type="checkbox"]:checked').forEach(cb => {
                selected.push(cb.value);
            });
            
            if (type === 'worldbooks') {
                currentEditingContact.worldbooks = selected;
            } else {
                currentEditingContact.groups = selected;
            }
            
            updateMultiSelectDisplay(type, selected);
            closeModal();
        }

        function updateMultiSelectDisplay(type, selectedIds) {
            let displayEl, sourceData, nameKey;
            if (type === 'worldbooks') {
                displayEl = document.getElementById('contact-worldbooks-display');
                sourceData = appData.worldbooks;
                nameKey = 'title';
            } else {
                displayEl = document.getElementById('contact-groups-display');
                sourceData = appData.contactGroups;
                nameKey = 'name';
            }

            if (!displayEl) return;

            const selectedNames = selectedIds
                .map(id => sourceData.find(item => item.id === id)?.[nameKey])
                .filter(Boolean);
            
            if (selectedNames.length > 0) {
                displayEl.textContent = selectedNames.join(', ');
            } else {
                displayEl.textContent = t('editor_click_to_select');
            }
        }


        // --- 世界书 App ---
        function renderWorldBookList() {
            const container = document.getElementById('worldBookListContent');
            container.innerHTML = '';
            if (appData.worldbooks.length === 0) {
                container.innerHTML = `<div class="app-placeholder">${t('worldbook_placeholder')}</div>`;
                return;
            }
            appData.worldbooks.forEach(book => {
                const tagsHTML = (book.tags || []).map(tag => `<span class="worldbook-tag">${tag}</span>`).join('');
                const item = document.createElement('div');
                item.className = 'worldbook-list-item';
                item.innerHTML = `
                    <div class="list-item-info">
                        <div class="list-item-name">${book.title || '无标题'}</div>
                        <div class="worldbook-tags">${tagsHTML}</div>
                    </div>
                    <i class="fas fa-chevron-right item-arrow"></i>
                `;
                item.onclick = () => openWorldBookEditor(book.id);
                container.appendChild(item);
            });
        }

        function openWorldBookEditor(bookId) {
            currentEditingWorldBookId = bookId;
            openSubPage('worldBookEditor');
            const book = bookId ? appData.worldbooks.find(b => b.id === bookId) : {};

            document.getElementById('worldBookEditorTitle').textContent = bookId ? t('worldbook_editor_title_edit') : t('worldbook_editor_title_create');
            document.getElementById('worldbook-title').value = book?.title || '';
            document.getElementById('worldbook-category').value = book?.category || '';
            document.getElementById('worldbook-depth').value = book?.depth || 0;
            document.getElementById('worldbook-depth-value').textContent = book?.depth || 0;
            document.getElementById('worldbook-keywords').value = book?.keywords || '';
            document.getElementById('worldbook-trigger-toggle').checked = book?.triggerByKeywords || false;
            document.getElementById('worldbook-content').value = book?.content || '';
            
            renderTags(book?.tags || []);
        }

        function saveWorldBook() {
            const title = document.getElementById('worldbook-title').value.trim();
            if (!title) {
                showiOSAlert(t('common_error'), '请为您的世界书输入一个标题。', 'error');
                return;
            }
            const tags = Array.from(document.querySelectorAll('#tag-container .tag-item')).map(el => el.textContent.slice(0, -1).trim());

            const bookData = {
                title: title,
                category: document.getElementById('worldbook-category').value.trim(),
                depth: parseInt(document.getElementById('worldbook-depth').value),
                tags: tags,
                keywords: document.getElementById('worldbook-keywords').value.trim(),
                triggerByKeywords: document.getElementById('worldbook-trigger-toggle').checked,
                content: document.getElementById('worldbook-content').value
            };

            if (currentEditingWorldBookId) {
                const index = appData.worldbooks.findIndex(b => b.id === currentEditingWorldBookId);
                appData.worldbooks[index] = { ...appData.worldbooks[index], ...bookData };
            } else {
                appData.worldbooks.push({ id: `wb_${Date.now()}`, ...bookData });
            }
            saveData();
            closeSubPage('worldBookEditor');
            renderWorldBookList();
        }

        function renderTags(tags) {
            const container = document.getElementById('tag-container');
            container.querySelectorAll('.tag-item').forEach(el => el.remove());
            tags.forEach(tag => {
                const tagEl = document.createElement('span');
                tagEl.className = 'tag-item';
                tagEl.textContent = tag;
                const removeEl = document.createElement('i');
                removeEl.className = 'fas fa-times remove-tag';
                removeEl.onclick = () => tagEl.remove();
                tagEl.appendChild(removeEl);
                container.insertBefore(tagEl, document.getElementById('tag-input'));
            });
        }

        // --- 聊天 App 核心功能 ---
        function renderChatApp() {
            switchChatTab('messages');
        }

        function switchChatTab(tabName) {
            document.querySelectorAll('.chat-page').forEach(p => p.classList.remove('active'));
            document.getElementById(`chatPage${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
            
            document.querySelectorAll('.chat-nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`.chat-nav-item[onclick="switchChatTab('${tabName}')"]`).classList.add('active');

            const titleMap = {
                messages: t('chat_title_messages'),
                contacts: t('chat_title_contacts'),
                friends: t('chat_title_friends'),
                me: t('chat_title_me')
            };
            document.getElementById('chatTitle').textContent = titleMap[tabName];
            
            const actionGroup = document.getElementById('chatActionBtnGroup');
            actionGroup.innerHTML = '';
            if (tabName === 'contacts') {
                actionGroup.innerHTML = `<div class="app-action-btn" onclick="openContactActionsModal()"><i class="fas fa-plus"></i></div>`;
                renderContactsList();
            } else if (tabName === 'friends') {
                actionGroup.innerHTML = `<div class="app-action-btn" onclick="openPostEditor(null)"><i class="fas fa-camera"></i></div>`;
                renderFriendsFeed();
            } else if (tabName === 'messages') {
                renderMessagesList();
            } else if (tabName === 'me') {
                renderMePage();
            }
        }

        function renderMessagesList() {
            const container = document.getElementById('messagesListContent');
            container.innerHTML = '';
            
            const visibleContacts = appData.contacts.filter(c => !appData.settings.blacklist.includes(c.id));
            if (visibleContacts.length === 0) {
                container.innerHTML = `<div class="app-placeholder">${t('contacts_placeholder')}</div>`;
                return;
            }

            visibleContacts.sort((a, b) => {
                const aPinned = appData.chat.chatSettings[a.id]?.pinned || false;
                const bPinned = appData.chat.chatSettings[b.id]?.pinned || false;
                return bPinned - aPinned;
            });

            visibleContacts.forEach(contact => {
                const chatSettings = appData.chat.chatSettings[contact.id] || {};
                const messages = appData.chat.messages[contact.id] || [];
                const lastMessage = messages.filter(m => m.status !== 'recalled').pop();
                let lastMessageContent = t('chat_room_start_chat');
                if (lastMessage) {
                    switch(lastMessage.type) {
                        case 'text': lastMessageContent = lastMessage.content; break;
                        case 'image': lastMessageContent = `[${t('chat_action_image')}]`; break;
                        case 'video': lastMessageContent = '[视频]'; break;
                        case 'sticker': lastMessageContent = '[表情]'; break;
                        case 'transfer': lastMessageContent = `[${t('chat_action_transfer')}]`; break;
                        case 'location': lastMessageContent = `[${t('chat_action_location')}] ${lastMessage.content.title}`; break;
                        case 'sim-file': lastMessageContent = `[${t('chat_action_file')}] ${lastMessage.content.name}`; break;
                        case 'sim-video': lastMessageContent = `[视频]`; break;
                        case 'sim-camera': lastMessageContent = `[${t('chat_action_image')}]`; break;
                        case 'voice': lastMessageContent = `[${t('chat_action_voice')}]`; break;
                        case 'tieba-share': lastMessageContent = `[帖子] ${lastMessage.content.title}`; break;
                        case 'music-share': lastMessageContent = `[音乐分享] ${lastMessage.content.title}`; break;
                    }
                }

                const item = document.createElement('div');
                item.className = 'message-list-item';
                if (chatSettings.pinned) {
                    item.classList.add('pinned');
                }
                item.innerHTML = `
                    <div class="list-item-avatar-wrapper">
                        <div class="list-item-avatar" style="background-image: url(${contact.avatar || ''})"></div>
                    </div>
                    <div class="list-item-info">
                        <div class="list-item-name">${contact.name || '未命名'}</div>
                        <div class="list-item-bio">${lastMessageContent}</div>
                    </div>
                `;
                item.onclick = () => openChatRoom(contact.id);
                container.appendChild(item);
            });
        }

        function renderMePage() {
            const activeProfile = appData.chat.userProfiles.find(p => p.id === appData.chat.activeProfileId);
            const nickname = activeProfile?.name || t('chat_me_set_nickname');
            const signature = activeProfile?.signature || t('chat_me_set_signature');
            const avatar = activeProfile?.avatar || '';
            const avatarFrame = '';

            document.getElementById('meNickname').textContent = nickname;
            document.getElementById('meSignature').textContent = signature;
            document.getElementById('meAvatar').style.backgroundImage = `url(${avatar})`;
            document.getElementById('meAvatarFrame').style.backgroundImage = `url(${avatarFrame})`;
        }

        function editNickname() {
            const activeProfile = appData.chat.userProfiles.find(p => p.id === appData.chat.activeProfileId);
            if (!activeProfile) {
                showiOSAlert(t('common_info'), t('my_profiles_placeholder'));
                return;
            }
            const newNickname = prompt(t('chat_me_set_nickname'), activeProfile.name);
            if (newNickname !== null && newNickname.trim() !== '') {
                activeProfile.name = newNickname.trim();
                saveData();
                renderMePage();
            }
        }

        function editSignature() {
            const activeProfile = appData.chat.userProfiles.find(p => p.id === appData.chat.activeProfileId);
            if (!activeProfile) {
                showiOSAlert(t('common_info'), t('my_profiles_placeholder'));
                return;
            }
            const newSignature = prompt(t('chat_me_set_signature'), activeProfile.signature);
            if (newSignature !== null) {
                activeProfile.signature = newSignature.substring(0, 50);
                saveData();
                renderMePage();
            }
        }

        function renderMyProfilesList() {
            const container = document.getElementById('myProfilesListContent');
            container.innerHTML = '';
            if (appData.chat.userProfiles.length === 0) {
                container.innerHTML = `<div class="app-placeholder">${t('my_profiles_placeholder')}</div>`;
                return;
            }
            appData.chat.userProfiles.forEach(profile => {
                const item = document.createElement('div');
                item.className = 'profile-list-item';
                const isActive = profile.id === appData.chat.activeProfileId;
                item.innerHTML = `
                    <div class="list-item-avatar-wrapper">
                        <div class="list-item-avatar" style="background-image: url(${profile.avatar || ''})"></div>
                    </div>
                    <div class="list-item-info">
                        <div class="list-item-name">${profile.name || '未命名'} ${isActive ? t('my_profiles_current') : ''}</div>
                    </div>
                    <i class="fas fa-chevron-right item-arrow"></i>
                `;
                item.onclick = () => {
                    showCustomiOSAlert(t('my_profiles_op_title'), '', [
                        { text: t('my_profiles_op_view'), action: () => openUserEditor(profile.id) },
                        { text: t('my_profiles_op_activate'), action: () => {
                            appData.chat.activeProfileId = profile.id;
                            saveData();
                            renderMyProfilesList();
                            renderMePage();
                        }},
                        { text: t('common_delete'), style: 'destructive', action: () => {
                            if (confirm(`确定要删除自设“${profile.name}”吗？`)) {
                                appData.chat.userProfiles = appData.chat.userProfiles.filter(p => p.id !== profile.id);
                                if (appData.chat.activeProfileId === profile.id) {
                                    appData.chat.activeProfileId = appData.chat.userProfiles[0]?.id || null;
                                }
                                saveData();
                                renderMyProfilesList();
                                renderMePage();
                            }
                        }},
                        { text: t('common_cancel'), style: 'bold' }
                    ]);
                };
                container.appendChild(item);
            });
        }

        function openUserEditor(userId) {
            currentEditingUserId = userId;
            openSubPage('userEditor');
            const user = userId ? appData.chat.userProfiles.find(u => u.id === userId) : null;

            document.getElementById('userEditorTitle').textContent = user ? t('user_editor_title_edit') : t('user_editor_title_create');
            document.getElementById('userAvatarPreview').style.backgroundImage = `url(${user?.avatar || ''})`;
            document.getElementById('user-name').value = user?.name || '';
            
            document.querySelectorAll('input[name="user-gender"]').forEach(radio => {
                radio.checked = radio.value === (user?.gender || '');
            });

            document.getElementById('user-occupation').value = user?.occupation || '';
            document.getElementById('user-wxid').value = user?.wxid || '';
            document.getElementById('user-qid').value = user?.qid || '';
            document.getElementById('user-qq').value = user?.qq || '';
            document.getElementById('user-persona').value = user?.persona || '';

            tempAvatarData.data = user?.avatar || null;
            tempAvatarData.type = 'avatar';
        }

        function saveUser() {
            const wxid = document.getElementById('user-wxid').value;
            if (wxid && !/^[a-zA-Z0-9_-]{1,20}$/.test(wxid)) {
                showiOSAlert(t('common_error'), 'wxid只能包含大小写字母、数字、-和_，且长度不超过20。', 'error'); return;
            }
            const qid = document.getElementById('user-qid').value;
            if (qid && !/^[a-zA-Z0-9]{1,12}$/.test(qid)) {
                showiOSAlert(t('common_error'), 'QID只能包含大小写字母和数字，且长度不超过12。', 'error'); return;
            }
            const qq = document.getElementById('user-qq').value;
            if (qq && !/^\d{1,10}$/.test(qq)) {
                showiOSAlert(t('common_error'), 'QQ号只能是1-10位的纯数字。', 'error'); return;
            }

            const userData = {
                avatar: tempAvatarData.type === 'avatar' ? tempAvatarData.data : (appData.chat.userProfiles.find(u => u.id === currentEditingUserId)?.avatar || null),
                name: document.getElementById('user-name').value,
                gender: document.querySelector('input[name="user-gender"]:checked')?.value || '',
                occupation: document.getElementById('user-occupation').value,
                wxid: wxid,
                qid: qid,
                qq: qq,
                persona: document.getElementById('user-persona').value,
            };

            if (currentEditingUserId) {
                const index = appData.chat.userProfiles.findIndex(u => u.id === currentEditingUserId);
                appData.chat.userProfiles[index] = { ...appData.chat.userProfiles[index], ...userData };
            } else {
                const newId = `user_${Date.now()}`;
                appData.chat.userProfiles.push({ id: newId, signature: t('chat_me_set_signature'), ...userData });
                if (!appData.chat.activeProfileId) {
                    appData.chat.activeProfileId = newId;
                }
            }
            saveData();
            closeSubPage('userEditor');
            renderMePage();
            renderMyProfilesList();
        }

        // --- 聊天室功能 ---
        function openChatRoom(contactId) {
            const contact = appData.contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            currentChatContactId = contactId;
            
            if (!appData.chat.messages[contactId]) appData.chat.messages[contactId] = [];
            if (!appData.chat.chatSettings[contactId]) {
                appData.chat.chatSettings[contactId] = {
                    replyCount: { min: 1, max: 8 }
                };
            }
            
            currentTurnId = (appData.chat.messages[contactId]?.slice(-1)[0]?.turnId) || `turn_${Date.now()}`;
            openSubPage('chatRoom');
            
            updateChatRoomHeader();
            renderChatMessages();
            updateChatRoomUI();
            updateChatRoomModeButton();
            
            const navBar = document.querySelector('#chatRoomContainer .app-navigation-bar');
            const content = document.querySelector('#chatRoomContainer .app-content');
            setTimeout(() => {
                const navBarHeight = navBar.offsetHeight;
                content.style.paddingTop = `${44 + navBarHeight}px`;
            }, 50);
        }

        function updateChatRoomHeader() {
            const contact = appData.contacts.find(c => c.id === currentChatContactId);
            const chatSettings = appData.chat.chatSettings[currentChatContactId] || {};
            
            document.getElementById('chatRoomTitle').textContent = contact.name || '聊天';
            document.getElementById('chatRoomRemark').textContent = chatSettings.remark || '';
            document.getElementById('chatRoomHeaderAvatar').style.backgroundImage = `url(${chatSettings.charAvatar || contact.avatar || ''})`;
        }

        function updateChatRoomUI() {
            const settings = appData.chat.chatSettings[currentChatContactId] || {};
            const container = document.getElementById('chatRoomContainer');
            container.style.backgroundImage = settings.bg ? `url(${settings.bg})` : '';
        }

        function renderChatMessages() {
            const container = document.getElementById('chatMessagesContainer');
            container.innerHTML = '';
            const originalMessages = appData.chat.messages[currentChatContactId] || [];
            
            if (originalMessages.length === 0) {
                container.innerHTML = `<div class="app-placeholder" style="color: #999;">${t('chat_room_start_chat')}</div>`;
                return;
            }

            const processedMessages = [];
            for (let i = 0; i < originalMessages.length; i++) {
                let msg = { ...originalMessages[i] };
                if (msg.type === 'sticker' && msg.status !== 'recalled') {
                    let count = 1;
                    while (i + 1 < originalMessages.length &&
                           originalMessages[i + 1].type === 'sticker' &&
                           originalMessages[i + 1].content === msg.content &&
                           originalMessages[i + 1].sender === msg.sender &&
                           originalMessages[i + 1].status !== 'recalled') {
                        count++;
                        i++;
                    }
                    msg.stickerCount = count;
                }
                processedMessages.push(msg);
            }

            const chatSettings = appData.chat.chatSettings[currentChatContactId] || {};
            const contact = appData.contacts.find(c => c.id === currentChatContactId);
            const user = appData.chat.userProfiles.find(p => p.id === appData.chat.activeProfileId);

            const charAvatar = chatSettings.charAvatar || contact?.avatar || '';
            const userAvatar = chatSettings.userAvatar || user?.avatar || '';
            const charAvatarFrame = chatSettings.charAvatarFrame || '';
            const userAvatarFrame = chatSettings.userAvatarFrame || '';

            let lastMessageTimestamp = 0;
            const timeDiffThreshold = 15 * 60 * 1000;

            for (let i = 0; i < processedMessages.length; i++) {
                const msg = processedMessages[i];
                const prevMsg = processedMessages[i - 1];

                if (msg.status === 'recalled') {
                    const recalledEl = document.createElement('div');
                    recalledEl.className = 'recalled-message-center';
                    recalledEl.textContent = `${msg.sender === 'user' ? t('chat_room_you') : (contact?.name || '对方')}${t('chat_room_recalled_msg')}`;
                    container.appendChild(recalledEl);
                    continue;
                }

                if (msg.timestamp - lastMessageTimestamp > timeDiffThreshold) {
                    const timeEl = document.createElement('div');
                    timeEl.className = 'message-timestamp-center';
                    timeEl.textContent = new Date(msg.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                    container.appendChild(timeEl);
                    lastMessageTimestamp = msg.timestamp;
                }

                const isConsecutive = prevMsg && prevMsg.sender === msg.sender && prevMsg.status !== 'recalled' && (msg.timestamp - prevMsg.timestamp < 60000);

                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper ${msg.sender === 'user' ? 'message-right' : 'message-left'}`;
                if (isConsecutive) wrapper.classList.add('consecutive');
                wrapper.dataset.messageId = msg.id;
                if (multiSelectMode) wrapper.classList.add('multiselect-mode');

                const quotedMessageHTML = msg.quote ? `<div class="quoted-reply">${msg.quote.senderName}: ${msg.quote.content}</div>` : '';
                
                let bubbleContent = '';
                switch(msg.type) {
                    case 'text': bubbleContent = `<div class="message-bubble">${msg.content}</div>`; break;
                    case 'image': bubbleContent = `<div class="message-bubble" style="padding: 3px;"><img src="${msg.content}" alt="图片" onclick="triggerVisionAPI(event, '${msg.content}', '${msg.id}')"></div>`; break;
                    case 'video': bubbleContent = `<div class="message-bubble" style="padding: 3px;"><video src="${msg.content}" controls></video></div>`; break;
                    case 'sticker':
                        const countHTML = msg.stickerCount > 1 ? `<span class="sticker-count">x${msg.stickerCount}</span>` : '';
                        bubbleContent = `
                            <div class="sticker-bubble-wrapper">
                                <div class="message-bubble">
                                    <img src="${msg.content}">
                                </div>
                                ${countHTML}
                            </div>`;
                        break;
                    case 'transfer':
                        let statusText = '';
                        if (msg.content.status === 'sent') statusText = '转账待领取';
                        if (msg.content.status === 'received') statusText = '已收款';
                        if (msg.content.status === 'returned') statusText = '已退回';
                        bubbleContent = `
                            <div class="transfer-bubble" onclick="handleTransferClick('${msg.id}')">
                                <div class="transfer-header"><i class="fas fa-exchange-alt transfer-icon"></i><span class="transfer-title">${t('chat_action_transfer')}</span></div>
                                <div class="transfer-amount">¥${msg.content.amount.toFixed(2)}</div>
                                ${msg.content.memo ? `<div class="transfer-memo">${msg.content.memo}</div>` : ''}
                                <div class="transfer-status">${statusText}</div>
                            </div>`;
                        break;
                    case 'sim-file':
                        bubbleContent = `
                            <div class="file-bubble">
                                <i class="fas fa-file-alt file-icon-lg"></i>
                                <div class="file-info">
                                    <div class="file-name">${msg.content.name}</div>
                                    <div class="file-size">${msg.content.size}</div>
                                </div>
                            </div>`;
                        break;
                    case 'location':
                         bubbleContent = `
                            <div class="location-bubble" onclick="showLocationDetails('${msg.id}')">
                                <div class="location-text">
                                    <div class="location-title">${msg.content.title}</div>
                                    <div class="location-summary">${msg.content.summary}</div>
                                </div>
                                <div class="location-map-placeholder"><i class="fas fa-map-marker-alt"></i></div>
                            </div>`;
                        break;
                    case 'sim-camera':
                        bubbleContent = `
                            <div class="image-placeholder-bubble" onclick="this.classList.toggle('revealed')">
                                <span class="placeholder-text"><i class="fas fa-image"></i> 该图已破损</span>
                                <div class="real-content">${msg.content.description}</div>
                            </div>`;
                        break;
                    case 'sim-video':
                        bubbleContent = `
                            <div class="sim-video-bubble">
                                <div class="sim-video-player">
                                    <i class="fas fa-play"></i>
                                    <div class="sim-video-duration">${msg.content.duration}</div>
                                </div>
                                <div class="sim-video-info">
                                    <div class="sim-video-desc">${msg.content.description}</div>
                                    <div class="sim-video-size">${msg.content.size}</div>
                                </div>
                            </div>`;
                        break;
                    case 'voice':
                        bubbleContent = `
                            <div class="message-bubble voice-bubble" onclick="toggleVoicePlay(event)" ondblclick="toggleVoiceText(event, this)">
                                <i class="fas fa-play voice-icon"></i>
                                <div class="voice-wave-container">
                                    ${'<div class="voice-wave-bar"></div>'.repeat(10)}
                                </div>
                                <span class="voice-duration">${msg.content.duration}s</span>
                                <div class="voice-text-content">${msg.content.text}</div>
                            </div>`;
                        break;
                    case 'tieba-share':
                        bubbleContent = `
                            <div class="tieba-share-bubble" onclick="openTiebaPostDetail('${msg.content.id}')">
                                <div class="tieba-share-title">${msg.content.title}</div>
                                <div class="tieba-share-content">${msg.content.content}</div>
                                <div class="tieba-share-footer"><i class="fas fa-comments"></i> 来自 贴吧</div>
                            </div>`;
                        break;
                    case 'music-share':
                        bubbleContent = `
                            <div class="music-share-bubble" onclick="playSharedMusic('${msg.content.id}')">
                                <div class="music-share-header">
                                    <div class="music-share-cover" style="background-image: url(${msg.content.cover})"></div>
                                    <div class="music-share-info">
                                        <div class="music-share-title">${msg.content.title}</div>
                                        <div class="music-share-artist">${msg.content.artist}</div>
                                    </div>
                                </div>
                                <div class="music-share-footer">
                                    <span>一起听</span>
                                    <i class="fas fa-play-circle"></i>
                                </div>
                            </div>`;
                        break;
                    case 'typing': bubbleContent = `<div class="message-typing-indicator">${t('chat_room_typing')}</div>`; break;
                }
                const contentHTML = `<div class="message-bubble-wrapper" onclick="handleMessageClick(event, '${msg.id}')">${bubbleContent}</div>`;

                const avatarUrl = msg.sender === 'user' ? userAvatar : charAvatar;
                const avatarFrameUrl = msg.sender === 'user' ? userAvatarFrame : charAvatarFrame;
                const messageTimestampUnder = `<div class="message-timestamp-under">${new Date(msg.timestamp).toLocaleTimeString('zh-CN', {hour12: false, hour: '2-digit', minute:'2-digit', second:'2-digit'})}</div>`;
                
                const multiselectCheckbox = multiSelectMode ? `<input type="checkbox" class="multiselect-checkbox" onchange="toggleMessageSelection('${msg.id}')" ${selectedMessages.has(msg.id) ? 'checked' : ''}>` : '';

                wrapper.innerHTML = `
                    ${multiselectCheckbox}
                    <div class="message-avatar-wrapper">
                        <div class="message-avatar" style="background-image: url(${avatarUrl})"></div>
                        <div class="message-avatar-frame" style="background-image: url(${avatarFrameUrl})"></div>
                    </div>
                    <div class="message-content-wrapper">
                        ${quotedMessageHTML}
                        ${contentHTML}
                        ${messageTimestampUnder}
                    </div>
                `;
                container.appendChild(wrapper);
            }
            container.scrollTop = container.scrollHeight;
        }

        function addMessage(message, contactId = currentChatContactId) {
            if (!appData.chat.messages[contactId]) {
                appData.chat.messages[contactId] = [];
            }
            const messages = appData.chat.messages[contactId];
            const typingIndex = messages.findIndex(m => m.type === 'typing');
            if (typingIndex > -1) {
                messages.splice(typingIndex, 1);
            }

            if (message.sender === 'user') {
                currentTurnId = `turn_${Date.now()}`;
            }
            message.turnId = currentTurnId;

            messages.push(message);
            saveData(true);
            
            if (contactId === currentChatContactId) {
                renderChatMessages();
            }
            renderMessagesList();
        }

        function sendTextMessage() {
            const input = document.getElementById('chatInputField');
            const content = input.value.trim();
            if (content) {
                const quoteInfo = JSON.parse(input.dataset.quote || 'null');
                addMessage({
                    id: `msg_${Date.now()}`,
                    type: 'text',
                    sender: 'user',
                    content: content,
                    timestamp: Date.now(),
                    quote: quoteInfo
                });
                input.value = '';
                input.style.height = 'auto';
                input.dataset.quote = '';
                document.getElementById('chatInputField').placeholder = t('chat_input_placeholder');
                input.dispatchEvent(new Event('input'));
            }
        }

        function sendImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const type = file.type.startsWith('video') ? 'video' : 'image';
                    const messageId = `msg_${Date.now()}`;
                    addMessage({
                        id: messageId,
                        type: type,
                        sender: 'user',
                        content: e.target.result,
                        timestamp: Date.now()
                    });
                    if (type === 'image') {
                        triggerVisionAPI(event, e.target.result, messageId);
                    }
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }

        function toggleQuickActions() {
            const quickActions = document.getElementById('chatQuickActions');
            quickActions.classList.toggle('hidden');
        }

        // --- AI回复逻辑 ---
        function getRealTimeContext() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            const dayOfWeek = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'][now.getDay()];

            let timeOfDay = '';
            if (hours >= 5 && hours < 9) timeOfDay = '清晨';
            else if (hours >= 9 && hours < 12) timeOfDay = '上午';
            else if (hours >= 12 && hours < 14) timeOfDay = '中午';
            else if (hours >= 14 && hours < 18) timeOfDay = '下午';
            else if (hours >= 18 && hours < 24) timeOfDay = '晚上';
            else timeOfDay = '深夜';

            let festival = '';
            if (month === 1 && day === 1) festival = '元旦';
            if (month === 2 && day === 14) festival = '情人节';
            if (month === 5 && day === 20) festival = '520网络情人节';
            if (month === 12 && day === 25) festival = '圣诞节';

            let context = `现在是北京时间 ${year}年${month}月${day}日 ${dayOfWeek} ${timeOfDay} ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}。`;
            if (festival) {
                context += `今天是${festival}。`;
            }
            return context;
        }

        function getRecentTopics() {
            const messages = (appData.chat.messages[currentChatContactId] || [])
                .filter(m => m.type === 'text')
                .slice(-5)
                .map(m => m.content);
            if (messages.length === 0) return "无";
            return messages.join('; ');
        }

        async function triggerApiReply() {
            let api = appData.settings.chatApi;
            if (api.useMain) {
                api = appData.settings.mainApi;
            }

            if (!api.key) {
                showiOSAlert(t('common_error'), '请先在“设置”>“API设置”中配置您的聊天API密钥。', 'error');
                return;
            }
            const contact = appData.contacts.find(c => c.id === currentChatContactId);
            const user = appData.chat.userProfiles.find(p => p.id === appData.chat.activeProfileId);
            if (!contact || !user) {
                showiOSAlert(t('common_error'), '请确保已设置联系人和当前用户自设。', 'error');
                return;
            }

            addMessage({ id: `typing_${Date.now()}`, type: 'typing', sender: 'char', timestamp: Date.now() });

            const historyMessages = (appData.chat.messages[currentChatContactId] || [])
                .filter(m => m.type === 'text' && m.status !== 'recalled')
                .slice(-15)
                .map(m => ({
                    role: m.sender === 'user' ? 'user' : 'assistant',
                    content: m.content
                }));
            
            const chatMode = appData.settings.chatMode;
            const replyCount = appData.chat.chatSettings[currentChatContactId]?.replyCount || { min: 1, max: 8 };
            let modeInstructions, formatInstructions;

            if (chatMode === 'offline') {
                modeInstructions = `## 对话模式：线下剧情\n- **风格**: 生成一段包含神态、动作、环境、心理等细节描写的长文剧情。\n- **长度**: 回复应为一段完整的、描述性的文本，字数不限。\n- **禁止**: 不要使用任何括号。`;
                formatInstructions = `## 回复格式\n你的回复必须是一个 JSON 对象，格式如下:\n\`\`\`json\n{\n  "action": "text",\n  "content": "你的长篇剧情描述内容。"\n}\n\`\`\``;
            } else {
                modeInstructions = `## 对话模式：线上聊天\n- **风格**: 模拟真实的人类在线聊天，一次发送一句话，每句话严格限制在20个字符以内，不要加任何标点符号。\n- **长度**: 生成一个包含 ${replyCount.min} 到 ${replyCount.max} 句话的对话轮次。\n- **表情包**: 你有 30% 到 65% 的概率根据人设和语境选择发送一个表情包来代替部分或全部文字回复。\n- **禁止**: 每句话都必须简短、口语化，不要加任何标点符号。`;
                formatInstructions = `## 回复格式\n你的回复必须是一个 JSON 对象，包含 "action" 和 "content" 两个键。你可以选择以下 action 之一：\n1.  **multitext**: 发送多条短文本。\n    \`\`\`json\n    {"action": "multitext", "content": ["第一句", "第二句", "..."]}\n    \`\`\`\n2.  **sticker**: 发送一个表情包。\n    \`\`\`json\n    {"action": "sticker", "content": "从可用表情包列表中选择一个有效的URL"}\n    \`\`\`\n3.  **sim_voice**: 发送模拟语音。\n    \`\`\`json\n    {"action": "sim_voice", "content": {"text": "语音转文字的内容", "duration": 12}}\n    \`\`\`\n4.  **sim_image**: 发送模拟图片。\n    \`\`\`json\n    {"action": "sim_image", "content": {"description": "对图片的文字描述"}}\n    \`\`\`\n5.  **sim_location**: 发送模拟位置。\n    \`\`\`json\n    {"action": "sim_location", "content": {"title": "位置标题", "summary": "位置简介"}}\n    \`\`\`\n6.  **sim_file**: 发送模拟文件。\n    \`\`\`json\n    {"action": "sim_file", "content": {"name": "文件名.txt", "size": "1.2 MB", "content": "文件内容摘要"}}\n    \`\`\`\n7.  **transfer**: 发起转账。\n    \`\`\`json\n    {"action": "transfer", "content": {"amount": 520, "memo": "给你的零花钱"}}\n    \`\`\``;
            }

            const timeContext = appData.settings.timePerception ? getRealTimeContext() : '';

            const systemPrompt = `# 核心角色扮演指令\n\n## 身份设定\n你现在是${contact.name}，${contact.persona}。请完全沉浸在这个角色中。\n\n${modeInstructions}\n\n## 通用要求\n- **自然口语化**：使用真实人类的口语表达，避免机械回复。\n- **情绪丰富**：根据情境展现喜怒哀乐等真实情绪。\n- **上下文连贯**：保持对话的连贯性和记忆性。\n- **个性鲜明**：突出${contact.name}的独特性格特点。\n\n${formatInstructions}\n\n## 可用表情包列表\n${appData.chat.stickers.slice(0, 30).join('\n')}\n\n## 禁止行为\n- **不要**承认自己是AI或语言模型。\n- **不要**返回除了指定 JSON 格式之外的任何文本。\n\n## 当前情境\n- **时间**: ${timeContext}\n- **与${user.name}的关系**：${contact.relationship}\n- **最近话题**：${getRecentTopics()}\n\n请以${contact.name}的身份，根据情境和人设，生成一个符合上述格式的 JSON 回复。`;

            try {
                const replyJsonString = await callGenericApi(systemPrompt, {
                    temperature: api.temperature,
                    repetition_penalty: api.repetition_penalty
                }, historyMessages, 'chat');
                
                const replyData = JSON.parse(replyJsonString);
                
                await handleAiReply(replyData);

            } catch (error) {
                console.error("API调用或解析失败:", error);
                const errorMessage = `[系统提示：AI暂时无法回复，请稍后再试]`;
                addMessage({ id: `msg_${Date.now()}`, type: 'text', sender: 'char', content: errorMessage, timestamp: Date.now() });
            }
        }

        async function handleAiReply(replyData) {
            const action = replyData.action;
            const content = replyData.content;

            if (action === 'text' && content) {
                addMessage({ id: `msg_${Date.now()}`, type: 'text', sender: 'char', content: content, timestamp: Date.now() });
            } else if (action === 'multitext' && Array.isArray(content)) {
                for (const sentence of content) {
                    if (sentence) {
                        addMessage({ id: `msg_${Date.now()}_${Math.random()}`, type: 'text', sender: 'char', content: sentence, timestamp: Date.now() });
                        await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
                    }
                }
            } else if (action === 'sticker' && typeof content === 'string') {
                addMessage({ id: `msg_${Date.now()}`, type: 'sticker', sender: 'char', content: content, timestamp: Date.now() });
            } else if (action === 'sim_voice' && content) {
                sendVoiceSim('char', content);
            } else if (action === 'sim_image' && content) {
                sendCameraSim('char', 'image', content);
            } else if (action === 'sim_location' && content) {
                sendLocation('char', content);
            } else if (action === 'sim_file' && content) {
                sendFile('char', 'sim', content);
            } else if (action === 'transfer' && content) {
                sendTransfer('char', content.amount, content.memo);
            }
        }

        async function triggerVisionAPI(event, imageUrl, messageId) {
            event.stopPropagation();
            let visionApi = appData.settings.visionApi;
            if (visionApi.useMain) {
                visionApi = appData.settings.mainApi;
            }

            if (!visionApi.key) {
                showiOSAlert(t('common_info'), '请在设置中配置识图API以启用图片识别功能。', 'info');
                return;
            }
            
            addMessage({ id: `typing_${Date.now()}`, type: 'typing', sender: 'char', timestamp: Date.now() });

            const contact = appData.contacts.find(c => c.id === currentChatContactId);
            const user = appData.chat.userProfiles.find(p => p.id === appData.chat.activeProfileId);
            const recentHistory = (appData.chat.messages[currentChatContactId] || [])
                .filter(m => m.type === 'text' && m.id !== messageId)
                .slice(-5)
                .map(m => `${m.sender === 'user' ? user.name : contact.name}: ${m.content}`)
                .join('\n');

            const prompt = `你正在和 ${user.name} 聊天，他/她刚刚给你发了一张图片。你的身份是 ${contact.name} (${contact.persona})。
            ## 任务
            1.  仔细识别图片内容。
            2.  不要直接描述图片，而是将图片内容与你们的聊天情境、你的角色性格和人设自然地结合起来，发表评论或感想。
            3.  你的回复应该像真人看到图片后的自然反应，可以提出问题，可以联想，可以开玩笑等。
            
            ## 当前情境
            - **最近的对话**: \n${recentHistory}
            - **你的性格**: ${contact.persona}
            
            ## 回复要求
            - **重要**: 你的回复必须是一个 JSON 对象，格式为 {"action": "multitext", "content": ["第一句回复。", "第二句回复。", "..."]}。
            - 将你的感想拆分成多句简短、口语化的句子，放入 content 数组中。
            - 只返回这个纯 JSON 对象，不要任何额外标记或文本。`;
            
            try {
                const replyJsonString = await callGenericApi(prompt, { temperature: visionApi.temperature }, [{
                    role: 'user',
                    content: [
                        { type: 'text', text: prompt },
                        { type: 'image_url', image_url: { url: imageUrl } }
                    ]
                }], 'vision');
                
                const replyData = JSON.parse(replyJsonString);
                await handleAiReply(replyData);

            } catch (error) {
                console.error("识图API调用失败:", error);
                const errorMessage = `[系统提示：图片识别失败，请稍后再试]`;
                addMessage({ id: `msg_${Date.now()}`, type: 'text', sender: 'char', content: errorMessage, timestamp: Date.now() });
            }
        }

        function openStickerModal() {
            if (appData.chat.stickers.length === 0) {
                showiOSAlert(t('common_info'), '你还没有导入任何表情包。请在快捷操作中导入。');
                return;
            }
            const stickerGrid = appData.chat.stickers.map(url => 
                `<div class="sticker-item" style="background-image: url(${url})" onclick="sendSticker('${url}')"></div>`
            ).join('');
            showModal(`
                <div class="modal-title">选择表情包</div>
                <div class="modal-body" id="stickerModal">
                    <div class="sticker-grid">${stickerGrid}</div>
                </div>
            `);
        }

        function openStickerImportModal() {
            showCustomiOSAlert(t('chat_action_import_sticker'), '请选择导入方式', [
                { text: 'URL 导入', action: () => showStickerUrlImport() },
                { text: '本地导入', action: () => showStickerLocalImport() },
                { text: t('common_cancel'), style: 'bold' }
            ]);
        }

        function showStickerUrlImport() {
            showModal(`
                <div class="modal-title">URL导入表情包</div>
                <div class="modal-body" style="background: var(--theme-bg); padding: 20px; gap: 15px; display: flex; flex-direction: column;">
                    <div class="glass-form-group">
                        <label>单个 URL</label>
                        <input type="text" id="sticker-url-single" class="glass-input" placeholder="http://.../image.png">
                    </div>
                    <button class="glass-button" onclick="importStickersFromUrl('single')">导入单个</button>
                    <div class="glass-form-group">
                        <label>批量 URL (每行一个)</label>
                        <textarea id="sticker-url-batch" class="glass-textarea" style="min-height: 100px;"></textarea>
                    </div>
                    <button class="glass-button" onclick="importStickersFromUrl('batch')">导入批量</button>
                </div>
            `);
        }

        function importStickersFromUrl(type) {
            let urls = [];
            if (type === 'single') {
                const url = document.getElementById('sticker-url-single').value.trim();
                if (url) urls.push(url);
            } else {
                const batchUrls = document.getElementById('sticker-url-batch').value.trim();
                urls = batchUrls.split('\n').map(u => u.trim()).filter(Boolean);
            }

            if (urls.length > 0) {
                appData.chat.stickers.push(...urls);
                appData.chat.stickers = [...new Set(appData.chat.stickers)]; // 去重
                saveData();
                showiOSAlert(t('common_success'), `${urls.length}个表情包已添加。`);
                closeModal();
            } else {
                showiOSAlert(t('common_error'), '请输入有效的URL。', 'error');
            }
        }

        function showStickerLocalImport() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.style.display = 'none';
            input.onchange = (e) => {
                const files = e.target.files;
                if (files.length > 0) {
                    let importedCount = 0;
                    Array.from(files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            appData.chat.stickers.push(event.target.result);
                            importedCount++;
                            if (importedCount === files.length) {
                                appData.chat.stickers = [...new Set(appData.chat.stickers)]; // 去重
                                saveData();
                                showiOSAlert(t('common_success'), `${importedCount}个表情包已添加。`);
                            }
                        };
                        reader.readAsDataURL(file);
                    });
                }
            };
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        }

        function sendSticker(url) {
            addMessage({
                id: `msg_${Date.now()}`,
                type: 'sticker',
                sender: 'user',
                content: url,
                timestamp: Date.now()
            });
            closeModal();
        }

        function openTransferModal(sender) {
            const title = sender === 'user' ? t('chat_action_transfer') : '模拟转账';
            showModal(`
                <div class="modal-title">${title}</div>
                <div class="modal-body" id="transferModal">
                    <div class="transfer-form">
                        <div class="glass-form-group">
                            <label>转账金额</label>
                            <input type="number" id="transfer-amount" class="glass-input" placeholder="¥ 0.00">
                        </div>
                        <div class="glass-form-group">
                            <label>备注 (最多10字)</label>
                            <input type="text" id="transfer-memo" class="glass-input" maxlength="10">
                        </div>
                        <button class="glass-button" onclick="sendTransfer('user')">确认转账</button>
                    </div>
                </div>
            `);
        }

        function sendTransfer(sender, amount, memo) {
            let transferAmount, transferMemo;
            if (sender === 'user') {
                transferAmount = parseFloat(document.getElementById('transfer-amount').value);
                transferMemo = document.getElementById('transfer-memo').value;
            } else {
                transferAmount = amount;
                transferMemo = memo;
            }

            if (isNaN(transferAmount) || transferAmount <= 0) {
                showiOSAlert(t('common_error'), '请输入有效的转账金额。', 'error');
                return;
            }
            
            if (sender === 'user') {
                const currentCurrency = appData.chat.wallet.currency;
                const currentRate = exchangeRates[currentCurrency].rate;
                const amountInUSD = transferAmount / currentRate;

                if (appData.chat.wallet.balance < amountInUSD) {
                    showiOSAlert(t('common_error'), '您的钱包余额不足以完成此笔转账。', 'error');
                    return;
                }

                appData.chat.wallet.balance -= amountInUSD;
                appData.chat.transactions.push({ type: `转账给 ${appData.contacts.find(c=>c.id===currentChatContactId).name}`, amount: -amountInUSD, date: Date.now() });
                renderWallet();
            }
            
            addMessage({
                id: `msg_${Date.now()}`,
                type: 'transfer',
                sender: sender,
                content: { amount: transferAmount, memo: transferMemo, status: 'sent' },
                timestamp: Date.now()
            });
            
            if (sender === 'user') {
                closeModal();
            }
        }

        function handleTransferClick(messageId) {
            const message = appData.chat.messages[currentChatContactId].find(m => m.id === messageId);
            if (!message) return;

            const contact = appData.contacts.find(c => c.id === currentChatContactId);
            const amount = message.content.amount;

            if (message.sender === 'user') {
                let statusText = '';
                switch(message.content.status) {
                    case 'sent': statusText = '对方尚未领取'; break;
                    case 'received': statusText = '对方已收款'; break;
                    case 'returned': statusText = '转账已退回'; break;
                }
                showiOSAlert('转账详情', `您向 ${contact.name} 的转账<br>金额: ¥${amount.toFixed(2)}<br>状态: ${statusText}`);
            } else { // 消息来自 Char
                if (message.content.status !== 'sent') {
                    const statusText = message.content.status === 'received' ? '已收款' : '已退回';
                    showiOSAlert('转账详情', `来自 ${contact.name} 的转账<br>金额: ¥${amount.toFixed(2)}<br>状态: ${statusText}`);
                    return;
                }
                showCustomiOSAlert('收到一笔转账', `来自 ${contact.name} 的转账: ¥${amount.toFixed(2)}`, [
                    { text: '领取', action: () => {
                        message.content.status = 'received';
                        const amountInUSD = amount / exchangeRates['CNY'].rate;
                        appData.chat.wallet.balance += amountInUSD;
                        appData.chat.transactions.push({ type: `收到 ${contact.name} 的转账`, amount: amountInUSD, date: Date.now() });
                        showiOSAlert('已收款', `已领取来自 ${contact.name} 的转账。`);
                        saveData(true);
                        renderChatMessages();
                        renderWallet();
                    }},
                    { text: '退回', style: 'destructive', action: () => {
                        message.content.status = 'returned';
                        showiOSAlert('已退回', `转账已退回给 ${contact.name}。`);
                        saveData(true);
                        renderChatMessages();
                    }},
                    { text: t('common_cancel'), style: 'bold' }
                ]);
            }
        }

        // --- 聊天设置功能 ---
        function toggleChatRoomMode() {
            const currentMode = appData.settings.chatMode;
            const newMode = currentMode === 'online' ? 'offline' : 'online';
            setChatMode(newMode, true);
            showiOSAlert('模式切换', `已切换到 ${newMode === 'online' ? '线上聊天' : '线下剧情'} 模式`);
        }

        function updateChatRoomModeButton() {
            const btn = document.getElementById('chatModeToggleBtn');
            if (!btn) return;
            const mode = appData.settings.chatMode;
            if (mode === 'online') {
                btn.innerHTML = '<i class="fas fa-comments"></i>';
                btn.title = '切换到线下剧情';
            } else {
                btn.innerHTML = '<i class="fas fa-book-open"></i>';
                btn.title = '切换到线上聊天';
            }
        }

        function openChatSettings() {
            openSubPage('chatSettings');
            const settings = appData.chat.chatSettings[currentChatContactId] || {};
            document.getElementById('pinContactText').textContent = settings.pinned ? t('chat_settings_unpin') : t('chat_settings_pin');
        }

        function editChatRemark() {
            const chatSettings = appData.chat.chatSettings[currentChatContactId] || {};
            const newRemark = prompt(t('chat_settings_edit_remark'), chatSettings.remark || '');
            if (newRemark !== null) {
                chatSettings.remark = newRemark.trim();
                appData.chat.chatSettings[currentChatContactId] = chatSettings;
                saveData();
                updateChatRoomHeader();
            }
        }

        function togglePinContact() {
            if (!appData.chat.chatSettings[currentChatContactId]) appData.chat.chatSettings[currentChatContactId] = {};
            const settings = appData.chat.chatSettings[currentChatContactId];
            settings.pinned = !settings.pinned;
            saveData();
            document.getElementById('pinContactText').textContent = settings.pinned ? t('chat_settings_unpin') : t('chat_settings_pin');
            renderMessagesList();
            showiOSAlert(t('common_success'), settings.pinned ? '已置顶' : '已取消置顶');
        }

        function blockContact() {
            if (confirm(`确定要拉黑该联系人吗？`)) {
                if (!appData.settings.blacklist.includes(currentChatContactId)) {
                    appData.settings.blacklist.push(currentChatContactId);
                    saveData();
                    closeSubPage('chatSettings');
                    closeSubPage('chatRoom');
                    renderMessagesList();
                    showiOSAlert('已拉黑', '该联系人已移至黑名单。');
                }
            }
        }

        function changeChatBackground(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (!appData.chat.chatSettings[currentChatContactId]) appData.chat.chatSettings[currentChatContactId] = {};
                    appData.chat.chatSettings[currentChatContactId].bg = e.target.result;
                    saveData();
                    updateChatRoomUI();
                };
                reader.readAsDataURL(file);
            }
        }

        function changeChatAvatar(event, type) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (!appData.chat.chatSettings[currentChatContactId]) appData.chat.chatSettings[currentChatContactId] = {};
                    if (type === 'char') {
                        appData.chat.chatSettings[currentChatContactId].charAvatar = e.target.result;
                    } else {
                        appData.chat.chatSettings[currentChatContactId].userAvatar = e.target.result;
                    }
                    saveData();
                    renderChatMessages();
                    updateChatRoomHeader();
                };
                reader.readAsDataURL(file);
            }
        }

        function triggerAvatarFrameUpload(type) {
            document.getElementById(`${type}-avatar-frame-upload`).click();
        }

        function changeAvatarFrame(event, type) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (!appData.chat.chatSettings[currentChatContactId]) appData.chat.chatSettings[currentChatContactId] = {};
                    
                    if (type === 'char') {
                        appData.chat.chatSettings[currentChatContactId].charAvatarFrame = e.target.result;
                    } else {
                        appData.chat.chatSettings[currentChatContactId].userAvatarFrame = e.target.result;
                    }
                    
                    saveData();
                    renderChatMessages();
                };
                reader.readAsDataURL(file);
            }
        }

        function clearChatHistory() {
            if (confirm('确定要清空与该联系人的所有聊天记录吗？此操作不可恢复。')) {
                appData.chat.messages[currentChatContactId] = [];
                saveData();
                renderChatMessages();
                showiOSAlert('已清空', '聊天记录已全部清除。');
            }
        }

        function openReplyCountSettings() {
            const chatSettings = appData.chat.chatSettings[currentChatContactId];
            const min = chatSettings.replyCount.min;
            const max = chatSettings.replyCount.max;

            showModal(`
                <div class="modal-title" data-lang="chat_settings_reply_count">自定义回复条数</div>
                <div class="modal-body" style="background: var(--theme-bg); padding: 20px; gap: 15px; display: flex; flex-direction: column;">
                    <div class="glass-form-group">
                        <label>最小回复条数</label>
                        <input type="number" id="reply-count-min" class="glass-input" value="${min}" min="1" max="20">
                    </div>
                    <div class="glass-form-group">
                        <label>最大回复条数</label>
                        <input type="number" id="reply-count-max" class="glass-input" value="${max}" min="1" max="20">
                    </div>
                    <button class="glass-button" onclick="saveReplyCountSettings()">保存</button>
                </div>
            `);
        }

        function saveReplyCountSettings() {
            let min = parseInt(document.getElementById('reply-count-min').value);
            let max = parseInt(document.getElementById('reply-count-max').value);

            if (isNaN(min) || isNaN(max) || min < 1 || max < 1 || min > max) {
                showiOSAlert(t('common_error'), '请输入有效的数值，且最小值不能大于最大值。', 'error');
                return;
            }

            appData.chat.chatSettings[currentChatContactId].replyCount = { min, max };
            saveData();
            closeModal();
        }

        // --- 钱包 & 银行卡功能 ---
        function renderBankCards() {
            const container = document.getElementById('bankCardList');
            container.innerHTML = '';
            if (appData.chat.bankCards.length === 0) {
                container.innerHTML = `<div class="app-placeholder">${t('bank_card_placeholder')}</div>`;
                return;
            }
            appData.chat.bankCards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'bank-card';
                cardEl.innerHTML = `
                    <div class="bank-card-name">${card.name}</div>
                    <div class="bank-card-balance">¥${card.balance.toFixed(2)}</div>
                    <div class="bank-card-number">${card.number.replace(/(\d{4})/g, '$1 ')}</div>
                `;
                container.appendChild(cardEl);
            });
        }

        function addBankCard() {
            const bankNames = ["绮梦银行", "琉璃银行", "星尘银行", "幻海银行", "玫瑰储蓄"];
            const newCard = {
                id: `card_${Date.now()}`,
                name: bankNames[Math.floor(Math.random() * bankNames.length)],
                number: Array.from({length: 16}, () => Math.floor(Math.random() * 10)).join(''),
                balance: 10000 + Math.random() * 90000
            };
            appData.chat.bankCards.push(newCard);
            saveData();
            renderBankCards();
        }

        function renderWallet() {
            const wallet = appData.chat.wallet;
            const currency = wallet.currency;
            const rate = exchangeRates[currency].rate;
            const symbol = exchangeRates[currency].symbol;
            const displayBalance = wallet.balance * rate;
            document.getElementById('walletBalanceAmount').textContent = `${symbol}${displayBalance.toFixed(2)}`;

            const switcher = document.getElementById('currencySwitcher');
            switcher.innerHTML = Object.keys(exchangeRates).map(c => 
                `<button class="${c === currency ? 'active' : ''}" onclick="switchCurrency('${c}')">${c}</button>`
            ).join('');
        }

        function switchCurrency(newCurrency) {
            if (exchangeRates[newCurrency]) {
                appData.chat.wallet.currency = newCurrency;
                saveData();
                renderWallet();
            }
        }

        function renderTransactionHistory() {
            const container = document.getElementById('transactionHistoryList');
            container.innerHTML = '';
            if (appData.chat.transactions.length === 0) {
                container.innerHTML = `<div class="app-placeholder">${t('transaction_history_placeholder')}</div>`;
                return;
            }
            const currency = appData.chat.wallet.currency;
            const rate = exchangeRates[currency].rate;
            const symbol = exchangeRates[currency].symbol;

            [...appData.chat.transactions].reverse().forEach(tx => {
                const itemEl = document.createElement('div');
                itemEl.className = 'transaction-item';
                const isIncome = tx.amount > 0;
                const displayAmount = tx.amount * rate;
                itemEl.innerHTML = `
                    <div class="transaction-info">
                        <div class="type">${tx.type}</div>
                        <div class="date">${new Date(tx.date).toLocaleString()}</div>
                    </div>
                    <div class="transaction-amount ${isIncome ? 'income' : 'expense'}">
                        ${isIncome ? '+' : ''}${symbol}${displayAmount.toFixed(2)}
                    </div>
                `;
                container.appendChild(itemEl);
            });
        }

        function showTopUpModal() {
            if (appData.chat.bankCards.length === 0) {
                showiOSAlert(t('common_error'), '请先添加一张银行卡。', 'error');
                return;
            }
            const cardListHtml = appData.chat.bankCards.map(card => 
                `<div class="list-item" onclick="processTopUp('${card.id}')">
                    <span>${card.name} (...${card.number.slice(-4)})</span>
                    <span>¥${card.balance.toFixed(2)}</span>
                </div>`
            ).join('');
            showModal(`
                <div class="modal-title">选择充值银行卡</div>
                <div class="modal-body">${cardListHtml}</div>
            `);
        }

        function processTopUp(cardId) {
            const card = appData.chat.bankCards.find(c => c.id === cardId);
            const amountStr = prompt(`从 ${card.name} 充值，请输入金额 (或输入 'all' 充值全部余额):`, "100");
            if (amountStr === null) return;

            let amount;
            if (amountStr.toLowerCase() === 'all') {
                amount = card.balance;
            } else {
                amount = parseFloat(amountStr);
            }

            if (amount && !isNaN(amount) && amount > 0) {
                if (card.balance < amount) {
                    showiOSAlert(t('common_error'), '银行卡余额不足。', 'error');
                    return;
                }
                card.balance -= amount;
                const amountInUSD = amount / exchangeRates['CNY'].rate;
                appData.chat.wallet.balance += amountInUSD;
                appData.chat.transactions.push({ type: '充值', amount: amountInUSD, date: Date.now() });
                saveData();
                renderWallet();
                renderBankCards();
                closeModal();
                showiOSAlert(t('common_success'), `成功充值 ¥${amount.toFixed(2)}`);
            }
        }

        function showWithdrawModal() {
            if (appData.chat.bankCards.length === 0) {
                showiOSAlert(t('common_error'), '请先添加一张银行卡用于收款。', 'error');
                return;
            }
            const cardListHtml = appData.chat.bankCards.map(card => 
                `<div class="list-item" onclick="processWithdraw('${card.id}')">
                    <span>${card.name} (..${card.number.slice(-4)})</span>
                </div>`
            ).join('');
            showModal(`
                <div class="modal-title">选择提现银行卡</div>
                <div class="modal-body">${cardListHtml}</div>
            `);
        }

        function processWithdraw(cardId) {
            const card = appData.chat.bankCards.find(c => c.id === cardId);
            const currency = appData.chat.wallet.currency;
            const rate = exchangeRates[currency].rate;
            const symbol = exchangeRates[currency].symbol;
            const walletDisplayBalance = appData.chat.wallet.balance * rate;

            const amountStr = prompt(`提现到 ${card.name}，请输入金额 (${currency}):`, "100");
            const amount = parseFloat(amountStr);
            if (amount && !isNaN(amount) && amount > 0) {
                if (walletDisplayBalance < amount) {
                    showiOSAlert(t('common_error'), '钱包余额不足。', 'error');
                    return;
                }
                const amountInUSD = amount / rate;
                const amountInCNY = amountInUSD * exchangeRates['CNY'].rate;
                card.balance += amountInCNY;
                appData.chat.wallet.balance -= amountInUSD;
                appData.chat.transactions.push({ type: '提现', amount: -amountInUSD, date: Date.now() });
                saveData();
                renderWallet();
                renderBankCards();
                closeModal();
                showiOSAlert(t('common_success'), `成功提现 ${symbol}${amount.toFixed(2)}`);
            }
        }

        // --- 消息交互功能 ---
        function handleMessageClick(event, messageId) {
            if (multiSelectMode) {
                const checkbox = event.currentTarget.closest('.message-wrapper').querySelector('.multiselect-checkbox');
                if(checkbox) {
                    checkbox.checked = !checkbox.checked;
                    toggleMessageSelection(messageId);
                }
                return;
            }
            
            const popover = document.getElementById('messageActionPopover');
            const message = appData.chat.messages[currentChatContactId].find(m => m.id === messageId);
            if (!message || message.status === 'recalled') return;

            let actions = [];
            if (message.type === 'text') {
                actions.push({ text: t('common_edit'), func: `editMessage('${messageId}')` });
            }
            actions.push({ text: '引用', func: `quoteMessage('${messageId}')` });
            if (Date.now() - message.timestamp < 2 * 60 * 1000) {
                actions.push({ text: '撤回', func: `recallMessage('${messageId}')` });
            }
            if (message.sender === 'char') {
                actions.push({ text: '重Roll', func: `rerollTurn('${messageId}')` });
            }
            actions.push({ text: t('common_delete'), func: `deleteMessage('${messageId}')`, style: 'destructive' });
            actions.push({ text: '多选', func: `enterMultiSelectMode('${messageId}')` });

            popover.innerHTML = actions.map(a => `<div class="message-action-popover-item ${a.style || ''}" onclick="${a.func}">${a.text}</div>`).join('');
            
            const bubbleWrapper = event.currentTarget;
            const bubbleRect = bubbleWrapper.getBoundingClientRect();
            const screenRect = document.querySelector('.screen').getBoundingClientRect();

            popover.style.display = 'flex';
            const popoverRect = popover.getBoundingClientRect();
            
            let top = bubbleRect.top - screenRect.top - popoverRect.height - 5;
            if (top < 88) { top = bubbleRect.bottom - screenRect.top + 5; }
            let left = bubbleRect.left - screenRect.left + (bubbleRect.width / 2) - (popoverRect.width / 2);
            left = Math.max(5, Math.min(left, screenRect.width - popoverRect.width - 5));

            popover.style.top = `${top}px`;
            popover.style.left = `${left}px`;

            setTimeout(() => { document.addEventListener('click', hideMessagePopover, { once: true }); }, 0);
            event.stopPropagation();
        }

        function hideMessagePopover() {
            document.getElementById('messageActionPopover').style.display = 'none';
        }

        function editMessage(messageId) {
            const message = appData.chat.messages[currentChatContactId].find(m => m.id === messageId);
            if (!message || message.type !== 'text') return;
            const newContent = prompt('编辑消息:', message.content);
            if (newContent !== null) {
                message.content = newContent;
                message.edited = true;
                saveData();
                renderChatMessages();
            }
            hideMessagePopover();
        }

        function quoteMessage(messageId) {
            const message = appData.chat.messages[currentChatContactId].find(m => m.id === messageId);
            const user = appData.chat.userProfiles.find(p => p.id === appData.chat.activeProfileId);
            const contact = appData.contacts.find(c => c.id === currentChatContactId);
            const senderName = message.sender === 'user' ? (user?.name || '我') : (contact?.name || '对方');
            let content = message.content;
            if (message.type !== 'text') {
                const typeMap = {'image': '图片', 'video': '视频', 'sticker': '表情', 'transfer': '转账', 'location': '位置', 'sim-file': '文件', 'sim-video': '视频', 'sim-camera': '图片', 'voice': '语音'};
                content = `[${typeMap[message.type] || '消息'}]`;
            }
            
            const input = document.getElementById('chatInputField');
            input.dataset.quote = JSON.stringify({ id: messageId, senderName, content });
            input.placeholder = `正在引用 ${senderName} 的消息...`;
            input.focus();
            hideMessagePopover();
        }

        function recallMessage(messageId) {
            const message = appData.chat.messages[currentChatContactId].find(m => m.id === messageId);
            if (Date.now() - message.timestamp < 2 * 60 * 1000) {
                message.status = 'recalled';
                saveData();
                renderChatMessages();
            } else {
                showiOSAlert('无法撤回', '超过2分钟的消息无法撤回。');
            }
            hideMessagePopover();
        }

        function rerollTurn(messageId) {
            const message = appData.chat.messages[currentChatContactId].find(m => m.id === messageId);
            if (!message) return;
            const turnIdToReroll = message.turnId;
            
            appData.chat.messages[currentChatContactId] = appData.chat.messages[currentChatContactId].filter(m => m.turnId !== turnIdToReroll);
            
            saveData(true);
            renderChatMessages();
            triggerApiReply();
            hideMessagePopover();
        }

        function deleteMessage(messageId) {
            appData.chat.messages[currentChatContactId] = appData.chat.messages[currentChatContactId].filter(m => m.id !== messageId);
            saveData();
            renderChatMessages();
            hideMessagePopover();
        }

        function enterMultiSelectMode(initialMessageId) {
            multiSelectMode = true;
            selectedMessages.clear();
            if (initialMessageId) selectedMessages.add(initialMessageId);
            document.querySelector('.chat-input-area').style.display = 'none';
            document.getElementById('multiselectActionBar').classList.add('visible');
            renderChatMessages();
            hideMessagePopover();
        }

        function exitMultiSelectMode() {
            multiSelectMode = false;
            selectedMessages.clear();
            document.querySelector('.chat-input-area').style.display = 'block';
            document.getElementById('multiselectActionBar').classList.remove('visible');
            renderChatMessages();
        }

        function toggleMessageSelection(messageId) {
            if (selectedMessages.has(messageId)) {
                selectedMessages.delete(messageId);
            } else {
                selectedMessages.add(messageId);
            }
        }

        function deleteSelectedMessages() {
            if (selectedMessages.size === 0) return;
            appData.chat.messages[currentChatContactId] = appData.chat.messages[currentChatContactId].filter(m => !selectedMessages.has(m.id));
            saveData();
            exitMultiSelectMode();
        }

        // --- 朋友圈 (作为聊天子页面) ---
        function renderFriendsFeed() {
            const feedContainer = document.getElementById('friendsFeed');
            feedContainer.innerHTML = '';
            const activeUser = appData.chat.userProfiles.find(p => p.id === appData.chat.activeProfileId);
            
            const visiblePosts = appData.friends.posts.filter(post => {
                if (!post.visibility) return true;
                const visibility = post.visibility;
                if (visibility.type === 'all') return true;
                if (visibility.type === 'none' && post.authorId === activeUser?.id) return true;
                if (visibility.type === 'partial' && (visibility.allowed.includes(activeUser?.id) || post.authorId === activeUser?.id)) return true;
                return false;
            });

            if (visiblePosts.length === 0) {
                feedContainer.innerHTML = `<div class="app-placeholder">${t('friends_placeholder')}</div>`;
                return;
            }

            [...visiblePosts].reverse().forEach(post => {
                const author = appData.chat.userProfiles.find(p => p.id === post.authorId) || appData.contacts.find(c => c.id === post.authorId);
                if (!author) return;

                const filesHTML = (post.files || []).map(file => {
                    if (file.type.startsWith('image')) return `<div class="post-file-item" style="background-image: url(${file.data})"></div>`;
                    if (file.type.startsWith('video')) return `<div class="post-file-item"><i class="fas fa-play-circle"></i></div>`;
                    if (file.type === 'sim-image') {
                        return `<div class="post-file-item"><div class="image-placeholder-bubble revealed" style="width:100%; height:100%; margin:0; padding:5px; font-size: 0.8em;"><div class="real-content">${file.data.description}</div></div></div>`;
                    }
                    return `<div class="post-file-item"><i class="fas fa-file-alt"></i></div>`;
                }).join('');

                const likes = post.likes || [];
                const comments = post.comments || [];
                
                const likesHTML = likes.length > 0 ? `
                    <div class="post-likes">
                        <i class="fas fa-heart"></i>
                                                ${likes.map(likeId => appData.chat.userProfiles.find(p => p.id === likeId)?.name || appData.contacts.find(c => c.id === likeId)?.name).filter(Boolean).join(', ')}
                    </div>
                ` : '';

                const commentsHTML = comments.map(comment => {
                    const commenter = appData.chat.userProfiles.find(p => p.id === comment.authorId) || appData.contacts.find(c => c.id === comment.authorId);
                    let replyToHTML = '';
                    if (comment.replyTo) {
                        const repliedAuthor = appData.chat.userProfiles.find(p => p.id === comment.replyTo) || appData.contacts.find(c => c.id === comment.replyTo);
                        if (repliedAuthor) {
                            replyToHTML = ` <span class="reply-to">回复</span> <span class="comment-author">${repliedAuthor.name}</span>`;
                        }
                    }
                    return `
                        <div class="post-comment-item" onclick="addPostComment('${post.id}', '${comment.authorId}')" ondblclick="deletePostComment('${post.id}', '${comment.id}')">
                            <span class="comment-author">${commenter?.name || '未知用户'}</span>${replyToHTML}: ${comment.content}
                        </div>
                    `;
                }).join('');

                const postEl = document.createElement('div');
                postEl.className = 'friend-post';
                postEl.innerHTML = `
                    <div class="post-avatar-wrapper">
                        <div class="post-avatar" style="background-image: url(${author.avatar || ''})"></div>
                    </div>
                    <div class="post-main">
                        <div class="post-header">
                            <span class="post-author-name">${author.name}</span>
                            <span class="post-timestamp">${new Date(post.timestamp).toLocaleString()}</span>
                        </div>
                        <div class="post-content-text">${post.content}</div>
                        ${filesHTML ? `<div class="post-files-grid">${filesHTML}</div>` : ''}
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                            ${post.location ? `<div class="post-location" style="margin-bottom: 0;"><i class="fas fa-map-marker-alt"></i> ${post.location}</div>` : '<div></div>'}
                            <div class="post-footer">
                                ${post.authorId === activeUser?.id ? `<div class="post-delete-btn" onclick="deletePost('${post.id}')"><i class="fas fa-trash"></i></div>` : ''}
                                <div class="post-actions-btn" onclick="showPostActions(event, '${post.id}')"><i class="fas fa-ellipsis-h"></i></div>
                            </div>
                        </div>
                        ${likesHTML || commentsHTML ? `<div class="post-likes-comments">${likesHTML}${commentsHTML ? `<div class="post-comments-list">${commentsHTML}</div>` : ''}</div>` : ''}
                    </div>
                `;
                feedContainer.appendChild(postEl);
            });
        }

        function openPostEditor(postId) {
            const post = postId ? appData.friends.posts.find(p => p.id === postId) : null;
            currentEditingPost = {
                id: post?.id || null,
                content: post?.content || '',
                files: post?.files || [],
                location: post?.location || '',
                visibility: post?.visibility || { type: 'all', allowed: [] }
            };
            
            openSubPage('postEditor');
            document.getElementById('post-content-input').value = currentEditingPost.content;
            updatePostEditorUI();
        }

        function updatePostEditorUI() {
            document.getElementById('post-location-display').textContent = currentEditingPost.location || t('post_editor_location');
            const visibilityMap = { 'all': t('post_visibility_all'), 'none': t('post_visibility_self'), 'partial': t('post_visibility_partial') };
            document.getElementById('post-visibility-display').textContent = visibilityMap[currentEditingPost.visibility.type];
            
            const previewContainer = document.getElementById('post-files-preview');
            previewContainer.innerHTML = currentEditingPost.files.map((file, index) => {
                let previewContent = '';
                if (file.type.startsWith('image')) previewContent = `<img src="${file.data}" alt="${file.name}">`;
                else if (file.type.startsWith('video')) previewContent = `<video src="${file.data}"></video>`;
                else previewContent = `<div class="file-icon"><i class="fas fa-file"></i></div>`;
                
                return `<div class="file-preview-item">${previewContent}<div class="remove-file-btn" onclick="removePostFile(${index})">&times;</div></div>`;
            }).join('');
        }

        function handlePostFiles(event) {
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentEditingPost.files.push({
                        name: file.name,
                        type: file.type,
                        data: e.target.result
                    });
                    updatePostEditorUI();
                };
                reader.readAsDataURL(file);
            }
        }

        function removePostFile(index) {
            currentEditingPost.files.splice(index, 1);
            updatePostEditorUI();
        }

        function editPostLocation() {
            const newLocation = prompt('自定义位置 (最多20字)', currentEditingPost.location);
            if (newLocation !== null) {
                currentEditingPost.location = newLocation.substring(0, 20);
                updatePostEditorUI();
            }
        }

        function editPostVisibility() {
            const options = [
                { text: t('post_visibility_all'), action: () => { currentEditingPost.visibility = { type: 'all', allowed: [] }; updatePostEditorUI(); }},
                { text: t('post_visibility_self'), action: () => { currentEditingPost.visibility = { type: 'none', allowed: [] }; updatePostEditorUI(); }},
                { text: t('post_visibility_partial'), action: () => openVisibilityFriendPicker() },
                { text: t('common_cancel'), style: 'bold' }
            ];
            showCustomiOSAlert(t('post_editor_visibility'), '', options);
        }

        function openVisibilityFriendPicker() {
            const friends = appData.contacts;
            const selectedIds = new Set(currentEditingPost.visibility.allowed);
            const listHtml = friends.map(friend => `
                <div class="list-item checkbox-list-item">
                    <input type="checkbox" id="vis-${friend.id}" value="${friend.id}" ${selectedIds.has(friend.id) ? 'checked' : ''}>
                    <label for="vis-${friend.id}" style="flex: 1;">${friend.name}</label>
                </div>
            `).join('');

            showModal(`
                <div class="modal-title">选择可见的好友</div>
                <div class="modal-body">${listHtml}</div>
                <div style="padding: 10px;"><button class="glass-button" onclick="confirmVisibility()">${t('common_confirm')}</button></div>
            `);
        }

        function confirmVisibility() {
            const allowed = [];
            document.querySelectorAll('.modal-body input[type="checkbox"]:checked').forEach(cb => allowed.push(cb.value));
            currentEditingPost.visibility = { type: 'partial', allowed: allowed };
            updatePostEditorUI();
            closeModal();
        }

        function savePost() {
            const activeUser = appData.chat.userProfiles.find(p => p.id === appData.chat.activeProfileId);
            if (!activeUser) {
                showiOSAlert(t('common_error'), '请先设置一个当前自设。');
                return;
            }
            
            const content = document.getElementById('post-content-input').value;
            if (!content && currentEditingPost.files.length === 0) {
                showiOSAlert(t('common_error'), '动态内容不能为空。');
                return;
            }

            const newPost = {
                id: currentEditingPost.id || `post_${Date.now()}`,
                authorId: activeUser.id,
                content: content,
                files: currentEditingPost.files,
                location: currentEditingPost.location,
                visibility: currentEditingPost.visibility,
                timestamp: Date.now(),
                likes: currentEditingPost.id ? (appData.friends.posts.find(p=>p.id===currentEditingPost.id)?.likes || []) : [],
                comments: currentEditingPost.id ? (appData.friends.posts.find(p=>p.id===currentEditingPost.id)?.comments || []) : []
            };

            if (currentEditingPost.id) {
                const index = appData.friends.posts.findIndex(p => p.id === currentEditingPost.id);
                if (index > -1) appData.friends.posts[index] = newPost;
            } else {
                appData.friends.posts.push(newPost);
            }
            
            saveData();
            closeSubPage('postEditor');
            renderFriendsFeed();
        }

        function deletePost(postId) {
            if (confirm('确定要删除这条动态吗？')) {
                appData.friends.posts = appData.friends.posts.filter(p => p.id !== postId);
                saveData();
                renderFriendsFeed();
            }
        }

        function showPostActions(event, postId) {
            const activeUser = appData.chat.userProfiles.find(p => p.id === appData.chat.activeProfileId);
            if (!activeUser) return;

            const post = appData.friends.posts.find(p => p.id === postId);
            const isLiked = post.likes.includes(activeUser.id);

            const popover = document.createElement('div');
            popover.className = 'post-actions-popover';
            popover.id = 'active-post-popover';
            popover.innerHTML = `
                <button onclick="togglePostLike('${postId}')"><i class="fas fa-heart"></i> ${isLiked ? '取消' : '赞'}</button>
                <button onclick="addPostComment('${postId}')"><i class="fas fa-comment"></i> 评论</button>
            `;
            
            document.body.appendChild(popover);
            const btnRect = event.currentTarget.getBoundingClientRect();
            popover.style.position = 'absolute';
            
            const popoverRect = popover.getBoundingClientRect();
            let top = btnRect.top - popoverRect.height - 5;
            let left = btnRect.left + btnRect.width / 2 - popoverRect.width / 2;

            if (top < 0) top = btnRect.bottom + 5;
            if (left < 0) left = 5;
            if (left + popoverRect.width > window.innerWidth) left = window.innerWidth - popoverRect.width - 5;

            popover.style.top = `${top}px`;
            popover.style.left = `${left}px`;

            const closePopover = (e) => {
                const activePopover = document.getElementById('active-post-popover');
                if (activePopover && !activePopover.contains(e.target) && e.target !== event.currentTarget) {
                    activePopover.remove();
                    document.removeEventListener('click', closePopover);
                }
            };
            setTimeout(() => document.addEventListener('click', closePopover), 0);
            event.stopPropagation();
        }

        function togglePostLike(postId) {
            const activeUser = appData.chat.userProfiles.find(p => p.id === appData.chat.activeProfileId);
            const post = appData.friends.posts.find(p => p.id === postId);
            const likeIndex = post.likes.indexOf(activeUser.id);
            if (likeIndex > -1) {
                post.likes.splice(likeIndex, 1);
            } else {
                post.likes.push(activeUser.id);
            }
            saveData();
            renderFriendsFeed();
        }

        function addPostComment(postId, replyToAuthorId = null) {
            const post = appData.friends.posts.find(p => p.id === postId);
            const activeUser = appData.chat.userProfiles.find(p => p.id === appData.chat.activeProfileId);
            let promptMessage = '发表评论:';
            if (replyToAuthorId) {
                const replyToAuthor = appData.chat.userProfiles.find(p => p.id === replyToAuthorId) || appData.contacts.find(c => c.id === replyToAuthorId);
                if (replyToAuthor) promptMessage = `回复 ${replyToAuthor.name}:`;
            }
            
            const content = prompt(promptMessage);
            if (content) {
                if (!post.comments) post.comments = [];
                post.comments.push({
                    id: `comment_${Date.now()}`,
                    authorId: activeUser.id,
                    replyTo: replyToAuthorId,
                    content: content,
                    timestamp: Date.now()
                });
                saveData();
                renderFriendsFeed();
            }
        }

        function deletePostComment(postId, commentId) {
            const post = appData.friends.posts.find(p => p.id === postId);
            const comment = post.comments.find(c => c.id === commentId);
            const activeUser = appData.chat.userProfiles.find(p => p.id === appData.chat.activeProfileId);
            
            if (comment && (comment.authorId === activeUser.id || post.authorId === activeUser.id)) {
                if (confirm('确定要删除这条评论吗？')) {
                    post.comments = post.comments.filter(c => c.id !== commentId);
                    saveData();
                    renderFriendsFeed();
                }
            }
        }

        // --- 商城 App ---
        function renderShoppingApp() {
            switchShoppingTab('Home');
        }

        function switchShoppingTab(tabName) {
            document.querySelectorAll('.shopping-page').forEach(p => p.classList.remove('active'));
            document.getElementById(`shoppingPage${tabName}`).classList.add('active');
            
            document.querySelectorAll('.shopping-nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`.shopping-nav-item[onclick="switchShoppingTab('${tabName}')"]`).classList.add('active');

            const titleMap = { 'Home': t('shopping_title_home'), 'Cart': t('shopping_title_cart'), 'Me': t('shopping_title_me') };
            document.getElementById('shoppingTitle').textContent = titleMap[tabName];

            const actionGroup = document.getElementById('shoppingActionGroup');
            if (tabName === 'Home') {
                const layoutIcon = appData.shopping.layout === 'grid' ? 'fa-list' : 'fa-th';
                actionGroup.innerHTML = `
                    <div class="app-action-btn" onclick="toggleShoppingLayout()"><i class="fas ${layoutIcon}"></i></div>
                    <div class="app-action-btn" onclick="addCustomProduct()"><i class="fas fa-plus"></i></div>
                `;
            } else {
                actionGroup.innerHTML = '';
            }

            if (tabName === 'Home') renderShoppingHome();
            if (tabName === 'Cart') renderShoppingCart();
            if (tabName === 'Me') renderShoppingMe();
        }

        function renderShoppingHome() {
            renderShoppingCategories();
            renderProducts();
        }

        function renderShoppingCategories() {
            const container = document.getElementById('shoppingCategories');
            container.innerHTML = `<button class="shopping-category-btn ${appData.shopping.activeCategory === 'all' ? 'active' : ''}" onclick="filterProducts('all')">全部</button>`;
            appData.shopping.categories.forEach(cat => {
                container.innerHTML += `<button class="shopping-category-btn ${appData.shopping.activeCategory === cat ? 'active' : ''}" onclick="filterProducts('${cat}')">${cat}</button>`;
            });
            container.innerHTML += `<button class="shopping-category-btn" onclick="addShoppingCategory()">+</button>`;
        }

        function addShoppingCategory() {
            const newCategory = prompt("请输入要添加的分类名称:");
            if (newCategory && !appData.shopping.categories.includes(newCategory)) {
                appData.shopping.categories.push(newCategory);
                saveData();
                renderShoppingCategories();
            }
        }

        function filterProducts(category) {
            appData.shopping.activeCategory = category;
            renderShoppingCategories();
            renderProducts();
        }

        function renderProducts() {
            const container = document.getElementById('shoppingProductsContainer');
            const layout = appData.shopping.layout;
            container.className = layout === 'grid' ? 'shopping-products-grid' : 'shopping-products-list';
            container.innerHTML = '';

            const filteredProducts = appData.shopping.activeCategory === 'all'
                ? appData.shopping.products
                : appData.shopping.products.filter(p => p.category === appData.shopping.activeCategory);

            if (filteredProducts.length === 0) {
                container.innerHTML = '<div class="app-placeholder" style="grid-column: 1 / -1;">该分类下暂无商品。</div>';
                return;
            }

            filteredProducts.forEach(product => {
                const cardClass = layout === 'grid' ? 'product-card-grid' : 'product-card-list';
                const infoClass = layout === 'grid' ? 'product-card-grid-info' : 'product-card-list-info';
                const productHTML = `
                    <div class="${cardClass}" onclick="addToCart('${product.id}')">
                        <img src="${product.image}" alt="${product.name}">
                        <div class="${infoClass}">
                            <div class="product-name">${product.name}</div>
                            <div class="product-price">¥${product.price.toFixed(2)}</div>
                        </div>
                    </div>
                `;
                container.innerHTML += productHTML;
            });
        }
        
        function addCustomProduct() {
            const name = prompt("商品名称:");
            const priceStr = prompt("商品价格:");
            const category = prompt("商品分类:", appData.shopping.activeCategory !== 'all' ? appData.shopping.activeCategory : '');
            const store = prompt("店铺名称:");
            
            const price = parseFloat(priceStr);
            if (name && !isNaN(price) && category && store) {
                const newProduct = {
                    id: `prod_custom_${Date.now()}`,
                    name,
                    price,
                    category,
                    store,
                    image: `https://via.placeholder.com/150/87CEEB/000000?text=${encodeURIComponent(name.charAt(0))}`
                };
                appData.shopping.products.unshift(newProduct);
                if (!appData.shopping.categories.includes(category)) {
                    appData.shopping.categories.push(category);
                }
                saveData();
                renderShoppingHome();
            } else {
                showiOSAlert(t('common_error'), "请确保所有信息填写正确。");
            }
        }

        function toggleShoppingLayout() {
            appData.shopping.layout = appData.shopping.layout === 'grid' ? 'list' : 'grid';
            saveData();
            switchShoppingTab('Home');
        }

        function addToCart(productId) {
            const product = appData.shopping.products.find(p => p.id === productId);
            if (product) {
                const cartItem = appData.shopping.cart.find(item => item.id === productId);
                if (cartItem) {
                    cartItem.quantity++;
                } else {
                    appData.shopping.cart.push({ ...product, quantity: 1 });
                }
                saveData();
                showiOSAlert(t('common_success'), `${product.name} 已添加到购物车。`);
            }
        }

        function renderShoppingCart() {
            const container = document.getElementById('shoppingCartContent');
            container.innerHTML = '';
            if (appData.shopping.cart.length === 0) {
                container.innerHTML = '<div class="app-placeholder">购物车是空的，快去逛逛吧！</div>';
                updateCartTotal();
                return;
            }
            appData.shopping.cart.forEach(item => {
                const itemHTML = `
                    <div class="cart-item">
                        <img src="${item.image}" alt="${item.name}">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">¥${item.price.toFixed(2)}</div>
                            <div class="cart-item-quantity">
                                <button onclick="updateCartQuantity('${item.id}', -1)">-</button>
                                <span>${item.quantity}</span>
                                <button onclick="updateCartQuantity('${item.id}', 1)">+</button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += itemHTML;
            });
            updateCartTotal();
        }

        function updateCartQuantity(productId, change) {
            const cartItem = appData.shopping.cart.find(item => item.id === productId);
            if (cartItem) {
                cartItem.quantity += change;
                if (cartItem.quantity <= 0) {
                    appData.shopping.cart = appData.shopping.cart.filter(item => item.id !== productId);
                }
                saveData();
                renderShoppingCart();
            }
        }

        function updateCartTotal() {
            const total = appData.shopping.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            document.getElementById('cartTotalPrice').textContent = `总计: ¥${total.toFixed(2)}`;
        }

        function checkout(target) {
            if (appData.shopping.cart.length === 0) {
                showiOSAlert(t('common_info'), "您的购物车里还没有商品。");
                return;
            }
            
            if (target === 'char' || target === 'ask-char') {
                openGiftRecipientPicker(target);
            } else {
                const total = appData.shopping.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const totalInUSD = total / exchangeRates['CNY'].rate;
                if (appData.chat.wallet.balance < totalInUSD) {
                    showiOSAlert(t('common_error'), `需要支付 ¥${total.toFixed(2)}，但您的钱包余额不足。`);
                    return;
                }
                processCheckout('self', null, total, totalInUSD);
            }
        }

        function openGiftRecipientPicker(checkoutType) {
            const contacts = appData.contacts.filter(c => !appData.settings.blacklist.includes(c.id));
            if (contacts.length === 0) {
                showiOSAlert(t('common_info'), "通讯录中没有可以操作的好友。");
                return;
            }

            const listHtml = contacts.map(contact => `
                <div class="list-item" onclick="confirmGiftRecipient('${contact.id}', '${checkoutType}')">
                    <div class="list-item-avatar-wrapper" style="margin-right: 10px;">
                        <div class="list-item-avatar" style="background-image: url(${contact.avatar || ''})"></div>
                    </div>
                    <div class="list-item-info">
                        <div class="list-item-name">${contact.name || '未命名'}</div>
                    </div>
                    <i class="fas fa-chevron-right item-arrow"></i>
                </div>
            `).join('');

            const title = checkoutType === 'char' ? '选择赠送对象' : '选择付款人';
            showModal(`
                <div class="modal-title">${title}</div>
                <div class="modal-body">${listHtml}</div>
            `);
        }

        function confirmGiftRecipient(recipientId, checkoutType) {
            const total = appData.shopping.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const totalInUSD = total / exchangeRates['CNY'].rate;
            
            if (checkoutType === 'char') {
                 if (appData.chat.wallet.balance < totalInUSD) {
                    showiOSAlert(t('common_error'), `需要支付 ¥${total.toFixed(2)}，但您的钱包余额不足。`);
                    return;
                }
                processCheckout('char', recipientId, total, totalInUSD);
            } else {
                processCheckout('ask-char', recipientId, total, totalInUSD);
            }
            closeModal();
        }

        function processCheckout(target, recipientId, total, totalInUSD) {
            const recipient = recipientId ? appData.contacts.find(c => c.id === recipientId) : null;
            const cartItems = [...appData.shopping.cart]; // 克隆购物车内容
            
            if (target === 'self' || target === 'char') {
                appData.chat.wallet.balance -= totalInUSD;
                const transactionType = target === 'self' ? '购物消费' : `为 ${recipient?.name || 'TA'} 购物`;
                appData.chat.transactions.push({ type: transactionType, amount: -totalInUSD, date: Date.now() });
            }
            
            cartItems.forEach(item => {
                const purchase = appData.shopping.purchases.find(p => p.id === item.id);
                if (purchase) {
                    purchase.quantity += item.quantity;
                } else {
                    appData.shopping.purchases.push({ id: item.id, quantity: item.quantity });
                }
            });

            if ((target === 'char' || target === 'ask-char') && recipient) {
                const message = target === 'char' ? `你为 ${recipient.name} 购买了${cartItems.length}件商品，共消费 ¥${total.toFixed(2)}。` : `已向 ${recipient.name} 发起代付请求。`;
                showiOSAlert(target === 'char' ? t('common_success') : "请求已发送", message);
            } else {
                showReceipt(target, total, cartItems);
            }

            appData.shopping.cart = [];
            saveData();
            renderShoppingCart();
            renderWallet();
        }

        function showReceipt(target, total, items) {
            const storeItems = {};
            items.forEach(item => {
                if (!storeItems[item.store]) storeItems[item.store] = [];
                storeItems[item.store].push(item);
            });

            let receiptHTML = '';
            for (const store in storeItems) {
                receiptHTML += `
                    <div class="receipt-header"><div class="receipt-title">${store}</div><div class="receipt-store">购物清单</div></div>
                    <div class="receipt-divider"></div>
                `;
                storeItems[store].forEach(item => {
                    receiptHTML += `<div class="receipt-item"><span class="receipt-item-name">${item.name} (x${item.quantity})</span><span>¥${(item.price * item.quantity).toFixed(2)}</span></div>`;
                });
                receiptHTML += `<div class="receipt-divider"></div>`;
            }

            receiptHTML += `
                <div class="receipt-item receipt-total"><span>总计</span><span>¥${total.toFixed(2)}</span></div>
                <div class="receipt-item"><span>支付给</span><span>${target === 'self' ? '自己' : (appData.contacts.find(c=>c.id===currentChatContactId)?.name || 'TA')}</span></div>
            `;

            showModal(`
                <div class="modal-title">支付成功</div>
                <div class="modal-body receipt-modal-body">${receiptHTML}</div>
                <div style="padding: 10px;"><button class="glass-button" onclick="closeModal()">${t('common_ok')}</button></div>
            `);
        }

        function renderShoppingMe() {
            const activeProfile = appData.chat.userProfiles.find(p => p.id === appData.chat.activeProfileId);
            const nickname = activeProfile?.name || t('chat_me_set_nickname');
            const signature = activeProfile?.signature || t('chat_me_set_signature');
            const avatar = activeProfile?.avatar || '';
            
            document.getElementById('shoppingMeNickname').textContent = nickname;
            document.getElementById('shoppingMeSignature').textContent = signature;
            document.getElementById('shoppingMeAvatar').style.backgroundImage = `url(${avatar})`;

            document.getElementById('shoppingFavoritesCount').textContent = appData.shopping.favorites.length;
            const totalPurchased = appData.shopping.purchases.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('shoppingPurchasedCount').textContent = totalPurchased;
        }

        // --- 音乐 App & 灵动岛 ---
        function renderMusicApp() {
            switchMusicTab('Home');
        }

        function switchMusicTab(tabName) {
            document.querySelectorAll('#musicContainer .music-page').forEach(p => p.classList.remove('active'));
            document.getElementById(`musicPage${tabName}`).classList.add('active');
            
            document.querySelectorAll('#musicContainer .music-nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`.music-nav-item[onclick="switchMusicTab('${tabName}')"]`).classList.add('active');

            if (tabName === 'Home') {
                // 首页现在只显示搜索
            }
            if (tabName === 'Me') {
                renderMusicMePage();
            }
        }

        function renderMusicMePage() {
            const activeProfile = appData.chat.userProfiles.find(p => p.id === appData.chat.activeProfileId);
            const nickname = activeProfile?.name || '未设置';
            const signature = activeProfile?.signature || '未设置';
            const avatar = activeProfile?.avatar || '';
            
            document.getElementById('musicMeAvatar').style.backgroundImage = `url(${avatar})`;
            document.getElementById('musicMeNickname').textContent = nickname;
            document.getElementById('musicMeSignature').textContent = signature;
        }

        function openMusicImportModal(type) {
            tempMusicImportData = {};
            const coverHTML = `
                <div class="glass-form-group">
                    <label>专辑封面</label>
                    <input type="text" id="music-cover-url" class="glass-input" placeholder="图片URL (可选)">
                    <button class="glass-button" style="margin-top: 10px; background-color: #8e8e93;" onclick="document.getElementById('music-cover-file').click()">或选择本地图片</button>
                    <input type="file" id="music-cover-file" accept="image/*" style="display:none;" onchange="handleMusicCoverFile(event)">
                    <img id="music-cover-preview" style="max-width: 80px; margin-top: 10px; border-radius: 8px;">
                </div>
            `;
            const fileInputHTML = type === 'file' ? `<div class="glass-form-group"><label>音频文件</label><input type="file" id="music-audio-file" accept="audio/*" required></div>` : `<div class="glass-form-group"><label>音频URL</label><input type="text" id="music-audio-url" class="glass-input" required></div>`;

            showModal(`
                <div class="modal-title">导入音乐</div>
                <div class="modal-body" style="background: var(--theme-bg); padding: 20px; gap: 15px; display: flex; flex-direction: column;">
                    ${fileInputHTML}
                    <div class="glass-form-group"><label>歌曲名</label><input type="text" id="music-title" class="glass-input" required></div>
                    <div class="glass-form-group"><label>艺人名</label><input type="text" id="music-artist" class="glass-input" required></div>
                    <div class="glass-form-group"><label>歌词 (LRC格式)</label><textarea id="music-lyrics" class="glass-textarea" placeholder="[00:00.00]歌词..."></textarea></div>
                    ${coverHTML}
                    <button class="glass-button" onclick="importMusic('${type}')">确认导入</button>
                </div>
            `);
        }

        function handleMusicCoverFile(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    tempMusicImportData.cover = e.target.result;
                    document.getElementById('music-cover-preview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function importMusic(type) {
            const title = document.getElementById('music-title').value;
            const artist = document.getElementById('music-artist').value;
            const lyrics = document.getElementById('music-lyrics').value || '[00:00.00]此歌曲无歌词';
            const coverUrl = document.getElementById('music-cover-url').value;
            const cover = tempMusicImportData.cover || coverUrl || 'https://via.placeholder.com/150/E0E0E0/808080?text=Music';

            if (!title || !artist) {
                showiOSAlert(t('common_error'), "歌曲名和艺人名是必填项。");
                return;
            }
            
            const newSong = { id: `song_${Date.now()}`, title, artist, cover, lyrics, addedAt: Date.now() };

            if (type === 'url') {
                const audioUrl = document.getElementById('music-audio-url').value;
                if (!audioUrl) { showiOSAlert(t('common_error'), "音频URL是必填项。"); return; }
                newSong.src = audioUrl;
                appData.music.songs.push(newSong);
                saveData();
                if (document.getElementById('localMusicContainer').classList.contains('active')) {
                    renderLocalMusicList();
                }
                closeModal();
            } else {
                const audioFile = document.getElementById('music-audio-file').files[0];
                if (!audioFile) { showiOSAlert(t('common_error'), "请选择音频文件。"); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    newSong.src = e.target.result;
                    appData.music.songs.push(newSong);
                    saveData();
                    if (document.getElementById('localMusicContainer').classList.contains('active')) {
                        renderLocalMusicList();
                    }
                    closeModal();
                };
                reader.readAsDataURL(audioFile);
            }
        }

        function renderLocalMusicList() {
            const container = document.getElementById('localMusicListContent');
            container.innerHTML = '';
            if (appData.music.songs.length === 0) {
                container.innerHTML = `<div class="app-placeholder">${t('music_local_music')}为空</div>`;
                return;
            }
            appData.music.songs.forEach((song, index) => {
                const isFavorited = appData.music.favoriteSongIds.includes(song.id);
                const itemHTML = `
                    <div class="music-list-item" onclick="openMusicActions('${song.id}', ${index}, 'all')">
                        <div class="music-list-item-cover" style="background-image: url(${song.cover})"></div>
                        <div class="music-list-item-info">
                            <div class="music-list-item-title">${song.title}</div>
                            <div class="music-list-item-artist">${song.artist}</div>
                        </div>
                        <div class="music-list-item-actions">
                            <i class="fas fa-heart ${isFavorited ? 'favorited' : ''}" onclick="event.stopPropagation(); toggleFavoriteSong('${song.id}')"></i>
                            <i class="fas fa-plus" onclick="event.stopPropagation(); showAddToPlaylistModal('${song.id}')"></i>
                        </div>
                    </div>
                `;
                container.innerHTML += itemHTML;
            });
        }

        function playSong(index, playlistId = 'all') {
            appData.music.settings.currentPlaylist = playlistId;
            const currentPlaylistSongs = getSongsByPlaylistId(playlistId);
            
            if (index < 0 || index >= currentPlaylistSongs.length) return;
            
            const song = currentPlaylistSongs[index];
            const globalIndex = appData.music.songs.findIndex(s => s.id === song.id);
            appData.music.settings.currentIndex = globalIndex;
            
            musicAudioElement.src = song.src;
            musicAudioElement.playbackRate = appData.music.settings.playbackRate;
            musicAudioElement.preservesPitch = false; 
            musicAudioElement.mozPreservesPitch = false;
            musicAudioElement.webkitPreservesPitch = false;
            musicAudioElement.playbackRate = appData.music.settings.pitch;

            musicAudioElement.play();
            
            const recentlyPlayedEntry = appData.music.recentlyPlayed.find(s => s.songId === song.id);
            if (recentlyPlayedEntry) {
                recentlyPlayedEntry.playCount++;
                recentlyPlayedEntry.lastPlayed = Date.now();
            } else {
                appData.music.recentlyPlayed.push({
                    songId: song.id,
                    playCount: 1,
                    lastPlayed: Date.now(),
                    addedAt: song.addedAt || Date.now()
                });
            }
            saveData(true);

            parsedLyrics = parseLyrics(song.lyrics);
            
            updatePlayerUI();
            updateMusicWidget();
            updateDynamicIsland();
            updateMiniPlayer(true);
        }

        function stopMusic() {
            musicAudioElement.pause();
            musicAudioElement.currentTime = 0;
            appData.music.settings.currentIndex = -1;
            if(document.getElementById('playerAlbumArt')) {
                document.getElementById('playerAlbumArt').classList.remove('playing');
                document.getElementById('playerPlayPauseBtn').className = 'fas fa-play-circle play-pause-btn';
            }
            updateMusicWidget();
            updateDynamicIsland();
            updateMiniPlayer(false);
        }

        function togglePlayPause() {
            if (musicAudioElement.src && appData.music.settings.currentIndex > -1) {
                if (musicAudioElement.paused) {
                    musicAudioElement.play();
                } else {
                    musicAudioElement.pause();
                }
            } else if (appData.music.songs.length > 0) {
                playSong(0, 'all');
            }
        }

        function playNextSong() {
            const currentPlaylistSongs = getSongsByPlaylistId(appData.music.settings.currentPlaylist);
            if (currentPlaylistSongs.length === 0) return;
            
            const currentSong = appData.music.songs[appData.music.settings.currentIndex];
            const currentPlaylistIndex = currentPlaylistSongs.findIndex(s => s.id === currentSong?.id);

            if (appData.music.settings.mode === 'shuffle') {
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * currentPlaylistSongs.length);
                } while (currentPlaylistSongs.length > 1 && randomIndex === currentPlaylistIndex);
                const nextSongId = currentPlaylistSongs[randomIndex].id;
                const globalIndex = appData.music.songs.findIndex(s => s.id === nextSongId);
                playSong(globalIndex, 'all');
            } else {
                let nextIndex = currentPlaylistIndex + 1;
                if (nextIndex >= currentPlaylistSongs.length) nextIndex = 0;
                const nextSongId = currentPlaylistSongs[nextIndex].id;
                const globalIndex = appData.music.songs.findIndex(s => s.id === nextSongId);
                playSong(globalIndex, 'all');
            }
        }

        function playPrevSong() {
            const currentPlaylistSongs = getSongsByPlaylistId(appData.music.settings.currentPlaylist);
            if (currentPlaylistSongs.length === 0) return;
            const currentSong = appData.music.songs[appData.music.settings.currentIndex];
            const currentPlaylistIndex = currentPlaylistSongs.findIndex(s => s.id === currentSong?.id);

            let prevIndex = currentPlaylistIndex - 1;
            if (prevIndex < 0) prevIndex = currentPlaylistSongs.length - 1;
            const prevSongId = currentPlaylistSongs[prevIndex].id;
            const globalIndex = appData.music.songs.findIndex(s => s.id === prevSongId);
            playSong(globalIndex, 'all');
        }

        function changePlayMode() {
            const modes = ['sequence', 'loop', 'shuffle'];
            const icons = ['fa-retweet', 'fa-repeat', 'fa-random'];
            const currentModeIndex = modes.indexOf(appData.music.settings.mode);
            const nextModeIndex = (currentModeIndex + 1) % modes.length;
            appData.music.settings.mode = modes[nextModeIndex];
            
            const newIconClass = `fas ${icons[nextModeIndex]}`;
                        if(document.getElementById('island-mode-btn')) document.getElementById('island-mode-btn').querySelector('i').className = newIconClass;

            musicAudioElement.loop = appData.music.settings.mode === 'loop';
            saveData(true);
        }

        function updatePlayerUI() {
            updateDynamicIsland();
            const playerContainer = document.getElementById('musicPlayerContainer');
            if (!playerContainer || !playerContainer.classList.contains('active')) return;

            const song = appData.music.songs[appData.music.settings.currentIndex];
            if (!song) return;

            document.getElementById('playerAlbumArt').style.backgroundImage = `url(${song.cover})`;
            document.getElementById('playerSongTitle').textContent = song.title;
            document.getElementById('playerSongArtist').textContent = song.artist;
            
            const isPlaying = !musicAudioElement.paused;
            document.getElementById('playerAlbumArt').classList.toggle('playing', isPlaying);
            document.getElementById('playerPlayPauseBtn').className = `fas ${isPlaying ? 'fa-pause-circle' : 'fa-play-circle'} play-pause-btn`;
        }

        function updatePlayerProgress() {
            updateDynamicIsland();
            const playerContainer = document.getElementById('musicPlayerContainer');
            if (!playerContainer || !playerContainer.classList.contains('active')) return;

            const currentTime = musicAudioElement.currentTime;
            const duration = musicAudioElement.duration;
            if (isNaN(duration)) return;

            const formatTime = (s) => {
                if (isNaN(s)) return '0:00';
                return `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`;
            }

            document.getElementById('playerCurrentTime').textContent = formatTime(currentTime);
            document.getElementById('playerDuration').textContent = formatTime(duration);
            document.getElementById('playerProgressBar').value = currentTime;
            document.getElementById('playerProgressBar').max = duration;
        }

        function setupAudioEvents() {
            musicAudioElement.onplay = () => { updatePlayerUI(); updateMusicWidget(); updateDynamicIsland(); updateMiniPlayer(true); };
            musicAudioElement.onpause = () => { updatePlayerUI(); updateMusicWidget(); updateDynamicIsland(); updateMiniPlayer(true); };
            musicAudioElement.ontimeupdate = () => { updatePlayerProgress(); updateDynamicIsland(); updateMiniPlayer(true); updateActiveLyrics(); };
                        const islandPitchSlider = document.getElementById('island-pitch-slider');
            if (islandPitchSlider) {
                islandPitchSlider.oninput = (e) => {
                    const pitch = parseFloat(e.target.value);
                    appData.music.settings.pitch = pitch;
                    // Note: Pitch shifting via playbackRate is a simple approximation.
                    // True pitch shifting requires Web Audio API for better quality.
                    // For simplicity, we'll stick to this method.
                    // musicAudioElement.playbackRate = pitch; // This affects speed and pitch.
                    document.getElementById('island-pitch-value').textContent = `${pitch.toFixed(1)}x`;
                    if(document.getElementById('playerPitchSlider')) {
                        document.getElementById('playerPitchSlider').value = pitch;
                        document.getElementById('playerPitchValue').textContent = pitch.toFixed(1);
                    }
                    saveData(true);
                };
            }
        }

        function showMusicPlaylist() {
            const playlistId = appData.music.settings.currentPlaylist;
            const songs = getSongsByPlaylistId(playlistId);
            const listHtml = songs.map((song, index) => {
                const globalIndex = appData.music.songs.findIndex(s => s.id === song.id);
                const isCurrent = globalIndex === appData.music.settings.currentIndex;
                return `<div class="list-item" style="color: ${isCurrent ? 'var(--ios-blue)' : 'inherit'}" onclick="playSong(${globalIndex}, 'all')">${song.title} - ${song.artist}</div>`;
            }).join('');
            
            const playlistName = playlistId === 'all' ? t('music_local_music') 
                             : playlistId === 'favorites' ? t('music_favorite_songs')
                             : (appData.music.playlists.find(p => p.id === playlistId)?.name || '播放列表');
            showModal(`
                <div class="modal-title">${playlistName}</div>
                <div class="modal-body">${listHtml || '<div class="app-placeholder">列表为空</div>'}</div>
            `);
        }

        function getSongsByPlaylistId(playlistId) {
            if (playlistId === 'all') {
                return appData.music.songs;
            } else if (playlistId === 'favorites') {
                return appData.music.songs.filter(s => appData.music.favoriteSongIds.includes(s.id));
            } else {
                const playlist = appData.music.playlists.find(p => p.id === playlistId);
                return playlist ? appData.music.songs.filter(s => playlist.songIds.includes(s.id)) : [];
            }
        }

        function toggleFavoriteSong(songId) {
            const index = appData.music.favoriteSongIds.indexOf(songId);
            if (index > -1) {
                appData.music.favoriteSongIds.splice(index, 1);
            } else {
                appData.music.favoriteSongIds.push(songId);
            }
            saveData();
            if (document.getElementById('localMusicContainer').classList.contains('active')) {
                renderLocalMusicList();
            }
            if (document.getElementById('favoriteSongsContainer').classList.contains('active')) {
                renderFavoriteSongs();
            }
        }

        function createPlaylist() {
            const name = prompt("请输入新歌单的名称:");
            if (name && name.trim()) {
                appData.music.playlists.push({
                    id: `playlist_${Date.now()}`,
                    name: name.trim(),
                    songIds: []
                });
                saveData();
                renderPlaylists();
            }
        }

        function renderPlaylists() {
            const container = document.getElementById('musicPlaylistsContent');
            container.innerHTML = '';
            if (appData.music.playlists.length === 0) {
                container.innerHTML = `<div class="app-placeholder">${t('worldbook_placeholder')}</div>`;
                return;
            }
            appData.music.playlists.forEach(playlist => {
                const itemHTML = `
                    <div class="glass-list-item" onclick="openPlaylistDetail('${playlist.id}')">
                        <i class="fas fa-music item-icon"></i>
                        <span class="item-text">${playlist.name} (${playlist.songIds.length}首)</span>
                        <i class="fas fa-chevron-right item-arrow"></i>
                    </div>
                `;
                container.innerHTML += itemHTML;
            });
        }

        function openPlaylistDetail(playlistId) {
            const playlist = appData.music.playlists.find(p => p.id === playlistId);
            if (!playlist) return;
            
            const songs = appData.music.songs.filter(s => playlist.songIds.includes(s.id));
            const listHtml = songs.map((song) => {
                const globalIndex = appData.music.songs.findIndex(s => s.id === song.id);
                return `
                <div class="music-list-item" onclick="playSong(${globalIndex}, 'all')">
                    <div class="music-list-item-cover" style="background-image: url(${song.cover})"></div>
                    <div class="music-list-item-info">
                        <div class="music-list-item-title">${song.title}</div>
                        <div class="music-list-item-artist">${song.artist}</div>
                    </div>
                </div>
            `}).join('');

            showModal(`
                <div class="modal-title">${playlist.name}</div>
                <div class="modal-body">${listHtml || '<div class="app-placeholder">歌单是空的</div>'}</div>
            `);
        }

        function renderFavoriteSongs() {
            const container = document.getElementById('favoriteSongsContent');
            container.innerHTML = '';
            const favoriteSongs = appData.music.songs.filter(s => appData.music.favoriteSongIds.includes(s.id));
            if (favoriteSongs.length === 0) {
                container.innerHTML = `<div class="app-placeholder">${t('placeholder_no_data')}</div>`;
                return;
            }
            favoriteSongs.forEach(song => {
                const songIndex = appData.music.songs.findIndex(s => s.id === song.id);
                const itemHTML = `
                    <div class="music-list-item" onclick="openMusicActions('${song.id}', ${songIndex}, 'favorites')">
                        <div class="music-list-item-cover" style="background-image: url(${song.cover})"></div>
                        <div class="music-list-item-info">
                            <div class="music-list-item-title">${song.title}</div>
                            <div class="music-list-item-artist">${song.artist}</div>
                        </div>
                    </div>
                `;
                container.innerHTML += itemHTML;
            });
        }

        function showAddToPlaylistModal(songId) {
            if (appData.music.playlists.length === 0) {
                showiOSAlert(t('common_info'), "请先在“收藏歌单”中创建一个歌单。");
                return;
            }
            const listHtml = appData.music.playlists.map(playlist => 
                `<div class="list-item" onclick="addSongToPlaylist('${songId}', '${playlist.id}')">${playlist.name}</div>`
            ).join('');
            showModal(`
                <div class="modal-title">添加到歌单</div>
                <div class="modal-body">${listHtml}</div>
            `);
        }

        function addSongToPlaylist(songId, playlistId) {
            const playlist = appData.music.playlists.find(p => p.id === playlistId);
            if (playlist && !playlist.songIds.includes(songId)) {
                playlist.songIds.push(songId);
                saveData();
                showiOSAlert(t('common_success'), `已添加到歌单“${playlist.name}”。`);
                closeModal();
            } else if (playlist) {
                showiOSAlert(t('common_info'), `歌曲已存在于歌单“${playlist.name}”中。`);
                closeModal();
            }
        }

        function openMusicSearchSettings() {
            showiOSAlert('搜索引擎设置', `当前搜索引擎为：${t('music_engine_netease')}，无需更改。`);
        }

        async function searchMusic() {
            const query = document.getElementById('music-search-input').value.trim();
            if (!query) return;
            
            showiOSAlert('正在搜索...', `正在通过 ${t('music_engine_netease')} 搜索“${query}”...`);
            
            let results = [];
            try {
                results = await realMusicSearchAPI(query);
            } catch (e) {
                console.error("Music search failed:", e);
                results = [];
            }
            
            const resultsContainer = document.getElementById('musicSearchResults');
            resultsContainer.innerHTML = `<h3>搜索结果</h3>`;
            if (results.length === 0) {
                resultsContainer.innerHTML += `<div class="app-placeholder">${t('placeholder_no_data')}</div>`;
                closeiOSAlert();
                return;
            }
            
            results.forEach(song => {
                const safeSong = JSON.stringify(song).replace(/"/g, '&quot;');
                const itemHTML = `
                    <div class="music-list-item">
                        <div class="music-list-item-cover" style="background-image: url(${song.cover})"></div>
                        <div class="music-list-item-info">
                            <div class="music-list-item-title">${song.title}</div>
                            <div class="music-list-item-artist">${song.artist}</div>
                        </div>
                        <div class="music-list-item-actions">
                            <i class="fas fa-plus" onclick="importSearchedSong(event, ${safeSong})"></i>
                        </div>
                    </div>
                `;
                resultsContainer.innerHTML += itemHTML;
            });
            closeiOSAlert();
        }

        async function realMusicSearchAPI(query) {
            const corsProxy = 'https://api.allorigins.win/get?url=';
            const apiUrl = `${corsProxy}${encodeURIComponent(`https://music.163.com/api/search/get?s=${query}&type=1&limit=20`)}`;
            
            try {
                const response = await fetch(apiUrl, { cache: "no-cache" });
                if (!response.ok) {
                    console.error('CORS Proxy Network response was not ok:', response.statusText);
                    return [];
                }
                const data = await response.json();
                
                if (!data.contents) {
                    console.error('CORS Proxy did not return contents.');
                    return [];
                }

                const parsedData = JSON.parse(data.contents);

                if (parsedData.code === 200 && parsedData.result && parsedData.result.songs) {
                    return parsedData.result.songs.map(s => ({
                        title: s.name,
                        artist: s.artists.map(a => a.name).join('/'),
                        cover: (s.album.picUrl || 'https://via.placeholder.com/150').replace('http://', 'https://') + '?param=200y200',
                        src: `https://music.163.com/song/media/outer/url?id=${s.id}.mp3`,
                        lyrics: ''
                    }));
                }
                return [];
            } catch (error) {
                console.error("Real music search API fetch failed:", error);
                return [];
            }
        }
        
        function importSearchedSong(event, songData) {
            event.stopPropagation();
            const existing = appData.music.songs.find(s => s.title === songData.title && s.artist === songData.artist);
            if (existing) {
                showiOSAlert(t('common_info'), '这首歌曲已在您的本地音乐中。');
                return;
            }
            const newSong = { ...songData, id: `song_${Date.now()}`, addedAt: Date.now() };
            appData.music.songs.push(newSong);
            saveData();
            if (document.getElementById('localMusicContainer').classList.contains('active')) {
                renderLocalMusicList();
            }
            showiOSAlert(t('common_success'), `“${newSong.title}”已添加到本地音乐。`);
        }

        function showLyrics() {
            const song = appData.music.songs[appData.music.settings.currentIndex];
            if (!song || !song.lyrics) {
                showiOSAlert(t('common_info'), '当前歌曲没有歌词信息。');
                return;
            }
            const lyricsHtml = `<pre style="white-space: pre-wrap; text-align: center; font-size: 1.3em; line-height: 1.6;">${song.lyrics}</pre>`;
            showModal(`
                <div class="modal-title">${song.title} - 歌词</div>
                <div class="modal-body" style="padding: 20px;">${lyricsHtml}</div>
            `);
        }

        function openMusicActions(songId, index, playlistId) {
            const globalIndex = appData.music.songs.findIndex(s => s.id === songId);
            showCustomiOSAlert(t('music_actions_title'), '', [
                { text: '播放', action: () => playSong(globalIndex, 'all') },
                { text: t('music_action_download'), action: () => downloadSong(songId) },
                { text: t('music_action_share'), action: () => shareMusic(songId) },
                { text: t('common_delete'), style: 'destructive', action: () => deleteSong(songId) },
                { text: t('common_cancel'), style: 'bold' }
            ]);
        }

        function deleteSong(songId) {
            if (confirm('确定要从本地音乐中永久删除这首歌曲吗？')) {
                appData.music.songs = appData.music.songs.filter(s => s.id !== songId);
                appData.music.favoriteSongIds = appData.music.favoriteSongIds.filter(id => id !== songId);
                appData.music.recentlyPlayed = appData.music.recentlyPlayed.filter(s => s.songId !== songId);
                appData.music.playlists.forEach(playlist => {
                    playlist.songIds = playlist.songIds.filter(id => id !== songId);
                });

                if (appData.music.songs[appData.music.settings.currentIndex]?.id === songId) {
                    stopMusic();
                }

                saveData();
                if (document.getElementById('localMusicContainer').classList.contains('active')) renderLocalMusicList();
                if (document.getElementById('favoriteSongsContainer').classList.contains('active')) renderFavoriteSongs();
                if (document.getElementById('recentlyPlayedContainer').classList.contains('active')) renderRecentlyPlayed();
                showiOSAlert(t('common_success'), '歌曲已删除。');
            }
        }

        function downloadSong(songId) {
            const song = appData.music.songs.find(s => s.id === songId);
            if (song && song.src) {
                const a = document.createElement('a');
                a.href = song.src;
                a.download = `${song.artist} - ${song.title}.mp3`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                showiOSAlert(t('common_error'), '无法下载该歌曲。');
            }
        }

        function shareMusic(songId) {
            const contacts = appData.contacts.filter(c => !appData.settings.blacklist.includes(c.id));
            if (contacts.length === 0) {
                showiOSAlert(t('common_info'), "通讯录中没有可以分享的好友。");
                return;
            }

            const listHtml = contacts.map(contact => `
                <div class="list-item" onclick="confirmMusicShare('${songId}', '${contact.id}')">
                    <div class="list-item-avatar-wrapper" style="margin-right: 10px;">
                        <div class="list-item-avatar" style="background-image: url(${contact.avatar || ''})"></div>
                    </div>
                    <div class="list-item-info">
                        <div class="list-item-name">${contact.name || '未命名'}</div>
                    </div>
                    <i class="fas fa-chevron-right item-arrow"></i>
                </div>
            `).join('');

            showModal(`
                <div class="modal-title">分享给</div>
                <div class="modal-body">${listHtml}</div>
            `);
        }

        function confirmMusicShare(songId, contactId) {
            const song = appData.music.songs.find(s => s.id === songId);
            if (song) {
                addMessage({
                    id: `msg_${Date.now()}`,
                    type: 'music-share',
                    sender: 'user',
                    content: {
                        id: song.id,
                        title: song.title,
                        artist: song.artist,
                        cover: song.cover,
                        duration: musicAudioElement.duration ? formatTime(musicAudioElement.duration) : '0:00'
                    },
                    timestamp: Date.now()
                }, contactId);
                showiOSAlert(t('common_success'), "音乐已分享。");
                closeModal();
            }
        }
        
        function playSharedMusic(songId) {
            const songIndex = appData.music.songs.findIndex(s => s.id === songId);
            if (songIndex > -1) {
                playSong(songIndex, 'all');
            } else {
                showiOSAlert(t('common_error'), '无法播放，本地音乐库中未找到此歌曲。');
            }
        }

        function renderRecentlyPlayed() {
            const container = document.getElementById('recentlyPlayedListContent');
            container.innerHTML = '';
            
            let sortedList = [...appData.music.recentlyPlayed];
            const sortType = appData.music.settings.recentlyPlayedSort;

            const songMap = new Map(appData.music.songs.map(s => [s.id, s]));

            switch(sortType) {
                case 'az':
                    sortedList.sort((a, b) => (songMap.get(a.songId)?.title || '').localeCompare(songMap.get(b.songId)?.title || ''));
                    break;
                case 'za':
                    sortedList.sort((a, b) => (songMap.get(b.songId)?.title || '').localeCompare(songMap.get(a.songId)?.title || ''));
                    break;
                case 'count':
                    sortedList.sort((a, b) => b.playCount - a.playCount);
                    break;
                case 'newest':
                    sortedList.sort((a, b) => b.addedAt - a.addedAt);
                    break;
                case 'oldest':
                    sortedList.sort((a, b) => a.addedAt - b.addedAt);
                    break;
                default: // lastPlayed
                    sortedList.sort((a, b) => b.lastPlayed - a.lastPlayed);
                    break;
            }

            if (sortedList.length === 0) {
                container.innerHTML = `<div class="app-placeholder">还没有播放记录。</div>`;
                return;
            }

            sortedList.forEach(playedSong => {
                const song = songMap.get(playedSong.songId);
                if (song) {
                    const songIndex = appData.music.songs.findIndex(s => s.id === song.id);
                    const itemHTML = `
                        <div class="music-list-item" onclick="openMusicActions('${song.id}', ${songIndex}, 'all')">
                            <div class="music-list-item-cover" style="background-image: url(${song.cover})"></div>
                            <div class="music-list-item-info">
                                <div class="music-list-item-title">${song.title}</div>
                                <div class="music-list-item-artist">${song.artist}</div>
                            </div>
                            <div style="text-align: right; color: var(--secondary-text);">
                                <div>播放 ${playedSong.playCount} 次</div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += itemHTML;
                }
            });
        }

        function showSortOptions() {
            showCustomiOSAlert(t('music_sort_title'), '', [
                                { text: t('music_sort_az'), action: () => setSortOption('az') },
                { text: t('music_sort_za'), action: () => setSortOption('za') },
                { text: t('music_sort_count'), action: () => setSortOption('count') },
                { text: t('music_sort_newest'), action: () => setSortOption('newest') },
                { text: t('music_sort_oldest'), action: () => setSortOption('oldest') },
                { text: t('common_cancel'), style: 'bold' }
            ]);
        }

        function setSortOption(sortType) {
            appData.music.settings.recentlyPlayedSort = sortType;
            saveData(true);
            renderRecentlyPlayed();
        }

        function parseLyrics(lrc) {
            if (!lrc) return [];
            const lines = lrc.split('\n');
            const result = [];
            const timeRegex = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
            for (const line of lines) {
                const match = line.match(timeRegex);
                if (match) {
                    const minutes = parseInt(match[1]);
                    const seconds = parseInt(match[2]);
                    const milliseconds = parseInt(match[3].padEnd(3, '0'));
                    const time = minutes * 60 + seconds + milliseconds / 1000;
                    const text = line.replace(timeRegex, '').trim();
                    if (text) {
                        result.push({ time, text });
                    }
                }
            }
            return result;
        }

        function updateActiveLyrics() {
            if (parsedLyrics.length === 0) {
                const lyricsEl = document.getElementById('mini-player-lyrics');
                if (lyricsEl) lyricsEl.textContent = '暂无歌词';
                return;
            }
            const currentTime = musicAudioElement.currentTime;
            let newLyricIndex = -1;
            for (let i = 0; i < parsedLyrics.length; i++) {
                if (currentTime >= parsedLyrics[i].time) {
                    newLyricIndex = i;
                } else {
                    break;
                }
            }

            if (newLyricIndex !== currentLyricIndex) {
                currentLyricIndex = newLyricIndex;
                const lyricsEl = document.getElementById('mini-player-lyrics');
                if (lyricsEl && currentLyricIndex > -1) {
                    lyricsEl.textContent = parsedLyrics[currentLyricIndex].text;
                }
            }
        }

        function updateMiniPlayer(show) {
            const miniPlayer = document.getElementById('music-mini-player');
            if (appData.music.settings.miniPlayerHidden) {
                miniPlayer.classList.remove('visible');
                return;
            }

            if (!show) {
                miniPlayer.classList.remove('visible');
                return;
            }
            
            const song = appData.music.songs[appData.music.settings.currentIndex];
            if (!song) {
                miniPlayer.classList.remove('visible');
                return;
            }

            miniPlayer.classList.add('visible');
            document.getElementById('mini-player-cover').style.backgroundImage = `url(${song.cover})`;
            document.getElementById('mini-player-title').textContent = song.title;
            document.getElementById('mini-player-artist').textContent = song.artist;
            const isPlaying = !musicAudioElement.paused;
            document.getElementById('mini-player-play-btn').className = `fas ${isPlaying ? 'fa-pause' : 'fa-play'}`;
        }

        function hideMiniPlayer() {
            const miniPlayer = document.getElementById('music-mini-player');
            miniPlayer.classList.remove('visible');
            appData.music.settings.miniPlayerHidden = true;
            saveData(true);
        }

        function toggleMiniPlayerLyrics() {
            const lyricsContainer = document.getElementById('mini-player-lyrics-container');
            const icon = document.getElementById('mini-player-lyrics-toggle-icon');
            const isHidden = lyricsContainer.style.display === 'none';
            lyricsContainer.style.display = isHidden ? 'block' : 'none';
            icon.className = `fas ${isHidden ? 'fa-chevron-up' : 'fa-chevron-down'}`;
        }
        
        function makeDraggable(element, handle) {
            let isDragging = false;
            let offsetX, offsetY;
            const screen = document.querySelector('.screen');

            const startDrag = (e) => {
                isDragging = true;
                const event = e.touches ? e.touches[0] : e;
                offsetX = event.clientX - element.offsetLeft;
                offsetY = event.clientY - element.offsetTop;
                element.style.transition = 'none';
            };

            const drag = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const event = e.touches ? e.touches[0] : e;

                const screenRect = screen.getBoundingClientRect();
                let newLeft = event.clientX - offsetX;
                let newTop = event.clientY - offsetY;

                newLeft = Math.max(0, Math.min(newLeft, screenRect.width - element.offsetWidth));
                newTop = Math.max(0, Math.min(newTop, screenRect.height - element.offsetHeight));

                element.style.left = `${newLeft}px`;
                element.style.top = `${newTop}px`;
                element.style.bottom = 'auto';
                element.style.right = 'auto';
                element.style.transform = 'none';
            };

            const endDrag = () => {
                isDragging = false;
                element.style.transition = 'opacity 0.3s ease-in-out';
            };

            handle.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);

            handle.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', endDrag);
        }

        // --- 贴吧 App ---
        function renderTiebaApp() {
            switchTiebaTab('Home');
        }

        function switchTiebaTab(tabName) {
            document.querySelectorAll('#tiebaContainer .tieba-page').forEach(p => p.classList.remove('active'));
            document.getElementById(`tiebaPage${tabName}`).classList.add('active');
            
            document.querySelectorAll('#tiebaContainer .tieba-nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`.tieba-nav-item[onclick="switchTiebaTab('${tabName}')"]`).classList.add('active');

            const refreshBtn = document.getElementById('tiebaRefreshBtn');
            if (tabName === 'Home') {
                refreshBtn.style.display = 'flex';
                refreshBtn.onclick = () => refreshTiebaFeed(appData.tieba.activeCategory, `tiebaFeedHome`);
            } else {
                refreshBtn.style.display = 'none';
            }

            if (tabName === 'Home') {
                renderTiebaCategories();
                filterTiebaPosts(appData.tieba.activeCategory);
            } else if (tabName === 'Following') {
                renderTiebaFollowingPage();
            } else if (tabName === 'Me') {
                renderTiebaMePage();
            }
        }

        function renderTiebaCategories() {
            const container = document.getElementById('tiebaCategories');
            container.innerHTML = '';
            appData.tieba.categories.forEach(cat => {
                container.innerHTML += `<button class="tieba-category-btn ${appData.tieba.activeCategory === cat ? 'active' : ''}" onclick="filterTiebaPosts('${cat}')">${cat}</button>`;
            });
            container.innerHTML += `<button class="tieba-category-btn" onclick="addTiebaCategory()">+</button>`;
        }

        function addTiebaCategory() {
            const newCategory = prompt("请输入要添加的自定义标签:");
            if (newCategory && !appData.tieba.categories.includes(newCategory)) {
                appData.tieba.categories.push(newCategory);
                saveData();
                renderTiebaCategories();
            }
        }

        function filterTiebaPosts(category) {
            appData.tieba.activeCategory = category;
            renderTiebaCategories();
            const filterFunc = category === '全部' ? () => true : post => post.category === category;
            renderTiebaFeed('tiebaFeedHome', filterFunc);
        }

        function renderTiebaFeed(containerId, filterFunc) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const filteredPosts = appData.tieba.posts.filter(filterFunc);
            container.innerHTML = '';

            if (filteredPosts.length === 0) {
                container.innerHTML = `<div class="app-placeholder">${t('placeholder_no_content')}</div>`;
                return;
            }

            
           [...filteredPosts].reverse().forEach(post => {
                const author = getTiebaUser(post.authorId);
                const isLiked = (post.likes.users || []).includes(appData.tieba.myProfile.id);
                const tagsHTML = (post.tags || []).map(tag => `<span class="tieba-post-tag">${tag}</span>`).join('');
                const locationHTML = post.location ? `<div class="tieba-post-location"><i class="fas fa-map-marker-alt"></i> ${post.location}</div>` : '';

                const postHTML = `
                    <div class="tieba-post-card" 
                         onclick="openTiebaPostDetail('${post.id}')"
                         oncontextmenu="event.preventDefault(); deleteTiebaPost(event, '${post.id}')"
                         ontouchstart="handleTiebaCardPress(event, '${post.id}')"
                         ontouchend="handleTiebaCardRelease()"
                         ontouchmove="handleTiebaCardRelease()">
                        <div class="tieba-post-card-avatar" style="background-image: url(${author.avatar || ''})"></div>
                        <div class="tieba-post-card-main">
                            <div class="tieba-post-author-info">
                                <span class="tieba-post-author-name">${author.nickname || '匿名用户'}</span>
                                <span class="tieba-post-author-username">${author.username || '@unknown'}</span>
                            </div>
                            <div class="tieba-post-title">${post.title}</div>
                            <div class="tieba-post-tags">${tagsHTML}</div>
                            <div class="tieba-post-content-preview">${post.content}</div>
                            ${locationHTML}
                            <div class="tieba-post-footer">
                                <div class="tieba-post-actions">
                                    <div class="${isLiked ? 'liked' : ''}"><i class="fas fa-thumbs-up"></i> ${post.likes.count}</div>
                                    <div><i class="far fa-comment-dots"></i> ${post.comments.length}</div>
                                </div>
                                <div><i class="far fa-eye"></i> ${post.views}</div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += postHTML;
            });
        }

        function handleTiebaCardPress(event, postId) {
            tiebaLongPressTimer = setTimeout(() => {
                deleteTiebaPost(event, postId);
            }, 800);
        }
        function handleTiebaCardRelease() {
            clearTimeout(tiebaLongPressTimer);
        }
        function deleteTiebaPost(event, postId) {
            event.preventDefault();
            appData.tieba.posts = appData.tieba.posts.filter(p => p.id !== postId);
            saveData();
            const activeTab = document.querySelector('#tiebaContainer .tieba-nav-item.active').getAttribute('onclick').match(/'([^']+)'/)[1];
            if (activeTab === 'Home') {
                filterTiebaPosts(appData.tieba.activeCategory);
            } else if (activeTab === 'Following') {
                renderTiebaFollowingPage();
            }
        }

        function openTiebaPostDetail(postId) {
            const post = appData.tieba.posts.find(p => p.id === postId);
            if (!post) return;

            openSubPage('tiebaPostDetail');
            const refreshBtn = document.getElementById('tiebaDetailRefreshBtn');
            refreshBtn.onclick = () => refreshTiebaComments(postId);

            renderTiebaPostDetailContent(postId);
        }

        function renderTiebaPostDetailContent(postId) {
            const post = appData.tieba.posts.find(p => p.id === postId);
            if (!post) return;

            const container = document.getElementById('tiebaPostDetailContent');
            const author = getTiebaUser(post.authorId);
            const isLiked = (post.likes.users || []).includes(appData.tieba.myProfile.id);

            let commentsHTML = '';
            (post.comments || []).slice(0, post.displayCommentCount || 15).forEach((comment, index) => {
                const commenter = getTiebaUser(comment.authorId);
                let replyToHTML = '';
                if (comment.replyTo) {
                    const repliedComment = post.comments.find(c => c.id === comment.replyTo);
                    if (repliedComment) {
                        const repliedAuthor = getTiebaUser(repliedComment.authorId);
                        replyToHTML = `<div class="tieba-comment-reply-to"><span class="author">回复 ${repliedAuthor.nickname}:</span> ${repliedComment.content}</div>`;
                    }
                }
                commentsHTML += `
                    <div class="tieba-comment-item" onclick="addTiebaComment('${postId}', '${comment.id}')">
                        <div class="tieba-comment-avatar" style="background-image: url(${commenter.avatar || ''});"></div>
                        <div class="tieba-comment-main">
                            <div class="tieba-comment-header">
                                <span class="tieba-comment-author-name">${commenter.nickname || '匿名用户'}</span>
                                <span class="tieba-comment-floor">#${index + 1}</span>
                            </div>
                            ${replyToHTML}
                            <div class="tieba-comment-content">${comment.content}</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = `
                <div class="tieba-detail-post-header">
                    <div class="tieba-detail-author-info">
                        <div class="tieba-detail-author-name">${author.nickname || '匿名用户'}</div>
                        <div class="tieba-detail-author-username">${author.username || '@unknown'}</div>
                        <div class="tieba-detail-author-signature">${author.signature || '这个人很懒，什么都没留下...'}</div>
                    </div>
                </div>
                <h2 class="tieba-detail-title">${post.title}</h2>
                <p class="tieba-detail-content">${post.content}</p>
                <div class="tieba-detail-actions">
                    <button id="tieba-detail-like-btn" class="${isLiked ? 'liked' : ''}" onclick="toggleTiebaPostLike('${postId}')"><i class="fas fa-thumbs-up"></i> <span>${post.likes.count}</span></button>
                    <button onclick="addTiebaComment('${postId}')"><i class="fas fa-comment-dots"></i> <span>${post.comments.length}</span></button>
                    <button onclick="shareTiebaPost('${postId}')"><i class="fas fa-share-square"></i></button>
                </div>
                <div class="tieba-detail-comments-section">
                    ${commentsHTML || '<div class="app-placeholder">还没有评论，快来抢沙发吧！</div>'}
                </div>
            `;
        }

        function toggleTiebaPostLike(postId) {
            const post = appData.tieba.posts.find(p => p.id === postId);
            const myId = appData.tieba.myProfile.id;
            if (!post.likes.users) post.likes.users = [];
            const likeIndex = post.likes.users.indexOf(myId);

            if (likeIndex > -1) {
                post.likes.users.splice(likeIndex, 1);
                post.likes.count--;
            } else {
                post.likes.users.push(myId);
                post.likes.count++;
            }
            saveData();
            
            if (document.getElementById('tiebaPostDetailContainer').classList.contains('active')) {
                renderTiebaPostDetailContent(postId);
            }
            filterTiebaPosts(appData.tieba.activeCategory);
        }

        async function addTiebaComment(postId, replyToCommentId = null) {
            const post = appData.tieba.posts.find(p => p.id === postId);
            let promptMessage = '请输入你的评论:';
            let repliedComment, repliedAuthor;
            if (replyToCommentId) {
                repliedComment = post.comments.find(c => c.id === replyToCommentId);
                if (repliedComment) {
                    repliedAuthor = getTiebaUser(repliedComment.authorId);
                    promptMessage = `回复 ${repliedAuthor.nickname}:`;
                }
            }
            
            const content = prompt(promptMessage);
            if (content && content.trim()) {
                const newComment = {
                    id: `comment_${Date.now()}`,
                    authorId: appData.tieba.myProfile.id,
                    content: content.trim(),
                    timestamp: Date.now(),
                    replyTo: replyToCommentId
                };
                post.comments.push(newComment);
                saveData();
                            renderTiebaPostDetailContent(postId);

                if (repliedAuthor && repliedAuthor.id !== appData.tieba.myProfile.id) {
                    await generateTiebaCommentReply(postId, newComment.id, repliedAuthor.id);
                }
            }
        }

        async function generateTiebaCommentReply(postId, userCommentId, npcId) {
            const post = appData.tieba.posts.find(p => p.id === postId);
            const userComment = post.comments.find(c => c.id === userCommentId);
            const npc = getTiebaUser(npcId);

            showSpinner('tiebaDetailSpinnerOverlay', true);

            const prompt = `你是一个贴吧用户，你的名字是 ${npc.nickname}。现在有人在帖子“${post.title}”里回复了你的评论。
            你的原评论是：“${post.comments.find(c => c.id === userComment.replyTo)?.content || ''}”
            对方的回复是：“${userComment.content}”
            请以 ${npc.nickname} 的身份，用非常自然、口语化的风格回复对方。回复要简短，像真人一样。只返回回复内容，不要任何额外文字。`;

            try {
                const replyContent = await callGenericApi(prompt, { temperature: 1.1 }, [], 'tieba');
                const npcReply = {
                    id: `comment_${Date.now()}`,
                    authorId: npcId,
                    content: replyContent,
                    timestamp: Date.now(),
                    replyTo: userCommentId
                };
                post.comments.push(npcReply);
                saveData();
            } catch (error) {
                console.error("NPC 回复生成失败:", error);
            } finally {
                showSpinner('tiebaDetailSpinnerOverlay', false);
                renderTiebaPostDetailContent(postId);
            }
        }

        function shareTiebaPost(postId) {
            openTiebaShareRecipientPicker(postId);
        }

        function openTiebaShareRecipientPicker(postId) {
            const contacts = appData.contacts.filter(c => !appData.settings.blacklist.includes(c.id));
            if (contacts.length === 0) {
                showiOSAlert(t('common_info'), "通讯录中没有可以分享的好友。");
                return;
            }

            const listHtml = contacts.map(contact => `
                <div class="list-item" onclick="confirmTiebaShare('${postId}', '${contact.id}')">
                    <div class="list-item-avatar-wrapper" style="margin-right: 10px;">
                        <div class="list-item-avatar" style="background-image: url(${contact.avatar || ''})"></div>
                    </div>
                    <div class="list-item-info">
                        <div class="list-item-name">${contact.name || '未命名'}</div>
                    </div>
                    <i class="fas fa-chevron-right item-arrow"></i>
                </div>
            `).join('');

            showModal(`
                <div class="modal-title">分享到</div>
                <div class="modal-body">${listHtml}</div>
            `);
        }

        function confirmTiebaShare(postId, contactId) {
            const post = appData.tieba.posts.find(p => p.id === postId);
            if (post) {
                addMessage({
                    id: `msg_${Date.now()}`,
                    type: 'tieba-share',
                    sender: 'user',
                    content: {
                        id: post.id,
                        title: post.title,
                        content: post.content
                    },
                    timestamp: Date.now()
                }, contactId);
                showiOSAlert(t('common_success'), "帖子已分享到聊天。");
                closeModal();
            }
        }

        function renderTiebaMePage() {
            const container = document.getElementById('tiebaMeContent');
            const profile = appData.tieba.myProfile;
            const followingCount = appData.contacts.length;
            container.innerHTML = `
                <div class="tieba-me-profile-header" onclick="openTiebaProfileEditor()">
                    <div class="tieba-me-avatar" style="background-image: url(${profile.avatar || ''})"></div>
                    <div class="tieba-me-info">
                        <div class="tieba-me-nickname">${profile.nickname}</div>
                        <div class="tieba-me-username">${profile.username}</div>
                    </div>
                    <i class="fas fa-chevron-right item-arrow"></i>
                </div>
                <div class="tieba-me-stats">
                    <div class="tieba-me-stat-item">
                        <div class="tieba-me-stat-value">${profile.followers}</div>
                        <div class="tieba-me-stat-label">粉丝</div>
                    </div>
                    <div class="tieba-me-stat-item">
                        <div class="tieba-me-stat-value">${followingCount}</div>
                        <div class="tieba-me-stat-label">关注</div>
                    </div>
                </div>
                <div class="glass-list">
                    <div class="glass-list-item" onclick="openTiebaProfileEditor()">
                        <i class="fas fa-edit item-icon"></i><span class="item-text" data-lang="tieba_profile_editor_title">编辑个人资料</span><i class="fas fa-chevron-right item-arrow"></i>
                    </div>
                </div>
            `;
            applyTranslations();
        }

        function openTiebaProfileEditor() {
            openSubPage('tiebaProfileEditor');
            const profile = appData.tieba.myProfile;
            document.getElementById('tiebaAvatarPreview').style.backgroundImage = `url(${profile.avatar || ''})`;
            document.getElementById('tieba-nickname').value = profile.nickname;
            document.getElementById('tieba-username').value = profile.username;
            document.getElementById('tieba-signature').value = profile.signature;
            document.getElementById('tieba-followers').value = profile.followers;
            tempAvatarData.data = profile.avatar || null;
            tempAvatarData.type = 'tieba-avatar';
        }

        function saveTiebaProfile() {
            const username = document.getElementById('tieba-username').value;
            if (!username.startsWith('@') || !/^[a-zA-Z0-9_]{1,19}$/.test(username.substring(1))) {
                showiOSAlert(t('common_error'), '用户名必须以@开头，后面跟1-19位字母、数字或下划线。', 'error');
                return;
            }
            
            appData.tieba.myProfile.nickname = document.getElementById('tieba-nickname').value;
            appData.tieba.myProfile.username = username;
            appData.tieba.myProfile.signature = document.getElementById('tieba-signature').value;
            appData.tieba.myProfile.followers = parseInt(document.getElementById('tieba-followers').value) || 0;
            if (tempAvatarData.type === 'tieba-avatar') {
                appData.tieba.myProfile.avatar = tempAvatarData.data;
            }
            
            saveData();
            closeSubPage('tiebaProfileEditor');
            renderTiebaMePage();
        }

        function openTiebaPostEditor(postId) {
            const post = postId ? appData.tieba.posts.find(p => p.id === postId) : null;
            currentEditingTiebaPost = {
                id: post?.id || null,
                authorId: post?.authorId || appData.tieba.myProfile.id,
                title: post?.title || '',
                content: post?.content || '',
                files: post?.files || [],
                location: post?.location || ''
            };
            
            openSubPage('tiebaPostEditor');
            
            const authorSelect = document.getElementById('tieba-post-author-select');
            authorSelect.innerHTML = `<option value="${appData.tieba.myProfile.id}">${appData.tieba.myProfile.nickname} (我)</option>`;
            appData.contacts.forEach(contact => {
                authorSelect.innerHTML += `<option value="${contact.id}">${contact.name}</option>`;
            });
            authorSelect.value = currentEditingTiebaPost.authorId;

            document.getElementById('tieba-post-title-input').value = currentEditingTiebaPost.title;
            document.getElementById('tieba-post-content-input').value = currentEditingTiebaPost.content;
            updateTiebaPostEditorUI();
        }

        function updateTiebaPostEditorUI() {
            document.getElementById('tieba-post-location-display').textContent = currentEditingTiebaPost.location || t('tieba_post_editor_location');
            const previewContainer = document.getElementById('tieba-post-files-preview');
            previewContainer.innerHTML = currentEditingTiebaPost.files.map((file, index) => {
                let previewContent = '';
                if (file.type.startsWith('image')) previewContent = `<img src="${file.data}" alt="${file.name}">`;
                else if (file.type.startsWith('video')) previewContent = `<video src="${file.data}"></video>`;
                else previewContent = `<div class="file-icon"><i class="fas fa-file"></i></div>`;
                
                return `<div class="file-preview-item">${previewContent}<div class="remove-file-btn" onclick="removeTiebaPostFile(${index})">&times;</div></div>`;
            }).join('');
        }

        function handleTiebaPostFiles(event) {
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentEditingTiebaPost.files.push({
                        name: file.name,
                        type: file.type,
                        data: e.target.result
                    });
                    updateTiebaPostEditorUI();
                };
                reader.readAsDataURL(file);
            }
        }

        function removeTiebaPostFile(index) {
            currentEditingTiebaPost.files.splice(index, 1);
            updateTiebaPostEditorUI();
        }

        function editTiebaPostLocation() {
            const newLocation = prompt('自定义位置', currentEditingTiebaPost.location);
            if (newLocation !== null) {
                currentEditingTiebaPost.location = newLocation;
                updateTiebaPostEditorUI();
            }
        }

        function saveTiebaPost() {
            const title = document.getElementById('tieba-post-title-input').value.trim();
            const content = document.getElementById('tieba-post-content-input').value.trim();
            if (!title) {
                showiOSAlert(t('common_error'), '帖子标题不能为空。');
                return;
            }

            const authorId = document.getElementById('tieba-post-author-select').value;

            const newPost = {
                id: currentEditingTiebaPost.id || `tieba_post_${Date.now()}`,
                authorId: authorId,
                title: title,
                content: content,
                category: appData.tieba.activeCategory,
                files: currentEditingTiebaPost.files,
                location: currentEditingTiebaPost.location,
                timestamp: Date.now(),
                likes: { count: 0, users: [] }, 
                comments: [], 
                views: 0,
                displayCommentCount: 15,
                tags: []
            };

            if (currentEditingTiebaPost.id) {
                const index = appData.tieba.posts.findIndex(p => p.id === currentEditingTiebaPost.id);
                if (index > -1) appData.tieba.posts[index] = { ...appData.tieba.posts[index], ...newPost };
            } else {
                appData.tieba.posts.push(newPost);
            }
            
            saveData();
            closeSubPage('tiebaPostEditor');
            switchTiebaTab('Home');
            showiOSAlert(t('common_success'), '您的帖子已成功发布。');
        }

        async function refreshTiebaFeed(category, containerId, silent = false) {
            let api = appData.settings.tiebaApi;
            if (api.useMain) {
                api = appData.settings.mainApi;
            }

            if (!api.key) {
                if (!silent) showiOSAlert(t('common_error'), '请先在“设置”>“API设置”中配置您的贴吧API信息。', 'error');
                return;
            }
            if (!silent) showSpinner('tiebaSpinnerOverlay', true);

            const prompt = `你是一个贴吧内容生成器。请为"${category}"分类生成20条真实的帖子内容。
            要求：每条帖子都是一个JSON对象，包含 "title" (string, max 20 chars), "content" (string), "author" (object with "nickname", "username"), "tags" (array of strings, e.g., ["#挂人避雷", "#万万没想到"]), "location" (string, can be empty), "likes" (number), "views" (number)。
            将这20个JSON对象包裹在一个名为 "posts" 的JSON数组中。只返回这个包含 "posts" 键的纯JSON对象，不要任何markdown标记或额外文本。内容要真实自然，符合贴吧风格。`;

            let newPostsData;
            try {
                const content = await callGenericApi(prompt, { temperature: 1.2, max_tokens: 4000 }, [], 'tieba');
                const parsedContent = JSON.parse(content);
                newPostsData = parsedContent.posts;
                if (!Array.isArray(newPostsData) || newPostsData.length === 0) throw new Error("API返回格式不正确或为空");
            } catch (error) {
                console.error("贴吧刷新失败:", error);
                if (!silent) showiOSAlert('刷新失败', `无法获取新帖子: ${error.message}`, 'error');
                if (!silent) showSpinner('tiebaSpinnerOverlay', false);
                return;
            }

            const newPosts = newPostsData.map(p => {
                const authorId = `tieba_user_${p.author.username.replace('@', '')}`;
                if (!appData.tieba.users[authorId]) {
                    appData.tieba.users[authorId] = {
                        id: authorId,
                        nickname: p.author.nickname,
                        username: p.author.username,
                        signature: p.author.signature,
                        avatar: `https://i.pravatar.cc/150?u=${authorId}`,
                        stats: { followers: Math.floor(Math.random() * 5000), following: Math.floor(Math.random() * 500), posts: 0, likes: 0 }
                    };
                }

                return {
                    id: `tieba_post_${Date.now()}_${Math.random()}`,
                    authorId: authorId,
                    title: p.title,
                    content: p.content,
                    category: category,
                    tags: p.tags || [],
                    location: p.location || '',
                    timestamp: Date.now() - Math.floor(Math.random() * 86400000),
                    likes: { count: p.likes || 0, users: [] },
                    comments: [],
                    views: p.views || (p.likes || 0) * (10 + Math.floor(Math.random() * 20)),
                    displayCommentCount: 15
                };
            });

            for (const post of newPosts) {
                await refreshTiebaComments(post.id, true);
            }

            appData.tieba.posts.push(...newPosts);
            
            saveData();
            if (!silent) showiOSAlert(t('common_success'), `已获取${newPosts.length}条新帖子。`);
            
            const filterFunc = category === '全部' ? () => true : p => p.category === category;
            renderTiebaFeed(containerId, filterFunc);
            if (!silent) showSpinner('tiebaSpinnerOverlay', false);
        }

        async function refreshTiebaComments(postId, silent = false) {
            const post = appData.tieba.posts.find(p => p.id === postId);
            if (!post) return;

            if (!silent) showSpinner('tiebaDetailSpinnerOverlay', true);

            const prompt = `你是一个贴吧评论生成器。针对以下帖子，生成15条符合情景、风格各异的评论。
            帖子标题: "${post.title}"
            帖子内容: "${post.content}"
            要求：返回一个名为 "comments" 的JSON数组，数组中每个对象包含 "author" (object with "nickname", "username") 和 "content" (string)。只返回这个包含 "comments" 键的纯JSON对象，不要任何额外文本。`;

            let newCommentsData;
            try {
                const content = await callGenericApi(prompt, { temperature: 1.3 }, [], 'tieba');
                const parsedContent = JSON.parse(content);
                newCommentsData = parsedContent.comments;
                if (!Array.isArray(newCommentsData)) throw new Error("API返回格式不正确");
            } catch (error) {
                console.error("评论生成失败:", error);
                newCommentsData = [];
            }

            newCommentsData.forEach(c => {
                const authorId = `tieba_user_${c.author.username.replace('@', '')}`;
                if (!appData.tieba.users[authorId]) {
                    appData.tieba.users[authorId] = {
                        id: authorId,
                        nickname: c.author.nickname,
                        username: c.author.username,
                        avatar: `https://i.pravatar.cc/150?u=${authorId}`,
                        stats: { followers: 0, following: 0, posts: 0, likes: 0 }
                    };
                }
                post.comments.push({
                    id: `comment_${Date.now()}_${Math.random()}`,
                    authorId: authorId,
                    content: c.content,
                    timestamp: Date.now()
                });
            });

            post.displayCommentCount = (post.displayCommentCount || 15) + 15;
            saveData(true);
            if (!silent) {
                showSpinner('tiebaDetailSpinnerOverlay', false);
                renderTiebaPostDetailContent(postId);
            }
        }

        function renderTiebaFollowingPage() {
            const container = document.getElementById('tiebaFeedFollowing');
            container.innerHTML = '';
            if (appData.contacts.length === 0) {
                container.innerHTML = `<div class="app-placeholder">${t('placeholder_no_data')}</div>`;
                return;
            }
            appData.contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'contact-list-item';
                item.innerHTML = `
                    <div class="list-item-avatar-wrapper">
                        <div class="list-item-avatar" style="background-image: url(${contact.avatar || ''})"></div>
                    </div>
                    <div class="list-item-info">
                        <div class="list-item-name">${contact.name || '未命名'}</div>
                        <div class="list-item-bio">${contact.bio || ''}</div>
                    </div>
                    <i class="fas fa-chevron-right item-arrow"></i>
                `;
                item.onclick = () => openTiebaProfileDetail(contact.id);
                container.appendChild(item);
            });
        }

        function openTiebaProfileDetail(userId) {
            openSubPage('tiebaProfileDetail');
            const user = getTiebaUser(userId);
            const container = document.getElementById('tiebaProfileDetailContent');

            const userPosts = appData.tieba.posts.filter(p => p.authorId === userId);
            const userLikes = appData.tieba.posts.filter(p => (p.likes.users || []).includes(userId));

            container.innerHTML = `
                <div class="tieba-profile-header">
                    <div class="tieba-profile-avatar" style="background-image: url(${user.avatar || ''})"></div>
                    <div class="tieba-profile-nickname">${user.nickname}</div>
                    <div class="tieba-profile-username">${user.username}</div>
                    <p class="tieba-profile-signature">${user.signature || '这个人很懒，什么都没留下...'}</p>
                </div>
                <div class="tieba-profile-stats">
                    <div class="tieba-profile-stat-item">
                        <div class="tieba-profile-stat-value">${user.stats.followers}</div>
                        <div class="tieba-profile-stat-label">粉丝</div>
                    </div>
                    <div class="tieba-profile-stat-item">
                        <div class="tieba-profile-stat-value">${user.stats.following}</div>
                        <div class="tieba-profile-stat-label">关注</div>
                    </div>
                </div>
                <div class="tieba-profile-tabs">
                    <div class="tieba-profile-tab active" onclick="switchTiebaProfileTab(this, 'posts', '${userId}')">发帖 ${userPosts.length}</div>
                    <div class="tieba-profile-tab" onclick="switchTiebaProfileTab(this, 'likes', '${userId}')">点赞 ${userLikes.length}</div>
                </div>
                <div id="tiebaProfileTabContent" class="tieba-profile-content"></div>
            `;
            renderTiebaProfileTab('posts', userId);
        }

        function switchTiebaProfileTab(tabElement, tabName, userId) {
            document.querySelectorAll('.tieba-profile-tab').forEach(t => t.classList.remove('active'));
            tabElement.classList.add('active');
            renderTiebaProfileTab(tabName, userId);
        }

        function renderTiebaProfileTab(tabName, userId) {
            const container = document.getElementById('tiebaProfileTabContent');
            container.innerHTML = '';
            let postsToShow = [];
            if (tabName === 'posts') {
                postsToShow = appData.tieba.posts.filter(p => p.authorId === userId);
            } else {
                postsToShow = appData.tieba.posts.filter(p => (p.likes.users || []).includes(userId));
            }

            if (postsToShow.length === 0) {
                container.innerHTML = `<div class="app-placeholder">${t('placeholder_no_content')}</div>`;
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'tieba-profile-post-grid';
            [...postsToShow].reverse().forEach(post => {
                const firstImage = (post.files || []).find(f => f.type.startsWith('image'));
                grid.innerHTML += `
                    <div class="tieba-profile-post-item" onclick="openTiebaPostDetail('${post.id}')" style="background-image: url(${firstImage?.data || ''})">
                        ${!firstImage ? `<i class="fas fa-file-alt" style="color: #ccc; font-size: 24px;"></i>` : ''}
                        <div class="post-title-overlay">${post.title}</div>
                    </div>
                `;
            });
            container.appendChild(grid);
        }

        function getTiebaUser(userId) {
            if (userId === appData.tieba.myProfile.id) return appData.tieba.myProfile;
            const contact = appData.contacts.find(c => c.id === userId);
            if (contact) {
                return {
                    id: contact.id,
                    nickname: contact.name,
                    username: `@${contact.name.toLowerCase().replace(/\s/g, '_')}`,
                    signature: contact.bio,
                    avatar: contact.avatar,
                    stats: { followers: Math.floor(Math.random() * 1000), following: Math.floor(Math.random() * 200), posts: 0, likes: 0 }
                };
            }
            return appData.tieba.users[userId] || { nickname: '匿名用户', username: '@unknown', avatar: '', stats: {} };
        }

        // --- 聊天功能增强 ---
        function openFileModal(sender) {
            const options = [
                { text: '文本模拟文件', action: () => openSimFileModal(sender) }
            ];
            if (sender === 'user') {
                options.unshift({ text: '本地上传', action: () => {
                    const input = document.createElement('input');
                    input.type = 'file'; input.style.display = 'none';
                    input.onchange = handleLocalFileSelect;
                    document.body.appendChild(input); input.click(); document.body.removeChild(input);
                }});
            }
            options.push({ text: t('common_cancel'), style: 'bold' });
            showCustomiOSAlert(t('chat_action_file'), '', options);
        }

        function handleLocalFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    tempFileData = { name: file.name, data: e.target.result, type: file.type, size: file.size };
                    sendFile('user', 'local');
                };
                reader.readAsDataURL(file);
            }
        }

        function openSimFileModal(sender) {
            showModal(`
                <div class="modal-title">模拟文件</div>
                <div class="modal-body" style="background: var(--theme-bg); padding: 20px; gap: 15px; display: flex; flex-direction: column;">
                    <div class="glass-form-group"><label>文件名</label><input type="text" id="sim-file-name" class="glass-input" placeholder="e.g., report.txt"></div>
                    <div class="glass-form-group"><label>文件大小</label><div class="form-row"><input type="number" id="sim-file-size-num" class="glass-input" style="flex: 1;" value="10"><select id="sim-file-size-unit" class="glass-select" style="width: 80px;"><option value="KB">KB</option><option value="MB">MB</option><option value="GB">GB</option><option value="TB">TB</option></select></div></div>
                    <div class="glass-form-group"><label>文件内容</label><textarea id="sim-file-content" class="glass-textarea" style="min-height: 120px;"></textarea></div>
                    <button class="glass-button" onclick="sendFile('${sender}', 'sim')">发送模拟文件</button>
                </div>
            `);
        }

        function sendFile(sender, type, content) {
            let messageContent;
            if (type === 'local') {
                                messageContent = { name: tempFileData.name, size: formatFileSize(tempFileData.size), content: tempFileData.data, dataType: 'base64' };
            } else {
                if (sender === 'user') {
                    const name = document.getElementById('sim-file-name').value;
                    const simContent = document.getElementById('sim-file-content').value;
                    const sizeNum = document.getElementById('sim-file-size-num').value;
                    const sizeUnit = document.getElementById('sim-file-size-unit').value;
                    if (!name || !simContent) { showiOSAlert(t('common_error'), "文件名和内容不能为空。"); return; }
                    messageContent = { name: name, size: `${sizeNum} ${sizeUnit}`, content: simContent, dataType: 'text' };
                    closeModal();
                } else {
                    messageContent = content;
                }
            }
            addMessage({ id: `msg_${Date.now()}`, type: 'sim-file', sender: sender, content: messageContent, timestamp: Date.now() });
            tempFileData = {};
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function openLocationModal(sender) {
            showModal(`
                <div class="modal-title">发送位置</div>
                <div class="modal-body" style="background: var(--theme-bg); padding: 20px; gap: 15px; display: flex; flex-direction: column;">
                    <div class="glass-form-group"><label>位置标题 (必填, 最多20字)</label><input type="text" id="loc-title" class="glass-input" maxlength="20"></div>
                    <div class="glass-form-group"><label>位置简介 (必填, 最多120字)</label><textarea id="loc-summary" class="glass-textarea" maxlength="120" style="min-height: 80px;"></textarea></div>
                    <div class="glass-form-group"><label>详细内容 (非必填, 最多500字)</label><textarea id="loc-details" class="glass-textarea" maxlength="500" style="min-height: 120px;"></textarea></div>
                    <button class="glass-button" onclick="sendLocation('${sender}')">发送位置</button>
                </div>
            `);
        }

        function sendLocation(sender, content) {
            let locationContent;
            if (sender === 'user') {
                const title = document.getElementById('loc-title').value;
                const summary = document.getElementById('loc-summary').value;
                const details = document.getElementById('loc-details').value;
                if (!title || !summary) { showiOSAlert(t('common_error'), "位置标题和简介为必填项。"); return; }
                locationContent = { title, summary, details };
                closeModal();
            } else {
                locationContent = content;
            }
            addMessage({ id: `msg_${Date.now()}`, type: 'location', sender: sender, content: locationContent, timestamp: Date.now() });
        }

        function showLocationDetails(messageId) {
            const message = appData.chat.messages[currentChatContactId].find(m => m.id === messageId);
            if (message && message.type === 'location') {
                showiOSAlert(message.content.title, message.content.details || message.content.summary);
            }
        }

        function openCameraSimModal(sender) {
            showCustomiOSAlert('模拟拍摄', '', [
                { text: '模拟图片', action: () => openSimMediaModal(sender, 'image') },
                { text: '模拟视频', action: () => openSimMediaModal(sender, 'video') },
                { text: t('common_cancel'), style: 'bold' }
            ]);
        }

        function openSimMediaModal(sender, type) {
            const isVideo = type === 'video';
            const videoFields = `
                <div class="glass-form-group"><label>视频时长 (e.g., 00:15)</label><input type="text" id="sim-video-duration" class="glass-input" placeholder="mm:ss"></div>
                <div class="glass-form-group"><label>视频文件大小</label><div class="form-row"><input type="number" id="sim-video-size-num" class="glass-input" style="flex: 1;" value="5"><select id="sim-video-size-unit" class="glass-select" style="width: 80px;"><option value="MB">MB</option><option value="GB">GB</option></select></div></div>
            `;
            showModal(`
                <div class="modal-title">模拟${isVideo ? '视频' : '图片'}</div>
                <div class="modal-body" style="background: var(--theme-bg); padding: 20px; gap: 15px; display: flex; flex-direction: column;">
                    <div class="glass-form-group"><label>内容描述</label><textarea id="sim-media-desc" class="glass-textarea" style="min-height: 120px;"></textarea></div>
                    ${isVideo ? videoFields : ''}
                    <button class="glass-button" onclick="sendCameraSim('${sender}', '${type}')">发送</button>
                </div>
            `);
        }

        function sendCameraSim(sender, type, content) {
            let messageContent;
            if (sender === 'user') {
                const description = document.getElementById('sim-media-desc').value;
                if (!description) { showiOSAlert(t('common_error'), "请填写描述内容。"); return; }
                if (type === 'image') {
                    messageContent = { description };
                } else {
                    const duration = document.getElementById('sim-video-duration').value;
                    const sizeNum = document.getElementById('sim-video-size-num').value;
                    const sizeUnit = document.getElementById('sim-video-size-unit').value;
                    messageContent = { description, duration: duration || '00:00', size: `${sizeNum} ${sizeUnit}` };
                }
                closeModal();
            } else {
                messageContent = content;
            }
            
            addMessage({
                id: `msg_${Date.now()}`,
                type: type === 'image' ? 'sim-camera' : 'sim-video',
                sender: sender,
                content: messageContent,
                timestamp: Date.now()
            });
        }

        function openVoiceSimModal(sender) {
            showModal(`
                <div class="modal-title">模拟语音</div>
                <div class="modal-body" style="background: var(--theme-bg); padding: 20px; gap: 15px; display: flex; flex-direction: column;">
                    <div class="glass-form-group"><label>语音文本内容</label><textarea id="voice-text" class="glass-textarea" style="min-height: 100px;"></textarea></div>
                    <div class="glass-form-group"><label>语音时长 (秒)</label><input type="number" id="voice-duration" class="glass-input" value="10"></div>
                    <button class="glass-button" onclick="sendVoiceSim('${sender}')">发送语音</button>
                </div>
            `);
        }

        function sendVoiceSim(sender, content) {
            let voiceContent;
            if (sender === 'user') {
                const text = document.getElementById('voice-text').value;
                const duration = document.getElementById('voice-duration').value;
                if (!text || !duration) { showiOSAlert(t('common_error'), "请填写语音内容和时长。"); return; }
                voiceContent = { text, duration };
                closeModal();
            } else {
                voiceContent = content;
            }
            addMessage({ id: `msg_${Date.now()}`, type: 'voice', sender: sender, content: voiceContent, timestamp: Date.now() });
        }

        let lastClickTime = 0;
        function toggleVoicePlay(event) {
            const currentTime = new Date().getTime();
            if (currentTime - lastClickTime < 300) return;
            lastClickTime = currentTime;
            
            const bubble = event.currentTarget;
            const icon = bubble.querySelector('.voice-icon');
            
            setTimeout(() => {
                if (new Date().getTime() - lastClickTime > 250) {
                    const isPlaying = bubble.classList.toggle('playing');
                    icon.className = `fas ${isPlaying ? 'fa-pause' : 'fa-play'} voice-icon`;
                }
            }, 250);
        }

        function toggleVoiceText(event, bubble) {
            lastClickTime = 0;
            bubble.closest('.message-bubble').classList.toggle('show-text');
            event.stopPropagation();
        }
        
        // --- UI 辅助函数 ---
        function showiOSAlert(title, message = '', type = 'success') {
            const overlay = document.getElementById('iosAlertOverlay');
            document.getElementById('iosAlertTitle').textContent = title;
            document.getElementById('iosAlertMessage').innerHTML = message;
            const actions = document.getElementById('iosAlertActions');
            actions.innerHTML = `<button class="ios-alert-button bold" onclick="closeiOSAlert()">${t('common_ok')}</button>`;
            overlay.classList.add('show');
        }

        function showCustomiOSAlert(title, message = '', buttons = []) {
            const overlay = document.getElementById('iosAlertOverlay');
            document.getElementById('iosAlertTitle').textContent = title;
            document.getElementById('iosAlertMessage').textContent = message;
            const actions = document.getElementById('iosAlertActions');
            actions.innerHTML = '';

            if (buttons.length === 0) {
                buttons.push({ text: t('common_ok'), style: 'bold' });
            }

            buttons.forEach(btn => {
                const buttonEl = document.createElement('button');
                buttonEl.className = 'ios-alert-button';
                if (btn.style === 'bold') buttonEl.classList.add('bold');
                if (btn.style === 'destructive') buttonEl.classList.add('destructive');
                buttonEl.textContent = btn.text;
                buttonEl.onclick = () => {
                    closeiOSAlert();
                    if (btn.action) btn.action();
                };
                actions.appendChild(buttonEl);
            });

            overlay.classList.add('show');
        }

        function closeiOSAlert() {
            document.getElementById('iosAlertOverlay').classList.remove('show');
        }

        function showModal(htmlContent) {
            const modalOverlay = document.getElementById('modalOverlay');
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = htmlContent;
            modalOverlay.classList.add('show');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('show');
        }

        function showSpinner(overlayId, show) {
            const overlay = document.getElementById(overlayId);
            if (overlay) {
                overlay.style.display = show ? 'flex' : 'none';
            }
        }

        // --- Cropper 功能 ---
        function triggerAvatarUpload(targetType) {
            currentAvatarTarget.type = targetType;
            let inputId;
            if (targetType === 'contact') {
                inputId = 'avatar-upload';
                tempAvatarData.type = 'avatar';
            } else if (targetType === 'user') {
                inputId = 'user-avatar-upload';
                tempAvatarData.type = 'avatar';
            } else if (targetType === 'tiebaProfile') {
                inputId = 'tieba-avatar-upload';
                tempAvatarData.type = 'tieba-avatar';
            } else if (targetType === 'widget') {
                inputId = 'widget-avatar-upload';
                tempAvatarData.type = 'widget-avatar';
            } else if (targetType === 'card-widget-avatar') {
                inputId = 'card-widget-avatar-upload';
                tempAvatarData.type = 'card-widget-avatar';
            } else if (targetType === 'card-widget-bg') {
                inputId = 'card-widget-bg-upload';
                tempAvatarData.type = 'card-widget-bg';
            }
            if (inputId) document.getElementById(inputId).click();
        }

        document.getElementById('avatar-upload').addEventListener('change', handleAvatarFile);
        document.getElementById('user-avatar-upload').addEventListener('change', handleAvatarFile);
        document.getElementById('tieba-avatar-upload').addEventListener('change', handleAvatarFile);

        function handleAvatarFile(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const isBg = currentAvatarTarget.type === 'card-widget-bg';
                    openCropperModal(event.target.result, isBg ? (16/9) : 1);
                };
                reader.readAsDataURL(file);
            }
            e.target.value = '';
        }

        function openCropperModal(imageSrc, ratio = 1) {
            const modal = document.getElementById('cropperModal');
            const image = document.getElementById('cropperImage');
            image.src = imageSrc;
            modal.classList.add('show');

            if (cropper) {
                cropper.destroy();
            }
            cropper = new Cropper(image, {
                aspectRatio: ratio,
                viewMode: 1,
                background: false,
            });
        }

        function setCropRatio(ratio) {
            if (cropper) {
                cropper.setAspectRatio(ratio);
            }
        }

        function confirmCrop() {
            if (cropper) {
                const isBg = currentAvatarTarget.type === 'card-widget-bg';
                tempAvatarData.data = cropper.getCroppedCanvas({
                    width: isBg ? 512 : 256,
                    height: isBg ? 288 : 256,
                    imageSmoothingQuality: 'high',
                }).toDataURL('image/png');
                
                let previewId;
                if (currentAvatarTarget.type === 'contact') previewId = 'avatarPreview';
                else if (currentAvatarTarget.type === 'user') previewId = 'userAvatarPreview';
                else if (currentAvatarTarget.type === 'tiebaProfile') previewId = 'tiebaAvatarPreview';
                else if (currentAvatarTarget.type === 'widget') {
                    document.getElementById('widget-avatar').style.backgroundImage = `url(${tempAvatarData.data})`;
                    appData.settings.desktop.copywriting.avatar = tempAvatarData.data;
                    saveData(true);
                } else if (currentAvatarTarget.type === 'card-widget-avatar') {
                    document.getElementById('card-widget-editor-avatar-preview').style.backgroundImage = `url(${tempAvatarData.data})`;
                } else if (currentAvatarTarget.type === 'card-widget-bg') {
                    document.getElementById('card-widget-editor-bg-preview').style.backgroundImage = `url(${tempAvatarData.data})`;
                }
                
                if (previewId) {
                    document.getElementById(previewId).style.backgroundImage = `url(${tempAvatarData.data})`;
                }
                
                closeCropperModal();
            }
        }

        function closeCropperModal() {
            const modal = document.getElementById('cropperModal');
            modal.classList.remove('show');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }

        // --- 通用 API 调用辅助函数 ---
        function getApiEndpoint(type, apiType = 'chat') {
            let api = appData.settings[`${apiType}Api`];
            if (apiType !== 'main' && api.useMain) {
                api = appData.settings.mainApi;
            }
            
            let baseUrl = api.endpoint.trim();

            const defaultEndpoints = {
                'openai': 'https://api.openai.com/v1', 'deepseek': 'https://api.deepseek.com/v1',
                'openrouter': 'https://openrouter.ai/api/v1', 'gemini': 'https://generativelanguage.googleapis.com/v1beta',
                'doubao': 'https://ark.cn-beijing.volces.com/api/v3'
            };
            if (!baseUrl && defaultEndpoints[api.provider]) {
                baseUrl = defaultEndpoints[api.provider];
            }

            baseUrl = baseUrl.replace(/\/v1\/chat\/completions$|\/v1\/completions$|\/v1\/models$|\/v1$|\/$/, '');

            if (type === 'chat') {
                if (api.provider === 'gemini' || api.provider === 'custom_gemini') {
                    return `${baseUrl}/models/${api.model}:generateContent`;
                }
                if (api.provider === 'doubao') {
                    return `${baseUrl}/chat/completions`;
                }
                return `${baseUrl}/v1/chat/completions`;
            } 
            else if (type === 'models') {
                if (api.provider === 'gemini' || api.provider === 'custom_gemini') {
                    return `${baseUrl}/models`;
                }
                return `${baseUrl}/v1/models`;
            }
            return baseUrl;
        }

        async function callGenericApi(systemPrompt, params = {}, history = [], apiType = 'chat') {
            let api = appData.settings[`${apiType}Api`];
            if (apiType !== 'main' && api.useMain) {
                api = appData.settings.mainApi;
            }
            if (!api.key) throw new Error('API Key not configured');

            const endpoint = getApiEndpoint('chat', apiType);
            const headers = { 'Content-Type': 'application/json' };
            let fetchUrl = endpoint;

            if (api.provider === 'gemini' || api.provider === 'custom_gemini') {
                fetchUrl += `?key=${api.key}`;
            } else {
                headers['Authorization'] = `Bearer ${api.key}`;
            }

            let requestBody;
            if (api.provider === 'gemini' || api.provider === 'custom_gemini') {
                const contents = [];
                if (systemPrompt) {
                    contents.push({ role: 'user', parts: [{ text: systemPrompt }] });
                    contents.push({ role: 'model', parts: [{ text: '好的，我明白了。' }] });
                }
                
                let lastRole = 'model';
                history.forEach(msg => {
                    const currentRole = msg.role === 'assistant' ? 'model' : 'user';
                    if (currentRole !== lastRole) {
                        if (Array.isArray(msg.content)) {
                            contents.push({ role: currentRole, parts: msg.content.map(p => p.type === 'text' ? {text: p.text} : {inline_data: {mime_type: 'image/jpeg', data: p.image_url.url.split(',')[1]}}) });
                        } else {
                            contents.push({ role: currentRole, parts: [{ text: msg.content }] });
                        }
                        lastRole = currentRole;
                    } else {
                        const lastContent = contents[contents.length - 1];
                        if (Array.isArray(msg.content)) {
                            lastContent.parts.push(...msg.content.map(p => p.type === 'text' ? {text: p.text} : {inline_data: {mime_type: 'image/jpeg', data: p.image_url.url.split(',')[1]}}));
                        } else {
                            lastContent.parts.push({ text: msg.content });
                        }
                    }
                });
                
                if (contents.length === 0 && history.length > 0) {
                     history.forEach(msg => {
                        const role = msg.role === 'assistant' ? 'model' : 'user';
                        if (Array.isArray(msg.content)) {
                            contents.push({ role, parts: msg.content.map(p => p.type === 'text' ? {text: p.text} : {inline_data: {mime_type: 'image/jpeg', data: p.image_url.url.split(',')[1]}}) });
                        } else {
                            contents.push({ role, parts: [{ text: msg.content }] });
                        }
                    });
                }
                if (contents.length === 0) {
                     throw new Error("Cannot make a Gemini API call with empty contents.");
                }
                requestBody = { contents };

            } else { // OpenAI-like providers
                const messages = [];
                if (systemPrompt) messages.push({ role: 'system', content: systemPrompt });
                messages.push(...history);
                
                if (messages.length === 0) {
                    throw new Error("Cannot make an API call with empty messages.");
                }

                requestBody = {
                    model: api.model,
                    messages: messages,
                    temperature: params.temperature || 1.0,
                    max_tokens: params.max_tokens || 1500,
                };
                if (api.repetition_penalty && api.repetition_penalty !== 1.0) {
                    requestBody.repetition_penalty = api.repetition_penalty;
                }
            }

            const response = await fetch(fetchUrl, { method: 'POST', headers: headers, body: JSON.stringify(requestBody) });
            if (!response.ok) {
                const errorText = await response.text();
                let errorMessage = `API Error: ${response.status}`;
                try {
                    const errorData = JSON.parse(errorText);
                    errorMessage += ` - ${errorData.error?.message || 'Unknown error'}`;
                } catch(e) {
                    errorMessage += ` - ${errorText}`;
                }
                throw new Error(errorMessage);
            }

            const data = await response.json();
            let replyContent;
            if (api.provider === 'gemini' || api.provider === 'custom_gemini') {
                if (!data.candidates || !data.candidates[0].content) {
                    throw new Error('Invalid Gemini response: ' + JSON.stringify(data));
                }
                replyContent = data.candidates[0]?.content?.parts[0]?.text?.trim() || '';
            } else {
                if (!data.choices || !data.choices[0].message) {
                    throw new Error('Invalid OpenAI-like response: ' + JSON.stringify(data));
                }
                replyContent = data.choices[0]?.message?.content?.trim() || '';
            }
            
            let cleanContent = replyContent.replace(/^```json\s*|```\s*$/g, '').trim();
            const jsonMatch = cleanContent.match(/^(\{[\s\S]*\}|\[[\s\S]*\])$/);
            if (jsonMatch) {
                cleanContent = jsonMatch[0];
            }

            try {
                JSON.parse(cleanContent);
                return cleanContent;
            } catch (e) {
                if (!cleanContent.startsWith('{') && !cleanContent.startsWith('[')) {
                    return cleanContent;
                }
                console.error("Failed to parse what looks like a JSON response:", cleanContent, e);
                throw new Error("API returned malformed JSON. Raw response: " + cleanContent);
            }
        }

        // --- 桌面小组件 ---
        function renderWidgets() {
            updateMusicWidget();
            renderCardWidget();
            
            const copywriting = appData.settings.desktop.copywriting;
            document.getElementById('copywriting-line-1').innerText = copywriting.lines[0];
            document.getElementById('copywriting-line-2').innerText = copywriting.lines[1];
            document.getElementById('copywriting-line-3').innerText = copywriting.lines[2];
            document.getElementById('widget-avatar').style.backgroundImage = `url(${copywriting.avatar || ''})`;
            
            const widget = document.getElementById('copywriting-widget');
            widget.classList.toggle('glassy', copywriting.style === 'glassy');
        }

        function updateMusicWidget() {
            const song = appData.music.songs[appData.music.settings.currentIndex];
            const artEl = document.getElementById('music-widget-art');
            const titleEl = document.getElementById('music-widget-title');
            const artistEl = document.getElementById('music-widget-artist');
            const playBtn = document.getElementById('music-widget-play-btn');

            if (song) {
                artEl.style.backgroundImage = `url(${song.cover})`;
                titleEl.textContent = song.title;
                artistEl.textContent = song.artist;
            } else {
                artEl.style.backgroundImage = '';
                titleEl.textContent = t('music_widget_no_song');
                artistEl.textContent = '...';
            }
            
            const isPlaying = !musicAudioElement.paused;
            playBtn.className = `fas ${isPlaying ? 'fa-pause' : 'fa-play'}`;
        }

        function saveCopywriting() {
            const lines = [
                document.getElementById('copywriting-line-1').innerText.substring(0, 15),
                document.getElementById('copywriting-line-2').innerText.substring(0, 15),
                document.getElementById('copywriting-line-3').innerText.substring(0, 15)
            ];
            appData.settings.desktop.copywriting.lines = lines;
            saveData(true);
        }

        function handleWidgetAvatarUpload(event) {
            currentAvatarTarget.type = 'widget';
            handleAvatarFile(event);
        }

        function toggleCopywritingWidgetStyle() {
            const widget = document.getElementById('copywriting-widget');
            const currentStyle = appData.settings.desktop.copywriting.style;
            const newStyle = currentStyle === 'white' ? 'glassy' : 'white';
            appData.settings.desktop.copywriting.style = newStyle;
            widget.classList.toggle('glassy', newStyle === 'glassy');
            saveData(true);
        }

        function renderCardWidget() {
            const widgetData = appData.settings.desktop.cardWidget;
            document.getElementById('cardWidgetBg').style.backgroundImage = `url(${widgetData.background || ''})`;
            document.getElementById('cardWidgetAvatar').style.backgroundImage = `url(${widgetData.avatar || ''})`;
            document.getElementById('cardWidgetNickname').textContent = widgetData.nickname;
            document.getElementById('cardWidgetUsername').textContent = widgetData.username;
            document.getElementById('cardWidgetSignature').textContent = widgetData.signature;
            document.getElementById('cardWidgetAddress').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${widgetData.address}`;
        }

        function openCardWidgetEditor() {
            const widgetData = appData.settings.desktop.cardWidget;
            const modalHTML = `
                <div class="modal-title">编辑名片小组件</div>
                <div class="modal-body" style="background: var(--theme-bg); padding: 20px; gap: 15px; display: flex; flex-direction: column;">
                    <div class="glass-form-group">
                        <label>头像</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div id="card-widget-editor-avatar-preview" class="editor-avatar-preview" style="background-image: url(${widgetData.avatar || ''})"></div>
                            <button class="glass-button" style="flex: 1;" onclick="triggerAvatarUpload('card-widget-avatar')">更换头像</button>
                            <input type="file" id="card-widget-avatar-upload" accept="image/*" style="display:none;" onchange="handleAvatarFile(event)">
                        </div>
                    </div>
                    <div class="glass-form-group">
                        <label>背景</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div id="card-widget-editor-bg-preview" class="editor-avatar-preview" style="border-radius: 8px; background-image: url(${widgetData.background || ''})"></div>
                            <button class="glass-button" style="flex: 1;" onclick="triggerAvatarUpload('card-widget-bg')">更换背景</button>
                            <input type="file" id="card-widget-bg-upload" accept="image/*" style="display:none;" onchange="handleAvatarFile(event)">
                        </div>
                    </div>
                    <div class="glass-form-group">
                        <label>昵称 (最多60字符)</label>
                        <input type="text" id="card-widget-editor-nickname" class="glass-input" value="${widgetData.nickname}" maxlength="60">
                    </div>
                    <div class="glass-form-group">
                        <label>用户名 (最多15字符)</label>
                        <div class="form-row">
                            <span style="font-size: 1.2em; margin-right: 5px;">@</span>
                            <input type="text" id="card-widget-editor-username" class="glass-input" value="${widgetData.username.substring(1)}" maxlength="15">
                        </div>
                    </div>
                    <div class="glass-form-group">
                        <label>地址 (最多30字符)</label>
                        <input type="text" id="card-widget-editor-address" class="glass-input" value="${widgetData.address}" maxlength="30">
                    </div>
                    <div class="glass-form-group">
                        <label>个性签名 (最多50字符)</label>
                        <textarea id="card-widget-editor-signature" class="glass-textarea" style="min-height: 60px;" maxlength="50">${widgetData.signature}</textarea>
                    </div>
                    <button class="glass-button" onclick="saveCardWidget()">保存</button>
                </div>
            `;
            showModal(modalHTML);
        }

        function saveCardWidget() {
            const widgetData = appData.settings.desktop.cardWidget;
            
            if (tempAvatarData.type === 'card-widget-avatar') {
                widgetData.avatar = tempAvatarData.data;
            }
            if (tempAvatarData.type === 'card-widget-bg') {
                widgetData.background = tempAvatarData.data;
            }
            
            widgetData.nickname = document.getElementById('card-widget-editor-nickname').value;
            const usernameInput = document.getElementById('card-widget-editor-username').value.replace(/[^a-zA-Z0-9]/g, '');
            widgetData.username = '@' + usernameInput.substring(0, 15);
            widgetData.address = document.getElementById('card-widget-editor-address').value;
            widgetData.signature = document.getElementById('card-widget-editor-signature').value;

            saveData();
            renderCardWidget();
            closeModal();
        }
        
        // --- 灵动岛相关函数 ---
        function toggleDynamicIsland() {
            const island = document.getElementById('ins-dynamic-island');
            if (appData.music.settings.currentIndex > -1) {
                island.classList.toggle('expanded');
            }
        }

        function updateDynamicIsland() {
            const island = document.getElementById('ins-dynamic-island');
            if (!island) return;

            const song = appData.music.songs[appData.music.settings.currentIndex];
            const isMusicActive = !!song;
            
            island.classList.toggle('no-music', !isMusicActive);

            if (!isMusicActive) {
                island.classList.remove('playing', 'expanded');
                return;
            }

            const isPlaying = !musicAudioElement.paused;
            island.classList.toggle('playing', isPlaying);

            // 更新小岛
            document.getElementById('island-album-cover-small').style.backgroundImage = `url(${song.cover})`;
            
            // 更新展开视图
            document.getElementById('island-song-title').textContent = song.title;
            document.getElementById('island-artist').textContent = song.artist;
            document.getElementById('island-play-icon').className = `fas ${isPlaying ? 'fa-pause' : 'fa-play'}`;

            const currentTime = musicAudioElement.currentTime;
            const duration = musicAudioElement.duration;
            
            const formatTime = (s) => {
                if (isNaN(s)) return '0:00';
                return `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`;
            }

            if (!isNaN(duration)) {
                document.getElementById('island-current-time').textContent = formatTime(currentTime);
                document.getElementById('island-duration').textContent = formatTime(duration);
                document.getElementById('island-progress').style.width = `${(currentTime / duration) * 100}%`;
            }
            
            const speed = appData.music.settings.playbackRate;
            const pitch = appData.music.settings.pitch;
            document.getElementById('island-speed-slider').value = speed;
            document.getElementById('island-speed-value').textContent = `${speed.toFixed(1)}x`;
            document.getElementById('island-pitch-slider').value = pitch;
            document.getElementById('island-pitch-value').textContent = `${pitch.toFixed(1)}x`;

            const modes = ['sequence', 'loop', 'shuffle'];
            const icons = ['fa-retweet', 'fa-repeat', 'fa-random'];
            const modeIndex = modes.indexOf(appData.music.settings.mode);
            document.getElementById('island-mode-btn').querySelector('i').className = `fas ${icons[modeIndex]}`;
        }
        
        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            applyLoadedSettings();
            updateTime();
            updateBattery();
            setupAudioEvents();
            makeDraggable(document.getElementById('music-mini-player'), document.querySelector('#music-mini-player .mini-player-header'));
            setInterval(updateTime, 1000);
            setInterval(updateBattery, 30000);
            setInterval(triggerCharPost, 5 * 60 * 1000); // 每5分钟尝试触发一次

            document.getElementById('worldbook-depth').addEventListener('input', (e) => {
                document.getElementById('worldbook-depth-value').textContent = e.target.value;
            });

            document.getElementById('tag-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.value.trim() !== '') {
                    e.preventDefault();
                    const tags = Array.from(document.querySelectorAll('#tag-container .tag-item')).map(el => el.textContent.slice(0, -1).trim());
                    const newTag = e.target.value.trim();
                    if (!tags.includes(newTag)) {
                        renderTags([...tags, newTag]);
                    }
                    e.target.value = '';
                }
            });

            const chatInput = document.getElementById('chatInputField');
            const sendBtn = document.getElementById('chatSendBtn');

            chatInput.addEventListener('input', () => {
                chatInput.style.height = 'auto';
                chatInput.style.height = (chatInput.scrollHeight) + 'px';
                sendBtn.classList.toggle('visible', chatInput.value.trim().length > 0);
            });

            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendTextMessage();
                }
            });

            // Close dynamic island when clicking outside
            document.body.addEventListener('click', (e) => {
                const island = document.getElementById('ins-dynamic-island');
                if (island.classList.contains('expanded') && !island.contains(e.target)) {
                    island.classList.remove('expanded');
                }
            });
        });
    </script>
</body>
</html>
